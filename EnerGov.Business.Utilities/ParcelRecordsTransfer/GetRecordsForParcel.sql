WITH MailingAddresses AS (
    SELECT ma.MAILINGADDRESSID,
           ma.ADDRESSTYPE,
           LTRIM(RTRIM(ma.ADDRESSLINE1)) +
           IIF(LEN(ma.PREDIRECTION) > 0, ' ' + LTRIM(RTRIM(ma.PREDIRECTION)), '') + ' ' +
           LTRIM(RTRIM(ma.ADDRESSLINE2)) + ' ' + LTRIM(RTRIM(ma.STREETTYPE)) +
           IIF(LEN(ma.POSTDIRECTION) > 0, ' ' + LTRIM(RTRIM(ma.POSTDIRECTION)), '') +
           IIF(LEN(ma.UNITORSUITE) > 0, ' ' + LTRIM(RTRIM(ma.UNITORSUITE)), '')                                    AS StreetAddress
    FROM MAILINGADDRESS ma
)
SELECT
    'Permit' AS RecordType,
    pmp.PERMITNUMBER AS RecordNumber,
    pmpt.NAME AS RecordType,
    pmpwc.NAME AS RecordClass,
    ISNULL(pmp.DESCRIPTION, '') AS RecordDescription,
    pmp.APPLYDATE AS RecordDate,
    pmps.NAME AS RecordStatus,
    pmp.PMPERMITID AS RecordId,
    pmpar.PMPERMITPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    pmpar.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM PMPERMITADDRESS pmpa
        INNER JOIN MailingAddresses ma ON pmpa.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE pmpa.PMPERMITID = pmp.PMPERMITID AND pmpa.MAIN = 1) AS RecordMainAddress,
    '/managepermit/#/permit/' + pmp.PMPERMITID AS RecordUrl
FROM PMPERMIT pmp
INNER JOIN PMPERMITPARCEL pmpar ON pmp.PMPERMITID = pmpar.PMPERMITID
INNER JOIN PMPERMITTYPE pmpt ON pmp.PMPERMITTYPEID = pmpt.PMPERMITTYPEID
INNER JOIN PMPERMITWORKCLASS pmpwc ON pmp.PMPERMITWORKCLASSID = pmpwc.PMPERMITWORKCLASSID
INNER JOIN PMPERMITSTATUS pmps ON pmp.PMPERMITSTATUSID = pmps.PMPERMITSTATUSID
INNER JOIN PARCEL par ON pmpar.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Inspection' AS RecordType,
    imi.INSPECTIONNUMBER AS RecordNumber,
    imit.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(imi.COMMENTS, '') AS RecordDescription,
    ISNULL(imi.ACTUALSTARTDATE, ISNULL(imi.SCHEDULEDSTARTDATE, imi.REQUESTEDDATE)) AS RecordDate,
    imis.STATUSNAME AS RecordStatus,
    imi.IMINSPECTIONID AS RecordId,
    imip.INSPECTIONPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    imip.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM IMINSPECTIONADDRESS imia
        INNER JOIN MailingAddresses ma ON imia.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE imia.IMINSPECTIONID = imi.IMINSPECTIONID AND imia.MAIN = 1) AS RecordMainAddress,
    '/manageinspection/#/inspection/' + imi.IMINSPECTIONID AS RecordUrl
FROM IMINSPECTION imi
INNER JOIN IMINSPECTIONPARCEL imip ON imi.IMINSPECTIONID = imip.IMINSPECTIONID
INNER JOIN IMINSPECTIONTYPE imit ON imi.IMINSPECTIONTYPEID = imit.IMINSPECTIONTYPEID
INNER JOIN IMINSPECTIONSTATUS imis ON imi.IMINSPECTIONSTATUSID = imis.IMINSPECTIONSTATUSID
INNER JOIN PARCEL par ON imip.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Code Case' AS RecordType,
    cmcc.CASENUMBER AS RecordNumber,
    cmct.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(cmcc.DESCRIPTION, '') AS RecordDescription,
    cmcc.OPENEDDATE AS RecordDate,
    cmccs.NAME AS RecordStatus,
    cmcc.CMCODECASEID AS RecordId,
    cmccp.CMCODECASEPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    cmccp.[PRIMARY] AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM CMCODECASEADDRESS cmca
        INNER JOIN MailingAddresses ma ON cmca.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE cmca.CMCODECASEID = cmcc.CMCODECASEID AND cmca.MAIN = 1) AS RecordMainAddress,
    '/managecodecase/#/code-case/' + cmcc.CMCODECASEID AS RecordUrl
FROM CMCODECASE cmcc
INNER JOIN CMCASETYPE cmct ON cmcc.CMCASETYPEID = cmct.CMCASETYPEID
INNER JOIN CMCODECASESTATUS cmccs ON cmcc.CMCODECASESTATUSID = cmccs.CMCODECASESTATUSID
INNER JOIN CMCODECASEPARCEL cmccp ON cmcc.CMCODECASEID = cmccp.CMCODECASEID
INNER JOIN PARCEL par ON cmccp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Plan' AS RecordType,
    plp.PLANNUMBER AS RecordNumber,
    plpt.PLANNAME AS RecordType,
    plpwc.NAME AS RecordClass,
    ISNULL(plp.DESCRIPTION, '') AS RecordDescription,
    ISNULL(plp.APPLICATIONDATE, GETDATE()) AS RecordDate,
    plps.NAME AS RecordStatus,
    plp.PLPLANID AS RecordId,
    plpp.PLPLANPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    plpp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM PLPLANADDRESS plpa
        INNER JOIN MailingAddresses ma ON plpa.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE plpa.PLPLANID = plp.PLPLANID AND plpa.MAIN = 1) AS RecordMainAddress,
    '/manageplan/#/plan/' + plp.PLPLANID AS RecordUrl
FROM PLPLAN plp
INNER JOIN PLPLANTYPE plpt ON plp.PLPLANTYPEID = plpt.PLPLANTYPEID
INNER JOIN PLPLANWORKCLASS plpwc ON plp.PLPLANWORKCLASSID = plpwc.PLPLANWORKCLASSID
INNER JOIN PLPLANSTATUS plps ON plp.PLPLANSTATUSID = plps.PLPLANSTATUSID
INNER JOIN PLPLANPARCEL plpp ON plp.PLPLANID = plpp.PLPLANID
INNER JOIN PARCEL par ON plpp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Citizen Request' AS RecordType,
    cr.REQUESTNUMBER AS RecordNumber,
    crt.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(cr.DESCRIPTION, '') AS RecordDescription,
    ISNULL(cr.DATEFILED, ISNULL(cr.LASTCHANGEDON, GETDATE())) AS RecordDate,
    crs.STATUS AS RecordStatus,
    cr.CITIZENREQUESTID AS RecordId,
    crp.CITIZENREQUESTPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    crp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM CITIZENREQUESTADDRESS cra
        INNER JOIN MailingAddresses ma ON cra.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE cra.CITIZENREQUESTID = cr.CITIZENREQUESTID AND cra.MAIN = 1) AS RecordMainAddress,
    '' AS RecordUrl
FROM CITIZENREQUEST cr
INNER JOIN CITIZENREQUESTTYPE crt ON cr.CITIZENREQUESTTYPEID = crt.CITIZENREQUESTTYPEID
INNER JOIN CITIZENREQUESTSTATUS crs ON cr.CITIZENREQUESTSTATUSID = crs.CITIZENREQUESTSTATUSID
INNER JOIN CITIZENREQUESTPARCEL crp ON cr.CITIZENREQUESTID = crp.CITIZENREQUESTID
INNER JOIN PARCEL par ON crp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Project' AS RecordType,
    prp.PROJECTNUMBER AS RecordNumber,
    prpt.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(prp.DESCRIPTION, '') AS RecordDescription,
    ISNULL(prp.STARTDATE, prp.LASTCHANGEDON) AS RecordDate,
    prps.NAME AS RecordStatus,
    prp.PRPROJECTID AS RecordId,
    prpp.PRPROJECTPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    prpp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM PRPROJECTADDRESS prpa
        INNER JOIN MailingAddresses ma ON prpa.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE prpa.PRPROJECTID = prp.PRPROJECTID AND prpa.MAIN = 1) AS RecordMainAddress,
    '' AS RecordUrl
FROM PRPROJECT prp
INNER JOIN PRPROJECTTYPE prpt ON prp.PRPROJECTTYPEID = prpt.PRPROJECTTYPEID
INNER JOIN PRPROJECTSTATUS prps ON prp.PRPROJECTSTATUSID = prps.PRPROJECTSTATUSID
INNER JOIN PRPROJECTPARCEL prpp ON prp.PRPROJECTID = prpp.PRPROJECTID
INNER JOIN PARCEL par ON prpp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Business License' AS RecordType,
    bll.LICENSENUMBER AS RecordNumber,
    bllt.NAME AS RecordType,
    bllc.NAME AS RecordClass,
    ISNULL(bll.DESCRIPTION, '') AS RecordDescription,
    ISNULL(bll.APPLIEDDATE, ISNULL(bll.ISSUEDDATE, ISNULL(bll.LASTCHANGEDON, GETDATE()))) AS RecordDate,
    blls.NAME AS RecordStatus,
    bll.BLLICENSEID AS RecordId,
    bllp.BLLICENSEPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    bllp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM BLLICENSEADDRESS blla
        INNER JOIN MailingAddresses ma ON blla.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE blla.BLLICENSEID = bll.BLLICENSEID AND blla.MAIN = 1) AS RecordMainAddress,
    '/managebusinesslicense/#/business-license/' + bll.BLLICENSEID AS RecordUrl
FROM BLLICENSE bll
INNER JOIN BLLICENSETYPE bllt ON bll.BLLICENSETYPEID = bllt.BLLICENSETYPEID
INNER JOIN BLLICENSECLASS bllc ON bll.BLLICENSECLASSID = bllc.BLLICENSECLASSID
INNER JOIN BLLICENSESTATUS blls ON bll.BLLICENSESTATUSID = blls.BLLICENSESTATUSID
INNER JOIN BLLICENSEPARCEL bllp ON bll.BLLICENSEID = bllp.BLLICENSEID
INNER JOIN PARCEL par ON bllp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Business' AS RecordType,
    blgee.REGISTRATIONID AS RecordNumber,
    blect.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(blgee.DESCRIPTION, '') AS RecordDescription,
    ISNULL(blgee.OPENDATE, blgee.LASTCHANGEDON) AS RecordDate,
    bles.NAME AS RecordStatus,
    blgee.BLGLOBALENTITYEXTENSIONID AS RecordId,
    blgeep.BLGLOBALENTITYEXTPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    blgeep.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM BLGLOBALENTITYEXTENSIONADDRESS blgeea
        INNER JOIN MailingAddresses ma ON blgeea.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE blgeea.BLGLOBALENTITYEXTENSIONID = blgee.BLGLOBALENTITYEXTENSIONID AND blgeea.MAIN = 1) AS RecordMainAddress,
    '/managebusiness/#/business/' + blgee.BLGLOBALENTITYEXTENSIONID AS RecordUrl
FROM BLGLOBALENTITYEXTENSION blgee
INNER JOIN BLEXTCOMPANYTYPE blect ON blgee.BLEXTCOMPANYTYPEID = blect.BLEXTCOMPANYTYPEID
INNER JOIN BLEXTSTATUS bles ON blgee.BLEXTSTATUSID = bles.BLEXTSTATUSID
INNER JOIN BLGLOBALENTITYEXTENSIONPARCEL blgeep ON blgee.BLGLOBALENTITYEXTENSIONID = blgeep.BLGLOBALENTITYEXTENSIONID
INNER JOIN PARCEL par ON blgeep.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Professional License' AS RecordType,
    ill.LICENSENUMBER AS RecordNumber,
    illt.NAME AS RecordType,
    illc.NAME AS RecordClass,
    ISNULL(ill.DESCRIPTION, '') AS RecordDescription,
    ill.APPLIEDDATE AS RecordDate,
    ills.NAME AS RecordStatus,
    ill.ILLICENSEID AS RecordId,
    illp.ILLICENSEPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    illp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM ILLICENSEADDRESS illa
        INNER JOIN MailingAddresses ma ON illa.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE illa.ILLICENSEID = ill.ILLICENSEID AND illa.MAIN = 1) AS RecordMainAddress,
    '' AS RecordUrl
FROM ILLICENSE ill
INNER JOIN ILLICENSETYPE illt ON ill.ILLICENSETYPEID = illt.ILLICENSETYPEID
INNER JOIN ILLICENSECLASSIFICATION illc ON ill.ILLICENSECLASSIFICATIONID = illc.ILLICENSECLASSIFICATIONID
INNER JOIN ILLICENSESTATUS ills ON ill.ILLICENSESTATUSID = ills.ILLICENSESTATUSID
INNER JOIN ILLICENSEPARCEL illp ON ill.ILLICENSEID = illp.ILLICENSEID
INNER JOIN PARCEL par ON illp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Application' AS RecordType,
    pla.APPNUMBER AS RecordNumber,
    plat.APPLICATIONTYPENAME AS RecordType,
    '' AS RecordClass,
    ISNULL(pla.DESCRIPTION, '') AS RecordDescription,
    ISNULL(pla.APPLICATIONDATE, ISNULL(pla.LASTCHANGEDON, GETDATE())) AS RecordDate,
    plas.STATUS AS RecordStatus,
    pla.PLAPPLICATIONID AS RecordId,
    plap.PLAPPLICATIONPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    plap.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM PLAPPLICATIONADDRESS plaa
        INNER JOIN MailingAddresses ma ON plaa.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE plaa.PLAPPLICATIONID = pla.PLAPPLICATIONID AND plaa.MAIN = 1) AS RecordMainAddress,
    '' AS RecordUrl
FROM PLAPPLICATION pla
INNER JOIN PLAPPLICATIONTYPE plat ON pla.PLAPPLICATIONTYPEID = plat.PLAPPLICATIONTYPEID
INNER JOIN PLAPPLICATIONSTATUS plas ON pla.PLAPPLICATIONSTATUSID = plas.PLAPPLICATIONSTATUSID
INNER JOIN PLAPPLICATIONPARCEL plap ON pla.PLAPPLICATIONID = plap.PLAPPLICATIONID
INNER JOIN PARCEL par ON plap.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber

UNION ALL SELECT
    'Inspection Case' AS RecordType,
    imic.CASENO AS RecordNumber,
    imict.NAME AS RecordType,
    '' AS RecordClass,
    ISNULL(imic.DESCRIPTION, '') AS RecordDescription,
    imic.CREATEDATE AS RecordDate,
    imics.NAME AS RecordStatus,
    imic.IMINSPECTIONCASEID AS RecordId,
    imicp.IMINSPECTIONCASEPARCELID AS RecordParcelId,
    par.PARCELID AS ParcelId,
    par.PARCELNUMBER AS ParcelNumber,
    imicp.MAIN AS MainParcel,
    (SELECT TOP 1 ma.StreetAddress FROM IMINSPECTIONCASEADDRESS imica
        INNER JOIN MailingAddresses ma ON imica.MAILINGADDRESSID = ma.MAILINGADDRESSID
        WHERE imica.IMINSPECTIONCASEID = imica.IMINSPECTIONCASEID AND imica.MAIN = 1) AS RecordMainAddress,
    '' AS RecordUrl
FROM IMINSPECTIONCASE imic
INNER JOIN IMINSPECTIONCASETYPE imict ON imic.IMINSPECTIONCASETYPEID = imict.IMINSPECTIONCASETYPEID
INNER JOIN IMINSPECTIONCASESTATUS imics ON imic.IMINSPECTIONCASESTATUSID = imics.IMINSPECTIONCASESTATUSID
INNER JOIN IMINSPECTIONCASEPARCEL imicp ON imic.IMINSPECTIONCASEID = imicp.IMINSPECTIONCASEID
INNER JOIN PARCEL par ON imicp.PARCELID = par.PARCELID
WHERE par.PARCELNUMBER = @ParcelNumber