CREATE PROCEDURE [systemsetup].[USP_CAINTEGRATIONBATCHPROCESS_SEARCH]
(
	@SEARCH AS NVARCHAR(50) = '',
	@PAGE_NUMBER AS INT = 1,
	@PAGE_SIZE AS INT = 10,
	@IS_ASCENDING AS BIT = 1,	
	@BATCHNUMBER AS NVARCHAR(50) = '',
	@STATUS AS BIT = 0,
	@BATCHTYPEID AS INT = 0,
	@FINANCESYSTEMID AS CHAR(36) = NULL,
	@CLOSESTARTDATE DATE = NULL,
	@CLOSEENDDATE DATE = NULL,
	@PROCESSSTARTDATE  DATE = NULL,
	@PROCESSENDDATE DATE = NULL
)
AS
WITH RAW_DATA AS (
	SELECT
		[dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHPROCESSID],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[FINANCEBATCHID] AS [BATCHID],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[BATCH_NUMBER],
		[dbo].[CAFINANCIALINTEGRATIONSETUP].[CAFINANCIALINTEGRATIONTYPEID],
		[dbo].[CAINTEGRATIONBATCHTYPE].[NAME] AS [BATCHTYPE],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[BATCH_TOTAL],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[REQUESTED_DATE] AS [CLOSEDDATE],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[LASTSENDATTEMPTDATE],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[PROCESSED_DATE],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[CAFINANCIALINTEGRATIONSETUPID],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[RESULT_LOG],
		[dbo].[CAINTEGRATIONBATCHPROCESS].[SUCCESS],

		CASE @IS_ASCENDING WHEN 1 THEN
			ROW_NUMBER() OVER(ORDER BY [dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHPROCESSID])
		ELSE
			ROW_NUMBER() OVER(ORDER BY [dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHPROCESSID] DESC)
		END AS RowNumber,
		COUNT(1) OVER() AS TotalRows

	FROM [dbo].[CAINTEGRATIONBATCHPROCESS]	
	INNER JOIN [dbo].[CAINTEGRATIONBATCHTYPE] on [dbo].[CAINTEGRATIONBATCHTYPE].[CAINTEGRATIONBATCHTYPEID] = [dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID]
	LEFT JOIN [dbo].[CAFINANCIALINTEGRATIONSETUP] on [dbo].[CAFINANCIALINTEGRATIONSETUP].[CAFINANCIALINTEGRATIONSETUPID] = [dbo].[CAINTEGRATIONBATCHPROCESS].[CAFINANCIALINTEGRATIONSETUPID]
	
	WHERE [dbo].[CAINTEGRATIONBATCHPROCESS].[FINANCEBATCHID] LIKE '%'+ @SEARCH +'%'  AND 
	[dbo].[CAINTEGRATIONBATCHPROCESS].[BATCH_NUMBER] LIKE '%'+ @BATCHNUMBER +'%' AND
	([dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID] != 1 OR ([dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID] = 1 AND [dbo].[CAINTEGRATIONBATCHPROCESS].[BATCH_NUMBER] NOT LIKE '%REF%'))
	AND [dbo].[CAINTEGRATIONBATCHPROCESS].[SUCCESS]  = @STATUS AND
	[dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID] = CASE WHEN @BATCHTYPEID = 0 THEN [dbo].[CAINTEGRATIONBATCHPROCESS].[CAINTEGRATIONBATCHTYPEID] ELSE @BATCHTYPEID END  AND
	[dbo].[CAFINANCIALINTEGRATIONSETUP].[CAFINANCIALINTEGRATIONSETUPID] = CASE WHEN @FINANCESYSTEMID IS NULL THEN [dbo].[CAFINANCIALINTEGRATIONSETUP].[CAFINANCIALINTEGRATIONSETUPID] ELSE @FINANCESYSTEMID END  AND 
	(@CLOSESTARTDATE IS NULL OR [dbo].[CAINTEGRATIONBATCHPROCESS].[REQUESTED_DATE]  >= @CLOSESTARTDATE )
	AND (@CLOSEENDDATE IS NULL OR [dbo].[CAINTEGRATIONBATCHPROCESS].[REQUESTED_DATE]  < @CLOSEENDDATE )
	AND (@PROCESSSTARTDATE IS NULL OR [dbo].[CAINTEGRATIONBATCHPROCESS].[PROCESSED_DATE] >= @PROCESSSTARTDATE )
	AND (@PROCESSENDDATE IS NULL OR [dbo].[CAINTEGRATIONBATCHPROCESS].[PROCESSED_DATE] < @PROCESSENDDATE )
)

SELECT * 
FROM RAW_DATA
WHERE
	RowNumber > @PAGE_SIZE * (@PAGE_NUMBER - 1) AND 
	RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY 
	RowNumber