CREATE PROCEDURE [systemsetup].[USP_INTELLIGENTQUERYACTIONSETUP_SEARCH]
(
	@SEARCH			AS NVARCHAR(MAX)	=	'',
	@PAGE_NUMBER	AS INT				=	1,
	@PAGE_SIZE		AS INT				=	10,
	@IS_ASCENDING	AS BIT				=	1
)
AS

WITH RAW_DATA AS(
	SELECT	[dbo].[QUERY].[QUERYID],
			[dbo].[QUERY].[NAME],
			[dbo].[QUERY].[DESCRIPTION],
			[dbo].[QUERY].[ISENABLED],
			[dbo].[SYSTEMMODULE].[MODULENAME],
			CASE @IS_ASCENDING WHEN 1 THEN
				ROW_NUMBER() OVER(ORDER BY [dbo].[QUERY].[NAME])
			ELSE
				ROW_NUMBER() OVER(ORDER BY [dbo].[QUERY].[NAME] DESC)
			END AS ROWNUMBER,
			COUNT(1) OVER() AS TOTALROWS
	FROM	[dbo].[QUERY]
	INNER JOIN [dbo].[SYSTEMMODULE] ON [dbo].[QUERY].[MODULEID] = [dbo].[SYSTEMMODULE].[SYSTEMMODULEID]
	WHERE ([dbo].[QUERY].[NAME] LIKE '%'+@SEARCH+'%') OR ([dbo].[QUERY].[DESCRIPTION] LIKE '%'+@SEARCH+'%') 
)

SELECT		* 
FROM		RAW_DATA
WHERE		ROWNUMBER > @PAGE_SIZE * (@PAGE_NUMBER - 1) 
			AND RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY	ROWNUMBER