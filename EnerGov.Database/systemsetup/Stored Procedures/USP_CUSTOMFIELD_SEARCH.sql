CREATE PROCEDURE [systemsetup].[USP_CUSTOMFIELD_SEARCH]
(
	@SEARCH AS NVARCHAR(MAX) = '',
	@PAGE_NUMBER AS INT = 1,
	@PAGE_SIZE AS INT = 10,
	@IS_ASCENDING AS BIT = 1,
	@CUSTOMMODULEID AS INT = 0,
	@FIELDTYPEID AS INT = 0
)
AS
WITH RAW_DATA AS (
	SELECT 
	[CUSTOMFIELDID],
	[FIELDNAME], 
	[FIELDTYPE], 
	[FIELDTYPEID], 
	[LAYOUTNAME], 
	[MODULENAME], 
	[MODULEID],
	[TABLENAME],
	[SCUSTOMFIELD],
	CASE @IS_ASCENDING WHEN 1 THEN
				ROW_NUMBER() OVER(ORDER BY [FIELDNAME], [SCUSTOMFIELD])
				ELSE
				ROW_NUMBER() OVER(ORDER BY [FIELDNAME], [SCUSTOMFIELD] DESC)
				END AS ROWNUMBER,
	COUNT(1) OVER() AS TOTALROWS
	FROM (
	--TABLE COLUMNS
		SELECT 
				[DBO].[CUSTOMFIELD].[GCUSTOMFIELD] AS [CUSTOMFIELDID],
				[DBO].[CUSTOMFIELD].[SFIELDNAME] AS [FIELDNAME],
				[DBO].[CUSTOMFIELDTYPE].[SNAME] AS [FIELDTYPE],
				[DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] AS [FIELDTYPEID],
				[DBO].[CUSTOMFIELDLAYOUT].[SNAME] AS [LAYOUTNAME],
				[DBO].[CUSTOMFIELDMODULES].[MODULENAME] AS [MODULENAME],
				[DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] AS [MODULEID],
				[DBO].[CUSTOMFIELDTABLE].[NAME] AS [TABLENAME],
				[DBO].[CUSTOMFIELD].[SCUSTOMFIELD] AS [SCUSTOMFIELD]
		
 FROM [DBO].[CUSTOMFIELDTABLECOLUMNREF]
 JOIN [DBO].[CUSTOMFIELDCOLUMNTEMPLATE] ON [DBO].[CUSTOMFIELDTABLECOLUMNREF].[CUSTOMFIELDCOLUMNTEMPLATEID] = [DBO].[CUSTOMFIELDCOLUMNTEMPLATE].[CUSTOMFIELDCOLUMNTEMPLATEID]
 JOIN [DBO].[CUSTOMFIELD] ON [DBO].[CUSTOMFIELDCOLUMNTEMPLATE].[GCUSTOMFIELD] = [DBO].[CUSTOMFIELD].[GCUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDTABLE] ON [DBO].[CUSTOMFIELDTABLECOLUMNREF].[CUSTOMFIELDTABLEID] = [DBO].[CUSTOMFIELDTABLE].[CUSTOMFIELDTABLEID]
 JOIN [DBO].[CUSTOMFIELD] AS [CUSTOMFIELD_TABLE] ON [DBO].[CUSTOMFIELDTABLE].[CUSTOMFIELDTABLEID] = [CUSTOMFIELD_TABLE].[FKCUSTOMFIELDTABLE]
 JOIN [DBO].[CUSTOMFIELDTYPE] ON [DBO].[CUSTOMFIELD].[FKICUSTOMFIELDTYPE] = [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE]
 JOIN [DBO].[CUSTOMFIELDOBJECT] ON  [CUSTOMFIELD_TABLE].[GCUSTOMFIELD] = [DBO].[CUSTOMFIELDOBJECT].[GCUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDLAYOUT] ON [DBO].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [DBO].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
 JOIN [DBO].[CUSTOMFIELDMODULES] ON [DBO].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
 WHERE ( [DBO].[CUSTOMFIELD].[SFIELDNAME] LIKE '%' + @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDLAYOUT].[SNAME] LIKE '%'+ @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDTABLE].[NAME] LIKE '%'+ @SEARCH +'%')
		AND
		([DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] = CASE WHEN
		@CUSTOMMODULEID = 0 THEN [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] ELSE @CUSTOMMODULEID END)
		AND
		([DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] = CASE WHEN
		@FIELDTYPEID = 0 THEN [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] ELSE @FIELDTYPEID END)
UNION ALL
 --TABLE FOOTER
SELECT 
				[DBO].[CUSTOMFIELD].[GCUSTOMFIELD] AS [CUSTOMFIELDID],
				[DBO].[CUSTOMFIELD].[SFIELDNAME] AS [FIELDNAME],
				[DBO].[CUSTOMFIELDTYPE].[SNAME] AS [FIELDTYPE],
				[DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] AS [FIELDTYPEID],
				[DBO].[CUSTOMFIELDLAYOUT].[SNAME] AS [LAYOUTNAME],
				[DBO].[CUSTOMFIELDMODULES].[MODULENAME] AS [MODULENAME],
				[DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] AS [MODULEID],
				[DBO].[CUSTOMFIELDTABLE].[NAME] AS [TABLENAME],
				[DBO].[CUSTOMFIELD].[SCUSTOMFIELD] AS [SCUSTOMFIELD]
				
FROM [DBO].[CUSTOMFIELDTABLECOLUMNREF]
 JOIN [DBO].[CUSTOMFIELD] ON [DBO].[CUSTOMFIELDTABLECOLUMNREF].[CUSTOMFIELDTABLECOLUMNREFID] = [DBO].[CUSTOMFIELD].[FKCUSTOMFIELDTABLECOLREF]
 JOIN [DBO].[CUSTOMFIELDTABLE] ON [DBO].[CUSTOMFIELDTABLECOLUMNREF].[CUSTOMFIELDTABLEID] = [DBO].[CUSTOMFIELDTABLE].[CUSTOMFIELDTABLEID]
 JOIN [DBO].[CUSTOMFIELD] AS [CUSTOMFIELD_REF] ON [DBO].[CUSTOMFIELDTABLE].[CUSTOMFIELDTABLEID] = [CUSTOMFIELD_REF].[FKCUSTOMFIELDTABLE]
 JOIN [DBO].[CUSTOMFIELDTYPE] ON [DBO].[CUSTOMFIELD].[FKICUSTOMFIELDTYPE] = [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE]
 JOIN [DBO].[CUSTOMFIELDOBJECT] ON  [CUSTOMFIELD_REF].[GCUSTOMFIELD] = [DBO].[CUSTOMFIELDOBJECT].[GCUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDLAYOUT] ON [DBO].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [DBO].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
 JOIN [DBO].[CUSTOMFIELDMODULES] ON [DBO].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
WHERE ( [DBO].[CUSTOMFIELD].[SFIELDNAME] LIKE '%' + @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDLAYOUT].[SNAME] LIKE '%'+ @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDTABLE].[NAME] LIKE '%'+ @SEARCH +'%')
		AND
		([DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] = CASE WHEN
		@CUSTOMMODULEID = 0 THEN [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] ELSE @CUSTOMMODULEID END)
		AND
		([DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] = CASE WHEN
		@FIELDTYPEID = 0 THEN [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] ELSE @FIELDTYPEID END)
UNION ALL
-- TABLE CUSTOM FIELDS
SELECT 
				[DBO].[CUSTOMFIELD].[GCUSTOMFIELD] AS [CUSTOMFIELDID],
				[DBO].[CUSTOMFIELD].[SFIELDNAME] AS [FIELDNAME],
				[DBO].[CUSTOMFIELDTYPE].[SNAME] AS [FIELDTYPE],
				[DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] AS [FIELDTYPEID],
				[DBO].[CUSTOMFIELDLAYOUT].[SNAME] AS [LAYOUTNAME],
				[DBO].[CUSTOMFIELDMODULES].[MODULENAME] AS [MODULENAME],
				[DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] AS [MODULEID],
				[DBO].[CUSTOMFIELDTABLE].[NAME] AS [TABLENAME],
				[DBO].[CUSTOMFIELD].[SCUSTOMFIELD] AS [SCUSTOMFIELD]
				
FROM [DBO].[CUSTOMFIELDTABLE]
 JOIN [DBO].[CUSTOMFIELD] ON [DBO].[CUSTOMFIELDTABLE].[CUSTOMFIELDTABLEID] = [DBO].[CUSTOMFIELD].[FKCUSTOMFIELDTABLE]
 JOIN [DBO].[CUSTOMFIELDTYPE] ON [DBO].[CUSTOMFIELD].[FKICUSTOMFIELDTYPE] = [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE]
 JOIN [DBO].[CUSTOMFIELDOBJECT] ON  [DBO].[CUSTOMFIELD] .[GCUSTOMFIELD] = [DBO].[CUSTOMFIELDOBJECT].[GCUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDLAYOUT] ON [DBO].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [DBO].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
 JOIN [DBO].[CUSTOMFIELDMODULES] ON [DBO].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
WHERE ( [DBO].[CUSTOMFIELD].[SFIELDNAME] LIKE '%' + @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDLAYOUT].[SNAME] LIKE '%'+ @SEARCH +'%' OR 
		[DBO].[CUSTOMFIELDTABLE].[NAME] LIKE '%'+ @SEARCH +'%')
		AND
		([DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] = CASE WHEN
		@CUSTOMMODULEID = 0 THEN [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] ELSE @CUSTOMMODULEID END)
		AND
		([DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] = CASE WHEN
		@FIELDTYPEID = 0 THEN [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] ELSE @FIELDTYPEID END)
UNION ALL
-- REGULAR CUSTOM FIELDS
SELECT 
				[DBO].[CUSTOMFIELD].[GCUSTOMFIELD] AS [CUSTOMFIELDID],
				[DBO].[CUSTOMFIELD].[SFIELDNAME] AS [FIELDNAME],
				[DBO].[CUSTOMFIELDTYPE].[SNAME] AS [FIELDTYPE],
				[DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] AS [FIELDTYPEID],
				[DBO].[CUSTOMFIELDLAYOUT].[SNAME] AS [LAYOUTNAME],
				[DBO].[CUSTOMFIELDMODULES].[MODULENAME] AS [MODULENAME],
				[DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] AS [MODULEID],
				NULL AS [TABLENAME],
				[DBO].[CUSTOMFIELD].[SCUSTOMFIELD] AS [SCUSTOMFIELD]

FROM [DBO].[CUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDTYPE] ON [DBO].[CUSTOMFIELD].[FKICUSTOMFIELDTYPE] = [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE]
 JOIN [DBO].[CUSTOMFIELDOBJECT] ON  [DBO].[CUSTOMFIELD] .[GCUSTOMFIELD] = [DBO].[CUSTOMFIELDOBJECT].[GCUSTOMFIELD]
 JOIN [DBO].[CUSTOMFIELDLAYOUTCONTROLTYPE] ON [DBO].[CUSTOMFIELDOBJECT].[FKCUSTOMFIELDLAYOUTCONTROLTYPE] = [DBO].[CUSTOMFIELDLAYOUTCONTROLTYPE].[ICUSTOMFIELDLAYOUTCONTROLTYPE]
 JOIN [DBO].[CUSTOMFIELDLAYOUT] ON [DBO].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [DBO].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
 JOIN [DBO].[CUSTOMFIELDMODULES] ON [DBO].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
WHERE 
		([DBO].[CUSTOMFIELD].[SFIELDNAME] LIKE '%' + @SEARCH +'%' OR [DBO].[CUSTOMFIELDLAYOUT].[SNAME] LIKE '%'+ @SEARCH +'%')
		AND
		([DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] = CASE WHEN
		@CUSTOMMODULEID = 0 THEN [DBO].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID] ELSE @CUSTOMMODULEID END)
		AND
		([DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] = CASE WHEN
		@FIELDTYPEID = 0 THEN [DBO].[CUSTOMFIELDTYPE].[ICUSTOMFIELDTYPE] ELSE @FIELDTYPEID END)
		AND
		([DBO].[CUSTOMFIELDOBJECT].[BFOOTER] = 0 OR [DBO].[CUSTOMFIELDOBJECT].[BFOOTER] IS NULL)
		AND ([DBO].[CUSTOMFIELDLAYOUTCONTROLTYPE].[BHASDATA] = 1)
		AND ([DBO].[CUSTOMFIELDLAYOUTCONTROLTYPE].[ICUSTOMFIELDLAYOUTCONTROLTYPE] NOT IN (8,9,10))
	 ) AS ALLCFS
	 )

SELECT * 
FROM RAW_DATA
WHERE
	RowNumber > @PAGE_SIZE * (@PAGE_NUMBER - 1) AND 
	RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY 
	RowNumber