CREATE PROCEDURE [professionallicense].[USP_PROFESSIONALLICENSERENEW_GETCOREDETAILSBYIDS]
(
	@IDS RecordIDs READONLY
	
)
AS
BEGIN

	WITH IS_BILLING_CONTACT
	AS
	(SELECT DISTINCT ILLICENSEID, ISBILLING  FROM ILLICENSECONTACT
	JOIN @IDS ON  RECORDID = ILLICENSEID
	WHERE  ISBILLING =1),

	IS_ALREADY_RENEWED
	AS
	(SELECT ILLICENSE.ILLICENSEID,
	(CASE WHEN CHILD.ILLICENSEPARENTID IS NOT NULL THEN CAST( 1 AS BIT) ELSE CAST(0 AS BIT) END) AS ISALREADYRENEWED
	FROM ILLICENSE 
	LEFT JOIN ILLICENSE CHILD ON CHILD.ILLICENSEPARENTID = ILLICENSE.ILLICENSEID 
	JOIN @IDS ON RECORDID = ILLICENSE.ILLICENSEID
	
	),
	RENEW_DETAILS
	AS
	 (SELECT ILLICENSE.ILLICENSEID ,ILLICENSE.ROWVERSION ,ILLICENSETYPE.ILLICENSETYPEID, ILLICENSETYPE.ISRECEIPTSTYPE ,ILLICENSETYPE.ISRENEWABLE ,ILLICENSETYPELICENSECLASS .RENEWALDAYSPRIORTOEXPIRE,ILLICENSE.EXPIRATIONDATE 
	 FROM ILLICENSE 
	 JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID 
	 JOIN ILLICENSETYPELICENSECLASS ON ILLICENSETYPE.ILLICENSETYPEID = ILLICENSETYPELICENSECLASS .ILLICENSETYPEID AND ILLICENSE.ILLICENSECLASSIFICATIONID =ILLICENSETYPELICENSECLASS.ILLICENSECLASSIFICATIONID
	 JOIN @IDS ON ILLICENSE.ILLICENSEID = RECORDID
	 WHERE ILLICENSEID = RECORDID
	 )
	 SELECT RENEW_DETAILS.ILLICENSEID ,RENEW_DETAILS.ROWVERSION ,ILLICENSETYPEID, RENEW_DETAILS.ISRECEIPTSTYPE ,RENEW_DETAILS.ISRENEWABLE ,RENEW_DETAILS .RENEWALDAYSPRIORTOEXPIRE,RENEW_DETAILS.EXPIRATIONDATE,ISBILLING ,ISALREADYRENEWED FROM RENEW_DETAILS 
	 LEFT JOIN IS_ALREADY_RENEWED ON RENEW_DETAILS.ILLICENSEID = IS_ALREADY_RENEWED.ILLICENSEID
	 LEFT JOIN IS_BILLING_CONTACT ON IS_BILLING_CONTACT.ILLICENSEID= RENEW_DETAILS.ILLICENSEID
	 
END