CREATE PROCEDURE [professionallicense].[USP_PROFESSIONALLICENSE_GETBYIDS]
(
 @PROFESSIONALLICENSELIST RecordIDs READONLY,
 @USERID AS CHAR(36) = NULL
)
AS
BEGIN

DECLARE @BALANCEDUE AS MONEY
SET @BALANCEDUE = null

IF ((SELECT COUNT(*) FROM @PROFESSIONALLICENSELIST) = 1)
BEGIN
    DECLARE @ENTITYID char(36)
	SELECT @ENTITYID = [RECORDID] FROM @PROFESSIONALLICENSELIST
	SET @BALANCEDUE = [professionallicense].[UFN_GET_PROFFESSIONAL_LICENSE_BALANCE_DUE](@ENTITYID);
END

SELECT PL.ILLICENSEID,PL.LICENSENUMBER,PLT.NAME, PLCL.NAME, PLS.NAME, D.NAME,PL.LASTCHANGEDON,PL.APPLIEDDATE,PL.EXPIRATIONDATE,PL.LASTRENEWALDATE,
U.FNAME,U.LNAME, LG.NAME,PL.LICENSEYEAR ,PL.DESCRIPTION,G.GLOBALENTITYID,G.GLOBALENTITYNAME,G.FIRSTNAME,G.LASTNAME, 
PL.ROWVERSION, @BALANCEDUE,P.PARCELNUMBER,PL.ISSUEDATE,G.ISCOMPANY
FROM ILLICENSE PL JOIN ILLICENSETYPE PLT ON PL.ILLICENSETYPEID = PLT.ILLICENSETYPEID
JOIN ILLICENSECLASSIFICATION PLCL ON PL.ILLICENSECLASSIFICATIONID = PLCL.ILLICENSECLASSIFICATIONID
JOIN DISTRICT D ON PL.DISTRICTID = D.DISTRICTID
LEFT JOIN USERS U ON PL.ISSUEDBY = U.SUSERGUID
LEFT JOIN ILLICENSEGROUP LG ON PL.ILLICENSEGROUPID = LG.ILLICENSEGROUPID
JOIN ILLICENSESTATUS PLS ON PL.ILLICENSESTATUSID = PLS.ILLICENSESTATUSID
JOIN GLOBALENTITY G ON PL.GLOBALENTITYID = G.GLOBALENTITYID
LEFT JOIN ILLICENSEPARCEL LP ON LP.ILLICENSEID = PL.ILLICENSEID AND LP.MAIN = 1
LEFT JOIN PARCEL P ON P.PARCELID = LP.PARCELID
JOIN @PROFESSIONALLICENSELIST PLL ON PL.ILLICENSEID = PLL.RECORDID
LEFT JOIN RECENTHISTORYPROFESSIONALLICENSE RHPL ON RHPL.ILLICENSEID = PL.ILLICENSEID AND RHPL.USERID = @USERID
ORDER BY RHPL.LOGGEDDATETIME DESC
END