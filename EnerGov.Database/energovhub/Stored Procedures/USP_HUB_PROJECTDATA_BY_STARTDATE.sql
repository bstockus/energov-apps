CREATE  PROCEDURE [energovhub].[USP_HUB_PROJECTDATA_BY_STARTDATE] 
@PROJECTSTARTDATE datetime
AS
BEGIN
  -- SET NOCOUNT ON added to prevent extra result sets from
  -- interfering with SELECT statements.
  SET NOCOUNT ON;

  SELECT
    [PRPROJECT].[PRPROJECTID] AS PROJECTID,
    [PRPROJECT].[PROJECTNUMBER],
    [PRPROJECT].[DESCRIPTION] AS PROJECTDESCRIPTION,
    [PRPROJECT].[STARTDATE] AS PROJECTSTARTDATE,
    [PRPROJECT].[COMPLETEDATE] PROJECTCOMPLETEDATE,
    (SELECT TOP 1
      CASE [GLOBALENTITY].[ISCOMPANY]
        WHEN 0 THEN [GLOBALENTITY].[FIRSTNAME] + ' ' + [GLOBALENTITY].[LASTNAME]
        ELSE [GLOBALENTITY].[GLOBALENTITYNAME]
      END
    FROM [dbo].[PRPROJECTCONTACT]
    INNER JOIN [dbo].[GLOBALENTITY]
      ON [PRPROJECTCONTACT].[GLOBALENTITYID] = [GLOBALENTITY].[GLOBALENTITYID]
    WHERE [PRPROJECTCONTACT].[PRPROJECTID] = [PRPROJECT].[PRPROJECTID]
    ORDER BY [PRPROJECTCONTACT].[ISBILLING] DESC)
    PROJECTMAINCONTACT,
    ISNULL((SELECT
      SUM(ISNULL(DUE,0))
    FROM (SELECT
      PRPROJECTID,
      SUM(ABS(ISNULL(COMPUTEDAMOUNT,0) - ISNULL(AMOUNTPAIDTODATE,0))) AS 'DUE'
    FROM [dbo].[PRPROJECTFEE]
    JOIN [dbo].[CACOMPUTEDFEE]
      ON [PRPROJECTFEE].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID]
    WHERE CASTATUSID NOT IN (4, 9, 10)
    AND PRPROJECTID = [PRPROJECT].[PRPROJECTID]
    GROUP BY PRPROJECTID

    UNION ALL
    SELECT
      PMPERMITID,
       SUM(ABS(ISNULL(COMPUTEDAMOUNT,0) - ISNULL(AMOUNTPAIDTODATE,0))) AS 'DUE'
    FROM [dbo].[PMPERMITFEE]
    JOIN [dbo].[CACOMPUTEDFEE]
      ON [PMPERMITFEE].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID]
    WHERE CASTATUSID NOT IN (4, 9, 10)
    AND [PMPERMITFEE].[PMPERMITID] IN (SELECT
      PMPERMITID
    FROM PRPROJECTPERMIT
    WHERE PRPROJECTID = [PRPROJECT].[PRPROJECTID])
    GROUP BY PMPERMITID

    UNION ALL
    SELECT
      CMCODECASEID,
       SUM(ABS(ISNULL(COMPUTEDAMOUNT,0) - ISNULL(AMOUNTPAIDTODATE,0))) AS 'DUE'
    FROM [dbo].[CMCODECASEFEE]
    JOIN CACOMPUTEDFEE
      ON [CMCODECASEFEE].[CACOMPUTEDFEEID] = CACOMPUTEDFEE.CACOMPUTEDFEEID
    WHERE CASTATUSID NOT IN (4, 9, 10)
    AND [CMCODECASEFEE].[CMCODECASEID] IN (SELECT
      CMCODECASEID
    FROM [dbo].[PRPROJECTCODECASE]
    WHERE PRPROJECTID = [PRPROJECT].[PRPROJECTID])
    GROUP BY CMCODECASEID

    UNION ALL
    SELECT
      PLPLANID,
       SUM(ABS(ISNULL(COMPUTEDAMOUNT,0) - ISNULL(AMOUNTPAIDTODATE,0))) AS 'DUE'
    FROM [dbo].[PLPLANFEE]
    JOIN CACOMPUTEDFEE
      ON [PLPLANFEE].[CACOMPUTEDFEEID] = CACOMPUTEDFEE.CACOMPUTEDFEEID
    WHERE CASTATUSID NOT IN (4, 9, 10)
    AND [PLPLANFEE].[PLPLANID] IN (SELECT
      PLPLANID
    FROM [dbo].[PRPROJECTPLAN]
    WHERE PRPROJECTID = [PRPROJECT].[PRPROJECTID])
    GROUP BY PLPLANID

    UNION ALL
    SELECT
      PLAPPLICATIONID,
       SUM(ABS(ISNULL(COMPUTEDAMOUNT,0) - ISNULL(AMOUNTPAIDTODATE,0))) AS 'DUE'
    FROM [dbo].[PLAPPLICATIONFEE]
    JOIN CACOMPUTEDFEE
      ON [PLAPPLICATIONFEE].[CACOMPUTEDFEEID] = CACOMPUTEDFEE.CACOMPUTEDFEEID
    WHERE CASTATUSID NOT IN (4, 9, 10)
    AND [PLAPPLICATIONFEE].[PLAPPLICATIONID] IN (SELECT
      PLAPPLICATIONID
    FROM [dbo].[PRPROJECTAPPLICATION]
    WHERE PRPROJECTID = [PRPROJECT].[PRPROJECTID])
    GROUP BY PLAPPLICATIONID) TOTALS),0)
    TOTALDUE
  FROM [dbo].[PRPROJECT]
  WHERE [PRPROJECT].[STARTDATE] >= @PROJECTSTARTDATE

  EXEC [energovhub].[USP_HUB_PROJECTDATAADDRESS]

END