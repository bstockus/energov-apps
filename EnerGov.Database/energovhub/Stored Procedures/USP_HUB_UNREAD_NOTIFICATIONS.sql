CREATE PROCEDURE [energovhub].[USP_HUB_UNREAD_NOTIFICATIONS]
	@USERID CHAR(36)
AS
BEGIN
	SELECT 
		[dbo].[NOTIFICATIONS].[SUBJECT],
		[dbo].[NOTIFICATIONS].BODY,
		(ISNULL([dbo].[USERS].FNAME, '') + ' ' + ISNULL([dbo].[USERS].LNAME, '')) AS USERNAME,
		[dbo].[NOTIFICATIONS].FORMID,
		[dbo].[NOTIFICATIONS].NOTIFICATIONSID,
		CASENUMBERS.CASEID,
		CASENUMBERS.CASENUMBER,
		[dbo].[USERNOTIFICATION].DATECREATED
	FROM [dbo].[NOTIFICATIONS]
	JOIN [dbo].[USERNOTIFICATION] ON [dbo].[NOTIFICATIONS].NOTIFICATIONSID = [dbo].[USERNOTIFICATION].NOTIFICATIONSID
	JOIN [dbo].[USERS] ON [dbo].[USERNOTIFICATION].USERID = [dbo].[USERS].SUSERGUID
	OUTER APPLY (
			SELECT TOP 1 
				CASEID, CASENUMBER
			FROM [dbo].[GETCASENUMBERBYRECORD]([dbo].[NOTIFICATIONS].UNIQUERECORDID)
			) AS CASENUMBERS
	WHERE [dbo].[USERNOTIFICATION].USERID = @USERID AND [dbo].[USERNOTIFICATION].DATEREAD IS NULL
	ORDER BY [dbo].[USERNOTIFICATION].DATECREATED ASC
END