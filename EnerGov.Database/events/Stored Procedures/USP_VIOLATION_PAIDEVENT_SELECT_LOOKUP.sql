CREATE PROCEDURE [events].[USP_VIOLATION_PAIDEVENT_SELECT_LOOKUP]
	@VIOLATIONID CHAR(36)
AS
BEGIN
	-- select all the invoice and amountpaid for the given recordid.
	SELECT 
		[CAINVOICE].CAINVOICEID INVOICEID,
		[CAINVOICE].INVOICENUMBER,
		COALESCE(SUM([CACOMPUTEDFEE].AMOUNTPAIDTODATE), 0.00) TOTALPAID 
	FROM [CMVIOLATIONFEE] 
	INNER JOIN [CACOMPUTEDFEE] ON [CMVIOLATIONFEE].CACOMPUTEDFEEID = [CACOMPUTEDFEE].CACOMPUTEDFEEID
	INNER JOIN [CAINVOICEFEE]  ON [CAINVOICEFEE].CACOMPUTEDFEEID = [CACOMPUTEDFEE].CACOMPUTEDFEEID
	INNER JOIN [CAINVOICE] ON [CAINVOICE].CAINVOICEID = [CAINVOICEFEE].CAINVOICEID
	WHERE [CMVIOLATIONFEE].CMVIOLATIONID = @VIOLATIONID
	--since we need the totalpaid for the invoice we use group by
	GROUP BY [CAINVOICE].CAINVOICEID, [CAINVOICE].INVOICENUMBER	
	ORDER BY [CAINVOICE].INVOICENUMBER
END