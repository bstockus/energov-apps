CREATE PROCEDURE [events].[USP_PERMITEVENTQUEUE_DELETED_EVENT_SELECT_LOOKUP]
(
	@BATCHSIZE AS INT = 1000
)
AS
BEGIN

	SELECT TOP(@BATCHSIZE)
        [PERMITEVENTQUEUE].[PERMITEVENTQUEUEID],
		[PERMITEVENTQUEUE].[CREATEDDATE],
		[PERMITEVENTQUEUE].[PMPERMITID],
		[PERMITEVENTQUEUE].[PERMITNUMBER],
		CASE WHEN COALESCE([USERS].[FNAME], '') = ''
			 THEN CASE WHEN COALESCE([USERS].[LNAME], '') = '' 
					   THEN ''
					   ELSE [USERS].[LNAME] END
			 ELSE CASE WHEN COALESCE([USERS].[LNAME], '') = ''
						THEN [USERS].[FNAME]
						ELSE [USERS].[LNAME] + ', ' + [USERS].[FNAME] END
		END AS LASTCHANGEDBYNAME
		FROM [dbo].[PERMITEVENTQUEUE]
		LEFT JOIN [dbo].[USERS] ON [dbo].[PERMITEVENTQUEUE].[PERMITLASTCHANGEDBY] = [dbo].[USERS].[SUSERGUID]
		WHERE [dbo].[PERMITEVENTQUEUE].[PROCESSEDDATE] IS NULL
		AND [PERMITEVENTQUEUE].PERMITEVENTTYPEID = 5
END