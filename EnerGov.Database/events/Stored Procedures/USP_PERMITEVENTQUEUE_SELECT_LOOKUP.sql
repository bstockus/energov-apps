CREATE PROCEDURE [events].[USP_PERMITEVENTQUEUE_SELECT_LOOKUP]
(
	@BATCHSIZE AS INT = 1000
)
AS  
BEGIN

DECLARE @RESULT_DATA AS TABLE 
(
	[PERMITEVENTQUEUEID] BIGINT, 
	[PERMITEVENTTYPEID] INT,
	[CREATEDDATE] DATETIME,
	[PMPERMITID] CHAR(36),
	[DESCRIPTION] NVARCHAR(MAX),
	[PERMITNUMBER] NVARCHAR(50),
	[PERMITTYPENAME] NVARCHAR(50),
	[PERMITWORKCLASSNAME] NVARCHAR(50),
	[PERMITSTATUSNAME] NVARCHAR(50),
	[HOLDFLAG] BIT,
	[COMPLETEDFLAG] BIT,
	[ISSUEDFLAG] BIT,
	[FAILUREFLAG] BIT,
	[CANCELLEDFLAG] BIT,
	[APPLYDATE] DATETIME,
	[SQUAREFEET] DECIMAL,
	[VALUATION] MONEY,
	[LASTCHANGEDON] DATETIME,
	[ISSUEDATE] DATETIME,
	[EXPIREDATE] DATETIME,
	[LASTINSPECTIONDATE] DATETIME,
	[FINALIZEDATE] DATETIME,
	[ADDRESSLINE1] NVARCHAR(200),
	[ADDRESSLINE2] NVARCHAR(200),
	[ADDRESSLINE3] NVARCHAR(200),
	[STREETTYPE] NVARCHAR(50),
	[PREDIRECTION] NVARCHAR(30),
	[POSTDIRECTION] NVARCHAR(30),
	[UNITORSUITE] NVARCHAR(20),
	[CITY] NVARCHAR(50),
	[COUNTRYTYPE] INT,
	[PROVINCE] NVARCHAR(50),
	[STATE] NVARCHAR(50),
	[POSTALCODE] NVARCHAR(50),
	[COUNTRY] NVARCHAR(50),
	[PARCELNUMBER] NVARCHAR(50),
	[TAXNUMBER] NVARCHAR(50),
	[FIRSTNAME] NVARCHAR(30),
	[LASTNAME] NVARCHAR(30)
);

WITH RAW_DATA AS (
	SELECT TOP(@BATCHSIZE)
        [PERMITEVENTQUEUE].PERMITEVENTQUEUEID,
		[PERMITEVENTQUEUE].PERMITEVENTTYPEID,
		[PERMITEVENTQUEUE].CREATEDDATE,
		[PMPERMIT].PMPERMITID,
		[PMPERMIT].DESCRIPTION,
		[PMPERMIT].PERMITNUMBER,
		[PMPERMITTYPE].NAME PERMITTYPENAME,
		[PMPERMITWORKCLASS].NAME PERMITWORKCLASSNAME,
		[PMPERMITSTATUS].NAME PERMITSTATUSNAME,
		[PMPERMITSTATUS].HOLDFLAG,
		[PMPERMITSTATUS].COMPLETEDFLAG,
		[PMPERMITSTATUS].ISSUEDFLAG,
		[PMPERMITSTATUS].FAILUREFLAG,
		[PMPERMITSTATUS].CANCELLEDFLAG,
		[PMPERMIT].APPLYDATE,
		[PMPERMIT].SQUAREFEET,
		[PMPERMIT].VALUE VALUATION,
		[PMPERMIT].LASTCHANGEDON,
		[PMPERMIT].ISSUEDATE,
		[PMPERMIT].EXPIREDATE,
		[PMPERMIT].LASTINSPECTIONDATE,
		[PMPERMIT].FINALIZEDATE,
		[MAILINGADDRESS].ADDRESSLINE1,
		[MAILINGADDRESS].ADDRESSLINE2,
		[MAILINGADDRESS].ADDRESSLINE3,
		[MAILINGADDRESS].STREETTYPE,
		[MAILINGADDRESS].PREDIRECTION,
		[MAILINGADDRESS].POSTDIRECTION,
		[MAILINGADDRESS].UNITORSUITE,
		[MAILINGADDRESS].CITY,
		[MAILINGADDRESS].COUNTRYTYPE,
		[MAILINGADDRESS].PROVINCE,
		[MAILINGADDRESS].STATE,
		[MAILINGADDRESS].POSTALCODE,
		[MAILINGADDRESS].COUNTRY,
		[PARCEL].PARCELNUMBER,
		[PARCEL].TAXNUMBER,
		[USERS].FNAME FIRSTNAME,
		[USERS].LNAME LASTNAME

		FROM [dbo].[PERMITEVENTQUEUE]
		INNER JOIN [dbo].[PMPERMIT] ON [dbo].[PERMITEVENTQUEUE].PMPERMITID = [dbo].[PMPERMIT].PMPERMITID
		INNER JOIN [dbo].[PMPERMITTYPE] ON [dbo].[PMPERMIT].PMPERMITTYPEID = [dbo].[PMPERMITTYPE].PMPERMITTYPEID
		INNER JOIN [dbo].[PMPERMITSTATUS] ON [dbo].[PMPERMIT].PMPERMITSTATUSID = [dbo].[PMPERMITSTATUS].PMPERMITSTATUSID
		LEFT JOIN [dbo].[PMPERMITWORKCLASS] ON [dbo].[PMPERMIT].PMPERMITWORKCLASSID = [dbo].[PMPERMITWORKCLASS].PMPERMITWORKCLASSID
		LEFT JOIN [dbo].[PMPERMITADDRESS] ON [dbo].[PMPERMIT].PMPERMITID = [dbo].[PMPERMITADDRESS].PMPERMITID AND [dbo].[PMPERMITADDRESS].MAIN = 'True'
		LEFT JOIN [dbo].[MAILINGADDRESS] ON [dbo].[PMPERMITADDRESS].MAILINGADDRESSID = [dbo].[MAILINGADDRESS].MAILINGADDRESSID
		LEFT JOIN [dbo].[PMPERMITPARCEL] ON [dbo].[PMPERMIT].PMPERMITID = [dbo].[PMPERMITPARCEL].PMPERMITID AND [dbo].[PMPERMITPARCEL].MAIN = 'True'
		LEFT JOIN [dbo].[PARCEL] ON [dbo].[PMPERMITPARCEL].PARCELID = [dbo].[PARCEL].PARCELID
		LEFT JOIN [dbo].[USERS] ON [dbo].[PERMITEVENTQUEUE].PERMITLASTCHANGEDBY = [dbo].[USERS].SUSERGUID
	WHERE [dbo].[PERMITEVENTQUEUE].PROCESSEDDATE IS NULL
	ORDER BY [dbo].[PERMITEVENTQUEUE].CREATEDDATE
)

INSERT INTO @RESULT_DATA
SELECT * FROM RAW_DATA

SELECT * FROM @RESULT_DATA

DECLARE @PMPERMITIDs RecordIDs
INSERT INTO @PMPERMITIDs(RECORDID)
SELECT DISTINCT [PMPERMITID] 
FROM @RESULT_DATA

EXEC [events].[USP_EVENTQUEUE_GET_PERMITCONTACT] @UNIQUEIDS = @PMPERMITIDs
END