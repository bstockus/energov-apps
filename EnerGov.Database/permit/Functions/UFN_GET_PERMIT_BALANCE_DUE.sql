CREATE FUNCTION [permit].[UFN_GET_PERMIT_BALANCE_DUE]
(
	@ENTITYID char(36)
)
RETURNS MONEY
AS
BEGIN
	DECLARE @BALANCEDUE AS MONEY
	SELECT @BALANCEDUE = ISNULL(SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT - CACOMPUTEDFEE.AMOUNTPAIDTODATE),0)
	FROM PMPERMIT 
	INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
	INNER JOIN CACOMPUTEDFEE ON PMPERMITFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID AND CACOMPUTEDFEE.CASTATUSID NOT IN (10,5) -- DELETED & VOID
	WHERE PMPERMIT.PMPERMITID = @ENTITYID
	RETURN @BALANCEDUE;
END