CREATE PROCEDURE [permit].[USP_PMPERMIT_GETBYIDS]
(
	@PMPERMITLIST RecordIDs READONLY,
	@USERID AS CHAR(36) = NULL
)
AS
BEGIN

SELECT 
	USERS.FNAME,
	USERS.LNAME, 
	PMPERMIT.ISSUEDATE,
	PMPERMIT.PERMITNUMBER,
	PMPERMITSTATUS.NAME AS STATUSNAME,
	PMPERMITTYPE.NAME AS TYPENAME,
	PMPERMITWORKCLASS.NAME AS WORKCLASSNAME,
	PMPERMIT.APPLYDATE,
	DISTRICT.NAME AS DISTRICTNAME,
	PMPERMIT.EXPIREDATE,
	PMPERMIT.SQUAREFEET,
	PMPERMIT.VALUE,
	PMPERMIT.FINALIZEDATE,
	PMPERMIT.LASTINSPECTIONDATE,
	PMPERMIT.ROWVERSION, 
	PMPERMIT.DESCRIPTION,
	[permit].[UFN_GET_PERMIT_BALANCE_DUE](PMPERMIT.PMPERMITID) AS BALANCEDUE,
	(SELECT TOP 1 PRPROJECT.NAME 
		FROM PRPROJECTPERMIT
		INNER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTPERMIT.PRPROJECTID
		WHERE PRPROJECTPERMIT.PMPERMITID = PMPERMIT.PMPERMITID) AS PROJECTNAME,
	(SELECT TOP 1 PARCEL.PARCELNUMBER		
		FROM PMPERMITPARCEL
		INNER JOIN PARCEL ON PARCEL.PARCELID = PMPERMITPARCEL.PARCELID
		WHERE PMPERMITPARCEL.PMPERMITID = PMPERMIT.PMPERMITID
		ORDER BY PMPERMITPARCEL.MAIN DESC) AS PARCELNUMBER,
	PMPERMIT.PMPERMITID,
	PMPERMITTYPE.PMPERMITTYPEID,
	PMPERMITWORKCLASS.PMPERMITWORKCLASSID
FROM PMPERMIT 
INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
INNER JOIN PMPERMITWORKCLASS ON PMPERMIT.PMPERMITWORKCLASSID = PMPERMITWORKCLASS.PMPERMITWORKCLASSID
INNER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID
LEFT OUTER JOIN USERS ON PMPERMIT.ASSIGNEDTO = USERS.SUSERGUID
INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID = PMPERMITSTATUS.PMPERMITSTATUSID
INNER JOIN @PMPERMITLIST PMPERMITLIST ON PMPERMIT.PMPERMITID = PMPERMITLIST.RECORDID
LEFT OUTER JOIN RECENTHISTORYPERMIT ON RECENTHISTORYPERMIT.PERMITID = PMPERMIT.PMPERMITID AND RECENTHISTORYPERMIT.USERID = @USERID
ORDER BY RECENTHISTORYPERMIT.LOGGEDDATETIME DESC

EXEC [common].[USP_PMPERMITADDRESS_GETBYIDS] @PMPERMITLIST
EXEC [permit].[USP_PMPERMITCONTACT_GETBYIDS] @PMPERMITLIST

END