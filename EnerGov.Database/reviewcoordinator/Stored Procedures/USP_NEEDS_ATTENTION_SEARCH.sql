CREATE PROCEDURE [reviewcoordinator].[USP_NEEDS_ATTENTION_SEARCH]
@USERIDS RecordIds READONLY,
@ALLOWHOLDOVERRIDE BIT
AS
   
SET NOCOUNT ON;
BEGIN

WITH tblTasks AS (
SELECT		SYSTEMTASKID, 
			PLSUBMITTALID
FROM	(
select		SYSTEMTASK.SYSTEMTASKID,
			PLSUBMITTAL.PLSUBMITTALID,
			ROW_NUMBER() OVER(PARTITION BY	SYSTEMTASK.SYSTEMTASKID, PLSUBMITTAL.PLSUBMITTALID ORDER BY PLSUBMITTAL.DUEDATE) AS NEXTSUBMITTAL
FROM		SYSTEMTASK
JOIN		SYSTEMTASKTYPE ON SYSTEMTASK.SYSTEMTASKTYPEID = SYSTEMTASKTYPE.SYSTEMTASKTYPEID
JOIN		PMPERMIT ON SYSTEMTASK.UNIQUERECORDID = PMPERMIT.PMPERMITID
JOIN		PLSUBMITTAL ON PLSUBMITTAL.PMPERMITID = PMPERMIT.PMPERMITID
JOIN		SYSTEMTASKSUBMITTAL ON SYSTEMTASKSUBMITTAL.SYSTEMTASKID = SYSTEMTASK.SYSTEMTASKID AND SYSTEMTASKSUBMITTAL.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
JOIN		PLSUBMITTALSTATUS ON PLSUBMITTALSTATUS.PLSUBMITTALSTATUSID = PLSUBMITTAL.PLSUBMITTALSTATUSID				 
WHERE		ATTENTIONRESOLVED = 0
AND			(SYSTEMTASK.ASSIGNEDTO IS NULL OR SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @USERIDS))
AND			PLSUBMITTALSTATUS.FAILUREFLAG = 0 
AND			PLSUBMITTALSTATUS.SUCCESSFLAG = 0

UNION ALL

select		SYSTEMTASK.SYSTEMTASKID,
			PLSUBMITTAL.PLSUBMITTALID,
			ROW_NUMBER() OVER(PARTITION BY	SYSTEMTASK.SYSTEMTASKID, PLSUBMITTAL.PLSUBMITTALID ORDER BY PLSUBMITTAL.DUEDATE) AS NEXTSUBMITTAL
FROM		SYSTEMTASK
JOIN		SYSTEMTASKTYPE ON SYSTEMTASK.SYSTEMTASKTYPEID = SYSTEMTASKTYPE.SYSTEMTASKTYPEID
JOIN		PLPLAN ON SYSTEMTASK.UNIQUERECORDID = PLPLAN.PLPLANID
JOIN		PLSUBMITTAL ON PLSUBMITTAL.PLPLANID = PLPLAN.PLPLANID
JOIN		SYSTEMTASKSUBMITTAL ON SYSTEMTASKSUBMITTAL.SYSTEMTASKID = SYSTEMTASK.SYSTEMTASKID AND SYSTEMTASKSUBMITTAL.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
JOIN		PLSUBMITTALSTATUS ON PLSUBMITTALSTATUS.PLSUBMITTALSTATUSID = PLSUBMITTAL.PLSUBMITTALSTATUSID				 
WHERE		ATTENTIONRESOLVED = 0
AND			(SYSTEMTASK.ASSIGNEDTO IS NULL OR SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @USERIDS))
AND			PLSUBMITTALSTATUS.FAILUREFLAG = 0 
AND			PLSUBMITTALSTATUS.SUCCESSFLAG = 0

UNION ALL

SELECT		SYSTEMTASKID, 
			PLSUBMITTALID,
			1 AS NEXTSUBMITTAL
FROM		SYSTEMTASK
JOIN		SYSTEMTASKTYPE ON SYSTEMTASK.SYSTEMTASKTYPEID = SYSTEMTASKTYPE.SYSTEMTASKTYPEID
LEFT JOIN	PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = SYSTEMTASK.UNIQUERECORDID
LEFT JOIN	PLSUBMITTALSTATUS ON PLSUBMITTALSTATUS.PLSUBMITTALSTATUSID = PLSUBMITTAL.PLSUBMITTALSTATUSID				 
WHERE		ATTENTIONRESOLVED = 0
AND			SYSTEMTASK.ASSIGNEDTO IS NULL OR SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @USERIDS)
) AS tblTemp
WHERE		PLSUBMITTALID IS NOT NULL
AND			NEXTSUBMITTAL = 1)

SELECT		tblTasks.SYSTEMTASKID,
			tblTasks.PLSUBMITTALID
INTO		#tblFilteredTasks
FROM		tblTasks
JOIN		SYSTEMTASK ON tblTasks.SYSTEMTASKID = SYSTEMTASK.SYSTEMTASKID
LEFT JOIN	ERENTITYSESSION ON ERENTITYSESSION.PLSUBMITTALID = tblTasks.PLSUBMITTALID
LEFT JOIN	ERSESSIONTRANSACTION ON ERSESSIONTRANSACTION.PLSUBMITTALID = tblTasks.PLSUBMITTALID
				AND	((ERSESSIONTRANSACTION.PROCESSTYPE = 1 AND SYSTEMTASK.SYSTEMTASKTYPEID = 1) OR (ERSESSIONTRANSACTION.PROCESSTYPE != 1 AND SYSTEMTASK.SYSTEMTASKTYPEID != 1))
WHERE		ERSESSIONTRANSACTION.PROCESSSTATUS = 3
AND			ATTENTIONRESOLVED = 0
AND			((SYSTEMTASK.SYSTEMTASKTYPEID != 1 AND ERENTITYSESSION.SESSIONSTATUSID != 3)
			OR (SYSTEMTASK.SYSTEMTASKTYPEID = 1 AND ERENTITYSESSION.ERENTITYSESSIONID IS NULL))

select		COALESCE(PMPERMIT.PMPERMITTYPEID, PLPLAN.PLPLANTYPEID) AS ENTITYTYPEID,
			COALESCE(PMPERMIT.PMPERMITID, PLPLAN.PLPLANID) AS ENTITYID, 
			COALESCE(PMPERMIT.PMPERMITWORKCLASSID, PLPLAN.PLPlANWORKCLASSID) AS ENTITYWORKCLASSID,
			(CASE WHEN PMPERMIT.PMPERMITID IS NOT NULL THEN 2 WHEN PLPLAN.PLPLANID IS NOT NULL THEN 1 ELSE 0 END) AS ENTITYMODULE,
			SYSTEMTASK.SYSTEMTASKID,
			SYSTEMTASK.DUEDATE,
			SYSTEMTASKTYPE.SYSTEMTASKTYPEID,
			COALESCE(NULLIF(SYSTEMTASKTYPE.CUSTOMNAME,''), SYSTEMTASKTYPE.NAME) AS SYSTEMTASKTYPENAME,
			TEAM.TEAMIMAGE,
			TEAM.TEAMID,
			USERS.SUSERGUID,
			USERS.FNAME USERFIRSTNAME,
			USERS.LNAME USERLASTNAME,
			(SELECT COUNT(*) FROM ERPROJECTFILEVERSION WHERE SYSTEMTASKID = #tblFilteredTasks.SYSTEMTASKID AND MARKDELETE = 0) AS NEWFILECOUNT,
			#tblFilteredTasks.PLSUBMITTALID SUBMITTALID,
			PLSUBMITTAL.PLSUBMITTALTYPEID,
			PLSUBMITTALTYPE.TYPENAME,
			(SELECT COUNT(*) FROM PLSUBMITTALFILEVERSION JOIN ERPROJECTFILEVERSION ON PLSUBMITTALFILEVERSION.ERPROJECTFILEVERSIONID = ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID WHERE PLSUBMITTALFILEVERSION.PLSUBMITTALID = #tblFilteredTasks.PLSUBMITTALID AND ERPROJECTFILEVERSION.FILESTATUSID = 4) AS RESBUMITTALCOUNT,
			ERSESSIONTRANSACTION.RESULTLOG,
			ERSESSIONTRANSACTION.CREATEDATE,
			ERSESSIONTRANSACTION.PROCESSTYPE,
			TRANSACTIONUSERS.FNAME TRANSACTIONFIRSTNAME,
			TRANSACTIONUSERS.LNAME TRANSACTIONLASTNAME,
			SYSTEMTASK.COMPLETEDDATE,
			COALESCE(PMPERMITTYPE.NAME, PLPLANTYPE.PLANNAME) ENTITYTYPENAME,
			COALESCE(PMPERMITWORKCLASS.NAME, PLPLANWORKCLASS.NAME) ENTITYCLASSNAME,
			COALESCE(PMPERMIT.PERMITNUMBER, PLPLAN.PLANNUMBER) ENTITYNUMBER,
			COALESCE(PMPERMIT.ROWVERSION, PLPLAN.ROWVERSION) ROWVERSION,
			COALESCE(PERMIT_PROJECT.NAME,PLAN_PROJECT.NAME) PROJECTNAME,
			COALESCE(PMPERMIT.APPLYDATE, PLPLAN.APPLICATIONDATE) APPLYDATE,
			COALESCE(PMPERMIT.DESCRIPTION, PLPLAN.DESCRIPTION) ENTITYDESCRIPTION,
			HASSTOPHOLDS = [reviewcoordinator].UFN_HAS_ACTIVE_STOP_HOLDS(COALESCE(PMPERMIT.PMPERMITID, PLPLAN.PLPLANID), @ALLOWHOLDOVERRIDE),
			SYSTEMTASK.CREATEDON,
			HASINVOICEBALANCEDUE = [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](COALESCE(PMPERMIT.PMPERMITID, PLPLAN.PLPLANID)),
			SYSTEMTASK.SNOOZETYPEID,
			SYSTEMTASK.SNOOZEUNTILDATE
INTO		#RESULT_DATA
FROM		#tblFilteredTasks
JOIN		PLSUBMITTAL ON #tblFilteredTasks.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
JOIN		PLSUBMITTALTYPE ON PLSUBMITTAL.PLSUBMITTALTYPEID = PLSUBMITTALTYPE.PLSUBMITTALTYPEID
JOIN		SYSTEMTASK ON #tblFilteredTasks.SYSTEMTASKID = SYSTEMTASK.SYSTEMTASKID
JOIN		SYSTEMTASKTYPE ON SYSTEMTASK.SYSTEMTASKTYPEID = SYSTEMTASKTYPE.SYSTEMTASKTYPEID
LEFT JOIN	PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID
LEFT JOIN	PLPLANTYPE ON PLPLANTYPE.PLPLANTYPEID = PLPLAN.PLPLANTYPEID
LEFT JOIN	PLPLANWORKCLASS ON PLPLANWORKCLASS.PLPLANWORKCLASSID = PLPLAN.PLPLANWORKCLASSID
LEFT JOIN	PRPROJECTPLAN ON PRPROJECTPLAN.PLPLANID = PLPLAN.PLPLANID
LEFT JOIN	PRPROJECT PLAN_PROJECT ON PLAN_PROJECT.PRPROJECTID = PRPROJECTPLAN.PRPROJECTID
LEFT JOIN	PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID
LEFT JOIN	PMPERMITTYPE ON PMPERMITTYPE.PMPERMITTYPEID = PMPERMIT.PMPERMITTYPEID
LEFT JOIN	PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
LEFT JOIN	PRPROJECTPERMIT ON PRPROJECTPERMIT.PMPERMITID = PMPERMIT.PMPERMITID
LEFT JOIN	PRPROJECT PERMIT_PROJECT ON PERMIT_PROJECT.PRPROJECTID = PRPROJECTPERMIT.PRPROJECTID
LEFT JOIN	USERS ON SYSTEMTASK.ASSIGNEDTO = USERS.SUSERGUID
LEFT JOIN	TEAM ON SYSTEMTASK.TEAMASSIGNEDTO = TEAM.TEAMID
LEFT JOIN	ERENTITYSESSION ON ERENTITYSESSION.PLSUBMITTALID = #tblFilteredTasks.PLSUBMITTALID
LEFT JOIN	ERSESSIONTRANSACTION ON ERSESSIONTRANSACTION.PLSUBMITTALID = #tblFilteredTasks.PLSUBMITTALID 				
				AND	((ERSESSIONTRANSACTION.PROCESSTYPE = 1 AND SYSTEMTASK.SYSTEMTASKTYPEID = 1) OR (ERSESSIONTRANSACTION.PROCESSTYPE != 1 AND SYSTEMTASK.SYSTEMTASKTYPEID != 1))
LEFT JOIN	USERS AS TRANSACTIONUSERS ON ERSESSIONTRANSACTION.CREATEDBY = TRANSACTIONUSERS.SUSERGUID;

SELECT * FROM #RESULT_DATA ORDER BY APPLYDATE DESC

DECLARE @RESULT_ENTITYIDS RECORDIDS
INSERT INTO @RESULT_ENTITYIDS SELECT DISTINCT ENTITYID FROM #RESULT_DATA

DECLARE @RESULT_SUBMITTALIDS RECORDIDS
INSERT INTO @RESULT_SUBMITTALIDS SELECT DISTINCT SUBMITTALID FROM #RESULT_DATA

DECLARE @RESULT_SYTEMTASKIDS RECORDIDS
INSERT INTO @RESULT_SYTEMTASKIDS SELECT DISTINCT SYSTEMTASKID FROM #RESULT_DATA

exec [reviewcoordinator].[USP_ADDRESS_GETBYENTITYIDS] @ENTITYIDS = @RESULT_ENTITYIDS
exec [reviewcoordinator].[USP_ITEM_REVIEWS_GETBYPLSUBMITTALIDS] @SUBMITTALIDS = @RESULT_SUBMITTALIDS
exec [reviewcoordinator].[USP_CONTACT_GETBYENTITYIDS] @ENTITYIDS = @RESULT_ENTITYIDS
exec [reviewcoordinator].[USP_ERPROJECTFILEVERSION_GETBYSYSTEMTASKIDS] @SYSTEMTASKIDS = @RESULT_SYTEMTASKIDS

END