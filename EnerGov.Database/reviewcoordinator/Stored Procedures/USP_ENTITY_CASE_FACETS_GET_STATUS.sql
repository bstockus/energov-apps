CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_CASE_FACETS_GET_STATUS]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

WITH ENTITY_STATUS AS 
(
	SELECT * FROM (	
	SELECT		
			PMPERMITSTATUS.PMPERMITSTATUSID ENTITYSTATUSID,
			PMPERMITSTATUS.NAME ENTITYSTATUS,
			PMPERMIT.ASSIGNEDTO ASSIGNEDTO,
			PMPERMIT.FINALIZEDATE COMPLETEDATE
		FROM PMPERMIT	
		INNER JOIN PMPERMITSTATUS ON PMPERMITSTATUS.PMPERMITSTATUSID = PMPERMIT.PMPERMITSTATUSID
		UNION ALL
		SELECT					
			PLPLANSTATUS.PLPLANSTATUSID ENTITYSTATUSID,
			PLPLANSTATUS.NAME ENTITYSTATUS,			
			PLPLAN.ASSIGNEDTO ASSIGNEDTO,
			PLPLAN.COMPLETEDATE COMPLETEDATE
		FROM PLPLAN	
		INNER JOIN PLPLANSTATUS ON PLPLANSTATUS.PLPLANSTATUSID = PLPLAN.PLPLANSTATUSID		
) AS QUERY_DATA
	WHERE 	
	ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND
	COMPLETEDATE IS NULL
) 
SELECT ENTITYSTATUSID ID, ENTITYSTATUS NAME, COUNT(*) COUNT
FROM ENTITY_STATUS 
WHERE ENTITYSTATUSID IS NOT NULL
GROUP BY ENTITYSTATUSID, ENTITYSTATUS
ORDER BY COUNT(*) DESC, ENTITYSTATUS

END