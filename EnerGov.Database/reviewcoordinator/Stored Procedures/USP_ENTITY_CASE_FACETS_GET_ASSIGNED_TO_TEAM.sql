CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_CASE_FACETS_GET_ASSIGNED_TO_TEAM]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@OWNEDTEAMIDS AS RECORDIDS READONLY
AS
BEGIN

WITH ASSIGNED_TO_TEAM AS 
(
	SELECT * FROM (
	SELECT 
		TEAM.TEAMID, TEAM.NAME,
		PMPERMIT.ASSIGNEDTO ASSIGNEDTO,
		PMPERMIT.FINALIZEDATE COMPLETEDATE,
		PMPERMIT.PMPERMITID ENTITYID
		FROM PMPERMIT
		INNER JOIN TEAMRESOURCE ON TEAMRESOURCE.USERID = PMPERMIT.ASSIGNEDTO
		INNER JOIN RESOURCETYPE ON RESOURCETYPE.RESOURCETYPEID = TEAMRESOURCE.RESOURCETYPEID
		INNER JOIN TEAM ON TEAM.TEAMID = TEAMRESOURCE.TEAMID
		WHERE RESOURCETYPE.RESOURCESYSTEMTYPEID = 2 		-- Reviewer/Coordinator
		AND TEAM.TEAMID IN (SELECT RECORDID FROM @OWNEDTEAMIDS)
	UNION
	SELECT 
		TEAM.TEAMID, TEAM.NAME, 
		PMPERMIT.ASSIGNEDTO ASSIGNEDTO,
		PMPERMIT.FINALIZEDATE COMPLETEDATE,
		PMPERMIT.PMPERMITID ENTITYID
		FROM PMPERMIT
		INNER JOIN TEAM ON TEAM.USERID = PMPERMIT.ASSIGNEDTO
		WHERE TEAM.TEAMID IN (SELECT RECORDID FROM @OWNEDTEAMIDS)
	UNION
	SELECT 
		TEAM.TEAMID, TEAM.NAME, 
		PLPLAN.ASSIGNEDTO ASSIGNEDTO,
		PLPLAN.COMPLETEDATE COMPLETEDATE,
		PLPLAN.PLPLANID ENTITYID
		FROM PLPLAN
		INNER JOIN TEAMRESOURCE ON TEAMRESOURCE.USERID = PLPLAN.ASSIGNEDTO
		INNER JOIN RESOURCETYPE ON RESOURCETYPE.RESOURCETYPEID = TEAMRESOURCE.RESOURCETYPEID
		INNER JOIN TEAM ON TEAM.TEAMID = TEAMRESOURCE.TEAMID
		WHERE RESOURCETYPE.RESOURCESYSTEMTYPEID = 2 		-- Reviewer/Coordinator
		AND TEAM.TEAMID IN (SELECT RECORDID FROM @OWNEDTEAMIDS)
	UNION
	SELECT 
		TEAM.TEAMID, TEAM.NAME, 
		PLPLAN.ASSIGNEDTO ASSIGNEDTO,
		PLPLAN.COMPLETEDATE COMPLETEDATE,
		PLPLAN.PLPLANID ENTITYID
		FROM PLPLAN
		INNER JOIN TEAM ON TEAM.USERID = PLPLAN.ASSIGNEDTO
		WHERE TEAM.TEAMID IN (SELECT RECORDID FROM @OWNEDTEAMIDS)
	) AS QUERY_DATA
	WHERE 	
	(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR 
	(ASSIGNEDTO IS NULL AND TEAMID IN (SELECT RECORDID FROM @OWNEDTEAMIDS))
	) AND
	COMPLETEDATE IS NULL
) 
SELECT
ASSIGNED_TO_TEAM.TEAMID, ASSIGNED_TO_TEAM.NAME, COUNT(*) COUNT
FROM ASSIGNED_TO_TEAM
GROUP BY ASSIGNED_TO_TEAM.TEAMID, ASSIGNED_TO_TEAM.NAME
ORDER BY COUNT(*) DESC, ASSIGNED_TO_TEAM.NAME

END