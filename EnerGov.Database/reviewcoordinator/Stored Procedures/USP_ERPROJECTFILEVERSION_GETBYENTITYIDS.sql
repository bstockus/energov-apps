CREATE PROCEDURE [reviewcoordinator].[USP_ERPROJECTFILEVERSION_GETBYENTITYIDS]
	@ENTITYIDS AS RECORDIDS READONLY
AS
BEGIN

SET NOCOUNT ON;

SELECT
	ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID
	, ERUPLOADPOSTQUEUE.ERUPLOADENEWFILENAME
	, ERUPLOADPOSTQUEUE.RESULTLOG 
FROM ERPROJECTFILEVERSION
INNER JOIN ERPROJECTFILE ON ERPROJECTFILE.ERPROJECTFILEID = ERPROJECTFILEVERSION.ERPROJECTFILEID
INNER JOIN ERPROJECT ON ERPROJECT.ERPROJECTID = ERPROJECTFILE.ERPROJECTID
INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = ERPROJECT.PMPERMITID
INNER JOIN ERUPLOADPOSTQUEUE ON ERUPLOADPOSTQUEUE.ERUPLOADFOLDERNAME = ERPROJECT.UPLOADFOLDER AND (ERUPLOADPOSTQUEUE.ERUPLOADEFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME OR ERUPLOADPOSTQUEUE.ERUPLOADENEWFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME)
WHERE PMPERMIT.PMPERMITID IN (SELECT RECORDID FROM @ENTITYIDS)
AND	(ERUPLOADPOSTQUEUE.RESULTLOG IS NULL OR ERUPLOADPOSTQUEUE.RESULTLOG <> 'File Copied Successfully')
UNION ALL
SELECT
	ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID
	, ERUPLOADPOSTQUEUE.ERUPLOADENEWFILENAME
	, ERUPLOADPOSTQUEUE.RESULTLOG 
FROM ERPROJECTFILEVERSION
INNER JOIN ERPROJECTFILE ON ERPROJECTFILE.ERPROJECTFILEID = ERPROJECTFILEVERSION.ERPROJECTFILEID
INNER JOIN ERPROJECT ON ERPROJECT.ERPROJECTID = ERPROJECTFILE.ERPROJECTID
INNER JOIN PLPLAN ON PLPLAN.PLPLANID = ERPROJECT.PLPLANID
INNER JOIN ERUPLOADPOSTQUEUE ON ERUPLOADPOSTQUEUE.ERUPLOADFOLDERNAME = ERPROJECT.UPLOADFOLDER AND (ERUPLOADPOSTQUEUE.ERUPLOADEFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME OR ERUPLOADPOSTQUEUE.ERUPLOADENEWFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME)
WHERE PLPLAN.PLPLANID IN (SELECT RECORDID FROM @ENTITYIDS)
AND	(ERUPLOADPOSTQUEUE.RESULTLOG IS NULL OR ERUPLOADPOSTQUEUE.RESULTLOG <> 'File Copied Successfully')
END