CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_SUBMITTAL_FACETS_GET_ENTITY_NUMBER]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

WITH ENTITY_NUMBER AS 
(	
	SELECT * FROM (	
		-- permit submittals
		SELECT 
			PMPERMIT.PMPERMITID AS ENTITYID,
			PMPERMIT.PERMITNUMBER AS ENTITYNUMBER,
			PMPERMIT.ASSIGNEDTO AS ASSIGNEDTO,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID								
		UNION ALL
		-- plan submittals
		SELECT 
			PLPLAN.PLPLANID AS ENTITYID,
			PLPLAN.PLANNUMBER AS ENTITYNUMBER,
			PLPLAN.ASSIGNEDTO AS ASSIGNEDTO	,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID
) AS QUERY_DATA
WHERE 	
	(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND COMPLETED = 0 AND COMPLETEDATE IS NULL)
)
SELECT ENTITYID AS ID, ENTITYNUMBER AS NAME, COUNT(*) AS COUNT
FROM ENTITY_NUMBER 
WHERE ENTITYID IS NOT NULL
GROUP BY ENTITYID, ENTITYNUMBER
ORDER BY COUNT(*) DESC, ENTITYNUMBER

END