CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_CASE_FACETS_GET_ASSIGNED_TO]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

WITH ASSIGNED_TO AS 
(
	SELECT * FROM (	
	SELECT		
			PMPERMIT.ASSIGNEDTO ASSIGNEDTO,
			PMPERMIT.FINALIZEDATE COMPLETEDATE,
			USERS.FNAME USERFIRSTNAME,
			USERS.LNAME USERLASTNAME
		FROM PMPERMIT			
		INNER JOIN USERS ON USERS.SUSERGUID = PMPERMIT.ASSIGNEDTO
		UNION ALL
		SELECT				
			PLPLAN.ASSIGNEDTO ASSIGNEDTO,
			PLPLAN.COMPLETEDATE COMPLETEDATE,
			USERS.FNAME USERFIRSTNAME,
			USERS.LNAME USERLASTNAME
		FROM PLPLAN			
		INNER JOIN USERS ON USERS.SUSERGUID = PLPLAN.ASSIGNEDTO
) AS QUERY_DATA
	WHERE 	
	ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND
	COMPLETEDATE IS NULL
)
SELECT ASSIGNEDTO ID, USERFIRSTNAME FIRSTNAME, USERLASTNAME LASTNAME, COUNT(*) COUNT
FROM ASSIGNED_TO 
WHERE ASSIGNEDTO IS NOT NULL
GROUP BY ASSIGNEDTO, USERFIRSTNAME, USERLASTNAME
ORDER BY COUNT(*) DESC, USERFIRSTNAME, USERLASTNAME

END