CREATE PROCEDURE [reviewcoordinator].[USP_INBOX_CARD_FACETS_GET_TASK_TYPE]
	@FACETTYPE AS INT,	-- 0 = incomplete, 1 = complete, 2 = snoozed
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@ASSIGNEDTEAMIDS AS RECORDIDS READONLY,
	@LASTCOMPLETEDDATE AS DATE = NULL,
	@TODAY AS DATE = NULL
AS
BEGIN

SELECT 
	CAST(SYSTEMTASKTYPE.SYSTEMTASKTYPEID AS CHAR(1)) ID, 
	COALESCE(NULLIF(SYSTEMTASKTYPE.CUSTOMNAME, ''), SYSTEMTASKTYPE.NAME) NAME, 
	COUNT(*) COUNT
FROM SYSTEMTASK
INNER JOIN SYSTEMTASKTYPE ON SYSTEMTASKTYPE.SYSTEMTASKTYPEID = SYSTEMTASK.SYSTEMTASKTYPEID
LEFT OUTER JOIN PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = UNIQUERECORDID
WHERE SYSTEMTASKID IS NOT NULL AND
	(
	SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS)  OR
	(SYSTEMTASK.ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS))) AND
	(
		(@FACETTYPE = 0 AND COMPLETEDDATE IS NULL AND
		[reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, 
		[reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](COALESCE(PLSUBMITTAL.PMPERMITID, PLSUBMITTAL.PLPLANID, SYSTEMTASK.UNIQUERECORDID)), 
		SNOOZEUNTILDATE, @TODAY) = 0)
		OR		
		(@FACETTYPE = 1 AND @LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
		OR
		(@FACETTYPE = 2 AND COMPLETEDDATE IS NULL AND
		[reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, 
		[reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](COALESCE(PLSUBMITTAL.PMPERMITID, PLSUBMITTAL.PLPLANID, SYSTEMTASK.UNIQUERECORDID)), 
		SNOOZEUNTILDATE, @TODAY) = 1)
	)
GROUP BY SYSTEMTASKTYPE.SYSTEMTASKTYPEID, COALESCE(NULLIF(SYSTEMTASKTYPE.CUSTOMNAME, ''), SYSTEMTASKTYPE.NAME)
ORDER BY COUNT(*) DESC, COALESCE(NULLIF(SYSTEMTASKTYPE.CUSTOMNAME, ''), SYSTEMTASKTYPE.NAME)

END