CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_SUBMITTAL_FACETS_GET_ENTITY_TYPE]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

-- entity type
WITH ENTITY_TYPE AS 
(	
	SELECT * FROM (	
		-- permit submittals
		SELECT 				
			PMPERMIT.PMPERMITTYPEID AS ENTITYTYPEID,
			PMPERMITTYPE.NAME AS ENTITYTYPE,			
			PMPERMIT.ASSIGNEDTO AS ASSIGNEDTO,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID			
			LEFT JOIN PMPERMITTYPE ON PMPERMITTYPE.PMPERMITTYPEID = PMPERMIT.PMPERMITTYPEID									
		UNION ALL
		-- plan submittals
		SELECT 			
			PLPLAN.PLPLANTYPEID AS ENTITYTYPEID,
			PLPLANTYPE.PLANNAME AS ENTITYTYPE,			
			PLPLAN.ASSIGNEDTO AS ASSIGNEDTO	,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID			
			LEFT JOIN PLPLANTYPE ON PLPLANTYPE.PLPLANTYPEID = PLPLAN.PLPLANTYPEID
) AS QUERY_DATA
WHERE 	
	(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND COMPLETED = 0 AND COMPLETEDATE IS NULL)
)
SELECT ENTITYTYPEID AS ID, ENTITYTYPE AS NAME, COUNT(*) AS COUNT
FROM ENTITY_TYPE 
WHERE ENTITYTYPEID IS NOT NULL
GROUP BY ENTITYTYPEID, ENTITYTYPE
ORDER BY COUNT(*) DESC, ENTITYTYPE

END