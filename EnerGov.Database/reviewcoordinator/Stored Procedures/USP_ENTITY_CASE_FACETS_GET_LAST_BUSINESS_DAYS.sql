CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_CASE_FACETS_GET_LAST_BUSINESS_DAYS]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@LASTBUSINESSDAY AS DATE = NULL
AS
BEGIN

WITH LAST_BUSINESS_DAYS AS 
(
	SELECT 
		PMPERMIT.APPLYDATE APPLIEDDATE, 
		PMPERMIT.FINALIZEDATE COMPLETEDATE, 
		PMPERMIT.ASSIGNEDTO ASSIGNEDTO 
	FROM PMPERMIT
	UNION 
	SELECT 
		APPLICATIONDATE APPLIEDDATE, 
		PLPLAN.COMPLETEDATE COMPLETEDATE, 
		PLPLAN.ASSIGNEDTO ASSIGNEDTO 
	FROM PLPLAN
) 
SELECT ID = 'LastBusinessDays', NAME = 'LastBusinessDays', COUNT(*) COUNT
FROM LAST_BUSINESS_DAYS
WHERE 
	ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND 
	COMPLETEDATE IS NULL
	AND APPLIEDDATE >= @LASTBUSINESSDAY

END