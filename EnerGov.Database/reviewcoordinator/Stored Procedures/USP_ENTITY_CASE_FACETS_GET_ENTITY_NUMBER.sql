CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_CASE_FACETS_GET_ENTITY_NUMBER]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

WITH ENTITY_NUMBER AS 
(
	SELECT * FROM (	
	SELECT		
			PMPERMIT.PMPERMITID ENTITYID,
			PMPERMIT.PERMITNUMBER ENTITYNUMBER,
			PMPERMIT.ASSIGNEDTO ASSIGNEDTO,
			PMPERMIT.FINALIZEDATE COMPLETEDATE
		FROM PMPERMIT			
		UNION ALL
		SELECT		
			PLPLAN.PLPLANID ENTITYID,
			PLPLAN.PLANNUMBER ENTITYNUMBER,
			PLPLAN.ASSIGNEDTO ASSIGNEDTO,
			PLPLAN.COMPLETEDATE COMPLETEDATE
		FROM PLPLAN				
) AS QUERY_DATA
	WHERE 	
	ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND
	COMPLETEDATE IS NULL
)
SELECT ENTITYID ID, ENTITYNUMBER NAME, COUNT(*) COUNT
FROM ENTITY_NUMBER
WHERE ENTITYID IS NOT NULL
GROUP BY ENTITYID, ENTITYNUMBER
ORDER BY COUNT(*) DESC, ENTITYNUMBER

END