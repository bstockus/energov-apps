CREATE PROCEDURE [reviewcoordinator].[USP_INBOX_CARD_FACETS_GET_ENTITY_NUMBER]
	@FACETTYPE AS INT,	-- 0 = incomplete, 1 = complete, 2 = snoozed
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@ASSIGNEDTEAMIDS AS RECORDIDS READONLY,
	@LASTCOMPLETEDDATE AS DATE = NULL,
	@TODAY AS DATE = NULL
AS
BEGIN

WITH ENTITY_NUMBER AS 
(
	-- permit
	SELECT 
		PMPERMIT.PMPERMITID ENTITYID,
		PMPERMIT.PERMITNUMBER ENTITYNUMBER,
		SYSTEMTASK.SYSTEMTASKID
	FROM SYSTEMTASK
	INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = SYSTEMTASK.UNIQUERECORDID	
	WHERE (SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR
	(SYSTEMTASK.ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS))
	)
	AND PMPERMIT.PMPERMITTYPEID IS NOT NULL
	AND (		
		(@FACETTYPE = 0 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PMPERMIT.PMPERMITID), SNOOZEUNTILDATE, @TODAY) = 0)
		OR
		(@FACETTYPE = 1 AND @LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
		OR
		(@FACETTYPE = 2 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PMPERMIT.PMPERMITID), SNOOZEUNTILDATE, @TODAY) = 1)
	)
	UNION ALL
	-- plan
	SELECT 
		PLPLAN.PLPLANID ENTITYID,
		PLPLAN.PLANNUMBER ENTITYNUMBER,
		SYSTEMTASK.SYSTEMTASKID
	FROM SYSTEMTASK	
	INNER JOIN PLPLAN ON PLPLAN.PLPLANID = SYSTEMTASK.UNIQUERECORDID	
	WHERE (SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR
	(SYSTEMTASK.ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS))
	)
	AND PLPLAN.PLPLANTYPEID IS NOT NULL
	AND (		
		(@FACETTYPE = 0 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PLPLAN.PLPLANID), SNOOZEUNTILDATE, @TODAY) = 0)
		OR
		(@FACETTYPE = 1 AND @LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
		OR
		(@FACETTYPE = 2 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PLPLAN.PLPLANID), SNOOZEUNTILDATE, @TODAY) = 1)
	)
	UNION ALL
	-- permit submittals
	SELECT 
		PMPERMIT.PMPERMITID ENTITYID,
		PMPERMIT.PERMITNUMBER ENTITYNUMBER,
		SYSTEMTASK.SYSTEMTASKID
	FROM SYSTEMTASK	
	INNER JOIN PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = SYSTEMTASK.UNIQUERECORDID
	INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID	
	WHERE (SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR
	(SYSTEMTASK.ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS))
	)
	AND PMPERMIT.PMPERMITTYPEID IS NOT NULL
	AND (		
		(@FACETTYPE = 0 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PMPERMIT.PMPERMITID), SNOOZEUNTILDATE, @TODAY) = 0)
		OR
		(@FACETTYPE = 1 AND @LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
		OR
		(@FACETTYPE = 2 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PMPERMIT.PMPERMITID), SNOOZEUNTILDATE, @TODAY) = 1)
	)
	UNION ALL
	-- plan submittals
	SELECT 
		PLPLAN.PLPLANID ENTITYID,
		PLPLAN.PLANNUMBER ENTITYNUMBER,
		SYSTEMTASK.SYSTEMTASKID
	FROM SYSTEMTASK	
	INNER JOIN PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = SYSTEMTASK.UNIQUERECORDID
	INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID	
	WHERE (SYSTEMTASK.ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR
	(SYSTEMTASK.ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS))
	)
	AND PLPLAN.PLPLANTYPEID IS NOT NULL
	AND (		
		(@FACETTYPE = 0 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PLPLAN.PLPLANID), SNOOZEUNTILDATE, @TODAY) = 0)
		OR
		(@FACETTYPE = 1 AND @LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
		OR
		(@FACETTYPE = 2 AND COMPLETEDDATE IS NULL AND [reviewcoordinator].[UFN_IS_SNOOZED](SNOOZETYPEID, [reviewcoordinator].[UFN_HAS_INVOICE_BALANCE_DUE](PLPLAN.PLPLANID), SNOOZEUNTILDATE, @TODAY) = 1)
	)
) 
SELECT ENTITYID ID, ENTITYNUMBER NAME, COUNT(*) COUNT
FROM ENTITY_NUMBER 
WHERE ENTITYID IS NOT NULL
GROUP BY ENTITYID, ENTITYNUMBER
ORDER BY COUNT(*) DESC, ENTITYNUMBER

END