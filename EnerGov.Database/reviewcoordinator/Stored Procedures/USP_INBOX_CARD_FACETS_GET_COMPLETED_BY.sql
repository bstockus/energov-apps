CREATE PROCEDURE [reviewcoordinator].[USP_INBOX_CARD_FACETS_GET_COMPLETED_BY]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@ASSIGNEDTEAMIDS AS RECORDIDS READONLY,
	@LASTCOMPLETEDDATE AS DATE = NULL
AS
BEGIN

WITH COMPLETED_BY AS
(
SELECT 		
		SYSTEMTASK.COMPLETEDDATE,
		SYSTEMTASK.COMPLETEDBY,
		USERS.FNAME USERFIRSTNAME,
		USERS.LNAME USERLASTNAME,
		SYSTEMTASK.SYSTEMTASKID
	FROM SYSTEMTASK
	INNER JOIN USERS ON USERS.SUSERGUID = SYSTEMTASK.COMPLETEDBY
WHERE
	(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) OR 
	(ASSIGNEDTO IS NULL AND TEAMASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDTEAMIDS)) 
	) 
	AND
	(
		(@LASTCOMPLETEDDATE IS NULL AND COMPLETEDDATE IS NULL) 
		OR (@LASTCOMPLETEDDATE IS NOT NULL AND COMPLETEDDATE IS NOT NULL AND COMPLETEDDATE >= @LASTCOMPLETEDDATE)
	)
)
SELECT COMPLETEDBY ID, USERFIRSTNAME FIRSTNAME, USERLASTNAME LASTNAME, COUNT(*) COUNT
FROM COMPLETED_BY 
WHERE COMPLETEDBY IS NOT NULL
GROUP BY COMPLETEDBY, USERFIRSTNAME, USERLASTNAME
ORDER BY COUNT(*) DESC, USERFIRSTNAME, USERLASTNAME

END