CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_SUBMITTAL_FACETS_GET_OVERDUE]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY,
	@OVERDUEDATE AS DATE = NULL
AS
BEGIN

WITH OVERDUE AS 
(
	-- permit submittals
	SELECT 		
		PLSUBMITTAL.DUEDATE AS DUEDATE,
		PMPERMIT.ASSIGNEDTO AS ASSIGNEDTO,
		PLSUBMITTAL.COMPLETED AS COMPLETED,
		PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE		
	FROM PLSUBMITTAL 
		INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID								
	UNION ALL
	-- plan submittals
	SELECT 		
		PLSUBMITTAL.DUEDATE AS DUEDATE,
		PLPLAN.ASSIGNEDTO AS ASSIGNEDTO	,
		PLSUBMITTAL.COMPLETED AS COMPLETED,
		PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
	FROM PLSUBMITTAL 
		INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID
) 
SELECT ID = 'Overdue', NAME = 'Overdue', COUNT(*) COUNT
FROM OVERDUE 
WHERE 
(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND COMPLETED = 0 AND COMPLETEDATE IS NULL)
AND DUEDATE < @OVERDUEDATE

END