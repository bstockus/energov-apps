CREATE PROCEDURE [reviewcoordinator].[USP_ERPROJECTFILEVERSION_GETBYSYSTEMTASKIDS]
(
	@SYSTEMTASKIDS RECORDIDS READONLY
)
AS
BEGIN
SET NOCOUNT ON;
SELECT DISTINCT
	ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID,
	ERPROJECTFILEVERSION.ERPROJECTFILEID,
	ERPROJECTFILEVERSION.SAVEFILENAME,
	ERPROJECTFILEVERSION.FILEVERSION,
	ERPROJECTFILEVERSION.CREATEDATE,
	USERS.FNAME USERFIRSTNAME,
	USERS.LNAME USERLASTNAME,
	PROJECTFILECATEGORY = 
	(SELECT TOP 1 ERPROJECTFILECATEGORY.NAME 
	FROM ERPROJECTFILECATEGORYXREF 
	INNER JOIN ERPROJECTFILECATEGORY ON ERPROJECTFILECATEGORY.ERPROJECTFILECATEGORYID = ERPROJECTFILECATEGORYXREF.ERPROJECTFILECATEGORYID
	WHERE ERPROJECTFILECATEGORYXREF.ERPROJECTFILEID = ERPROJECTFILEVERSION.ERPROJECTFILEID
	),
	ERPROJECTFILEVERSION.FILESTATUSID,
	ERPROJECTFILEVERSION.SYSTEMTASKID,
	CAST(CASE WHEN ERUPLOADPOSTQUEUE.PROCESSDATE IS NULL OR ERUPLOADPOSTQUEUE.RESULTLOG != 'File Copied Successfully' THEN 1 ELSE 0 END AS BIT) AS FILEINPROCESS 
FROM ERPROJECTFILEVERSION
INNER JOIN ERPROJECTFILE ON ERPROJECTFILE.ERPROJECTFILEID = ERPROJECTFILEVERSION.ERPROJECTFILEID
INNER JOIN ERPROJECT ON ERPROJECT.ERPROJECTID = ERPROJECTFILE.ERPROJECTID 
LEFT OUTER JOIN USERS ON USERS.SUSERGUID = ERPROJECTFILEVERSION.CREATEDBY
LEFT JOIN ERUPLOADPOSTQUEUE ON ERUPLOADPOSTQUEUE.ERUPLOADFOLDERNAME = ERPROJECT.UPLOADFOLDER AND (ERUPLOADPOSTQUEUE.ERUPLOADEFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME OR ERUPLOADPOSTQUEUE.ERUPLOADENEWFILENAME = ERPROJECTFILEVERSION.SAVEFILENAME)
WHERE ERPROJECTFILEVERSION.MARKDELETE = 0 AND ERPROJECTFILEVERSION.SYSTEMTASKID IN (SELECT SYSTEMTASKID FROM @SYSTEMTASKIDS)
ORDER BY ERPROJECTFILEVERSION.CREATEDATE DESC
END