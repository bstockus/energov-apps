CREATE PROCEDURE [reviewcoordinator].[USP_ENTITY_SUBMITTAL_FACETS_GET_SUBMITTAL_TYPE]
	@ASSIGNEDUSERIDS AS RECORDIDS READONLY
AS
BEGIN

WITH SUBMITTAL_TYPE AS 
(	
	SELECT * FROM (	
		-- permit submittals
		SELECT 
			PLSUBMITTAL.PLSUBMITTALTYPEID AS SUBMITTALTYPEID,
			PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
			PMPERMIT.ASSIGNEDTO AS ASSIGNEDTO,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID
			LEFT JOIN PLSUBMITTALTYPE ON PLSUBMITTAL.PLSUBMITTALTYPEID = PLSUBMITTALTYPE.PLSUBMITTALTYPEID								
		UNION ALL
		-- plan submittals
		SELECT 			
			PLSUBMITTAL.PLSUBMITTALTYPEID AS SUBMITTALTYPEID,
			PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
			PLPLAN.ASSIGNEDTO AS ASSIGNEDTO	,
			PLSUBMITTAL.COMPLETED AS COMPLETED,
			PLSUBMITTAL.COMPLETEDATE AS COMPLETEDATE
		FROM PLSUBMITTAL 
			INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID
			LEFT JOIN PLSUBMITTALTYPE ON PLSUBMITTAL.PLSUBMITTALTYPEID = PLSUBMITTALTYPE.PLSUBMITTALTYPEID
) AS QUERY_DATA
WHERE 	
	(ASSIGNEDTO IN (SELECT RECORDID FROM @ASSIGNEDUSERIDS) AND COMPLETED = 0 AND COMPLETEDATE IS NULL)
)
SELECT SUBMITTALTYPEID AS ID, SUBMITTALTYPENAME AS NAME, COUNT(*) AS COUNT
FROM SUBMITTAL_TYPE 
WHERE SUBMITTALTYPEID IS NOT NULL
GROUP BY SUBMITTALTYPEID, SUBMITTALTYPENAME
ORDER BY COUNT(*) DESC, SUBMITTALTYPENAME

END