CREATE PROCEDURE [managebusiness].[USP_BLLICENSE_GETBYGLOBALENTITYEXTENSIONID]  
(  
 @GLOBALENTITYEXTENSIONID CHAR(36)  
)  
AS  
BEGIN  
SET NOCOUNT ON;  
SELECT   
	[BLLICENSE].[BLLICENSEID],  
	[BLLICENSE].[LICENSENUMBER],  
	[BLLICENSETYPE].[NAME],  
	[BLLICENSESTATUS].[NAME],  
	[BLLICENSE].[ISSUEDDATE],  
	[BLLICENSE].[EXPIRATIONDATE],
	[managebusiness].[UFN_BLLICENSETYPENAME_GETBYBLLICENSEID] ([BLLICENSE].[BLLICENSEID]) AS INDUSTRYCLASSIFICATION
FROM [dbo].[BLLICENSE]  
  INNER JOIN [dbo].[BLLICENSESTATUS]  ON [BLLICENSESTATUS].[BLLICENSESTATUSID]=[BLLICENSE].[BLLICENSESTATUSID]
  INNER JOIN [dbo].[BLLICENSETYPE]  ON [BLLICENSETYPE].[BLLICENSETYPEID]=[BLLICENSE].[BLLICENSETYPEID]   
WHERE   
	 [BLLICENSE].[BLGLOBALENTITYEXTENSIONID] = @GLOBALENTITYEXTENSIONID  
	 AND [BLLICENSE].[LASTRENEWALDATE] IS NULL  
	 AND ISNULL((SELECT COUNT(1) FROM BLLICENSE CHILD WHERE CHILD.BLLICENSEPARENTID IS NOT NULL AND CHILD.BLLICENSEPARENTID = BLLICENSE.BLLICENSEID), 0) = 0
	 AND [BLLICENSESTATUS].[BLLICENSESTATUSSYSTEMID] IN (1,2,4) --Issued,Expired,Other  
	 ORDER BY [BLLICENSE].[APPLIEDDATE] DESC
END