CREATE PROCEDURE [managebusiness].[USP_TAGGEDBUSINESSFEE_GETBYGLOBALENTITYID]
(
   @BLGLOBALENTITYEXTENSIONID CHAR(36)
)
AS
BEGIN
;WITH RESULT AS
(   --Business owned Fees
    SELECT
        [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID],            
        [dbo].[BLGLOBALENTITYEXTENSION].[REGISTRATIONID],
        ISNULL(SUM([dbo].[CACOMPUTEDFEE].[COMPUTEDAMOUNT]),0) FEETOTAL,
        ISNULL(SUM([dbo].[CACOMPUTEDFEE].[AMOUNTPAIDTODATE]),0) AMOUNTPAIDTOTAL,
        (ISNULL(SUM([dbo].[CACOMPUTEDFEE].[COMPUTEDAMOUNT]),0) - ISNULL(SUM([dbo].[CACOMPUTEDFEE].[AMOUNTPAIDTODATE]),0)) FEEDUE
    FROM [dbo].[BLGLOBALENTITYEXTENSION]
    INNER JOIN [dbo].[BLGLOBALENTITYEXTENSIONFEE] ON  [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID] = [dbo].[BLGLOBALENTITYEXTENSIONFEE].[BLGLOBALENTITYEXTENSIONID]
    INNER JOIN [dbo].[CACOMPUTEDFEE]  ON [dbo].[BLGLOBALENTITYEXTENSIONFEE].[CACOMPUTEDFEEID] = [dbo].[CACOMPUTEDFEE].[CACOMPUTEDFEEID]
		AND [dbo].[CACOMPUTEDFEE].[CASTATUSID] NOT IN (10,5) -- DELETED & VOID
    WHERE [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID] = @BLGLOBALENTITYEXTENSIONID
	GROUP BY [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID], [dbo].[BLGLOBALENTITYEXTENSION].[REGISTRATIONID]
	UNION 	
    --Child Business Fees
	SELECT
        [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID],            
        [dbo].[BLGLOBALENTITYEXTENSION].[REGISTRATIONID],
        ISNULL(SUM([dbo].[CACOMPUTEDFEE].[COMPUTEDAMOUNT]),0) FEETOTAL,
        ISNULL(SUM([dbo].[CACOMPUTEDFEE].[AMOUNTPAIDTODATE]),0) AMOUNTPAIDTOTAL,
        (ISNULL(SUM([dbo].[CACOMPUTEDFEE].[COMPUTEDAMOUNT]),0) - ISNULL(SUM([dbo].[CACOMPUTEDFEE].[AMOUNTPAIDTODATE]),0)) FEEDUE
    FROM [dbo].[BLGLOBALENTITYEXTENSION]
	INNER JOIN [dbo].[BLGLOBALENTITYEXTENSIONPARENTC] ON [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID]=[dbo].[BLGLOBALENTITYEXTENSIONPARENTC].[BLGLOBALENTITYEXTENSIONCHILDID]
    INNER JOIN [dbo].[BLGLOBALENTITYEXTENSIONFEE] ON  [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID] = [dbo].[BLGLOBALENTITYEXTENSIONFEE].[BLGLOBALENTITYEXTENSIONID]
    INNER JOIN [dbo].[CACOMPUTEDFEE]  ON [dbo].[BLGLOBALENTITYEXTENSIONFEE].[CACOMPUTEDFEEID] = [dbo].[CACOMPUTEDFEE].[CACOMPUTEDFEEID]
		AND [dbo].[CACOMPUTEDFEE].[CASTATUSID] NOT IN (10,5) -- DELETED & VOID
    WHERE [dbo].[BLGLOBALENTITYEXTENSIONPARENTC].[BLGLOBALENTITYEXTPARENTID] = @BLGLOBALENTITYEXTENSIONID
	GROUP BY [dbo].[BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID], [dbo].[BLGLOBALENTITYEXTENSION].[REGISTRATIONID]
)
SELECT * FROM RESULT WHERE FEEDUE>0
END;