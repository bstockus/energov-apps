CREATE PROCEDURE [managebusiness].[USP_TAGGEDTAXREMITTANCEFEE_GETBYGLOBALENTITYID]
(
   @BLGLOBALENTITYEXTENSIONID CHAR(36)
)
AS
BEGIN
;WITH RESULT AS
(
    SELECT
        TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID,            
        TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER,
        ISNULL(SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT),0) FEETOTAL,
        ISNULL(SUM(CACOMPUTEDFEE.AMOUNTPAIDTODATE),0) AMOUNTPAIDTOTAL,
        (ISNULL(SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT),0) - ISNULL(SUM(CACOMPUTEDFEE.AMOUNTPAIDTODATE),0)) FEEDUE
    FROM [dbo].[TXREMITTANCEACCOUNT]
    INNER JOIN [dbo].[TXREMITTANCE] ON [dbo].[TXREMITTANCEACCOUNT].[TXREMITTANCEACCOUNTID] =[dbo].[TXREMITTANCE].[TXREMITTANCEACCOUNTID]
    INNER JOIN [dbo].[TXREMITTANCEFEE] ON  [TXREMITTANCE].TXREMITTANCEID = [TXREMITTANCEFEE].TXREMITTANCEID
    INNER JOIN [dbo].[CACOMPUTEDFEE]  ON [TXREMITTANCEFEE].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID]
        AND [CACOMPUTEDFEE].[CASTATUSID] NOT IN (10,5) -- DELETED & VOID
    WHERE [TXREMITTANCEACCOUNT].[BLGLOBALENTITYEXTENSIONID] = @BLGLOBALENTITYEXTENSIONID
        GROUP BY TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID, TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER
)
SELECT * FROM RESULT WHERE FEEDUE>0
END;