CREATE PROCEDURE [workflow].[USP_GET_ILLICENSE_WORKFLOW_STEPS_ACTIONS_SUMMARY]
	@ID CHAR(36)
	
AS

SET NOCOUNT ON;

SELECT
	[dbo].[ILLICENSEWFSTEP].[ILLICENSEWFSTEPID],
	[dbo].[ILLICENSEWFSTEP].[WORKFLOWSTATUSID],
	[dbo].[ILLICENSEWFSTEP].[PRIORITYORDER],
	[dbo].[ILLICENSEWFSTEP].[SORTORDER],
	[dbo].[ILLICENSEWFSTEP].[NOPRIORITY],
	[dbo].[ILLICENSEWFSTEP].[NAME],
	[dbo].[ILLICENSEWFSTEP].[VERSIONNUMBER],
	[dbo].[ILLICENSEWFSTEP].[WFSTEPTYPEID],
	[dbo].[ILLICENSEWFSTEP].[ILLICENSEWFPARENTSTEPID]
FROM [dbo].[ILLICENSEWFSTEP]
WHERE [dbo].[ILLICENSEWFSTEP].[ILLICENSEID] = @ID
ORDER BY [dbo].[ILLICENSEWFSTEP].[PRIORITYORDER], [dbo].[ILLICENSEWFSTEP].[SORTORDER]


SELECT
	[dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFACTIONSTEPID],
	[dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFSTEPID],
	[dbo].[ILLICENSEWFACTIONSTEP].[WORKFLOWSTATUSID],
	[dbo].[ILLICENSEWFACTIONSTEP].[PRIORITYORDER],
	[dbo].[ILLICENSEWFACTIONSTEP].[SORTORDER],
	[dbo].[ILLICENSEWFACTIONSTEP].[NOPRIORITY],
	[dbo].[ILLICENSEWFACTIONSTEP].[NAME],
	[dbo].[ILLICENSEWFACTIONSTEP].[VERSIONNUMBER],
	[dbo].[ILLICENSEWFACTIONSTEP].[STARTDATE],
	[dbo].[ILLICENSEWFACTIONSTEP].[ENDDATE],
	[dbo].[ILLICENSEWFACTIONSTEP].[WFACTIONTYPEID],
	[dbo].[WFACTIONTYPE].[NAME],
	[dbo].[ILLICENSEWFACTIONSTEP].[RPTREPORTID],
	[dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFPARENTACTIONSTEPID],
	[dbo].[ILLICENSEWFACTIONSTEP].[LASTCHANGEDBY],
	CASE WHEN [dbo].[ILLICENSEWFACTIONSTEP].[WFACTIONTYPEID] = 1 THEN 
		COALESCE((SELECT [dbo].[PLSUBMITTAL].[PLSUBMITTALID] + ','
		FROM [dbo].[PLSUBMITTAL]
		WHERE [dbo].[PLSUBMITTAL].[ILLICENSEWFACTIONSTEPID] = [dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFACTIONSTEPID]
		FOR XML PATH ('')), '')  ELSE '' END AS SUBMITTALS,
	[dbo].[ILLICENSEWFACTIONSTEP].[IMINSPECTIONTYPEID]
FROM [dbo].[ILLICENSEWFACTIONSTEP]
INNER JOIN [dbo].[ILLICENSEWFSTEP] ON [dbo].[ILLICENSEWFSTEP].[ILLICENSEWFSTEPID] = [dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFSTEPID]
INNER JOIN [dbo].[WFACTIONTYPE] ON [dbo].[WFACTIONTYPE].[WFACTIONTYPEID] = [dbo].[ILLICENSEWFACTIONSTEP].[WFACTIONTYPEID]
INNER JOIN [dbo].[USERS] ON [dbo].[USERS].[SUSERGUID] = [dbo].[ILLICENSEWFACTIONSTEP].[LASTCHANGEDBY]
WHERE [dbo].[ILLICENSEWFSTEP].[ILLICENSEID] = @ID
ORDER BY [dbo].[ILLICENSEWFACTIONSTEP].[ILLICENSEWFSTEPID], [dbo].[ILLICENSEWFACTIONSTEP].[PRIORITYORDER], [dbo].[ILLICENSEWFACTIONSTEP].[SORTORDER]