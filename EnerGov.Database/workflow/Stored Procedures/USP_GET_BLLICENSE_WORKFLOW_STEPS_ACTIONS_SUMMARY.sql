CREATE PROCEDURE [workflow].[USP_GET_BLLICENSE_WORKFLOW_STEPS_ACTIONS_SUMMARY]
	@ID CHAR(36)
	
AS
SET NOCOUNT ON;

SELECT
	[dbo].[BLLICENSEWFSTEP].[BLLICENSEWFSTEPID],
	[dbo].[BLLICENSEWFSTEP].[WORKFLOWSTATUSID],
	[dbo].[BLLICENSEWFSTEP].[PRIORITYORDER],
	[dbo].[BLLICENSEWFSTEP].[SORTORDER],
	[dbo].[BLLICENSEWFSTEP].[NOPRIORITY],
	[dbo].[BLLICENSEWFSTEP].[NAME],
	[dbo].[BLLICENSEWFSTEP].[VERSIONNUMBER],
	[dbo].[BLLICENSEWFSTEP].[WFSTEPTYPEID],
	[dbo].[BLLICENSEWFSTEP].[BLLICENSEWFPARENTSTEPID]
FROM [dbo].[BLLICENSEWFSTEP]
WHERE [dbo].[BLLICENSEWFSTEP].[BLLICENSEID] = @ID
ORDER BY [dbo].[BLLICENSEWFSTEP].[PRIORITYORDER], [dbo].[BLLICENSEWFSTEP].[SORTORDER]


SELECT
	[dbo].[BLLICENSEWFACTIONSTEP].[BLLICENSEWFACTIONSTEPID],
	[dbo].[BLLICENSEWFACTIONSTEP].[BLLICENSEWFSTEPID],
	[dbo].[BLLICENSEWFACTIONSTEP].[WORKFLOWSTATUSID],
	[dbo].[BLLICENSEWFACTIONSTEP].[PRIORITYORDER],
	[dbo].[BLLICENSEWFACTIONSTEP].[SORTORDER],
	[dbo].[BLLICENSEWFACTIONSTEP].[NOPRIORITY],
	[dbo].[BLLICENSEWFACTIONSTEP].[NAME],
	[dbo].[BLLICENSEWFACTIONSTEP].[VERSIONNUMBER],
	[dbo].[BLLICENSEWFACTIONSTEP].[STARTDATE],
	[dbo].[BLLICENSEWFACTIONSTEP].[ENDDATE],
	[dbo].[BLLICENSEWFACTIONSTEP].[WFACTIONTYPEID],
	[dbo].[WFACTIONTYPE].[NAME],
	[dbo].[BLLICENSEWFACTIONSTEP].[RPTREPORTID],
	[dbo].[BLLICENSEWFACTIONSTEP].[PLPLANWFPARENTACTIONSTEPID],
	[dbo].[BLLICENSEWFACTIONSTEP].[LASTCHANGEDBY],
	CASE WHEN [dbo].[BLLICENSEWFACTIONSTEP].[WFACTIONTYPEID] = 1 THEN 
		COALESCE((SELECT [dbo].[PLSUBMITTAL].[PLSUBMITTALID] + ','
		FROM [dbo].[PLSUBMITTAL]
		WHERE [dbo].[PLSUBMITTAL].[BLLICENSEWFACTIONSTEPID] = [dbo].[BLLICENSEWFACTIONSTEP].[BLLICENSEWFACTIONSTEPID]
		FOR XML PATH ('')), '')  ELSE '' END AS SUBMITTALS,
	[dbo].[BLLICENSEWFACTIONSTEP].[IMINSPECTIONTYPEID]
FROM [dbo].[BLLICENSEWFACTIONSTEP]
INNER JOIN [dbo].[BLLICENSEWFSTEP] ON [dbo].[BLLICENSEWFSTEP].[BLLICENSEWFSTEPID] = [dbo].[BLLICENSEWFACTIONSTEP].[BLLICENSEWFSTEPID]
INNER JOIN [dbo].[WFACTIONTYPE] ON [dbo].[WFACTIONTYPE].[WFACTIONTYPEID] = [dbo].[BLLICENSEWFACTIONSTEP].[WFACTIONTYPEID]
INNER JOIN [dbo].[USERS] ON [dbo].[USERS].[SUSERGUID] = [dbo].[BLLICENSEWFACTIONSTEP].[LASTCHANGEDBY]
WHERE [dbo].[BLLICENSEWFSTEP].[BLLICENSEID] = @ID
ORDER BY [dbo].[BLLICENSEWFACTIONSTEP].[BLLICENSEWFSTEPID], [dbo].[BLLICENSEWFACTIONSTEP].[PRIORITYORDER], [dbo].[BLLICENSEWFACTIONSTEP].[SORTORDER]