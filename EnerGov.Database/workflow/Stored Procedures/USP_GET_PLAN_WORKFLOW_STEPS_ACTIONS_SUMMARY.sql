CREATE PROCEDURE [workflow].[USP_GET_PLAN_WORKFLOW_STEPS_ACTIONS_SUMMARY]
	@ID CHAR(36)
	
AS
SET NOCOUNT ON;

SELECT
	[dbo].[PLPLANWFSTEP].[PLPLANWFSTEPID],
	[dbo].[PLPLANWFSTEP].[WORKFLOWSTATUSID],
	[dbo].[PLPLANWFSTEP].[PRIORITYORDER],
	[dbo].[PLPLANWFSTEP].[SORTORDER],
	[dbo].[PLPLANWFSTEP].[NOPRIORITY],
	[dbo].[PLPLANWFSTEP].[NAME],
	[dbo].[PLPLANWFSTEP].[VERSIONNUMBER],
	[dbo].[PLPLANWFSTEP].[WFSTEPTYPEID],
	[dbo].[PLPLANWFSTEP].[PLPLANWFPARENTSTEPID]
FROM [dbo].[PLPLANWFSTEP]
WHERE [dbo].[PLPLANWFSTEP].[PLPLANID] = @ID
ORDER BY [dbo].[PLPLANWFSTEP].[PRIORITYORDER], [dbo].[PLPLANWFSTEP].[SORTORDER]


SELECT
	[dbo].[PLPLANWFACTIONSTEP].[PLPLANWFACTIONSTEPID],
	[dbo].[PLPLANWFACTIONSTEP].[PLPLANWFSTEPID],
	[dbo].[PLPLANWFACTIONSTEP].[WORKFLOWSTATUSID],
	[dbo].[PLPLANWFACTIONSTEP].[PRIORITYORDER],
	[dbo].[PLPLANWFACTIONSTEP].[SORTORDER],
	[dbo].[PLPLANWFACTIONSTEP].[NOPRIORITY],
	[dbo].[PLPLANWFACTIONSTEP].[NAME],
	[dbo].[PLPLANWFACTIONSTEP].[VERSIONNUMBER],
	[dbo].[PLPLANWFACTIONSTEP].[STARTDATE],
	[dbo].[PLPLANWFACTIONSTEP].[ENDDATE],
	[dbo].[PLPLANWFACTIONSTEP].[WFACTIONTYPEID],
	[dbo].[WFACTIONTYPE].[NAME],
	[dbo].[PLPLANWFACTIONSTEP].[RPTREPORTID],
	[dbo].[PLPLANWFACTIONSTEP].[PLPLANWFPARENTACTIONSTEPID],
	[dbo].[PLPLANWFACTIONSTEP].[LASTCHANGEDBY],
	CASE WHEN [dbo].[PLPLANWFACTIONSTEP].[WFACTIONTYPEID] = 1 THEN 
		COALESCE((SELECT [dbo].[PLSUBMITTAL].[PLSUBMITTALID] + ','
		FROM [dbo].[PLSUBMITTAL]
		WHERE [dbo].[PLSUBMITTAL].[PLPLANWFACTIONSTEPID] = [dbo].[PLPLANWFACTIONSTEP].[PLPLANWFACTIONSTEPID]
		FOR XML PATH ('')), '')  ELSE '' END AS SUBMITTALS,
	[dbo].[PLPLANWFACTIONSTEP].[IMINSPECTIONTYPEID]
FROM [dbo].[PLPLANWFACTIONSTEP]
INNER JOIN [dbo].[PLPLANWFSTEP] ON [dbo].[PLPLANWFSTEP].[PLPLANWFSTEPID] = [dbo].[PLPLANWFACTIONSTEP].[PLPLANWFSTEPID]
INNER JOIN [dbo].[WFACTIONTYPE] ON [dbo].[WFACTIONTYPE].[WFACTIONTYPEID] = [dbo].[PLPLANWFACTIONSTEP].[WFACTIONTYPEID]
INNER JOIN [dbo].[USERS] ON [dbo].[USERS].[SUSERGUID] = [dbo].[PLPLANWFACTIONSTEP].[LASTCHANGEDBY]
WHERE [dbo].[PLPLANWFSTEP].[PLPLANID] = @ID
ORDER BY [dbo].[PLPLANWFACTIONSTEP].[PLPLANWFSTEPID], [dbo].[PLPLANWFACTIONSTEP].[PRIORITYORDER], [dbo].[PLPLANWFACTIONSTEP].[SORTORDER]