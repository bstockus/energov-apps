CREATE PROCEDURE [workflow].[USP_GET_RESPONSES_BYSUBMITTALID]
	@SUBMITTALID CHAR(36)
AS
BEGIN
SET NOCOUNT ON; 

	SELECT		USERS.EMAIL AS REVIEWER,
                PLPLANCORRECTION.COMMENTS AS ORIGINALCOMMENT,
                RESPONSE.RESPONSEID,
                RESPONSE.RESPONSEENTITYID,
                RESPONSE.RESPONSETYPEID,
                RESPONSETYPE.NAME AS RESPONSETYPENAME,
                RESPONSE.RESPONSE,
                RESPONSE.CREATEDATE,
                RESPONSE.LASTCHANGEDBY,
                RESPONSE.CREATEDBY,
                USERS_CREATEDBY.FNAME AS CREATEDBYFNAME,
                USERS_CREATEDBY.LNAME AS CREATEDBYLNAME,
				RESPONSE.LASTCHANGEDON,
				'' AS FILENAME,
				'' AS FILEVERSIONID
	FROM		PLSUBMITTAL
	INNER JOIN	PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
	INNER JOIN	PLPLANCORRECTION ON PLPLANCORRECTION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
	INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANCORRECTION.PLPLANCORRECTIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
	INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
	INNER JOIN	USERS ON USERS.SUSERGUID = PLPLANCORRECTION.ADDEDBYUSERID
	INNER JOIN	USERS AS USERS_CREATEDBY ON USERS_CREATEDBY.SUSERGUID = RESPONSE.CREATEDBY
	WHERE		PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID
	UNION ALL
	SELECT		USERS.EMAIL AS REVIEWER,
                PLPLANRECOMMENDATION.RECOMMENDATION AS ORIGINALCOMMENT,
                RESPONSE.RESPONSEID,
                RESPONSE.RESPONSEENTITYID,
                RESPONSE.RESPONSETYPEID,
                RESPONSETYPE.NAME AS RESPONSETYPENAME,
                RESPONSE.RESPONSE,
                RESPONSE.CREATEDATE,
                RESPONSE.LASTCHANGEDBY,
                RESPONSE.CREATEDBY,
                USERS_CREATEDBY.FNAME AS CREATEDBYFNAME,
                USERS_CREATEDBY.LNAME AS CREATEDBYLNAME,
				RESPONSE.LASTCHANGEDON,
				'' AS FILENAME,
				'' AS FILEVERSIONID
	FROM		PLSUBMITTAL
	INNER JOIN	PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
	INNER JOIN	PLPLANRECOMMENDATION ON PLPLANRECOMMENDATION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
	INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANRECOMMENDATION.PLPLANRECOMENDATIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
	INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
	INNER JOIN	USERS ON USERS.SUSERGUID = PLPLANRECOMMENDATION.ADDEDBYUSERID
	INNER JOIN	USERS AS USERS_CREATEDBY ON USERS_CREATEDBY.SUSERGUID = RESPONSE.CREATEDBY
	WHERE		PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID                    
	UNION ALL
	SELECT		COALESCE(USERS.EMAIL, ERFILEMARKUP.AUTHOR) AS REVIEWER,
                ERFILEMARKUP.COMMENTS AS ORIGINALCOMMENT,
                RESPONSE.RESPONSEID,
                RESPONSE.RESPONSEENTITYID,
                RESPONSE.RESPONSETYPEID,
                RESPONSETYPE.NAME AS RESPONSETYPENAME,
                RESPONSE.RESPONSE,
                RESPONSE.CREATEDATE,
                RESPONSE.LASTCHANGEDBY,
                RESPONSE.CREATEDBY,
                USERS_CREATEDBY.FNAME AS CREATEDBYFNAME,
                USERS_CREATEDBY.LNAME AS CREATEDBYLNAME,
				RESPONSE.LASTCHANGEDON,
				ERFILEMARKUP.FILENAME,
				ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID AS FILEVERSIONID
	FROM PLSUBMITTAL 
	INNER JOIN	PLSUBMITTALFILEVERSION ON PLSUBMITTALFILEVERSION.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
	INNER JOIN	ERPROJECTFILEVERSION ON ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID = PLSUBMITTALFILEVERSION.ERPROJECTFILEVERSIONID
	INNER JOIN	ERENTITYSESSION AS ERENTITYSESSION ON PLSUBMITTALFILEVERSION.PLSUBMITTALID = ERENTITYSESSION.PLSUBMITTALID
	INNER JOIN	ERFILEMARKUP AS ERFILEMARKUP ON (ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID = ERFILEMARKUP.ERPROJECTFILEVERSIONID) AND (ERFILEMARKUP.ERENTITYSESSIONID = ERENTITYSESSION.ERENTITYSESSIONID)
	INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = ERFILEMARKUP.ERFILEMARKUPID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
	INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
	LEFT JOIN	USERS ON USERS.SUSERGUID = ERFILEMARKUP.CREATEDBY
	INNER JOIN	USERS AS USERS_CREATEDBY ON USERS_CREATEDBY.SUSERGUID = RESPONSE.CREATEDBY
	WHERE		ERPROJECTFILEVERSION.MARKDELETE = 0
	AND			PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID;

	WITH CTE AS (
		SELECT		USERS.EMAIL AS REVIEWER,
					USERS.SUSERGUID
		FROM		PLSUBMITTAL
		INNER JOIN	PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
		INNER JOIN	PLPLANCORRECTION ON PLPLANCORRECTION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
		INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANCORRECTION.PLPLANCORRECTIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
		INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
		INNER JOIN	USERS ON USERS.SUSERGUID = PLPLANCORRECTION.ADDEDBYUSERID
		WHERE		PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID
		UNION
		SELECT		USERS.EMAIL AS REVIEWER,
					USERS.SUSERGUID
		FROM		PLSUBMITTAL
		INNER JOIN	PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
		INNER JOIN	PLPLANRECOMMENDATION ON PLPLANRECOMMENDATION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
		INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANRECOMMENDATION.PLPLANRECOMENDATIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
		INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
		INNER JOIN	USERS ON USERS.SUSERGUID = PLPLANRECOMMENDATION.ADDEDBYUSERID
		WHERE		PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID                    
		UNION
		SELECT		USERS.EMAIL AS REVIEWER,
					USERS.SUSERGUID
		FROM		PLSUBMITTAL 
		INNER JOIN	PLSUBMITTALFILEVERSION ON PLSUBMITTALFILEVERSION.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
		INNER JOIN	ERPROJECTFILEVERSION ON ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID = PLSUBMITTALFILEVERSION.ERPROJECTFILEVERSIONID
		INNER JOIN	ERENTITYSESSION AS ERENTITYSESSION ON PLSUBMITTALFILEVERSION.PLSUBMITTALID = ERENTITYSESSION.PLSUBMITTALID
		INNER JOIN	ERFILEMARKUP AS ERFILEMARKUP ON (ERPROJECTFILEVERSION.ERPROJECTFILEVERSIONID = ERFILEMARKUP.ERPROJECTFILEVERSIONID) AND (ERFILEMARKUP.ERENTITYSESSIONID = ERENTITYSESSION.ERENTITYSESSIONID)
		INNER JOIN	RESPONSE ON RESPONSE.RESPONSEENTITYID = ERFILEMARKUP.ERFILEMARKUPID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
		INNER JOIN	RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
		INNER JOIN	USERS ON USERS.SUSERGUID = ERFILEMARKUP.CREATEDBY
		WHERE		ERPROJECTFILEVERSION.MARKDELETE = 0
		AND			PLSUBMITTAL.PLSUBMITTALID = @SUBMITTALID	
	)
	SELECT		DISTINCT DEPARTMENT.NAME AS DEPARTMENT
				, CTE.REVIEWER AS REVIEWER
	FROM		DEPARTMENT
	JOIN		USERDEPARTMENT ON DEPARTMENT.DEPARTMENTID = USERDEPARTMENT.DEPARTMENTID
	JOIN		CTE ON CTE.SUSERGUID = USERDEPARTMENT.SUSERGUID

END