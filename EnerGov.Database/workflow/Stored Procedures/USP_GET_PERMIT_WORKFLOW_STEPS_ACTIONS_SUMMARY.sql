CREATE PROCEDURE [workflow].[USP_GET_PERMIT_WORKFLOW_STEPS_ACTIONS_SUMMARY]
	@ID CHAR(36)
	
AS
SET NOCOUNT ON;

SELECT
	[dbo].[PMPERMITWFSTEP].[PMPERMITWFSTEPID],
	[dbo].[PMPERMITWFSTEP].[WORKFLOWSTATUSID],
	[dbo].[PMPERMITWFSTEP].[PRIORITYORDER],
	[dbo].[PMPERMITWFSTEP].[SORTORDER],
	[dbo].[PMPERMITWFSTEP].[NOPRIORITY],
	[dbo].[PMPERMITWFSTEP].[NAME],
	[dbo].[PMPERMITWFSTEP].[VERSIONNUMBER],
	[dbo].[PMPERMITWFSTEP].[WFSTEPTYPEID],
	[dbo].[PMPERMITWFSTEP].[PMPERMITWFPARENTSTEPID]
FROM [dbo].[PMPERMITWFSTEP]
WHERE [dbo].[PMPERMITWFSTEP].[PMPERMITID] = @ID
ORDER BY [dbo].[PMPERMITWFSTEP].[PRIORITYORDER], [dbo].[PMPERMITWFSTEP].[SORTORDER]


SELECT
	[dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFACTIONSTEPID],
	[dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFSTEPID],
	[dbo].[PMPERMITWFACTIONSTEP].[WORKFLOWSTATUSID],
	[dbo].[PMPERMITWFACTIONSTEP].[PRIORITYORDER],
	[dbo].[PMPERMITWFACTIONSTEP].[SORTORDER],
	[dbo].[PMPERMITWFACTIONSTEP].[NOPRIORITY],
	[dbo].[PMPERMITWFACTIONSTEP].[NAME],
	[dbo].[PMPERMITWFACTIONSTEP].[VERSIONNUMBER],
	[dbo].[PMPERMITWFACTIONSTEP].[STARTDATE],
	[dbo].[PMPERMITWFACTIONSTEP].[ENDDATE],
	[dbo].[PMPERMITWFACTIONSTEP].[WFACTIONTYPEID],
	[dbo].[WFACTIONTYPE].[NAME],
	[dbo].[PMPERMITWFACTIONSTEP].[RPTREPORTID],
	[dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFPARENTACTIONSTEPID],
	[dbo].[PMPERMITWFACTIONSTEP].[LASTCHANGEDBY],
	CASE WHEN [dbo].[PMPERMITWFACTIONSTEP].[WFACTIONTYPEID] = 1 THEN 
		COALESCE((SELECT [dbo].[PLSUBMITTAL].[PLSUBMITTALID] + ','
		FROM [dbo].[PLSUBMITTAL]
		WHERE [dbo].[PLSUBMITTAL].[PMPERMITWFACTIONSTEPID] = [dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFACTIONSTEPID]
		FOR XML PATH ('')), '')  ELSE '' END AS SUBMITTALS,
	[dbo].[PMPERMITWFACTIONSTEP].[IMINSPECTIONTYPEID]
FROM [dbo].[PMPERMITWFACTIONSTEP]
INNER JOIN [dbo].[PMPERMITWFSTEP] ON [dbo].[PMPERMITWFSTEP].[PMPERMITWFSTEPID] = [dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFSTEPID]
INNER JOIN [dbo].[WFACTIONTYPE] ON [dbo].[WFACTIONTYPE].[WFACTIONTYPEID] = [dbo].[PMPERMITWFACTIONSTEP].[WFACTIONTYPEID]
INNER JOIN [dbo].[USERS] ON [dbo].[USERS].[SUSERGUID] = [dbo].[PMPERMITWFACTIONSTEP].[LASTCHANGEDBY]
WHERE [dbo].[PMPERMITWFSTEP].[PMPERMITID] = @ID
ORDER BY [dbo].[PMPERMITWFACTIONSTEP].[PMPERMITWFSTEPID], [dbo].[PMPERMITWFACTIONSTEP].[PRIORITYORDER], [dbo].[PMPERMITWFACTIONSTEP].[SORTORDER]