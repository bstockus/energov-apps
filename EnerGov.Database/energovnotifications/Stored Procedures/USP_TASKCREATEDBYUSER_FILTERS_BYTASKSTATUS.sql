CREATE PROCEDURE [energovnotifications].[USP_TASKCREATEDBYUSER_FILTERS_BYTASKSTATUS]
(
	@USERID CHAR(36),
	@ISTASKCOMPLETED AS BIT = NULL,
	@ISTASKCREATEDBYME AS BIT = 0
)
AS
BEGIN

SET NOCOUNT ON;

SELECT DISTINCT 
	[dbo].[USERS].[SUSERGUID],
	(COALESCE([dbo].[USERS].[FNAME] + ' ', '') + [dbo].[USERS].[LNAME]) AS CREATEDBYUSER
FROM 
	[dbo].[TASK]
JOIN 
	[dbo].[TASKSTATUS] ON [dbo].[TASK].[TASKSTATUSID] = [dbo].[TASKSTATUS].[TASKSTATUSID]
JOIN 
	[dbo].[USERS] ON [dbo].[TASK].[CREATEDBYID] = [dbo].[USERS].[SUSERGUID]
LEFT JOIN 
	[dbo].[TASKUSER] ON [dbo].[TASK].[TASKID] = [dbo].[TASKUSER].[TASKID]
WHERE 
	((@ISTASKCOMPLETED IS NULL) OR ([dbo].[TASKSTATUS].[ISCOMPLETED] = @ISTASKCOMPLETED  AND [dbo].[TASKUSER].[USERID] = @USERID))
	AND (@ISTASKCREATEDBYME = 0 OR (@ISTASKCREATEDBYME = 1 AND [dbo].[TASK].[CREATEDBYID] = @USERID))	
	AND [dbo].[TASK].[TASKID] IN 
	(
		SELECT DISTINCT 
			[dbo].[TASKUSER].[TASKID]
		FROM [dbo].[TASKUSER]		
		WHERE 
			[dbo].[TASKUSER].[USERID] = @USERID
	)
ORDER BY 
	CREATEDBYUSER
END