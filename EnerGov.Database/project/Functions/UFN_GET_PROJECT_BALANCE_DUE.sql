CREATE FUNCTION [project].[UFN_GET_PROJECT_BALANCE_DUE]
(
	@PROJECTID char(36)
)
RETURNS MONEY
AS
BEGIN
	DECLARE @IGNORESTATUS5	INT		=	5	--Ignore fees with Status VOID (5)
	DECLARE @IGNORESTATUS10 INT		=	10	--Ignore fees with Status Deleted (10)
	DECLARE @BALANCEDUE		MONEY

	SELECT @BALANCEDUE = (SELECT SUM(DUE) FROM
		(
			SELECT		PRPROJECTID, SUM(COMPUTEDAMOUNT - AMOUNTPAIDTODATE) AS DUE 
			FROM		PRPROJECTFEE 
						JOIN CACOMPUTEDFEE ON PRPROJECTFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
			WHERE		CASTATUSID NOT IN (@IGNORESTATUS5, @IGNORESTATUS10) 
						AND PRPROJECTID = PRPROJECT.PRPROJECTID
			GROUP BY	PRPROJECTID
			
			UNION ALL
			SELECT		PMPERMITID, SUM(COMPUTEDAMOUNT - AMOUNTPAIDTODATE) AS DUE 
			FROM		PMPERMITFEE 
						JOIN CACOMPUTEDFEE ON PMPERMITFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
			WHERE		CASTATUSID NOT IN (@IGNORESTATUS5, @IGNORESTATUS10) 
						AND PMPERMITFEE.PMPERMITID IN (SELECT PMPERMITID FROM PRPROJECTPERMIT WHERE PRPROJECTID = PRPROJECT.PRPROJECTID)
			GROUP BY	PMPERMITID
			
			UNION ALL
			SELECT		CMCODECASEID, SUM(COMPUTEDAMOUNT - AMOUNTPAIDTODATE) AS DUE 
			FROM		CMCODECASEFEE 
						JOIN CACOMPUTEDFEE ON CMCODECASEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
			WHERE		CASTATUSID NOT IN (@IGNORESTATUS5, @IGNORESTATUS10) 
						AND CMCODECASEFEE.CMCODECASEID IN (SELECT CMCODECASEID FROM PRPROJECTCODECASE WHERE PRPROJECTID = PRPROJECT.PRPROJECTID)
			GROUP BY	CMCODECASEID
			
			UNION ALL
			SELECT		PLPLANID, SUM(COMPUTEDAMOUNT - AMOUNTPAIDTODATE) AS DUE 
			FROM		PLPLANFEE 
						JOIN CACOMPUTEDFEE ON PLPLANFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
			WHERE		CASTATUSID NOT IN (@IGNORESTATUS5, @IGNORESTATUS10) 
						AND PLPLANFEE.PLPLANID IN (SELECT PLPLANID FROM PRPROJECTPLAN WHERE PRPROJECTID = PRPROJECT.PRPROJECTID)
			GROUP BY	PLPLANID
			
			UNION ALL
			SELECT		PLAPPLICATIONID, SUM(COMPUTEDAMOUNT - AMOUNTPAIDTODATE) AS DUE 
			FROM		PLAPPLICATIONFEE 
						JOIN CACOMPUTEDFEE ON PLAPPLICATIONFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
			WHERE		CASTATUSID NOT IN (@IGNORESTATUS5, @IGNORESTATUS10) 
						AND PLAPPLICATIONFEE.PLAPPLICATIONID IN (SELECT PLAPPLICATIONID FROM PRPROJECTAPPLICATION WHERE PRPROJECTID = PRPROJECT.PRPROJECTID)
			GROUP BY	PLAPPLICATIONID
		)	TOTALS)
	FROM	PRPROJECT
	WHERE	PRPROJECTID = @PROJECTID

	RETURN @BALANCEDUE;
END