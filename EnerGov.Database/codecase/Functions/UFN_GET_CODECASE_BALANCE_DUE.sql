CREATE FUNCTION [codecase].[UFN_GET_CODECASE_BALANCE_DUE]
(
	@ENTITYID char(36)
)
RETURNS MONEY
AS
BEGIN
	DECLARE @BALANCEDUE AS MONEY
	SELECT @BALANCEDUE = ISNULL(SUM([dbo].[CACOMPUTEDFEE].[COMPUTEDAMOUNT] - [dbo].[CACOMPUTEDFEE].[AMOUNTPAIDTODATE]),0)
	FROM [dbo].[CMCODECASE] 
	INNER JOIN [dbo].[CMCODECASEFEE] ON [dbo].[CMCODECASEFEE].[CMCODECASEID] = [dbo].[CMCODECASE].[CMCODECASEID]
	INNER JOIN [dbo].[CACOMPUTEDFEE] ON [dbo].[CMCODECASEFEE].[CACOMPUTEDFEEID] = [dbo].[CACOMPUTEDFEE].[CACOMPUTEDFEEID] AND [dbo].[CACOMPUTEDFEE].[CASTATUSID] NOT IN (10,5) -- DELETED & VOID
	WHERE [dbo].[CMCODECASE].[CMCODECASEID] = @ENTITYID
	RETURN @BALANCEDUE;
END