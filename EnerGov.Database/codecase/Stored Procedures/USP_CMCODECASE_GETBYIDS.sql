CREATE PROCEDURE [codecase].[USP_CMCODECASE_GETBYIDS]
(
	@CMCODECASELIST RecordIDs READONLY,
	@USERID AS CHAR(36) = NULL,
	@ROLEID AS CHAR(36)
)
AS
BEGIN
	SELECT 
		[USERS].[LNAME], 
		[USERS].[FNAME],
		[CMCODECASE].[CMCODECASEID],
		[CMCODECASE].[CASENUMBER],
		PROJECTNAME = (SELECT TOP 1 [PRPROJECT].[NAME] 
			FROM [dbo].[PRPROJECTCODECASE]
			INNER JOIN [PRPROJECT] ON [PRPROJECT].[PRPROJECTID] = [PRPROJECTCODECASE].[PRPROJECTID]
			WHERE [PRPROJECTCODECASE].[CMCODECASEID] = [CMCODECASE].[CMCODECASEID]),
		STATUSNAME = [CMCODECASESTATUS].[NAME],
		TYPENAME = [CMCASETYPE].[NAME], 	 
		[CMCODECASE].[DESCRIPTION],	
		[DISTRICT] = [DISTRICT].[NAME],
		[CMCODECASE].[LASTCHANGEDON],
		[CMCODECASE].[CLOSEDDATE],	
		[CMCODECASE].[EMERGENCY],
		[CMCODECASE].[OPENEDDATE],
		[CMCODECASE].[ASSIGNEDTO],	
		PARCELNUMBER = ISNULL((SELECT TOP 1 PARCEL.PARCELNUMBER		
			FROM CMCODECASEPARCEL
			INNER JOIN [dbo].[PARCEL] ON [dbo].[PARCEL].[PARCELID] = [CMCODECASEPARCEL].[PARCELID]
			WHERE [CMCODECASEPARCEL].[CMCODECASEID] = [CMCODECASE].[CMCODECASEID] AND [CMCODECASEPARCEL].[PRIMARY] = 1),''),
		NUMBEROFVIOLATIONS = (SELECT [codecase].[UFN_GET_CODECASE_VIOLATIONS_COUNT] ([CMCODECASE].[CMCODECASEID])),
		EARLIERDATE = (SELECT [codecase].[UFN_GET_CODECASE_VIOLATIONS_MINDATE] ([CMCODECASE].[CMCODECASEID])),
		[codecase].[UFN_GET_CODECASE_BALANCE_DUE]([CMCODECASE].[CMCODECASEID]) AS BALANCEDUE,
		 [CMCODECASE].[ROWVERSION]
	FROM [dbo].[CMCODECASE]
			LEFT JOIN [CMCASETYPE] ON [CMCASETYPE].[CMCASETYPEID] = [CMCODECASE].[CMCASETYPEID]
			LEFT JOIN [DISTRICT] ON [CMCODECASE].[DISTRICTID] = [DISTRICT].[DISTRICTID]
			INNER JOIN [CMCODECASESTATUS] ON [CMCODECASE].[CMCODECASESTATUSID] = [CMCODECASESTATUS].[CMCODECASESTATUSID]
			LEFT OUTER JOIN [USERS] ON [CMCODECASE].[ASSIGNEDTO] = [USERS].[SUSERGUID]
			INNER JOIN @CMCODECASELIST CMCODECASELIST ON [CMCODECASE].[CMCODECASEID] = [CMCODECASELIST].[RECORDID]
			LEFT OUTER JOIN [RECENTHISTORYCODECASE] ON [RECENTHISTORYCODECASE].[CODECASEID] = [CMCODECASE].[CMCODECASEID] AND [RECENTHISTORYCODECASE].[USERID] = @USERID
	ORDER BY [RECENTHISTORYCODECASE].[LOGGEDDATETIME] DESC

EXEC [codecase].[USP_CMCODECASEADDRESS_GETBYIDS] @CMCODECASELIST
EXEC [codecase].[USP_CMCODECASECONTACT_GETBYIDS] @CMCODECASELIST, @ROLEID
EXEC [codecase].[USP_CMCODECASEVIOLATOR_GETBYIDS] @CMCODECASELIST, @ROLEID
EXEC [codecase].[USP_CMCODECASEVIOLATORADDRESS_GETBYIDS] @CMCODECASELIST

END