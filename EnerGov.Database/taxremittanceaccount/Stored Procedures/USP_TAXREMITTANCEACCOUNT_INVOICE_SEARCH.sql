CREATE PROCEDURE [taxremittanceaccount].[USP_TAXREMITTANCEACCOUNT_INVOICE_SEARCH]
(
    @TXREMITTANCEACCOUNTID AS CHAR(36),
    @PAGE_NUMBER AS INT = 1,
    @PAGE_SIZE AS INT = 10,
    @SORT_FIELD AS NVARCHAR(50) = '',
    @IS_ASCENDING AS BIT = 0,
    @START_DATE DATE = NULL,
    @END_DATE DATE = NULL
)
AS
BEGIN
SET NOCOUNT ON;
;WITH RAW_DATA
   AS(
        SELECT DISTINCT [dbo].[CAINVOICE].CAINVOICEID,
        [dbo].[CAINVOICE].INVOICENUMBER,
        [dbo].[CAINVOICE].INVOICETOTAL,
        [dbo].[CAINVOICE].INVOICEDATE,
        [dbo].[CAINVOICE].INVOICEDUEDATE,
        [dbo].[CASTATUS].NAME AS INVOICESTATUS
        FROM [dbo].[TXREMITTANCEFEE]
        JOIN [dbo].[TXREMITTANCE]
        ON [dbo].[TXREMITTANCEFEE].TXREMITTANCEID = [dbo].[TXREMITTANCE].TXREMITTANCEID
        JOIN [dbo].[CACOMPUTEDFEE]
        ON [dbo].[CACOMPUTEDFEE].CACOMPUTEDFEEID=[dbo].[TXREMITTANCEFEE].CACOMPUTEDFEEID
        JOIN [dbo].[CAINVOICEFEE]
        ON [dbo].[CAINVOICEFEE].CACOMPUTEDFEEID=[dbo].[CACOMPUTEDFEE].CACOMPUTEDFEEID
        JOIN [dbo].[CAINVOICE]
        ON [dbo].[CAINVOICE].CAINVOICEID=[dbo].[CAINVOICEFEE].CAINVOICEID
        JOIN [dbo].[CASTATUS]
        ON [dbo].[CASTATUS].CASTATUSID=[dbo].[CAINVOICE].CASTATUSID
        WHERE [dbo].[TXREMITTANCE].TXREMITTANCEACCOUNTID=@TXREMITTANCEACCOUNTID
        AND ((@START_DATE IS NULL OR @END_DATE IS NULL) OR ((@START_DATE IS NOT NULL AND @END_DATE IS NOT NULL) AND ([dbo].[TXREMITTANCE].REPORTEDDATE BETWEEN @START_DATE AND @END_DATE)))
		AND ((@START_DATE IS NULL OR @END_DATE IS NULL) OR ((@START_DATE IS NOT NULL AND @END_DATE IS NOT NULL) AND ([dbo].[CAINVOICE].INVOICEDATE BETWEEN @START_DATE AND @END_DATE)))
)
SELECT * FROM( SELECT CAINVOICEID,INVOICENUMBER,
INVOICETOTAL,INVOICEDATE,INVOICEDUEDATE,INVOICESTATUS,
COUNT(1) OVER() AS TotalRows,
(CASE WHEN @IS_ASCENDING =1
        THEN
        CASE
            WHEN @SORT_FIELD = 'caInvoiceId' THEN ROW_NUMBER() OVER(ORDER BY CAINVOICEID ASC)
            WHEN  @SORT_FIELD= 'invoiceNumber' THEN ROW_NUMBER() OVER(ORDER BY INVOICENUMBER ASC)
            WHEN  @SORT_FIELD= 'invoiceTotal' THEN ROW_NUMBER() OVER(ORDER BY INVOICETOTAL ASC)
            WHEN  @SORT_FIELD= 'invoiceDate' THEN ROW_NUMBER() OVER(ORDER BY INVOICEDATE ASC)
            WHEN  @SORT_FIELD= 'invoiceDueDate' THEN ROW_NUMBER() OVER(ORDER BY INVOICEDUEDATE ASC)
            WHEN  @SORT_FIELD= 'invoiceStatus' THEN ROW_NUMBER() OVER(ORDER BY INVOICESTATUS ASC)
            ELSE ROW_NUMBER() OVER(ORDER BY INVOICEDUEDATE ASC)
        END
        WHEN @IS_ASCENDING=0
        THEN
        CASE
            WHEN  @SORT_FIELD = 'caInvoiceId' THEN ROW_NUMBER() OVER(ORDER BY CAINVOICEID DESC)
            WHEN  @SORT_FIELD= 'invoiceNumber' THEN ROW_NUMBER() OVER(ORDER BY INVOICENUMBER DESC)
            WHEN  @SORT_FIELD= 'invoiceTotal' THEN ROW_NUMBER() OVER(ORDER BY INVOICETOTAL DESC)
            WHEN  @SORT_FIELD= 'invoiceDate' THEN ROW_NUMBER() OVER(ORDER BY INVOICEDATE DESC)
            WHEN  @SORT_FIELD= 'invoiceDueDate' THEN ROW_NUMBER() OVER(ORDER BY INVOICEDUEDATE DESC)
            WHEN  @SORT_FIELD= 'invoiceStatus' THEN ROW_NUMBER() OVER(ORDER BY INVOICESTATUS DESC)
            ELSE ROW_NUMBER() OVER(ORDER BY INVOICEDUEDATE DESC)
        END
        END) AS RowNumber
FROM RAW_DATA) AS Result
WHERE
    RowNumber > @PAGE_SIZE * (@PAGE_NUMBER - 1) AND
    RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY
    RowNumber
END