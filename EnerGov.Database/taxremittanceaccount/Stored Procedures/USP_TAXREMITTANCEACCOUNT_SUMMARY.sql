CREATE PROCEDURE [TAXREMITTANCEACCOUNT].[USP_TAXREMITTANCEACCOUNT_SUMMARY]
(
	@TXREMITTANCEACCOUNTID AS CHAR(36)
)
AS

DECLARE @NEXTDUEDATE AS DATETIME = NULL
DECLARE @BALANCEDUE AS MONEY

SELECT @NEXTDUEDATE = MIN(TXBILLPERIOD.DUEDATE)
			FROM [dbo].[TXBILLPERIOD]
				INNER JOIN TXRPTPERIOD ON TXRPTPERIOD.TXRPTPERIODID = TXBILLPERIOD.RPTPERIODREF
				INNER JOIN TXREMITTANCEACCOUNT ON TXREMITTANCEACCOUNT.REPORTPERIODID = TXRPTPERIOD.TXRPTPERIODID		
			WHERE [dbo].[TXBILLPERIOD].DUEDATE >= GETDATE() AND TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID = @TXREMITTANCEACCOUNTID				

SELECT @BALANCEDUE = ISNULL(SUM(CACOMPFEE.COMPUTEDAMOUNT - CACOMPFEE.AMOUNTPAIDTODATE),0)
			FROM TXREMITTANCEFEE
					INNER JOIN TXREMITTANCE 
								ON TXREMITTANCEFEE.TXREMITTANCEID = TXREMITTANCE.TXREMITTANCEID
					INNER JOIN CACOMPUTEDFEE CACOMPFEE 
								ON TXREMITTANCEFEE.CACOMPUTEDFEEID = CACOMPFEE.CACOMPUTEDFEEID AND CACOMPFEE.CASTATUSID NOT IN (10,5) -- DELETED & VOID
			WHERE TXREMITTANCE.TXREMITTANCEACCOUNTID = @TXREMITTANCEACCOUNTID


SELECT 
	TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID,
	TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER AS REMITTANCEACCOUNTNUMBER,
	BLGLOBALENTITYEXTENSION.COMPANYNAME,		
	BLGLOBALENTITYEXTENSION.DBA,
	TXREMITSTATUS.NAME AS [STATUS],
	TXREMITTANCEACCOUNT.OPENDATE,
	CASE
		WHEN TXREMITSTATUS.TXREMITSTATUSSYSTEMID = 1	
		THEN @NEXTDUEDATE
		ELSE NULL
	END AS [DUEDATE],
	TXREMITTANCETYPE.NAME AS [TAXREMACCOUNTTYPENAME],
	TXRPTPERIOD.NAME [REPORTPERIOD],
	@BALANCEDUE AS [BALANCEDUE],
	BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEID,
	BLEXTCOMPANYTYPE.NAME AS [COMPANYTYPE],
	BLEXTSTATUS.NAME AS [BUSINESSSTATUS],
	BLEXTLOCATION.NAME AS [BUSINESSLOCATION],
	BLGLOBALENTITYEXTENSION.OPENDATE AS [BUSINESSOPENDATE],
	MAILINGADDRESS.ADDRESSLINE1,
	MAILINGADDRESS.ADDRESSLINE2,
	MAILINGADDRESS.ADDRESSLINE3,
	MAILINGADDRESS.ADDRESSTYPE,
	MAILINGADDRESS.CITY,
	MAILINGADDRESS.COUNTRY,
	MAILINGADDRESS.POBOX,
	MAILINGADDRESS.POSTALCODE,
	MAILINGADDRESS.PREDIRECTION,
	MAILINGADDRESS.PROVINCE,
	MAILINGADDRESS.RURALROUTE,
	MAILINGADDRESS.STATE,
	MAILINGADDRESS.STATION,
	TXREMITTANCEACCOUNT.BLGLOBALENTITYEXTENSIONID

		FROM TXREMITTANCEACCOUNT		
					INNER JOIN [TXREMITSTATUS]
						ON TXREMITTANCEACCOUNT.[TXREMITTANCESTATUSID]=TXREMITSTATUS.TXREMITSTATUSID
					INNER JOIN [TXREMITTANCETYPE]
						ON TXREMITTANCEACCOUNT.TXREMITTANCETYPEID=TXREMITTANCETYPE.TXREMITTANCETYPEID
					INNER JOIN [BLGLOBALENTITYEXTENSION]
						ON TXREMITTANCEACCOUNT.BLGLOBALENTITYEXTENSIONID= BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
					INNER JOIN BLEXTCOMPANYTYPE
						ON BLGLOBALENTITYEXTENSION.BLEXTCOMPANYTYPEID =  BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEID
					INNER JOIN BLEXTSTATUS 
						ON BLGLOBALENTITYEXTENSION.BLEXTSTATUSID = BLEXTSTATUS.BLEXTSTATUSID
					INNER JOIN BLEXTLOCATION 
						ON BLGLOBALENTITYEXTENSION.BLEXTLOCATIONID = BLEXTLOCATION.BLEXTLOCATIONID
					INNER JOIN TXRPTPERIOD
						ON TXREMITTANCEACCOUNT.REPORTPERIODID = TXRPTPERIOD.TXRPTPERIODID		
					LEFT JOIN [TXREMITTANCEACCOUNTADDRESS]
					ON TXREMITTANCEACCOUNTADDRESS.TXREMITTANCEACCOUNTID=TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID
					AND ISNULL(TXREMITTANCEACCOUNTADDRESS.MAIN,0)=1  
					LEFT JOIN [MAILINGADDRESS] 
					ON MAILINGADDRESS.MAILINGADDRESSID=TXREMITTANCEACCOUNTADDRESS.MAILINGADDRESSID

		WHERE TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID =  @TXREMITTANCEACCOUNTID

	
SELECT  GLOBALENTITY.GLOBALENTITYID AS [ENTITYID],
		GLOBALENTITY.FIRSTNAME,
		GLOBALENTITY.LASTNAME,
		GLOBALENTITY.GLOBALENTITYNAME AS [COMPANYNAME],
		GLOBALENTITY.TITLE,
		TXREMACCCONTACT.ISBILLING,
		BLCONTACTTYPE.NAME AS CONTACTTYPENAME,
		BLCONTACTTYPE.BLCONTACTTYPEID AS [CONTACTTYPEID]
	FROM TXREMACCCONTACT 
		INNER JOIN GLOBALENTITY ON TXREMACCCONTACT.GLOBALENTITYID = GLOBALENTITY.GLOBALENTITYID
		INNER JOIN BLCONTACTTYPE ON BLCONTACTTYPE.BLCONTACTTYPEID = TXREMACCCONTACT.BLCONTACTTYPEID
	WHERE TXREMACCCONTACT.TXREMITTANCEACCOUNTID = @TXREMITTANCEACCOUNTID
		AND TXREMACCCONTACT.GLOBALENTITYID = (SELECT TOP 1 TXREMACCCONTACT.GLOBALENTITYID
			FROM TXREMACCCONTACT WHERE TXREMACCCONTACT.TXREMITTANCEACCOUNTID = @TXREMITTANCEACCOUNTID
			AND TXREMACCCONTACT.ISBILLING=1)