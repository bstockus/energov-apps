CREATE PROCEDURE [common].[USP_CUSTOMFIELDPICKLISTITEM_GETBYFIELDLABELNAME]
(
 @CLASSNAME NVARCHAR(MAX),
 @PROPERTYNAME NVARCHAR(MAX),
 @FRIENDLYPROPERTYNAME NVARCHAR(MAX),
 @CUSTOMFIELDNAME NVARCHAR(MAX)
)
AS
BEGIN
DECLARE @CUSTOMFIELDLIST RecordIds

	INSERT INTO @CUSTOMFIELDLIST
	SELECT TOP 1 [dbo].[CUSTOMFIELD].[GCUSTOMFIELD]
	FROM [dbo].[CUSTOMFIELD] JOIN [dbo].[CUSTOMFIELDOBJECT] ON [dbo].[CUSTOMFIELD].[GCUSTOMFIELD] = [dbo].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELD]
	JOIN [dbo].[CUSTOMFIELDLAYOUT] ON [dbo].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [dbo].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
	JOIN [dbo].[CUSTOMFIELDMODULES] ON [dbo].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [dbo].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
	WHERE [dbo].[CUSTOMFIELD].[GCUSTOMFIELD] NOT IN (SELECT [dbo].[NONSEARCHABLE_CUSTOMFIELDSVIEW].[GCUSTOMFIELD] FROM [dbo].[NONSEARCHABLE_CUSTOMFIELDSVIEW])
	AND ((@CLASSNAME LIKE '%CustomFieldTable%' AND LEN(@PROPERTYNAME) > 0 AND [dbo].[CUSTOMFIELD].[SFIELDNAME] = @PROPERTYNAME)
	OR ([dbo].[CUSTOMFIELD].[SFIELDNAME] = @CUSTOMFIELDNAME AND ([dbo].[CUSTOMFIELDOBJECT].[SLABEL] + ' (' + [dbo].[CUSTOMFIELDLAYOUT].[SNAME] + ')') = @FRIENDLYPROPERTYNAME)
	)
	ORDER BY [dbo].[CUSTOMFIELD].[SFIELDNAME]

IF NOT EXISTS (SELECT * FROM @CUSTOMFIELDLIST)
    INSERT INTO @CUSTOMFIELDLIST
	SELECT TOP 1 [dbo].[CUSTOMFIELD].[GCUSTOMFIELD]
	FROM [dbo].[CUSTOMFIELD] JOIN [dbo].[CUSTOMFIELDOBJECT] ON [dbo].[CUSTOMFIELD].[GCUSTOMFIELD] = [dbo].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELD]
	JOIN [dbo].[CUSTOMFIELDLAYOUT] ON [dbo].[CUSTOMFIELDOBJECT].[FKGCUSTOMFIELDLAYOUT] = [dbo].[CUSTOMFIELDLAYOUT].[GCUSTOMFIELDLAYOUTS]
	JOIN [dbo].[CUSTOMFIELDMODULES] ON [dbo].[CUSTOMFIELDLAYOUT].[CUSTOMFIELDMODULEID] = [dbo].[CUSTOMFIELDMODULES].[CUSTOMFIELDMODULEID]
	WHERE [dbo].[CUSTOMFIELD].[GCUSTOMFIELD] NOT IN (SELECT [dbo].[NONSEARCHABLE_CUSTOMFIELDSVIEW].[GCUSTOMFIELD] FROM [dbo].[NONSEARCHABLE_CUSTOMFIELDSVIEW])
	AND [dbo].[CUSTOMFIELD].[SFIELDNAME] = @CUSTOMFIELDNAME
	ORDER BY [dbo].[CUSTOMFIELD].[SFIELDNAME]

SELECT [dbo].[CUSTOMFIELDPICKLISTITEM].[GCUSTOMFIELDPICKLISTITEM],[dbo].[CUSTOMFIELDPICKLISTITEM].[SVALUE] FROM [dbo].[CUSTOMFIELDPICKLISTITEM] JOIN [dbo].[CUSTOMFIELDPICKLIST] ON 
[dbo].[CUSTOMFIELDPICKLISTITEM].[FKGCUSTOMFIELDPICKLIST] = [dbo].[CUSTOMFIELDPICKLIST].[GCUSTOMFIELDPICKLIST]
JOIN @CUSTOMFIELDLIST CUSTOMFIELDLIST ON [dbo].[CUSTOMFIELDPICKLIST].[FKGCUSTOMFIELD] = [CUSTOMFIELDLIST].[RECORDID]
ORDER BY [dbo].[CUSTOMFIELDPICKLISTITEM].[IORDER]

END