CREATE PROCEDURE [managecontacts].[USP_LINKEDRECORDS_GETBYGLOBALENTITYID]          
(@GLOBALENTITYID CHAR(36))          
AS          
BEGIN          
    SET NOCOUNT ON;    
 SELECT     
   'Business License' AS MODULE,      
   [BLLICENSE].[LICENSENUMBER] AS CASENUMBER,      
   [BLLICENSETYPE].[NAME] AS CASETYPE,      
   [BLLICENSECLASS].[NAME] AS WORKCLASS,      
   CASE     
  WHEN ([BLGLOBALENTITYEXTENSION].[GLOBALENTITYID] = @GLOBALENTITYID)    
   THEN ''    
  ELSE    
   'Contact'    
   END AS ADDITIONALINFO    
   FROM      
   [dbo].[BLLICENSE]      
   INNER JOIN [dbo].[BLLICENSETYPE] ON [BLLICENSE].[BLLICENSETYPEID] = [BLLICENSETYPE].[BLLICENSETYPEID]      
   INNER JOIN [dbo].[BLLICENSECLASS] ON [BLLICENSE].[BLLICENSECLASSID] = [BLLICENSECLASS].[BLLICENSECLASSID]      
   INNER JOIN [dbo].[BLGLOBALENTITYEXTENSION] ON [BLLICENSE].[BLGLOBALENTITYEXTENSIONID] = [BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID]      
   WHERE     
   ([BLGLOBALENTITYEXTENSION].[GLOBALENTITYID] = @GLOBALENTITYID       
   OR      
   (EXISTS (SELECT 1 FROM [dbo].[BLLICENSECONTACT]      
     WHERE [BLLICENSECONTACT].[BLLICENSEID] = [BLLICENSE].[BLLICENSEID]      
  AND [BLLICENSECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID)))      
    
  UNION ALL  
    
  SELECT     
   'Professional License' AS MODULE,      
   ILLICENSE.[LICENSENUMBER] AS CASENUMBER ,      
   [ILLICENSETYPE].[NAME] AS CASETYPE,      
   '' AS WORKCLASS,      
   CASE     
  WHEN ([ILLICENSE].[GLOBALENTITYID] = @GLOBALENTITYID)    
   THEN 'Licensee'    
  ELSE    
   'License Contact'    
   END AS ADDITIONALINFO    
   FROM      
   [dbo].[ILLICENSE]      
   INNER JOIN [dbo].[ILLICENSETYPE] ON [ILLICENSE].[ILLICENSETYPEID] = [ILLICENSETYPE].[ILLICENSETYPEID]      
   WHERE     
   ([ILLICENSE].[GLOBALENTITYID] = @GLOBALENTITYID       
   OR      
   (EXISTS (SELECT 1 FROM [dbo].[ILLICENSECONTACT]      
     WHERE [ILLICENSECONTACT].[ILLICENSEID] = [ILLICENSE].[ILLICENSEID]      
  AND [ILLICENSECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID)))  
    
  UNION ALL   
    
   SELECT    
   'Application' AS MODULE,    
   [PLAPPLICATION].[APPNUMBER] AS CASENUMBER,    
   [PLAPPLICATIONTYPE].[APPLICATIONTYPENAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[PLAPPLICATION]    
   INNER JOIN [dbo].[PLAPPLICATIONCONTACT] ON [PLAPPLICATION].[PLAPPLICATIONID] = [PLAPPLICATIONCONTACT].[PLAPPLICATIONID]    
   INNER JOIN [dbo].[PLAPPLICATIONTYPE] ON [PLAPPLICATION].[PLAPPLICATIONTYPEID] = [PLAPPLICATIONTYPE].[PLAPPLICATIONTYPEID]    
   WHERE [PLAPPLICATIONCONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID  
     
    UNION ALL  
    
    SELECT    
   'Inspection' AS MODULE,    
   [IMINSPECTION].[INSPECTIONNUMBER] AS CASENUMBER,    
   [IMINSPECTIONTYPE].[NAME] AS CASETYPE,    
    '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[IMINSPECTIONCONTACT]    
   INNER JOIN [dbo].[IMINSPECTION] ON [IMINSPECTION].[IMINSPECTIONID] = [IMINSPECTIONCONTACT].[IMINSPECTIONID]    
   INNER JOIN [dbo].[IMINSPECTIONTYPE] ON [IMINSPECTION].[IMINSPECTIONTYPEID] = [IMINSPECTIONTYPE].[IMINSPECTIONTYPEID]    
   WHERE [IMINSPECTIONCONTACT].[GLOBALENTITYID] = @GLOBALENTITYID  
     
   UNION ALL
    
    SELECT    
   'Project' AS MODULE,    
   [PRPROJECT].[PROJECTNUMBER] AS CASENUMBER,    
   [PRPROJECTTYPE].[NAME] AS CASETYPE,    
    '' AS WORKCLASS,    
   '' AS ADDITIONALINFO   
   FROM    
   [dbo].[PRPROJECTCONTACT]    
   INNER JOIN [dbo].[PRPROJECT] ON [PRPROJECTCONTACT].[PRPROJECTID] = [PRPROJECT].[PRPROJECTID]    
   INNER JOIN [dbo].[PRPROJECTTYPE] ON [PRPROJECT].[PRPROJECTTYPEID] = [PRPROJECTTYPE].[PRPROJECTTYPEID]    
   WHERE [PRPROJECTCONTACT].[GLOBALENTITYID] = @GLOBALENTITYID   
     
    UNION ALL  
    
    SELECT    
   'Code Case' AS MODULE,    
   [CMCODECASE].[CASENUMBER] AS CASENUMBER,    
   [CMCASETYPE].[NAME] AS CASETYPE,    
    '' AS WORKCLASS,    
   '' AS ADDITIONALINFO   
   FROM    
   [dbo].[CMCODECASECONTACT]    
   INNER JOIN [dbo].[CMCODECASE] ON [CMCODECASECONTACT].[CMCODECASEID] = [CMCODECASE].[CMCODECASEID]    
   INNER JOIN [dbo].[CMCASETYPE] ON [CMCODECASE].[CMCASETYPEID] = [CMCASETYPE].[CMCASETYPEID]    
   WHERE [CMCODECASECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID   
     
   UNION ALL
    
   SELECT    
   'Remittance Account' AS MODULE,    
   [TXREMITTANCEACCOUNT].[REMITTANCEACCOUNTNUMBER] AS CASENUMBER,    
   [TXREMITTANCETYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[TXREMITTANCEACCOUNT]    
   INNER JOIN [dbo].[TXREMACCCONTACT] ON [TXREMITTANCEACCOUNT].[TXREMITTANCEACCOUNTID] = [TXREMACCCONTACT].[TXREMITTANCEACCOUNTID]    
   INNER JOIN [dbo].[TXREMITTANCETYPE] ON TXREMITTANCEACCOUNT.[TXREMITTANCETYPEID] = [TXREMITTANCETYPE].[TXREMITTANCETYPEID]    
   WHERE [TXREMACCCONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID  
     
   UNION ALL
    
   SELECT    
   'Rental Property' AS MODULE,    
   [RPPROPERTY].[PROPERTYNUMBER] AS CASENUMBER,    
   [RPPROPERTYTYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[RPPROPERTY]    
   INNER JOIN [dbo].[RPPROPERTYCONTACT] ON [RPPROPERTY].[RPPROPERTYID] = [RPPROPERTYCONTACT].[RPPROPERTYID]    
   INNER JOIN [dbo].[RPPROPERTYTYPE] ON [RPPROPERTY].[RPPROPERTYTYPEID] = [RPPROPERTYTYPE].[RPPROPERTYTYPEID]    
   WHERE [RPPROPERTYCONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID   
  
   UNION ALL 
  
   SELECT     
   'Landlord License' AS MODULE,      
   [RPLANDLORDLICENSE].[LANDLORDNUMBER] AS CASENUMBER,      
   [RPLANDLORDLICENSETYPE].[NAME] AS CASETYPE,      
   '' AS WORKCLASS,      
   CASE     
  WHEN ([RPLANDLORDLICENSECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID)    
   THEN 'Contact'    
  ELSE    
   'LandLord'    
   END AS ADDITIONALINFO    
   FROM      
   [dbo].[RPLANDLORDLICENSE]      
   INNER JOIN [dbo].[RPLANDLORDLICENSETYPE] ON [RPLANDLORDLICENSE].[RPLANDLORDLICENSETYPEID] = [RPLANDLORDLICENSETYPE].[RPLANDLORDLICENSETYPEID]      
   LEFT OUTER JOIN [dbo].[RPLANDLORDLICENSECONTACT] ON [RPLANDLORDLICENSE].[RPLANDLORDLICENSEID] = [RPLANDLORDLICENSECONTACT].[RPLANDLORDLICENSEID]      
   WHERE     
   ([RPLANDLORDLICENSE].[GLOBALENTITYID] = @GLOBALENTITYID   
     OR [RPLANDLORDLICENSECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID)  
  
  UNION ALL
    
   SELECT    
   'Permit Renewal Case' AS MODULE,    
   [PMRENEWALCASE].[NUMBER] AS CASENUMBER,    
   [PMRENEWALCASETYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[PMRENEWALCASE]    
   INNER JOIN [dbo].[PMRENEWALCASETYPE] ON [PMRENEWALCASE].[PMRENEWALCASETYPEID] = [PMRENEWALCASETYPE].[PMRENEWALCASETYPEID]    
   WHERE [PMRENEWALCASE].[BILLINGCONTACTID] =  @GLOBALENTITYID  
     
   UNION ALL 
    
   SELECT    
   'Impact Case' AS MODULE,    
   [IPCASE].[CASENUMBER] AS CASENUMBER,    
   [IPCASETYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[IPCASE]    
   INNER JOIN [dbo].[IPCASECONTACT] ON [IPCASE].[IPCASEID] = [IPCASECONTACT].[IPCASEID]  
   INNER JOIN [dbo].[IPCASETYPE] ON [IPCASE].[IPCASETYPEID] = [IPCASETYPE].[IPCASETYPEID]    
   WHERE [IPCASECONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID   
  
   UNION ALL 
    
   SELECT    
   'Invoice' AS MODULE,    
   [CAINVOICE].[INVOICENUMBER] AS CASENUMBER,    
   [CASTATUS].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[CAINVOICE]    
   INNER JOIN [dbo].[CASTATUS] ON [CAINVOICE].[CASTATUSID] = [CASTATUS].[CASTATUSID]   
   WHERE [CAINVOICE].[GLOBALENTITYID] =  @GLOBALENTITYID  
  
   UNION ALL  
    
   SELECT    
   'Receipt(Transaction)' AS MODULE,    
   [CATRANSACTION].[RECEIPTNUMBER] AS CASENUMBER,    
   [CATRANSACTIONTYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   [CATRANSACTIONSTATUS].[NAME] AS ADDITIONALINFO  
   FROM    
   [dbo].[CATRANSACTION]    
   INNER JOIN [dbo].[CATRANSACTIONTYPE] ON [CATRANSACTION].[CATRANSACTIONTYPEID] = [CATRANSACTIONTYPE].[CATRANSACTIONTYPEID]  
   INNER JOIN [dbo].[CATRANSACTIONSTATUS] ON [CATRANSACTION].[CATRANSACTIONSTATUSID] = [CATRANSACTIONSTATUS].[CATRANSACTIONSTATUSID]   
   WHERE [CATRANSACTION].[GLOBALENTITYID] =  @GLOBALENTITYID  
  
   UNION ALL 
    
   SELECT    
   'Cashier' AS MODULE,    
   [GLOBALENTITYACCOUNT].[ACCOUNTNUMBER] AS CASENUMBER,    
   [GLOBALENTITYACCOUNTTYPE].[TYPENAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   'Balance: $' + CONVERT(VARCHAR,[GLOBALENTITYACCOUNT].[BALANCE]) AS ADDITIONALINFO  
   FROM    
   [dbo].[GLOBALENTITYACCOUNTENTITY]    
   INNER JOIN [dbo].[GLOBALENTITYACCOUNT] ON [GLOBALENTITYACCOUNTENTITY].[GLOBALENTITYACCOUNTID] = [GLOBALENTITYACCOUNT].[GLOBALENTITYACCOUNTID]  
   INNER JOIN [dbo].[GLOBALENTITYACCOUNTTYPE] ON [GLOBALENTITYACCOUNT].[GLOBALENTITYACCOUNTTYPEID] = [GLOBALENTITYACCOUNTTYPE].[GLOBALENTITYACCOUNTTYPEID]   
   WHERE [GLOBALENTITYACCOUNTENTITY].[GLOBALENTITYID] =  @GLOBALENTITYID  
  
   UNION ALL 
    
   SELECT    
   'Citizen Request' AS MODULE,    
   [CITIZENREQUEST].[REQUESTNUMBER] AS CASENUMBER,    
   [CITIZENREQUESTTYPE].[NAME] AS CASETYPE,    
   '' AS WORKCLASS,    
   '' AS ADDITIONALINFO  
   FROM    
   [dbo].[CITIZENREQUESTCALLERXREF]    
   INNER JOIN [dbo].[CITIZENREQUEST] ON [CITIZENREQUESTCALLERXREF].[CITIZENREQUESTID] = [CITIZENREQUEST].[CITIZENREQUESTID]  
   INNER JOIN [dbo].[CITIZENREQUESTTYPE] ON CITIZENREQUEST.[CITIZENREQUESTTYPEID] = [CITIZENREQUESTTYPE].[CITIZENREQUESTTYPEID]   
   WHERE [CITIZENREQUESTCALLERXREF].[GLOBALENTITYID] =  @GLOBALENTITYID  
  
   UNION ALL
  
   SELECT     
   'Business' AS MODULE,      
   [BLGLOBALENTITYEXTENSION].[REGISTRATIONID] AS CASENUMBER,      
   [BLEXTCOMPANYTYPE].[NAME] AS CASETYPE,      
   '' AS WORKCLASS,      
   CASE     
  WHEN ([BLGLOBALENTITYEXTENSION].[GLOBALENTITYID] = @GLOBALENTITYID)    
   THEN   
   'Business ' +   
     CASE WHEN ([BLGLOBALENTITYEXTENSION].[DBA] IS NOT NULL AND [BLGLOBALENTITYEXTENSION].[DBA] <> '')  
  THEN 'dba: ' + [BLGLOBALENTITYEXTENSION].[DBA]  
  ELSE '' END  
  ELSE    
   'Contact'    
   END AS ADDITIONALINFO    
   FROM      
   [dbo].[BLGLOBALENTITYEXTENSION]      
   INNER JOIN [dbo].[BLEXTCOMPANYTYPE] ON [BLGLOBALENTITYEXTENSION].[BLEXTCOMPANYTYPEID] = [BLEXTCOMPANYTYPE].[BLEXTCOMPANYTYPEID]      
   WHERE     
   ([BLGLOBALENTITYEXTENSION].[GLOBALENTITYID] = @GLOBALENTITYID       
   OR      
   (EXISTS (SELECT 1 FROM [dbo].[BLGLOBALENTITYEXTENSIONCONTACT]      
     WHERE [BLGLOBALENTITYEXTENSIONCONTACT].[BLGLOBALENTITYEXTENSIONID] = [BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID]      
  AND [BLGLOBALENTITYEXTENSIONCONTACT].[GLOBALENTITYID] = @GLOBALENTITYID)))

  UNION ALL

   SELECT     
 'Permit' AS MODULE,    
 [PMPERMIT].[PERMITNUMBER] AS CASENUMBER,    
 [PMPERMITTYPE].[NAME] AS CASETYPE,    
 [PMPERMITWORKCLASS].[NAME] AS WORKCLASS,    
 [PMPERMITADDRESS].[PMPERMITADDRESSID] AS ADDITIONALINFO
 FROM     
 [dbo].[PMPERMITCONTACT]    
 INNER JOIN [dbo].[PMPERMIT] ON [PMPERMITCONTACT].[PMPERMITID] = [PMPERMIT].[PMPERMITID]    
 INNER JOIN [dbo].[PMPERMITTYPE] ON [PMPERMIT].[PMPERMITTYPEID] = [PMPERMITTYPE].[PMPERMITTYPEID]    
 INNER JOIN [dbo].[PMPERMITWORKCLASS] ON [PMPERMIT].[PMPERMITWORKCLASSID] = [PMPERMITWORKCLASS].[PMPERMITWORKCLASSID]    
 LEFT OUTER JOIN [dbo].[PMPERMITADDRESS] ON [PMPERMIT].[PMPERMITID] = [PMPERMITADDRESS].[PMPERMITID]    
 LEFT OUTER JOIN [dbo].[MAILINGADDRESS] ON [MAILINGADDRESS].[MAILINGADDRESSID] = [PMPERMITADDRESS].[MAILINGADDRESSID]    
    WHERE [PMPERMITCONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID  

  UNION ALL

  SELECT     
  'Plan' AS MODULE,    
  [PLPLAN].[PLANNUMBER] AS CASENUMBER,    
  [PLPLANTYPE].[PLANNAME] AS CASETYPE,    
  [PLPLANWORKCLASS].[NAME]AS WORKCLASS,    
  [PLPLANADDRESS].[PLPLANADDRESSID] AS ADDITIONALINFO
  FROM    
  [dbo].[PLPLANCONTACT]    
  INNER JOIN [dbo].[PLPLAN] ON [PLPLANCONTACT].[PLPLANID] = [PLPLAN].[PLPLANID]    
  INNER JOIN [dbo].[PLPLANTYPE] ON [PLPLAN].[PLPLANTYPEID] = [PLPLANTYPE].[PLPLANTYPEID]    
  INNER JOIN [dbo].[PLPLANWORKCLASS] ON [PLPLAN].[PLPLANWORKCLASSID] = [PLPLANWORKCLASS].[PLPLANWORKCLASSID]    
  LEFT OUTER JOIN [dbo].[PLPLANADDRESS] ON [PLPLAN].[PLPLANID] = [PLPLANADDRESS].[PLPLANID]    
  LEFT OUTER JOIN [dbo].[MAILINGADDRESS] ON [MAILINGADDRESS].[MAILINGADDRESSID] = [PLPLANADDRESS].[MAILINGADDRESSID]    
  WHERE [PLPLANCONTACT].[GLOBALENTITYID] =  @GLOBALENTITYID  
  
  EXEC [managecontacts].[USP_LINKEDRECORDSPERMITPLAN_GETBYGLOBALENTITYID] @GLOBALENTITYID
    
END;