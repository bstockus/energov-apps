CREATE PROCEDURE [managecontacts].[USP_INVOICES_DUE_FEE_CHILDREN]        
(@GLOBALENTITYID CHAR(36))        
AS        
BEGIN        
    SET NOCOUNT ON;        

	SELECT    
	[CACOMPUTEDFEE].[FEENAME],
	COALESCE(
		[PERMITENTITY].[ENTITYNUMBER],
		[PLANENTITY].[ENTITYNUMBER],
		[APPLICATIONENTITY].[ENTITYNUMBER],
		[PROJECTENTITY].[ENTITYNUMBER],
		[CODECASEENTITY].[ENTITYNUMBER],
		[VIOLATIONENTITY].[ENTITYNUMBER],
		[INSPECTIONENTITY].[ENTITYNUMBER],
		[BUSINESSLICENSEENTITY].[ENTITYNUMBER],
		[PROFESSIONALLICENSEENTITY].[ENTITYNUMBER],
		[IMPACTENTITY].[ENTITYNUMBER],
		[TAXENTITY].[ENTITYNUMBER],
		[RENTALPROPERTYENTITY].[ENTITYNUMBER],
		[LANDLORDLICENSEENTITY].[ENTITYNUMBER],
		'') AS [ENTITYNUMBER],
	CAST (0 AS BIT) AS [ISMISCFEE],
	[CACOMPUTEDFEE].[COMPUTEDAMOUNT] - [CACOMPUTEDFEE].[AMOUNTPAIDTODATE] AS [AMOUNTDUE],
	[CAINVOICE].[CAINVOICEID],
	[CACOMPUTEDFEE].[CACOMPUTEDFEEID] AS [FEEUNIQUEID]
	FROM    
	[dbo].[CAINVOICEFEE]  
	JOIN [dbo].[CAINVOICE] ON [CAINVOICE].[CAINVOICEID] = [CAINVOICEFEE].[CAINVOICEID]
	JOIN [dbo].[CAINVOICECONTACT] ON [CAINVOICECONTACT].[CAINVOICEID] = [CAINVOICE].[CAINVOICEID]
	JOIN [dbo].[CACOMPUTEDFEE] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [CAINVOICEFEE].[CACOMPUTEDFEEID]
	JOIN [dbo].[CASTATUS] ON [CAINVOICE].[CASTATUSID] = [CASTATUS].[CASTATUSID]   
	
	--Below is what it takes to populate the entity number on an invoice fee
	LEFT OUTER JOIN
	(
		SELECT [PERMITNUMBER] [ENTITYNUMBER],  [PMPERMITFEE].[CACOMPUTEDFEEID]
        FROM [PMPERMIT] 
        JOIN [PMPERMITFEE] ON [PMPERMIT].[PMPERMITID] = [PMPERMITFEE].[PMPERMITID] 
	) [PERMITENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [PERMITENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [PLANNUMBER] [ENTITYNUMBER],  [PLPLANFEE].[CACOMPUTEDFEEID]
        FROM [PLPLAN] 
        JOIN [PLPLANFEE] ON [PLPLAN].[PLPLANID] = [PLPLANFEE].[PLPLANID] 
	) [PLANENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [PLANENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [APPNUMBER] [ENTITYNUMBER],  [PLAPPLICATIONFEE].[CACOMPUTEDFEEID]
        FROM [PLAPPLICATION] 
        JOIN [PLAPPLICATIONFEE] ON [PLAPPLICATION].[PLAPPLICATIONID] = [PLAPPLICATIONFEE].[PLAPPLICATIONID] 
	) [APPLICATIONENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [APPLICATIONENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [PROJECTNUMBER] [ENTITYNUMBER],  [PRPROJECTFEE].[CACOMPUTEDFEEID]
        FROM [PRPROJECT] 
        JOIN [PRPROJECTFEE] ON [PRPROJECT].[PRPROJECTID] = [PRPROJECTFEE].[PRPROJECTID] 
	) [PROJECTENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [PROJECTENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [CASENUMBER] [ENTITYNUMBER],  [CMCODECASEFEE].[CACOMPUTEDFEEID]
        FROM [CMCODECASE] 
        JOIN [CMCODECASEFEE] ON [CMCODECASE].[CMCODECASEID] = [CMCODECASEFEE].[CMCODECASEID] 
	) [CODECASEENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [CODECASEENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [CASENUMBER] [ENTITYNUMBER],  [CMVIOLATIONFEE].[CACOMPUTEDFEEID]
        FROM [CMVIOLATION] 
        JOIN [CMVIOLATIONFEE] ON [CMVIOLATION].[CMVIOLATIONID] = [CMVIOLATIONFEE].[CMVIOLATIONID] 
		JOIN [CMCODEWFSTEP] ON [CMVIOLATION].[CMCODEWFSTEPID] = [CMCODEWFSTEP].[CMCODEWFSTEPID] 
		JOIN [CMCODECASE] ON [CMCODEWFSTEP].[CMCODECASEID] = [CMCODECASE].[CMCODECASEID]
	) [VIOLATIONENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [VIOLATIONENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [INSPECTIONNUMBER] [ENTITYNUMBER],  [IMINSPECTIONFEE].[CACOMPUTEDFEEID]
        FROM [IMINSPECTION] 
        JOIN [IMINSPECTIONFEE] ON [IMINSPECTION].[IMINSPECTIONID] = [IMINSPECTIONFEE].[IMINSPECTIONID] 
	) [INSPECTIONENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [INSPECTIONENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [LICENSENUMBER] [ENTITYNUMBER],  [BLLICENSEFEE].[CACOMPUTEDFEEID]
        FROM [BLLICENSE] 
        JOIN [BLLICENSEFEE] ON [BLLICENSE].[BLLICENSEID] = [BLLICENSEFEE].[BLLICENSEID] 
	) [BUSINESSLICENSEENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [BUSINESSLICENSEENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [LICENSENUMBER] [ENTITYNUMBER],  [ILLICENSEFEE].[CACOMPUTEDFEEID]
        FROM [ILLICENSE] 
        JOIN [ILLICENSEFEE] ON [ILLICENSE].[ILLICENSEID] = [ILLICENSEFEE].[ILLICENSEID] 
	) [PROFESSIONALLICENSEENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [PROFESSIONALLICENSEENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [CONDITIONNUMBER] [ENTITYNUMBER],  [IPCONDITIONFEE].[CACOMPUTEDFEEID]
        FROM [IPCONDITION] 
        JOIN [IPCONDITIONFEE] ON [IPCONDITION].[IPCONDITIONID] = [IPCONDITIONFEE].[IPCONDITIONID] 
	) [IMPACTENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [IMPACTENTITY].[CACOMPUTEDFEEID]

	LEFT OUTER JOIN
	(
		SELECT [REMITTANCEACCOUNTNUMBER] [ENTITYNUMBER],  [TXREMITTANCEFEE].[CACOMPUTEDFEEID]
        FROM [TXREMITTANCE] 
		JOIN [TXREMITTANCEACCOUNT] ON [TXREMITTANCEACCOUNT].[TXREMITTANCEACCOUNTID] = [TXREMITTANCE].[TXREMITTANCEACCOUNTID]
        JOIN [TXREMITTANCEFEE] ON [TXREMITTANCE].[TXREMITTANCEID] = [TXREMITTANCEFEE].[TXREMITTANCEID] 
	) [TAXENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [TAXENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [RPPROPERTY].[PROPERTYNUMBER] [ENTITYNUMBER],  [RPPROPERTYFEE].[CACOMPUTEDFEEID]
        FROM [RPPROPERTY] 
        JOIN [RPPROPERTYFEE] ON [RPPROPERTY].[RPPROPERTYID] = [RPPROPERTYFEE].[RPPROPERTYID] 
	) [RENTALPROPERTYENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [RENTALPROPERTYENTITY].[CACOMPUTEDFEEID]
	LEFT OUTER JOIN
	(
		SELECT [RPLANDLORDLICENSE].[LANDLORDNUMBER] [ENTITYNUMBER],  [RPLANDLORDLICENSEFEE].[CACOMPUTEDFEEID]
        FROM [RPLANDLORDLICENSE] 
        JOIN [RPLANDLORDLICENSEFEE] ON [RPLANDLORDLICENSE].[RPLANDLORDLICENSEID] = [RPLANDLORDLICENSEFEE].[RPLANDLORDLICENSEID] 
	) [LANDLORDLICENSEENTITY] ON [CACOMPUTEDFEE].[CACOMPUTEDFEEID] = [LANDLORDLICENSEENTITY].[CACOMPUTEDFEEID]
	
	WHERE [CAINVOICECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID 
	AND [CAINVOICE].[CASTATUSID] NOT IN (4, 5, 9, 10)
	AND [CACOMPUTEDFEE].[CASTATUSID] NOT IN (4, 5, 9, 10)
   
	UNION ALL
    
	SELECT    
	[CAMISCFEE].[FEENAME],
	'' AS [ENTITYNUMBER],
	CAST (1 AS BIT) AS [ISMISCFEE],
	[CAMISCFEE].[AMOUNT] - [CAMISCFEE].[PAIDAMOUNT] AS [AMOUNTDUE],
	[CAINVOICE].[CAINVOICEID],
	[CAMISCFEE].[CAMISCFEEID] AS [FEEUNIQUEID]
	FROM    
	[dbo].[CAINVOICEMISCFEE]  
	JOIN [dbo].[CAINVOICE] ON [CAINVOICE].[CAINVOICEID] = [CAINVOICEMISCFEE].[CAINVOICEID]
	JOIN [dbo].[CAINVOICECONTACT] ON [CAINVOICECONTACT].[CAINVOICEID] = [CAINVOICE].[CAINVOICEID]
	JOIN [dbo].[CAMISCFEE] ON [CAMISCFEE].[CAMISCFEEID] = [CAINVOICEMISCFEE].[CAMISCFEEID]
	JOIN [dbo].[CASTATUS] ON [CAINVOICE].[CASTATUSID] = [CASTATUS].[CASTATUSID]   
	WHERE [CAINVOICECONTACT].[GLOBALENTITYID] = @GLOBALENTITYID 
	AND [CAINVOICE].[CASTATUSID] NOT IN (4, 5, 9, 10)
	AND [CAMISCFEE].[CASTATUSID] NOT IN (4, 5, 9, 10)
	
END;