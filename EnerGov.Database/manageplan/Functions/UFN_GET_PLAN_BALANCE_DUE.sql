CREATE FUNCTION [manageplan].[UFN_GET_PLAN_BALANCE_DUE]
(
	@ENTITYID char(36)
)
RETURNS MONEY
AS
BEGIN
	DECLARE @BALANCEDUE AS MONEY
	SELECT @BALANCEDUE = ISNULL(SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT - CACOMPUTEDFEE.AMOUNTPAIDTODATE),0)
	FROM PLPLAN 
	INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
	INNER JOIN CACOMPUTEDFEE ON PLPLANFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID AND CACOMPUTEDFEE.CASTATUSID NOT IN (10,5) -- DELETED & VOID
	WHERE PLPLAN.PLPLANID = @ENTITYID
	RETURN @BALANCEDUE;
END