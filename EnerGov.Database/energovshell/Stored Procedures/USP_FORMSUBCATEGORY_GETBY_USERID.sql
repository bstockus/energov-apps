CREATE PROCEDURE [energovshell].[USP_FORMSUBCATEGORY_GETBY_USERID]
(
	@USERID CHAR(36)
)
AS
BEGIN	
	SET NOCOUNT ON;

	DECLARE @REMOVESILVERLIGHTLINKS BIT
	SET @REMOVESILVERLIGHTLINKS = (SELECT TOP 1 BITVALUE FROM SETTINGS WHERE NAME = 'RemoveSilverlightLinks')

	SELECT  [dbo].[FORMCATEGORYFORMSUBCATEGORYXREF].[FKFORMCATEGORYID],
			[dbo].[FORMSUBCATEGORY].[NAME] AS [SUBCATEGORYNAME] ,
			[dbo].[FORMSUBCATEGORY].[DISPLAYLABEL] AS [SUBCATEGORYDISPLAYLABEL],
			[dbo].[FORMSUBCATEGORY].[FORMSUBCATEGORYID] AS [SUBCATEGORYID],
			[dbo].[FORMSUBCATEGORYSUBMENUXREF].[DISPLAYORDER] AS [SUBCATEGORYDISPLAYORDER],
			[dbo].[FORMSUBCATEGORY].[ISADMIN] AS [SUBCATEGORYISADMIN],
			[dbo].[SUBMENUS].[SSUBMENUGUID] AS [SUBMENUID]
	FROM	[dbo].[FORMCATEGORYFORMSUBCATEGORYXREF] WITH (NOLOCK) 
		JOIN	[dbo].[FORMSUBCATEGORY] WITH (NOLOCK) ON  [dbo].[FORMSUBCATEGORY].[FORMSUBCATEGORYID] =  [dbo].[FORMCATEGORYFORMSUBCATEGORYXREF].[FKFORMSUBCATEGORYID]
		JOIN	[dbo].[FORMSUBCATEGORYSUBMENUXREF] WITH (NOLOCK) ON  [dbo].[FORMSUBCATEGORYSUBMENUXREF].[FKFORMSUBCATEGORYID] =  [dbo].[FORMSUBCATEGORY].[FORMSUBCATEGORYID]
		JOIN	[dbo].[ROLESUBMENUXREF] WITH (NOLOCK) ON  [dbo].[ROLESUBMENUXREF].[FKSUBMENUID] =  [dbo].[FORMSUBCATEGORYSUBMENUXREF].[FKSUBMENUID]
		JOIN    [dbo].[SUBMENUS] WITH (NOLOCK) ON  [dbo].[SUBMENUS].[SSUBMENUGUID] =  [dbo].[ROLESUBMENUXREF].[FKSUBMENUID]
		JOIN	[dbo].[ROLES] WITH (NOLOCK) ON  [dbo].[ROLES].[SROLEGUID] =  [dbo].[ROLESUBMENUXREF].[FKROLEID]
		JOIN	[dbo].[USERS] WITH (NOLOCK) ON  [dbo].[USERS].[SROLEID] =  [dbo].[ROLES].[SROLEGUID]
	WHERE	 [dbo].[ROLESUBMENUXREF].[BVISIBLE] = 1 AND  [dbo].[USERS].[SUSERGUID] = @USERID 
	AND ([dbo].[SUBMENUS].EXTERNALMENU = CASE WHEN COALESCE(@REMOVESILVERLIGHTLINKS, 0) = 1 THEN 1 ELSE 0 END OR [dbo].[SUBMENUS].EXTERNALMENU = CASE WHEN COALESCE(@REMOVESILVERLIGHTLINKS, 0) = 1 THEN 1 ELSE 1 END)
END