CREATE PROCEDURE [technicalsupport].[USP_CATILLSESSION_CLOSE_DUPLICATE_TILLSESSION]
(
	@USERID AS CHAR(36)
)
AS

DECLARE @SessionDate AS DATETIME
DECLARE @WillOpenTillSessionId AS CHAR(36)
SELECT @SessionDate = CAST(GETDATE() AS DATE)

IF ((SELECT COUNT(*) 
     FROM CATILLSESSION WITH(NOLOCK) 
	 WHERE USERID = @USERID
	 AND CLOSEDTIMESTAMP IS NULL 
	 AND SESSIONDATE = @SessionDate) > 1)
BEGIN
	SELECT @WillOpenTillSessionId = MAX(CATILLSESSIONID) 
	FROM CATILLSESSION WITH(NOLOCK) 
	WHERE USERID = @USERID
	AND CLOSEDTIMESTAMP IS NULL 
	AND SESSIONDATE = @SessionDate

	UPDATE CATILLSESSION 
	SET CLOSEDTIMESTAMP = GETDATE() 
	WHERE CATILLSESSIONID != @WillOpenTillSessionId 
	AND USERID = @USERID
	AND CLOSEDTIMESTAMP IS NULL 
	AND SESSIONDATE = @SessionDate

    INSERT INTO [GLOBALERROR]
            ([GGLOBALERROR]
            ,[USERNAME]
            ,[LOGDATE]
            ,[EXCEPTION]
            ,[SENTTOENERGOV]
            ,[GLOBALERRORNUMBER])
    VALUES  (LOWER(NEWID())
            ,N'EnerGov Service'
            ,GETDATE()
            ,'Closed duplicated till session of User(' + @USERID + ') by USP_CATILLSESSION_CLOSE_DUPLICATE_TILLSESSION'
            ,NULL
            ,NULL);
END