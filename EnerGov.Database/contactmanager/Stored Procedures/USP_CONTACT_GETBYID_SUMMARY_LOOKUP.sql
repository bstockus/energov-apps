CREATE PROCEDURE [contactmanager].[USP_CONTACT_GETBYID_SUMMARY_LOOKUP]
(
	@ID CHAR(36),
	@PERMITID CHAR(36) = NULL
)
AS
BEGIN
SET NOCOUNT ON;

DECLARE @IsPendingConfirmation Bit = 0;

IF(@PERMITID IS NOT NULL)
BEGIN
	SELECT @IsPendingConfirmation = CASE
										WHEN EXISTS(SELECT [PMPERMITCONTACT].[GLOBALENTITYID] FROM [PMPERMITCONTACT] 
										WHERE [PMPERMITCONTACT].[GLOBALENTITYID] = @ID 
										AND [PMPERMITCONTACT].[PMPERMITID] = @PERMITID 
										AND [PMPERMITCONTACT].[CONTACTCONFIRMSTATUSID] = 0)
										THEN 1
									ELSE 0
									END
END

DECLARE @PARENTGLOBALENTITYID CHAR(36) = NULL;

BEGIN
SET @PARENTGLOBALENTITYID = (SELECT TOP 1 [GLOBALENTITYID]
	 FROM [GLOBALENTITYSUBCONTACTXREF] JOIN [GLOBALENTITY] ON [GLOBALENTITYSUBCONTACTXREF].[PARENTGLOBALENTITYID] = [GLOBALENTITY].[GLOBALENTITYID]
	WHERE [GLOBALENTITYSUBCONTACTXREF].[SUBCONTACTGLOBALENTITYID] = @ID 
	ORDER BY CONCAT([GLOBALENTITY].[GLOBALENTITYNAME],[GLOBALENTITY].[FIRSTNAME],[GLOBALENTITY].[LASTNAME]))
END

SELECT 
	[GLOBALENTITY].[GLOBALENTITYID],
	[GLOBALENTITY].[FIRSTNAME],
	[GLOBALENTITY].[LASTNAME],
	[GLOBALENTITY].[MIDDLENAME],
	[GLOBALPREFFERCOMM].[PREFNAME],
	[GLOBALENTITY].[EMAIL],
	[GLOBALENTITY].[GLOBALENTITYNAME],
	[GLOBALENTITY].[CONTACTID],
	[GLOBALENTITY].[ISCONTACT],
    [GLOBALENTITY].[ISACTIVE],
    [GLOBALENTITY].[ISCOMPANY],
	CAST(CASE WHEN EXISTS(SELECT [USERS].[GLOBALENTITYID] FROM [USERS] JOIN [APPLICATIONALLOWED] ON [USERS].SUSERGUID = [APPLICATIONALLOWED].[USERID]
	WHERE [APPLICATIONALLOWED].[APPLICATIONID] = 2 AND [APPLICATIONALLOWED].[APPROVED] = 1 AND [USERS].[GLOBALENTITYID] = [GLOBALENTITY].[GLOBALENTITYID]) 
	THEN 1 ELSE 0 END as bit) ISPORTALACCOUNT,
    [GLOBALENTITY].[TITLE],
    [GLOBALENTITY].[PREFCOMM],
    [GLOBALENTITY].[LASTCHANGEDON],
    [ChangedBy].[FNAME] + ' ' + [ChangedBy].[LNAME] LASTUPDATEDBY,
	[GLOBALENTITY].[BUSINESSPHONE],
	[GLOBALENTITY].[HOMEPHONE],
	[GLOBALENTITY].[MOBILEPHONE],
	[GLOBALENTITY].[OTHERPHONE],
	@PARENTGLOBALENTITYID AS PARENTGLOBALENTITYID,
	[ParentGlobalEntity].[FIRSTNAME],
	[ParentGlobalEntity].[LASTNAME],
	[ParentGlobalEntity].[GLOBALENTITYNAME],
	[ParentGlobalEntity].[ISCOMPANY],
	@IsPendingConfirmation ISPENDINGCONFIRMATION,
	[GLOBALENTITY].[OTHEREMAIL]
FROM [GLOBALENTITY] WITH (NOLOCK)
LEFT OUTER JOIN [USERS] ChangedBy WITH (NOLOCK) ON ChangedBy.SUSERGUID = [GLOBALENTITY].LASTCHANGEDBY
LEFT OUTER JOIN [GLOBALPREFFERCOMM] WITH (NOLOCK) ON [GLOBALPREFFERCOMM].[GLOBALPREFFERCOMMID] = [GLOBALENTITY].[PREFCOMM]
LEFT OUTER JOIN [GLOBALENTITY] ParentGlobalEntity WITH (NOLOCK) ON ParentGlobalEntity.GLOBALENTITYID = @PARENTGLOBALENTITYID
WHERE
	[GLOBALENTITY].[GLOBALENTITYID] = @ID  

SELECT top 1
	[MAILINGADDRESS].[MAILINGADDRESSID],
	[MAILINGADDRESS].[ADDRESSLINE1],
	[MAILINGADDRESS].[ADDRESSLINE2],
	[MAILINGADDRESS].[ADDRESSLINE3],
	[MAILINGADDRESS].[CITY],
	[MAILINGADDRESS].[STATE],
	[MAILINGADDRESS].[COUNTY],
	[MAILINGADDRESS].[COUNTRY],
	[MAILINGADDRESS].[POSTALCODE],
	[MAILINGADDRESS].[COUNTRYTYPE],
	[MAILINGADDRESS].[POSTDIRECTION],
	[MAILINGADDRESS].[PREDIRECTION],
	[MAILINGADDRESS].[ADDRESSID],
	[MAILINGADDRESS].[ADDRESSTYPE],
	[MAILINGADDRESS].[STREETTYPE],
	[MAILINGADDRESS].[PARCELID],
	[MAILINGADDRESS].[PARCELNUMBER],
	[MAILINGADDRESS].[UNITORSUITE],
	[MAILINGADDRESS].[PROVINCE],
	[MAILINGADDRESS].[RURALROUTE],
	[MAILINGADDRESS].[STATION],
	[MAILINGADDRESS].[COMPSITE],
	[MAILINGADDRESS].[POBOX],
	[MAILINGADDRESS].[ATTN],
	[MAILINGADDRESS].[ROWVERSION],
	[MAILINGADDRESSCOUNTRYTYPE].[MAILINGADDRESSCOUNTRYTYPENAME],
	[GLOBALENTITYMAILINGADDRESS].[GLOBALENTITYID]
	FROM [MAILINGADDRESS] WITH (NOLOCK)
INNER JOIN [GLOBALENTITYMAILINGADDRESS] WITH (NOLOCK) ON [MAILINGADDRESS].[MAILINGADDRESSID] = [GLOBALENTITYMAILINGADDRESS].[MAILINGADDRESSID]
INNER JOIN [MAILINGADDRESSCOUNTRYTYPE] WITH (NOLOCK) ON [MAILINGADDRESSCOUNTRYTYPE].MAILINGADDRESSCOUNTRYTYPEID = [MAILINGADDRESS].COUNTRYTYPE
WHERE
	[GLOBALENTITYMAILINGADDRESS].[GLOBALENTITYID] = @ID
ORDER BY [GLOBALENTITYMAILINGADDRESS].[MAIN] desc

END