CREATE PROCEDURE [globalsearch].[USP_CORRECTIONTYPE_SEARCH_SELECT_LOOKUP]
(
	@SEARCH AS NVARCHAR(MAX) = '',
	@PAGE_NUMBER AS INT = 1,
	@PAGE_SIZE AS INT = 10,
	@IS_ASCENDING AS BIT = 1,	
	@PLCORRECTIONTYPECATEGORYIDS RecordIDs READONLY 
)
AS
BEGIN
SET NOCOUNT ON;
;WITH RAW_DATA AS(
		SELECT  [PLPLANCORRECTIONTYPE].[PLPLANCORRECTIONTYPEID],
				[PLPLANCORRECTIONTYPE].[NAME],
				[PLPLANCORRECTIONTYPE].[DESCRIPTION],
				[PLPLANCORRECTIONTYPE].[CORRECTIVEACTION],
				[PLPLANCORRECTIONTYPE].[PLCORRECTIONTYPECATEGORYID],
				[PLCORRECTIONTYPECATEGORY].[NAME] AS [CATEGORYNAME],
				CASE @IS_ASCENDING WHEN 1 THEN
					ROW_NUMBER() OVER(ORDER BY [dbo].[PLPLANCORRECTIONTYPE].[NAME])
				ELSE
					ROW_NUMBER() OVER(ORDER BY [dbo].[PLPLANCORRECTIONTYPE].[NAME] DESC)
				END AS RowNumber,
				COUNT(1) OVER() AS TotalRows
		FROM [dbo].[PLPLANCORRECTIONTYPE] WITH (NOLOCK) INNER JOIN [dbo].[PLCORRECTIONTYPECATEGORY] WITH (NOLOCK)
				ON [PLPLANCORRECTIONTYPE].[PLCORRECTIONTYPECATEGORYID]=[PLCORRECTIONTYPECATEGORY].[PLCORRECTIONTYPECATEGORYID]
		 WHERE (
				[PLPLANCORRECTIONTYPE].[DESCRIPTION] LIKE '%'+@SEARCH+'%' OR
				[PLPLANCORRECTIONTYPE].[NAME] LIKE '%'+@SEARCH+'%' OR
				[PLCORRECTIONTYPECATEGORY].[NAME] LIKE '%'+@SEARCH+'%' 
				) AND ((SELECT CASE 
								WHEN (SELECT COUNT([RECORDID]) FROM  @PLCORRECTIONTYPECATEGORYIDS)=0  THEN 1
								WHEN (SELECT COUNT([RECORDID]) FROM  @PLCORRECTIONTYPECATEGORYIDS
																WHERE [RECORDID]=[PLPLANCORRECTIONTYPE].[PLCORRECTIONTYPECATEGORYID]) <> 0 THEN 1 
								ELSE 0 END)=1)
)
SELECT * 
FROM RAW_DATA
WHERE
	RowNumber > @PAGE_SIZE * (@PAGE_NUMBER - 1) AND 
	RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY 
	RowNumber
END