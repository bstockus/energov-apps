CREATE PROCEDURE [globalsearch].[USP_WORKFLOWSTEP_SEARCH_SELECT_LOOKUP]
(
	@SEARCH AS NVARCHAR(MAX) = '',
	@PAGE_NUMBER AS INT = 1,
	@PAGE_SIZE AS INT = 10,
	@IS_ASCENDING AS BIT = 1,	
	@WFTEMPLATEID AS CHAR(36)
)
AS
BEGIN
SET NOCOUNT ON;
;WITH RAW_DATA AS(
			SELECT
				[WFSTEP].[WFSTEPID],
				[WFSTEP].[NAME],
				[WFSTEP].[DESCRIPTION],
				CASE @IS_ASCENDING WHEN 1 THEN
					ROW_NUMBER() OVER(ORDER BY [dbo].[WFSTEP].[NAME])
				ELSE
					ROW_NUMBER() OVER(ORDER BY [dbo].[WFSTEP].[NAME] DESC)
				END AS RowNumber,
				COUNT(1) OVER() AS TotalRows		
			FROM [dbo].[WFTEMPLATESTEP] WITH (NOLOCK)
				INNER JOIN [dbo].[WFTEMPLATE] WITH (NOLOCK) ON [WFTEMPLATESTEP].[WFTEMPLATEID] =[WFTEMPLATE].[WFTEMPLATEID]
				INNER JOIN [dbo].[WFSTEP] WITH (NOLOCK) ON [WFTEMPLATESTEP].[WFSTEPID] =[WFSTEP].[WFSTEPID]
			WHERE [WFTEMPLATESTEP].[WFTEMPLATEID]=@WFTEMPLATEID AND
					([dbo].[WFSTEP].[NAME] LIKE '%'+@SEARCH+'%' OR [dbo].[WFSTEP].[DESCRIPTION] LIKE '%'+@SEARCH+'%' )			
				)
SELECT * 
FROM RAW_DATA
WHERE
	RowNumber > @PAGE_SIZE * (@PAGE_NUMBER - 1) AND 
	RowNumber <= @PAGE_SIZE * @PAGE_NUMBER
ORDER BY 
	RowNumber
END