CREATE PROCEDURE [metadata].[USP_METADATACLASSPROPERTY_GETBYCAFEETEMPLATEID]
(@CAFEETEMPLATEID CHAR(36))
AS
BEGIN  
 SET NOCOUNT ON;  
		DECLARE @CONDITIONGROUPIDS  [dbo].[RecordIDs];
		;WITH CTE AS
			(
				SELECT 
					[CACONDITIONGROUP].[CACONDITIONGROUPID],
					[CACONDITIONGROUP].[PARENTCONDITIONGROUPID], 
					1 AS [LEVEL] 
				FROM [dbo].[CACONDITIONGROUP] 
					WHERE
						[CACONDITIONGROUP].[CACONDITIONGROUPID] IN (
						SELECT [CACONDITIONGROUPID] FROM [dbo].[CAFEETEMPLATEFEE] WHERE [CAFEETEMPLATEID] = @CAFEETEMPLATEID
						UNION ALL
						SELECT [CACONDITIONGROUPID] FROM [dbo].[CAFEETEMPLATEDISCOUNT] WHERE [CAFEETEMPLATEID] = @CAFEETEMPLATEID		
						)
				UNION ALL
				SELECT 
					[CHILDRECORD].[CACONDITIONGROUPID],
					[CHILDRECORD].[PARENTCONDITIONGROUPID],
					[LEVEL]+1 AS [LEVEL] 
				FROM 
					[dbo].[CACONDITIONGROUP] [CHILDRECORD] INNER JOIN CTE AS [PARENTRECORD] 
							ON [CHILDRECORD].[PARENTCONDITIONGROUPID] = [PARENTRECORD].[CACONDITIONGROUPID]
			)
			INSERT INTO @CONDITIONGROUPIDS
			SELECT [CTE].[CACONDITIONGROUPID]
			FROM [CTE] 
			OPTION (MAXRECURSION 0)

	 SELECT    
		ISNULL([dbo].[METADATACLASSPROPERTY].[NAME], [dbo].[METADATACLASS].[NAME]),
		ISNULL([dbo].[METADATACLASSPROPERTY].[FRIENDLYNAME], [dbo].[METADATACLASS].[FRIENDLYNAME]),
		CASE WHEN [dbo].[METADATACLASSPROPERTY].[HASCHILDREN] = 1 THEN [dbo].[METADATACLASSPROPERTY].[TYPENAME] ELSE [dbo].[METADATACLASS].[NAME] END AS TYPENAME,
		CASE WHEN [dbo].[METADATACLASSPROPERTY].[HASCHILDREN] = 1 THEN [dbo].[METADATACLASSPROPERTY].[TYPEFULLNAME] ELSE [dbo].[METADATACLASS].[TYPEFULLNAME] END AS TYPEFULLNAME,
		[dbo].[METADATACLASSPROPERTY].[ISPRIMARYKEY],
		[dbo].[METADATACLASSPROPERTY].[GENERICTYPEISPRIMITIVE],
		[dbo].[METADATACLASSPROPERTY].[GENERICTYPEISENUMERABLE],
		[dbo].[METADATACLASSPROPERTY].[HASCHILDREN],
		[dbo].[METADATACLASSPROPERTY].[CONTROLTYPEID],
		[dbo].[METADATACLASSPROPERTY].[LOOKUPTABLENAME],
		[dbo].[METADATACLASSPROPERTY].[GISFEATURESETNAME],
		[dbo].[METADATACLASSPROPERTY].[ISGEOCALLERTYPE],
		[dbo].[METADATACLASSPROPERTY].[PROPERTYNAME],
		[dbo].[CACONDITION].CACONDITIONID AS CONDITIONID,
		[dbo].[METADATACLASSPROPERTY].TYPENAME AS DATATYPE,
		[dbo].[METADATACLASSPROPERTY].[ISWORKFLOWATTRIBUTE]
	 FROM [dbo].[CACONDITIONGROUP]  
	 JOIN [dbo].[CACONDITION] ON [dbo].[CACONDITIONGROUP].[CACONDITIONGROUPID] = [dbo].[CACONDITION].[CACONDITIONGROUPID]  
	 LEFT JOIN [dbo].[METADATACLASS] ON [dbo].[CACONDITION].[CLASSNAME] = [dbo].[METADATACLASS].[TYPEFULLNAME]
	 LEFT JOIN [dbo].[METADATACLASSPROPERTY] ON [dbo].[METADATACLASS].ID = [dbo].[METADATACLASSPROPERTY].[PARENTID] AND [dbo].[CACONDITION].[OPERANDVALUE] = [dbo].[METADATACLASSPROPERTY].[NAME]  
	 WHERE 
		[dbo].[CACONDITIONGROUP].[CACONDITIONGROUPID] IN (SELECT [RECORDID] from @CONDITIONGROUPIDS) 
		AND [dbo].CACONDITION.OPERANDTYPEID IN (1,2) -- Entity = 1, EntityProperty = 2,
		AND ([dbo].[CACONDITION].[CUSTOMFIELDTABLE] = '' OR [dbo].[CACONDITION].[CUSTOMFIELDTABLE] IS NULL)   
		AND  [dbo].[METADATACLASS].[TYPEFULLNAME] IS NOT NULL	
END