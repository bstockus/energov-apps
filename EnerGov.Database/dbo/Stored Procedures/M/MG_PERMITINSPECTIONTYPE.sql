-- =============================================
-- Author:		<Author,Bin Wu>
-- Create date: <Create Date,,>
-- Description:	-- Return all availble inspection types for changing
-- =============================================
CREATE PROCEDURE MG_PERMITINSPECTIONTYPE
	@PermitId char(36)
AS
BEGIN	

--get the lowest step order priority
DECLARE @MinPriorityWFStepOrder INT
SET @MinPriorityWFStepOrder = 
(SELECT  MIN(PMPERMITWFSTEP.PRIORITYORDER)
FROM     PMPERMITWFACTIONSTEP
			INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
WHERE    PMPERMITWFSTEP.PMPERMITID = @PermitId 
		AND PMPERMITWFSTEP.NOPRIORITY = 0
			AND (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5))

--get the lowest step order priority
DECLARE @MinWFStepOrder INT
SET @MinWFStepOrder = ISNull(@MinPriorityWFStepOrder, (SELECT  MIN(PMPERMITWFSTEP.PRIORITYORDER)
FROM     PMPERMITWFACTIONSTEP
			INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
WHERE    PMPERMITWFSTEP.PMPERMITID = @PermitId
			AND (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5)))


--get the lowest action priorty
DECLARE @MinPriorityWFActionOrder INT
SET @MinPriorityWFActionOrder = 
(SELECT  MIN(PMPERMITWFACTIONSTEP.PRIORITYORDER)
FROM     PMPERMITWFACTIONSTEP
			INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
WHERE    PMPERMITWFSTEP.PMPERMITID = @PermitId
			AND PMPERMITWFSTEP.PRIORITYORDER = @MinWFStepOrder
			AND PMPERMITWFACTIONSTEP.NOPRIORITY = 0
			AND (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5)) 
       

--get the lowest action priorty
DECLARE @MinWFActionOrder INT
SET @MinWFActionOrder = ISNULL(@MinPriorityWFActionOrder, (SELECT  MIN(PMPERMITWFACTIONSTEP.PRIORITYORDER)
FROM     PMPERMITWFACTIONSTEP
			INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
WHERE    PMPERMITWFSTEP.PMPERMITID = @PermitId
			AND PMPERMITWFSTEP.PRIORITYORDER = @MinWFStepOrder 
			AND (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5))) 

       	            
SELECT  PMPERMITWFSTEP.PMPERMITID, IMINSPECTIONTYPE.NAME, PMPERMITWFACTIONSTEP.IMINSPECTIONTYPEID, PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID, PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID
FROM    PMPERMITWFACTIONSTEP 
			INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
            INNER JOIN IMINSPECTIONTYPE ON PMPERMITWFACTIONSTEP.IMINSPECTIONTYPEID = IMINSPECTIONTYPE.IMINSPECTIONTYPEID
            LEFT JOIN IMINSPECTIONACTREF ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = IMINSPECTIONACTREF.OBJECTID
			LEFT JOIN IMINSPECTION ON IMINSPECTIONACTREF.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
WHERE	PMPERMITWFSTEP.PMPERMITID = @PermitId
			AND PMPERMITWFACTIONSTEP.WFACTIONTYPEID = 6
			AND (((PMPERMITWFSTEP.PRIORITYORDER = @MinWFStepOrder OR PMPERMITWFSTEP.NOPRIORITY = 1) AND PMPERMITWFACTIONSTEP.PRIORITYORDER =  @MinWFActionOrder ) OR PMPERMITWFACTIONSTEP.NOPRIORITY = 1)
			AND (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5 AND IMINSPECTION.SCHEDULEDSTARTDATE IS NULL ) ) 			

END