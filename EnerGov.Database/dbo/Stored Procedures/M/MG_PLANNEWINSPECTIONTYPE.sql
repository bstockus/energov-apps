
CREATE PROCEDURE MG_PLANNEWINSPECTIONTYPE
	@planId char(36)
AS
BEGIN
--get the lowest step order priority
DECLARE @MinPriorityWFStepOrder INT
SET @MinPriorityWFStepOrder = 
(SELECT MIN(PLPLANWFSTEP.PRIORITYORDER)
FROM    PLPLANWFACTIONSTEP 
			INNER JOIN PLPLANWFSTEP ON PLPLANWFACTIONSTEP.PLPLANWFSTEPID = PLPLANWFSTEP.PLPLANWFSTEPID                      
WHERE	PLPLANWFSTEP.PLPLANID = @planId
			AND PLPLANWFSTEP.NOPRIORITY = 0
			AND (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 5))



--get the lowest step order priority
DECLARE @MinWFStepOrder INT
SET @MinWFStepOrder = ISNull(@MinPriorityWFStepOrder, (SELECT MIN(PLPLANWFSTEP.PRIORITYORDER)
FROM    PLPLANWFACTIONSTEP 
			INNER JOIN PLPLANWFSTEP ON PLPLANWFACTIONSTEP.PLPLANWFSTEPID = PLPLANWFSTEP.PLPLANWFSTEPID                      
WHERE	PLPLANWFSTEP.PLPLANID = @planId 
		AND (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 5)))


--get the lowest action priorty
DECLARE @MinPriorityWFActionOrder INT
SET @MinPriorityWFActionOrder = 
(SELECT MIN(PLPLANWFACTIONSTEP.PRIORITYORDER)
FROM	PLPLANWFACTIONSTEP 
			INNER JOIN PLPLANWFSTEP ON PLPLANWFACTIONSTEP.PLPLANWFSTEPID = PLPLANWFSTEP.PLPLANWFSTEPID
WHERE   PLPLANWFSTEP.PLPLANID = @planId 
			AND PLPLANWFSTEP.PRIORITYORDER = @MinWFStepOrder
			AND PLPLANWFACTIONSTEP.NOPRIORITY = 0
			AND (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 5))
	
--get the lowest action priorty
DECLARE @MinWFActionOrder INT
SET @MinWFActionOrder = ISNULL(@MinPriorityWFActionOrder, (SELECT MIN(PLPLANWFACTIONSTEP.PRIORITYORDER)
FROM	PLPLANWFACTIONSTEP 
			INNER JOIN PLPLANWFSTEP ON PLPLANWFACTIONSTEP.PLPLANWFSTEPID = PLPLANWFSTEP.PLPLANWFSTEPID
WHERE   PLPLANWFSTEP.PLPLANID = @planId 
			AND PLPLANWFSTEP.PRIORITYORDER = @MinWFStepOrder
			AND (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 5)))

--select the available inspection types for the permit with the above priority orders
SELECT  PLPLANWFSTEP.PLPLANID, IMINSPECTIONTYPE.NAME, PLPLANWFACTIONSTEP.IMINSPECTIONTYPEID, PLPLANWFACTIONSTEP.WORKFLOWSTATUSID, PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID
FROM    PLPLANWFACTIONSTEP 
			INNER JOIN PLPLANWFSTEP ON PLPLANWFACTIONSTEP.PLPLANWFSTEPID = PLPLANWFSTEP.PLPLANWFSTEPID
            INNER JOIN IMINSPECTIONTYPE ON PLPLANWFACTIONSTEP.IMINSPECTIONTYPEID = IMINSPECTIONTYPE.IMINSPECTIONTYPEID
            LEFT JOIN IMINSPECTIONACTREF ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = IMINSPECTIONACTREF.OBJECTID
			LEFT JOIN IMINSPECTION ON IMINSPECTIONACTREF.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
WHERE	PLPLANWFSTEP.PLPLANID = @planId 
			AND	PLPLANWFACTIONSTEP.WFACTIONTYPEID = 6
			AND (((PLPLANWFSTEP.PRIORITYORDER = @MinWFStepOrder OR PLPLANWFSTEP.NOPRIORITY = 1) AND PLPLANWFACTIONSTEP.PRIORITYORDER = @MinWFActionOrder)  OR PLPLANWFACTIONSTEP.NOPRIORITY = 1) 			
			AND (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR (PLPLANWFACTIONSTEP.WORKFLOWSTATUSID = 5 AND IMINSPECTION.SCHEDULEDSTARTDATE IS NULL )) 				  	
END