
CREATE PROCEDURE [dbo].[mg_Query_PermitParentHistory]
	@ParentId char(36)
AS
BEGIN
SELECT     IMINSPECTION.IMINSPECTIONID, IMINSPECTION.INSPECTIONNUMBER, IMINSPECTION.SCHEDULEDSTARTDATE, IMINSPECTIONTYPE.NAME TYPENAME, IMINSPECTION.IMINSPECTIONSTATUSID, IMINSPECTIONSTATUS.STATUSNAME,
		   USERS.LNAME, USERS.FNAME, IMINSPECTION.COMMENTS
             FROM   PMPERMITWFACTIONSTEP INNER JOIN PMPERMITWFSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID = PMPERMITWFSTEP.PMPERMITWFSTEPID
                                         INNER JOIN IMINSPECTIONTYPE ON PMPERMITWFACTIONSTEP.IMINSPECTIONTYPEID = IMINSPECTIONTYPE.IMINSPECTIONTYPEID
                                         INNER JOIN IMINSPECTIONACTREF ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = IMINSPECTIONACTREF.OBJECTID
								         INNER JOIN IMINSPECTION ON IMINSPECTIONACTREF.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
								         INNER JOIN IMINSPECTIONSTATUS ON IMINSPECTION.IMINSPECTIONSTATUSID = IMINSPECTIONSTATUS.IMINSPECTIONSTATUSID
								         LEFT JOIN IMINSPECTORREF ON IMINSPECTORREF.INSPECTIONID = IMINSPECTION.IMINSPECTIONID
								         LEFT JOIN USERS ON USERS.SUSERGUID = IMINSPECTORREF.USERID
             WHERE     (PMPERMITWFSTEP.PMPERMITID = @ParentId ) AND (PMPERMITWFACTIONSTEP.WFACTIONTYPEID = 6)
              -- AND  (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 0 OR (PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 5  ) OR PMPERMITWFACTIONSTEP.WORKFLOWSTATUSID = 1 )  
               AND (IMINSPECTORREF.BPRIMARY = 1 OR ( IMINSPECTORREF.BPRIMARY IS NULL))
		   	
END

