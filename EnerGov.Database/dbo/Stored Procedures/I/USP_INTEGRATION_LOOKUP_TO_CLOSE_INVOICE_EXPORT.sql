--Invoice Fee Status Should be in ( Due, Past Due, Invoiced, Invoiced, Past Due )
--Invoice Status Should NOT be in ( Paid In Full, Void, Refunded, Deleted )

CREATE PROCEDURE [dbo].[USP_INTEGRATION_LOOKUP_TO_CLOSE_INVOICE_EXPORT]
    @EndDate DATE
AS
BEGIN
	SELECT CACOMPUTEDFEE.CACOMPUTEDFEEID, CAINVOICEFEE.CAINVOICEFEEID
	FROM CAFEE
	JOIN CAFEETEMPLATEFEE ON CAFEE.CAFEEID = CAFEETEMPLATEFEE.CAFEEID
	JOIN CACOMPUTEDFEE ON CAFEETEMPLATEFEE.CAFEETEMPLATEFEEID = CACOMPUTEDFEE.CAFEETEMPLATEFEEID
	JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
	JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
	WHERE CAFEE.ISSUBJECTTOEXTERNALINVOICE = 1
	AND DATEADD(day, CAFEE.DAYSUNTILEXTERNALINVOICEEXPORT, CONVERT(date, CAINVOICEFEE.CREATEDON)) <= @EndDate
	AND COALESCE(CAINVOICEFEE.CAEXPORTSTATUSID, 1) = 1
	AND CACOMPUTEDFEE.CASTATUSID IN ( 1, 2, 6, 7 )
	AND CAINVOICE.CASTATUSID NOT IN ( 4, 5, 9, 10 )
	AND NOT EXISTS ( SELECT 'X' FROM CAEXTERNALINVOICEBATCHFEE 
						WHERE CAEXTERNALINVOICEBATCHFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID )
	UNION ALL

	SELECT CAMISCFEE.CAMISCFEEID AS CACOMPUTEDFEEID, CAINVOICEMISCFEE.CAINVOICEMISCFEEID AS CAINVOICEFEEID
	FROM CAMISCFEE
	JOIN CAFEE ON CAMISCFEE.CAFEEID = CAFEE.CAFEEID
	JOIN CAINVOICEMISCFEE ON CAMISCFEE.CAMISCFEEID = CAINVOICEMISCFEE.CAMISCFEEID
	JOIN CAINVOICE ON CAINVOICEMISCFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
	WHERE CAFEE.ISSUBJECTTOEXTERNALINVOICE = 1
	AND DATEADD(day, CAFEE.DAYSUNTILEXTERNALINVOICEEXPORT, CONVERT(date, CAINVOICEMISCFEE.CREATEDON)) <= @EndDate
	AND COALESCE(CAINVOICEMISCFEE.CAEXPORTSTATUSID, 1) = 1
	AND CAMISCFEE.CASTATUSID IN ( 1, 2, 6, 7 )
	AND CAINVOICE.CASTATUSID NOT IN ( 4, 5, 9, 10 )
	AND NOT EXISTS ( SELECT 'X' FROM CAEXTERNALINVOICEBATCHMISCFEE 
						WHERE CAEXTERNALINVOICEBATCHMISCFEE.CAMISCFEEID = CAMISCFEE.CAMISCFEEID )
END