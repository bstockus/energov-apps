
CREATE PROCEDURE rpt_IP_SR_Impact_Transaction_Detail_Report
@STARTDATE			datetime, 
	@ENDDATE			datetime 
AS

SET NOCOUNT ON

SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT	IPCASE.CASENUMBER,
		USERS.FNAME 'USERS_FNAME', USERS.LNAME 'USERS_LNAME',
		IPCONDITION.CONDITIONNUMBER,
		IPCASETYPE.NAME as CASETYPE,
		IPCONDITIONTYPE.IPCONDITIONTYPEID ,
		IPCONDITIONTYPE.NAME 'IPCONDITIONTYPE_NAME',
		CATRANSACTION.CATRANSACTIONID,
		CATRANSACTION.TRANSACTIONDATE,
		CATRANSACTIONPAYMENT.PAYMENTDATE,
		CATRANSACTION.RECEIPTNUMBER, 
		CATRANSACTIONPAYMENT.SUPPLEMENTALDATA AS CHECKNUMBER,
		CATRANSACTIONPAYMENT.PAYMENTAMOUNT AS AMOUNTPAID,
		(SELECT TOP 1 GLACCOUNT.ACCOUNTNUMBER
		 FROM	CAFEEGLACCOUNTXREF 
				INNER JOIN GLACCOUNT ON CAFEEGLACCOUNTXREF.CREDITGLACCOUNTID = GLACCOUNT.GLACCOUNTID
		 WHERE CAFEETEMPLATEFEE.CAFEEID = CAFEEGLACCOUNTXREF.CAFEEID 
		 ORDER BY CAFEEGLACCOUNTXREF.CAPAYMENTTYPEID
		) 'GLACCOUNT_ACCOUNTNUMBER',
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	IPCASE
		INNER JOIN IPCASETYPE ON IPCASE.IPCASETYPEID = IPCASETYPE.IPCASETYPEID
		INNER JOIN IPCONDITION ON IPCASE.IPCASEID = IPCONDITION.IPCASEID AND IPCONDITION.MONETARY = 1 
		INNER JOIN IPCONDITIONTYPE ON IPCONDITION.IPCONDITIONTYPEID = IPCONDITIONTYPE.IPCONDITIONTYPEID 
		INNER JOIN IPCONDITIONFEE ON IPCONDITION.IPCONDITIONID = IPCONDITIONFEE.IPCONDITIONID 
		INNER JOIN CACOMPUTEDFEE ON IPCONDITIONFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID AND CACOMPUTEDFEE.CASTATUSID in (3,4,8) /* (Partial Payment,Paid In Full,Partial/Past Due) */
		INNER JOIN CAFEETEMPLATEFEE on CACOMPUTEDFEE.CAFEETEMPLATEFEEID = CAFEETEMPLATEFEE.CAFEETEMPLATEFEEID 
		INNER JOIN CATRANSACTIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CATRANSACTIONFEE.CACOMPUTEDFEEID
		INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
		INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
		INNER JOIN USERS on CATRANSACTION.CREATEDBY = USERS.SUSERGUID 

WHERE	CATRANSACTIONPAYMENT.PAYMENTDATE BETWEEN @STARTDATE AND @ENDDATE

ORDER BY	IPCONDITIONTYPE.NAME, IPCONDITIONTYPE.IPCONDITIONTYPEID, IPCONDITION.CONDITIONNUMBER 

