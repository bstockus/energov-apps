CREATE PROCEDURE [dbo].[USP_INTEGRATION_UPDATE_CAINVOICEFEE_INVOICE_PENDING_EXPORT]
	@UniqueIds RecordIDs READONLY,
	@ChangedBy CHAR(36)
AS
BEGIN
	UPDATE CAINVOICEFEE SET CAEXPORTSTATUSID = 2 
	FROM CAINVOICEFEE
	JOIN @UniqueIds [FEEIDs] ON CAINVOICEFEE.CAINVOICEFEEID = [FEEIDs].[RECORDID] 
	AND COALESCE(CAEXPORTSTATUSID, 1) = 1;

	UPDATE CAINVOICE SET ROWVERSION = ROWVERSION + 1 
	FROM CAINVOICE
	JOIN CAINVOICEFEE ON CAINVOICE.CAINVOICEID = CAINVOICEFEE.CAINVOICEID
	JOIN @UniqueIds [FEEIDs] ON CAINVOICEFEE.CAINVOICEFEEID = [FEEIDs].[RECORDID]
	AND CAINVOICEFEE.CAEXPORTSTATUSID = 2;

	INSERT INTO HISTORYSYSTEMSETUP (ID, ROWVERSION, CHANGEDON, CHANGEDBY, FIELDNAME, OLDVALUE, NEWVALUE, ADDITIONALINFO)
	SELECT CI.CAINVOICEID, CI.ROWVERSION, GETDATE(), @ChangedBy, 'ExportStatus', '[None]', 'Pending Export', CF.FEENAME + ': Export Status changed by Windows Service.'
	FROM CAINVOICEFEE NF
    JOIN @UniqueIds [FEEIDs] ON NF.CAINVOICEFEEID = [FEEIDs].[RECORDID]
	JOIN CACOMPUTEDFEE CF ON NF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
	JOIN CAINVOICE CI ON NF.CAINVOICEID = CI.CAINVOICEID
	WHERE NF.CAEXPORTSTATUSID = 2;


	UPDATE CAINVOICEMISCFEE SET CAEXPORTSTATUSID = 2 
	FROM CAINVOICEMISCFEE
	JOIN @UniqueIds [FEEIDs] ON CAINVOICEMISCFEE.CAINVOICEMISCFEEID = [FEEIDs].[RECORDID] 
	AND COALESCE(CAEXPORTSTATUSID, 1) = 1;

	UPDATE CAINVOICE SET ROWVERSION = ROWVERSION + 1 
	FROM CAINVOICE
	JOIN CAINVOICEMISCFEE ON CAINVOICE.CAINVOICEID = CAINVOICEMISCFEE.CAINVOICEID
	JOIN @UniqueIds [FEEIDs] ON CAINVOICEMISCFEE.CAINVOICEMISCFEEID = [FEEIDs].[RECORDID]
	WHERE CAINVOICEMISCFEE.CAEXPORTSTATUSID = 2;

	INSERT INTO HISTORYSYSTEMSETUP (ID, ROWVERSION, CHANGEDON, CHANGEDBY, FIELDNAME, OLDVALUE, NEWVALUE, ADDITIONALINFO)
	SELECT CI.CAINVOICEID, CI.ROWVERSION, GETDATE(), @ChangedBy, 'ExportStatus', '[None]', 'Pending Export', MF.FEENAME + ': Export Status changed by Windows Service.'
	FROM CAINVOICEMISCFEE IMF
	JOIN @UniqueIds [FEEIDs] ON IMF.CAINVOICEMISCFEEID = [FEEIDs].[RECORDID]
	JOIN CAMISCFEE MF ON IMF.CAMISCFEEID = MF.CAMISCFEEID
	JOIN CAINVOICE CI ON IMF.CAINVOICEID = CI.CAINVOICEID
	WHERE IMF.CAEXPORTSTATUSID = 2;
END