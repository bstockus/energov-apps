

CREATE PROCEDURE rpt_IL_Standard_Professional_License
@ILLICENSEID VARCHAR(36),
@REPORTID VARCHAR(36)
AS

DECLARE @CUSTOMFIELDS NVARCHAR(MAX) = '';
EXEC [dbo].[GetCustomReportText] @REPORTID, @ILLICENSEID, @CUSTOMFIELDS OUTPUT; 

--DECLARE @ILLICENSEID VARCHAR(36) = '99955128-46d5-4a79-b1e9-269892a3ac2f'

/*BUILD LIST OF ADDRESSES FOR CONTACTS*/
SELECT GEMA.GLOBALENTITYID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2,
	ROW_NUMBER() OVER (PARTITION BY GEMA.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE 'Mailing%' THEN 1 WHEN MA.ADDRESSTYPE LIKE 'Billing%' THEN 2 WHEN MA.ADDRESSTYPE LIKE 'Location%' THEN 3 ELSE 4 END, MA.MAILINGADDRESSID) AS ROWNBR
INTO #CONTACTADDRESS
FROM GLOBALENTITYMAILINGADDRESS GEMA 
INNER JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID

/*ALL LICENSE FEES*/
SELECT ILF.ILLICENSEID, SUM(C.COMPUTEDAMOUNT) FEEAMOUNT
INTO #FEES
FROM ILLICENSEFEE ILF
INNER JOIN CACOMPUTEDFEE C ON C.CACOMPUTEDFEEID = ILF.CACOMPUTEDFEEID
WHERE ILF.ILLICENSEID = @ILLICENSEID AND
	C.CASTATUSID NOT IN (5,9,10) 
GROUP BY ILF.ILLICENSEID

CREATE INDEX TEMP1 ON #CONTACTADDRESS (GLOBALENTITYID);
CREATE INDEX TEMP2 ON #CONTACTADDRESS (ROWNBR);
CREATE INDEX TEMP1 ON #FEES (ILLICENSEID);

/*BEGIN MAIN QUERY*/
SELECT BL.ILLICENSEID, BL.LICENSENUMBER, CASE WHEN BL.EXPIRATIONDATE = '1/1/2999' THEN NULL ELSE BL.EXPIRATIONDATE END AS EXPIRATIONDATE, 
	BL.LICENSEYEAR TAXYEAR, BL.ISSUEDATE ISSUEDDATE,
	CASE WHEN BUS.ISCONTACT = 1 THEN BUS.FIRSTNAME + ' ' + BUS.LASTNAME ELSE BUS.GLOBALENTITYNAME END BUSINESSNAME,
	MA.ADDRESS_LINE1 MADDRESS_LINE1, MA.ADDRESS_LINE2 MADDRESS_LINE2,
	BLT.NAME LICENSETYPE,
	BLC.NAME LICENSECLASS,
	STUFF((SELECT distinct  ', '+(COLC.LICENSENUMBER + ' - ' + COLCT.NAME) 
			FROM COLICENSECERTIFICATION COLC
			INNER JOIN COLICENSECERTIFICATIONTYPE COLCT ON COLC.COSIMPLELICCERTTYPEID = COLCT.COSIMPLELICCERTTYPEID
			INNER JOIN GLOBALENTITY G ON G.GLOBALENTITYID = COLC.GLOBALENTITYID
			INNER JOIN ILLICENSE I ON I.GLOBALENTITYID = G.GLOBALENTITYID
			WHERE I.ILLICENSEID = @ILLICENSEID AND (COLC.EXPIREDATE IS NULL OR COLC.EXPIREDATE > GETDATE())
			for xml path(''), root('MyString'), type
		).value('/MyString[1]','varchar(max)'),1,2,'') AS 'BUSINESSTYPE',
	F.FEEAMOUNT,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Name') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Name') END Municipality_Name,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Address') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Address')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Address') END Municipality_Address,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Phone_Number') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Phone_Number')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Business_License_Municipality_Phone_Number') END Municipality_Phone_Number,
	(SELECT REPLACE(R.REPORTTEXT,CHAR(10),'<BR>') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Professional_License_Text1') Professional_License_Text1,
	(SELECT REPLACE(R.REPORTTEXT,CHAR(10),'<BR>') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Professional_License_Text2') Professional_License_Text2,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Professional_License_Signature_Line') Professional_License_Signature_Line,
   (SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'BL_Logo(CAN be used with signature image)') LOGO,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'BL_Logo(CAN be used with signature image)') SHOWLOGO,
	(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'BL_Watermark(CANNOT be used with signature image)') WATERMARK,
	(SELECT R.DIMENSIONS FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'BL_Watermark(CANNOT be used with signature image)') Watermark_Dimensions,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'BL_Watermark(CANNOT be used with signature image)') SHOWWATERMARK,
	(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Business_License_Signature_Image') SIGIMAGE,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Business_License_Signature_Image') SHOWSIGIMAGE,
	@CUSTOMFIELDS CUSTOMFIELDS
FROM ILLICENSE BL
INNER JOIN GLOBALENTITY BUS ON BL.GLOBALENTITYID = BUS.GLOBALENTITYID
LEFT JOIN #CONTACTADDRESS MA ON BUS.GLOBALENTITYID = MA.GLOBALENTITYID AND MA.ROWNBR = 1
INNER JOIN ILLICENSETYPE BLT ON BL.ILLICENSETYPEID = BLT.ILLICENSETYPEID
INNER JOIN ILLICENSECLASSIFICATION BLC ON BL.ILLICENSECLASSIFICATIONID = BLC.ILLICENSECLASSIFICATIONID
LEFT JOIN #FEES F ON BL.ILLICENSEID = F.ILLICENSEID
WHERE BL.ILLICENSEID = @ILLICENSEID


DROP TABLE #CONTACTADDRESS;
DROP TABLE #FEES;

