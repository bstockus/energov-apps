

CREATE PROCEDURE rpt_IL_SR_Professional_License_KPI_Report

-- Add the parameters for the stored procedure here

--@MODULEID varchar(36)
@STARTDATE datetime,
@ENDDATE datetime

AS

BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;
SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE=dateadd(ss,-1,datediff(dd,0,@ENDDATE) + 1)

-- Insert statements for procedure here
SELECT	'Applied' as KPIType,
		ILLICENSE.ILLICENSEID, ILLICENSE.APPLIEDDATE, ILLICENSE.ISSUEDATE, ILLICENSE.LASTRENEWALDATE,
		ILLICENSETYPE.NAME LICENSETYPE,
		ILLICENSECLASSIFICATION.NAME LICENSECLASSIFICATION,
		ILLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,
	   --(SELECT R.[IMAGE] FROM RPTIMAGELIB R
	   -- WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	ILLICENSE
		INNER JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
		INNER JOIN ILLICENSECLASSIFICATION ON ILLICENSE.ILLICENSECLASSIFICATIONID = ILLICENSECLASSIFICATION.ILLICENSECLASSIFICATIONID
		INNER JOIN ILLICENSESTATUS ON ILLICENSE.ILLICENSESTATUSID  = ILLICENSESTATUS.ILLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON ILLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	ILLICENSE.APPLIEDDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Issued' as KPIType,
		ILLICENSE.ILLICENSEID, ILLICENSE.APPLIEDDATE, ILLICENSE.ISSUEDATE, ILLICENSE.LASTRENEWALDATE,
		ILLICENSETYPE.NAME LICENSETYPE,
		ILLICENSECLASSIFICATION.NAME LICENSECLASSIFICATION,
		ILLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,
	   --(SELECT R.[IMAGE] FROM RPTIMAGELIB R
	   -- WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	ILLICENSE
		INNER JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
		INNER JOIN ILLICENSECLASSIFICATION ON ILLICENSE.ILLICENSECLASSIFICATIONID = ILLICENSECLASSIFICATION.ILLICENSECLASSIFICATIONID
		INNER JOIN ILLICENSESTATUS ON ILLICENSE.ILLICENSESTATUSID  = ILLICENSESTATUS.ILLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON ILLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	ILLICENSE.ISSUEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Renewal' as KPIType,
		ILLICENSE.ILLICENSEID, ILLICENSE.APPLIEDDATE, ILLICENSE.ISSUEDATE, ILLICENSE.LASTRENEWALDATE,
		ILLICENSETYPE.NAME LICENSETYPE,
		ILLICENSECLASSIFICATION.NAME LICENSECLASSIFICATION,
		ILLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
	 --   WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	ILLICENSE
		INNER JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
		INNER JOIN ILLICENSECLASSIFICATION ON ILLICENSE.ILLICENSECLASSIFICATIONID = ILLICENSECLASSIFICATION.ILLICENSECLASSIFICATIONID
		INNER JOIN ILLICENSESTATUS ON ILLICENSE.ILLICENSESTATUSID  = ILLICENSESTATUS.ILLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON ILLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	ILLICENSE.LASTRENEWALDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Fees' as KPIType,
		ILLICENSE.ILLICENSEID, ILLICENSE.APPLIEDDATE, ILLICENSE.ISSUEDATE, ILLICENSE.LASTRENEWALDATE,
		ILLICENSETYPE.NAME LICENSETYPE,
		ILLICENSECLASSIFICATION.NAME LICENSECLASSIFICATION,
		ILLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		COALESCE(LICENSEFEES.LICENSEFEE,0) AS LICENSEFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
	 --   WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	ILLICENSE
		INNER JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
		INNER JOIN ILLICENSECLASSIFICATION ON ILLICENSE.ILLICENSECLASSIFICATIONID = ILLICENSECLASSIFICATION.ILLICENSECLASSIFICATIONID
		INNER JOIN ILLICENSESTATUS ON ILLICENSE.ILLICENSESTATUSID  = ILLICENSESTATUS.ILLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON ILLICENSE.DISTRICTID = DISTRICT.DISTRICTID
		INNER JOIN (
			SELECT	ILLICENSEFEE.ILLICENSEID, CAINVOICE.INVOICEDATE, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) AS LICENSEFEE
			FROM	ILLICENSEFEE
					INNER JOIN CACOMPUTEDFEE ON ILLICENSEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
			WHERE	CACOMPUTEDFEE.ISDELETED = 0
					AND NOT CAINVOICE.CASTATUSID IN (5,9,10)	-- Exclude fees from Void, Refunded and Deleted invoices
					AND CAINVOICE.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE
			GROUP BY ILLICENSEFEE.ILLICENSEID, CAINVOICE.INVOICEDATE
		) AS LICENSEFEES ON ILLICENSE.ILLICENSEID = LICENSEFEES.ILLICENSEID

WHERE	LICENSEFEES.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT 'AppliedOnline',
		ILLICENSE.ILLICENSEID, ILLICENSE.APPLIEDDATE, ILLICENSE.ISSUEDATE, ILLICENSE.LASTRENEWALDATE,
		ILLICENSETYPE.NAME LICENSETYPE,
		ILLICENSECLASSIFICATION.NAME LICENSECLASSIFICATION,
		ILLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM	ILLICENSE
		INNER JOIN ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
		INNER JOIN ILLICENSECLASSIFICATION ON ILLICENSE.ILLICENSECLASSIFICATIONID = ILLICENSECLASSIFICATION.ILLICENSECLASSIFICATIONID
		INNER JOIN ILLICENSESTATUS ON ILLICENSE.ILLICENSESTATUSID  = ILLICENSESTATUS.ILLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON ILLICENSE.DISTRICTID = DISTRICT.DISTRICTID
WHERE (ILLICENSE.APPLIEDDATE BETWEEN @STARTDATE AND @ENDDATE
	OR ILLICENSE.LASTRENEWALDATE BETWEEN @STARTDATE AND @ENDDATE)
	AND ILLICENSE.ISAPPLIEDONLINE = 1


END
