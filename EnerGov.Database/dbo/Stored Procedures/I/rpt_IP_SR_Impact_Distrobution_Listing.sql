
CREATE PROCEDURE rpt_IP_SR_Impact_Distrobution_Listing
AS
SELECT 
--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
--			WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer,
		IPCASE.IPCASEID, IPCASE.CASENUMBER, 
		IPCONDITIONFUNALLOCATION.RESOLUTIONNUMBER, 
		IPCONDITIONFUNALLOCATION.RECOMMENDAMOUNT, 
		IPCONDITIONFUNALLOCATION.APPROVEDAMOUNT, 
		IPCONDITIONFUNALLOCATION.APPROVEDDATE, 
		IPCONDITIONFUNALLOCATION.COMMENTS, 
		IPCAPITALPROJECT.NAME as CAPITALPROJECTNAME,
		IPCONDITION.CONDITIONNUMBER,
		CASE WHEN OWN.ISCONTACT = 1 THEN OWN.FIRSTNAME +  ' ' + OWN.LASTNAME ELSE OWN.GLOBALENTITYNAME END OWNERNAME

FROM	IPCASE JOIN IPCONDITION on IPCASE.IPCASEID = IPCONDITION.IPCASEID and MONETARY = '1'
		INNER JOIN IPCONDITIONFUNALLOCATION on IPCONDITION.IPCONDITIONID = IPCONDITIONFUNALLOCATION.IPCONDITIONID
		LEFT OUTER JOIN IPCAPITALPROJECT on IPCONDITIONFUNALLOCATION.IPCAPITALPROJECTID = IPCAPITALPROJECT.IPCAPITALPROJECTID
/*** Billing Info ***/
		LEFT JOIN ( SELECT	IPCASECONTACT.IPCASEID,
							GLOBALENTITY.GLOBALENTITYID, GLOBALENTITY.GLOBALENTITYNAME, GLOBALENTITY.FIRSTNAME, GLOBALENTITY.LASTNAME, GLOBALENTITY.ISCONTACT,
							ROW_NUMBER() OVER (PARTITION BY IPCASECONTACT.IPCASEID ORDER BY GLOBALENTITY.GLOBALENTITYID) 'RowNBR'
					FROM	IPCASECONTACT JOIN GLOBALENTITY ON IPCASECONTACT.GLOBALENTITYID = GLOBALENTITY.GLOBALENTITYID
					WHERE IPCASECONTACT.ISBILLING = 1
		) as OWN ON IPCASE.IPCASEID = OWN.IPCASEID AND OWN.RowNBR = 1		/*** only want one contact ***/

