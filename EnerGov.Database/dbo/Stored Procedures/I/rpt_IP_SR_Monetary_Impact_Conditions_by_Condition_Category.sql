
CREATE PROCEDURE rpt_IP_SR_Monetary_Impact_Conditions_by_Condition_Category

AS
SELECT	IPCONDITIONCATEGORY.NAME AS ConditionCategoryName, IPCONDITIONCATEGORY.IPCONDITIONCATEGORYID,
		IPCONDITION.CONDITIONNUMBER, IPCONDITION.DESCRIPTION AS IPConditionDesc,
		IPCASE.SOURCECASENUMBER, IPCASE.CASENUMBER,
		DISTRICT.NAME AS DistrictName,
		CASE WHEN ISNULL(IPCONDITIONMONETARY.NUMOFCONDITIONUNIT,0) = 0 THEN IPCONDITIONMONETARY.ASSESSAMOUNT
			 ELSE ISNULL(IPCONDITIONMONETARY.ASSESSAMOUNT,0) * IPCONDITIONMONETARY.NUMOFCONDITIONUNIT
		END AS EstimatedAmount, 
		ISNULL(IPCONDITIONMONETARY.ACTUALCOLLECTEDTODATE,0) AS Collected, 
		ISNULL(TB_FUND.Disbursed,0) AS Disbursed,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
       
FROM	IPCASE
		INNER JOIN IPCASETYPE ON IPCASE.IPCASETYPEID = IPCASETYPE.IPCASETYPEID
		INNER JOIN IPCONDITION ON IPCASE.IPCASEID = IPCONDITION.IPCASEID
		INNER JOIN IPCONDITIONTYPE ON IPCONDITION.IPCONDITIONTYPEID = IPCONDITIONTYPE.IPCONDITIONTYPEID
		INNER JOIN IPCONDITIONCATEGORY ON IPCONDITIONTYPE.IPCONDITIONCATEGORYID = IPCONDITIONCATEGORY.IPCONDITIONCATEGORYID
		INNER JOIN IPCONDITIONMONETARY ON IPCONDITION.IPCONDITIONID = IPCONDITIONMONETARY.IPCONDITIONID
		LEFT OUTER JOIN IPCONDITIONNOTE ON IPCONDITION.IPCONDITIONID = IPCONDITIONNOTE.IPCONDITIONID
		INNER JOIN DISTRICT ON IPCASE.DISTRICTID = DISTRICT.DISTRICTID 
		LEFT OUTER JOIN (SELECT IPCONDITIONID, SUM(APPROVEDAMOUNT) AS Disbursed 
				         FROM IPCONDITIONFUNALLOCATION
						 GROUP BY IPCONDITIONID
						 ) AS TB_FUND ON IPCONDITION.IPCONDITIONID = TB_FUND.IPCONDITIONID
		LEFT OUTER JOIN PLPLAN ON IPCASE.SOURCECASEID = PLPLAN.PLPLANID

WHERE	IPCONDITION.MONETARY = 1

