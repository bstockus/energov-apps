
CREATE PROCEDURE rpt_IP_SR_Monetary_Impact_Conditions_by_Targeted_Fund_Use

AS

SELECT	IPTARGETEDFUNDTYPE.NAME AS IPTARGETEDFUNDTYPE,
		IPCASE.SOURCECASENUMBER,
		IPCASE.CASENUMBER,
		IPCASETYPE.IPCASETYPEID, IPCASETYPE.NAME AS IPCASETYPE,
		DISTRICT.DESCRIPTION AS MAGISTERIALDISTRICT,
		IPCONDITIONMONETARY.NUMOFCONDITIONUNIT, IPCONDITIONMONETARY.ACTUALCOLLECTEDTODATE,
		CASE WHEN IPCONDITIONMONETARY.NUMOFCONDITIONUNIT <> 0 THEN IPCONDITIONMONETARY.ASSESSAMOUNT * IPCONDITIONMONETARY.NUMOFCONDITIONUNIT
			 ELSE IPCONDITIONMONETARY.ASSESSAMOUNT
		END AS ESTIMATEDPROFFER,
		CASE WHEN ISNULL(IPCONDITIONMONETARY.ACTUALCOLLECTEDTODATE, 0) - ISNULL(TB_FUND.Disbursed, 0) <= 0 THEN 0
			 ELSE ISNULL(IPCONDITIONMONETARY.ACTUALCOLLECTEDTODATE, 0) - ISNULL(TB_FUND.Disbursed, 0)
		END AS AVAILABLEFUNDS,
		IPCONDITION.IPCONDITIONTYPEID, IPCONDITION.DESCRIPTION AS IPUSEOFFUNDS, IPCONDITION.CONDITIONNUMBER,
		IPCONDITIONCATEGORY.IPCONDITIONCATEGORYID, IPCONDITIONCATEGORY.NAME AS IPCONDITIONCATEGORY,
		ISNULL(TB_FUND.Disbursed, 0) AS AMOUNTDISBURSED,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	IPCONDITION
		INNER JOIN IPCONDITIONTYPE ON IPCONDITION.IPCONDITIONTYPEID = IPCONDITIONTYPE.IPCONDITIONTYPEID
		INNER JOIN IPCONDITIONCATEGORY ON IPCONDITIONTYPE.IPCONDITIONCATEGORYID = IPCONDITIONCATEGORY.IPCONDITIONCATEGORYID

		INNER JOIN IPCASE ON IPCONDITION.IPCASEID = IPCASE.IPCASEID
		INNER JOIN IPCONDITIONMONETARY ON IPCONDITION.IPCONDITIONID = IPCONDITIONMONETARY.IPCONDITIONID
		INNER JOIN IPCASETYPE ON IPCASE.IPCASETYPEID = IPCASETYPE.IPCASETYPEID

		INNER JOIN DISTRICT ON IPCASE.DISTRICTID = DISTRICT.DISTRICTID
		INNER JOIN IPTARGETEDFUNDTYPE ON IPCONDITIONMONETARY.IPTARGETEDFUNDTYPEID = IPTARGETEDFUNDTYPE.IPTARGETEDFUNDTYPEID
		LEFT JOIN (SELECT IPCONDITIONID, SUM(APPROVEDAMOUNT) AS Disbursed
					FROM IPCONDITIONFUNALLOCATION
					GROUP BY IPCONDITIONID
				  ) AS TB_FUND ON IPCONDITION.IPCONDITIONID = TB_FUND.IPCONDITIONID

WHERE	IPCONDITION.MONETARY = 1

ORDER BY IPCONDITIONCATEGORY, IPTARGETEDFUNDTYPE, SOURCECASENUMBER, CONDITIONNUMBER

