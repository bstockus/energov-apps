
--  EXEC [rpt_IL_SR_Avery_5160_Professional_License_Company_Labels] '01/01/2016', '06/01/2019'

CREATE PROCEDURE [dbo].[rpt_IL_SR_Avery_5160_Professional_License_Company_Labels]
@STARTDATE  DATETIME,
@ENDDATE	DATETIME,
@FILTER VARCHAR(150)
AS

SET @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(SECOND,-1,DATEDIFF(DAY,0,@ENDDATE) + 1) 

SELECT * FROM (
SELECT GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS NAME, ILT.NAME AS IL_TYPE,
       MA.ADDRESSLINE1, MA.ADDRESSLINE2, MA.ADDRESSLINE3, MA.CITY, MA."STATE",
       MA.POSTALCODE, MA.POSTDIRECTION, MA.PREDIRECTION, MA.STREETTYPE, MA.UNITORSUITE
	   , IL.ILLICENSEID, IL.LICENSENUMBER
	   , ROW_NUMBER()OVER(PARTITION BY IL.ILLICENSEID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE 'MAILING%' THEN 2 ELSE 4 END) ROWNBR
FROM  ILLICENSE IL
INNER JOIN ILLICENSETYPE ILT ON IL.ILLICENSETYPEID = ILT.ILLICENSETYPEID
INNER JOIN GLOBALENTITY GE ON IL.GLOBALENTITYID = GE.GLOBALENTITYID
LEFT JOIN ILLICENSEADDRESS IA ON IL.ILLICENSEID = IA.ILLICENSEID
LEFT OUTER JOIN MAILINGADDRESS MA ON IA.MAILINGADDRESSID = MA.MAILINGADDRESSID --AND MA.ADDRESSTYPE = 'MAILING ADDRESS'
WHERE 
	CASE @FILTER
		WHEN 'APPLIED DATE' THEN IL.APPLIEDDATE
		WHEN 'EXPIRED DATE' THEN IL.EXPIRATIONDATE
		WHEN 'ISSUED DATE' THEN IL.ISSUEDATE
		WHEN 'RENEWED DATE' THEN IL.LASTRENEWALDATE 
	END BETWEEN @STARTDATE AND @ENDDATE
) X WHERE X.ROWNBR = 1

