CREATE PROCEDURE [dbo].[USP_INTEGRATION_UPDATE_CHARGECODE_GL_AUDIT_LOG]
	@BATCH_NUMBER AS NVARCHAR(50),
	@EXCLUDE_RECEIPTNUMBER AS RecordNames READONLY
AS

BEGIN

DECLARE @HAVE_REJECTED_RECEIPTNUMBER AS BIT = (SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM @EXCLUDE_RECEIPTNUMBER);

DECLARE @Finance_Batch_Audit AS TABLE (
	CAFINANCIALINTGLAUDITID CHAR(36) NOT NULL,
	CHARGECODE NVARCHAR(100) NOT NULL
);

INSERT INTO @Finance_Batch_Audit
SELECT DISTINCT CAFINANCIALINTGLAUDITID, TRANSFEE.CHARGECODE
FROM CAINTEGRATIONBATCHPROCESS
INNER JOIN CATRANSACTION On CAINTEGRATIONBATCHPROCESS.BATCH_NUMBER = CATRANSACTION.EXTERNALBATCHNBR 
INNER JOIN ( 
SELECT CATRANSACTIONID, CATRANSACTIONGLPOSTINGID, CAFEE.ARFEECODE AS CHARGECODE, CATRANSACTIONFEEPOSTINGID, CATRANSACTIONFEE.CACOMPUTEDFEEID, CATRANSACTIONFEE.PAIDAMOUNT, REFUNDAMOUNT, CATRANSACTIONFEE.CASTATUSID, CACOMPUTEDFEE.FEENAME AS FEENAME
FROM CATRANSACTIONFEE 
INNER JOIN CATRANSACTIONFEEPOSTING ON CATRANSACTIONFEE.CATRANSACTIONFEEID = CATRANSACTIONFEEPOSTING.CATRANSACTIONFEEID
INNER JOIN CACOMPUTEDFEE ON CATRANSACTIONFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
INNER JOIN CAFEETEMPLATEFEE ON CACOMPUTEDFEE.CAFEETEMPLATEFEEID = CAFEETEMPLATEFEE.CAFEETEMPLATEFEEID
INNER JOIN CAFEE ON CAFEETEMPLATEFEE.CAFEEID = CAFEE.CAFEEID
UNION ALL
SELECT CATRANSACTIONID, CATRANSACTIONGLPOSTINGID, CAFEE.ARFEECODE AS CHARGECODE, CATRANSACTIONMISCFEEPOSTINGID, CAMISCFEE.CAMISCFEEID, CATRANSACTIONMISCFEE.PAIDAMOUNT, REFUNDAMOUNT, CATRANSACTIONMISCFEE.CASTATUSID, CAMISCFEE.FEENAME AS FEENAME
FROM CATRANSACTIONMISCFEE 
INNER JOIN CATRANSACTIONMISCFEEPOSTING ON CATRANSACTIONMISCFEE.CATRANSACTIONMISCFEEID = CATRANSACTIONMISCFEEPOSTING.CATRANSACTIONMISCFEEID
INNER JOIN CAMISCFEE ON CATRANSACTIONMISCFEE.CAMISCFEEID = CAMISCFEE.CAMISCFEEID
INNER JOIN CAFEE ON CAMISCFEE.CAFEEID = CAFEE.CAFEEID
UNION ALL
SELECT CATRANSACTIONID, CATRANSACTIONGLPOSTINGID, GLOBALENTITYACCOUNTTYPE.CHARGECODE, CATRANSACTIONACCOUNTPOSTINGID, CATRANSACTIONACCOUNT.CATRANSACTIONACCOUNTID, CATRANSACTIONACCOUNT.AMOUNT, 0 REFUNDAMOUNT, NULL CASTATUSID, ENTITYACCOUNTNUMBER AS FEENAME
FROM CATRANSACTIONACCOUNT 
INNER JOIN CATRANSACTIONACCOUNTPOSTING ON CATRANSACTIONACCOUNT.CATRANSACTIONACCOUNTID = CATRANSACTIONACCOUNTPOSTING.CATRANSACTIONACCOUNTID
INNER JOIN GLOBALENTITYACCOUNT ON CATRANSACTIONACCOUNT.ENTITYACCOUNTID = GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTID
INNER JOIN GLOBALENTITYACCOUNTTYPE ON GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTTYPEID = GLOBALENTITYACCOUNTTYPE.GLOBALENTITYACCOUNTTYPEID
) AS TRANSFEE ON CATRANSACTION.CATRANSACTIONID = TRANSFEE.CATRANSACTIONID
INNER JOIN CATRANSACTIONGLPOSTING on TRANSFEE.CATRANSACTIONGLPOSTINGID = CATRANSACTIONGLPOSTING.CATRANSACTIONGLPOSTINGID
INNER JOIN CAFINANCIALINTGLAUDIT on CATRANSACTIONGLPOSTING.CATRANSACTIONGLPOSTINGID = CAFINANCIALINTGLAUDIT.CATRANSACTIONGLPOSTINGID
WHERE CAINTEGRATIONBATCHPROCESS.BATCH_NUMBER = @BATCH_NUMBER
AND ((@HAVE_REJECTED_RECEIPTNUMBER = 0)
  OR (@HAVE_REJECTED_RECEIPTNUMBER = 1 AND NOT EXISTS (SELECT 'X' FROM @EXCLUDE_RECEIPTNUMBER A WHERE CATRANSACTION.RECEIPTNUMBER = A.Name)))
;

IF EXISTS (SELECT 1 FROM @Finance_Batch_Audit)
BEGIN
	UPDATE CAFINANCIALINTGLAUDIT 
	SET CHARGECODE = BATCHAUDIT.CHARGECODE
	FROM CAFINANCIALINTGLAUDIT
	JOIN @Finance_Batch_Audit AS BATCHAUDIT ON CAFINANCIALINTGLAUDIT.CAFINANCIALINTGLAUDITID = BATCHAUDIT.CAFINANCIALINTGLAUDITID
END

END