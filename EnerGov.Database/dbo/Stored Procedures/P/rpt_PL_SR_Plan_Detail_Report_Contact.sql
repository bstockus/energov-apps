

CREATE PROCEDURE [dbo].[rpt_PL_SR_Plan_Detail_Report_Contact]
@PLPLANID AS VARCHAR(36)
AS
WITH CONTACT_CTE AS
(SELECT GEMA.GLOBALENTITYID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2,
	ROW_NUMBER() OVER (PARTITION BY GEMA.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE  'Mailing%' THEN 1 WHEN MA.ADDRESSTYPE LIKE 'Location%' THEN 2 WHEN MA.ADDRESSTYPE LIKE 'Business%' THEN 3 ELSE 4 END ) AS ROWNBR
FROM GLOBALENTITYMAILINGADDRESS GEMA 
INNER JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID)

SELECT GE.GLOBALENTITYID,
	MA.ADDRESS_LINE1,
	MA.ADDRESS_LINE2,
	CASE WHEN GE.ISCONTACT = 1 
		THEN
			CASE WHEN GE.ISCOMPANY = 1
				THEN GE.GLOBALENTITYNAME + CHAR(13) + GE.FIRSTNAME + (
					CASE WHEN ISNULL(GE.MIDDLENAME,'') = '' 
						THEN '' 
						ELSE ' ' + LEFT(GE.MIDDLENAME,1)
					END) + ' ' + GE.LASTNAME 
				ELSE GE.FIRSTNAME + (
					CASE WHEN ISNULL(GE.MIDDLENAME,'') = '' 
						THEN '' 
						ELSE ' ' + LEFT(GE.MIDDLENAME,1)
					END) + ' ' + GE.LASTNAME 
			END
		ELSE GE.GLOBALENTITYNAME END CONTACTNAME,
	GE.BUSINESSPHONE,
	GE.HOMEPHONE,
	GE.MOBILEPHONE,
	LMCT.[NAME] CONTACTTYPE
FROM PLPLANCONTACT PL
INNER JOIN GLOBALENTITY GE ON GE.GLOBALENTITYID = PL.GLOBALENTITYID
INNER JOIN LANDMANAGEMENTCONTACTTYPE LMCT ON LMCT.LANDMANAGEMENTCONTACTTYPEID = PL.LANDMANAGEMENTCONTACTTYPEID
LEFT JOIN CONTACT_CTE MA ON MA.GLOBALENTITYID = GE.GLOBALENTITYID AND MA.ROWNBR = 1

WHERE PL.PLPLANID = @PLPLANID

