

CREATE PROCEDURE rpt_PL_SR_Plan_KPI_Report 

-- Add the parameters for the stored procedure here

--@MODULEID varchar(36)
@STARTDATE datetime,
@ENDDATE datetime

AS

BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;
SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE=dateadd(ss,-1,datediff(dd,0,@ENDDATE) + 1)
--DECLARE @STARTDATE DATETIME = '1/1/2018', @ENDDATE DATETIME = '1/1/2019';

-- Insert statements for procedure here
SELECT	'Applied' as KPIType,
		PLPLAN.PLPLANID, PLPLAN.APPLICATIONDATE, PLPLAN.COMPLETEDATE,
		PLPLANTYPE.PLANNAME PLANTYPE,
		PLPLANWORKCLASS.NAME PLANCLASS,
		PLPLANSTATUS.NAME PLANSTATUS,
		DISTRICT.NAME PLANDISTRICT,
		0 AS PLANFEE,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	PLPLAN
		INNER JOIN PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID
		INNER JOIN PLPLANWORKCLASS ON PLPLAN.PLPLANWORKCLASSID = PLPLANWORKCLASS.PLPLANWORKCLASSID
		INNER JOIN PLPLANSTATUS ON PLPLAN.PLPLANSTATUSID  = PLPLANSTATUS.PLPLANSTATUSID
		LEFT OUTER JOIN DISTRICT ON PLPLAN.DISTRICTID = DISTRICT.DISTRICTID
WHERE	PLPLAN.APPLICATIONDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Completed' as KPIType,
		PLPLAN.PLPLANID, PLPLAN.APPLICATIONDATE, PLPLAN.COMPLETEDATE,
		PLPLANTYPE.PLANNAME PLANTYPE,
		PLPLANWORKCLASS.NAME PLANCLASS,
		PLPLANSTATUS.NAME PLANSTATUS,
		DISTRICT.NAME PLANDISTRICT,
		0 AS PLANFEE,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	PLPLAN
		INNER JOIN PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID
		INNER JOIN PLPLANWORKCLASS ON PLPLAN.PLPLANWORKCLASSID = PLPLANWORKCLASS.PLPLANWORKCLASSID
		INNER JOIN PLPLANSTATUS ON PLPLAN.PLPLANSTATUSID  = PLPLANSTATUS.PLPLANSTATUSID
		LEFT OUTER JOIN DISTRICT ON PLPLAN.DISTRICTID = DISTRICT.DISTRICTID
WHERE	PLPLAN.COMPLETEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Fees' as KPIType,
		PLPLAN.PLPLANID, PLPLAN.APPLICATIONDATE, PLPLAN.COMPLETEDATE,
		PLPLANTYPE.PLANNAME PLANTYPE,
		PLPLANWORKCLASS.NAME PLANCLASS,
		PLPLANSTATUS.NAME PLANSTATUS,
		DISTRICT.NAME PLANDISTRICT,
		COALESCE(PLANFEES.PLANFEE,0) AS PLANFEE,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	PLPLAN
		INNER JOIN PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID
		INNER JOIN PLPLANWORKCLASS ON PLPLAN.PLPLANWORKCLASSID = PLPLANWORKCLASS.PLPLANWORKCLASSID
		INNER JOIN PLPLANSTATUS ON PLPLAN.PLPLANSTATUSID  = PLPLANSTATUS.PLPLANSTATUSID
		LEFT OUTER JOIN DISTRICT ON PLPLAN.DISTRICTID = DISTRICT.DISTRICTID
		INNER JOIN (
			SELECT	PLPLANFEE.PLPLANID, CAINVOICE.INVOICEDATE, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) AS PLANFEE
			FROM	PLPLANFEE
					INNER JOIN CACOMPUTEDFEE ON PLPLANFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
			WHERE	CACOMPUTEDFEE.ISDELETED = 0
					AND NOT CAINVOICE.CASTATUSID IN (5,9,10)	-- Exclude fees from Void, Refunded and Deleted invoices
					AND CAINVOICE.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE
			GROUP BY PLPLANFEE.PLPLANID, CAINVOICE.INVOICEDATE
		) AS PLANFEES ON PLPLAN.PLPLANID = PLANFEES.PLPLANID

WHERE	PLANFEES.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION ALL

SELECT 'AppliedOnline'
	, P.PLPLANID, P.APPLICATIONDATE, P.COMPLETEDATE
	, PT.PLANNAME
	, WC.NAME
	, PS.NAME
	, D.NAME
	, 0
	, (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
	, (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
	, (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM PLPLAN P
INNER JOIN PLPLANTYPE PT ON P.PLPLANTYPEID = PT.PLPLANTYPEID
INNER JOIN PLPLANWORKCLASS WC ON P.PLPLANWORKCLASSID = WC.PLPLANWORKCLASSID
LEFT JOIN DISTRICT D ON P.DISTRICTID = D.DISTRICTID
INNER JOIN PLPLANSTATUS PS ON P.PLPLANSTATUSID = PS.PLPLANSTATUSID
WHERE P.ISAPPLIEDONLINE = 1
	AND P.APPLICATIONDATE BETWEEN @STARTDATE AND @ENDDATE

END
