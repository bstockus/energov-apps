
-- select * from pmpermit order by applydate desc
-- EXEC rpt_PM_Standard_Inspection_Card 'da071fe9-aae6-4657-8b58-746ce05777ff',''
CREATE PROCEDURE rpt_PM_Standard_Inspection_Card
@PMPERMITID varchar(36),
@REPORTID VARCHAR(36)
AS

DECLARE @CUSTOMFIELDS NVARCHAR(MAX) = '';
EXEC [dbo].[GetCustomReportText] @REPORTID, @PMPERMITID, @CUSTOMFIELDS OUTPUT; 


/*BUILD CONTACT LIST TO GET OWNERS AND CONTRACTORS*/
SELECT PMC.PMPERMITID, GE.FIRSTNAME, GE.LASTNAME, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME COMPANYNAME,
	LMCT.NAME CONTACTTYPE, PMC.ISBILLING, GE.ISCOMPANY, GE.ISCONTACT, GE.MIDDLENAME,
	ROW_NUMBER() OVER (PARTITION BY PMC.PMPERMITID,LMCT.NAME ORDER BY GE.GLOBALENTITYID) AS ROWNBR,
	CASE	WHEN LEN(LTRIM(GE.BUSINESSPHONE)) > 0 THEN GE.BUSINESSPHONE 
		WHEN LEN(LTRIM(GE.MOBILEPHONE)) > 0 THEN GE.MOBILEPHONE 
		WHEN LEN(LTRIM(GE.HOMEPHONE)) > 0 THEN GE.HOMEPHONE 
		WHEN LEN(LTRIM(GE.OTHERPHONE)) > 0 THEN GE.OTHERPHONE 
		ELSE '' END AS PHONE
INTO #CONTACTS
FROM PMPERMITCONTACT PMC
INNER JOIN GLOBALENTITY GE ON PMC.GLOBALENTITYID = GE.GLOBALENTITYID
INNER JOIN LANDMANAGEMENTCONTACTTYPE LMCT ON PMC.LANDMANAGEMENTCONTACTTYPEID = LMCT.LANDMANAGEMENTCONTACTTYPEID
WHERE PMC.PMPERMITID = @PMPERMITID

/*MAIN ADDRESS OF PERMIT*/
SELECT PA.PMPERMITID, PA.MAIN, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2
INTO #MADDRESS
FROM PMPERMITADDRESS PA
INNER JOIN MAILINGADDRESS MA ON PA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE PA.PMPERMITID = @PMPERMITID AND PA.MAIN = 1

/*ADDRESS LIST FOR CONTACTS*/
SELECT GEMA.GLOBALENTITYID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2,
	ROW_NUMBER() OVER (PARTITION BY GEMA.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE 'Mailing%' THEN 1 WHEN MA.ADDRESSTYPE LIKE 'Billing%' THEN 2 WHEN MA.ADDRESSTYPE LIKE 'Location%' THEN 3 ELSE 4 END ) AS ROWNBR
INTO #CONTACTADDRESS
FROM GLOBALENTITYMAILINGADDRESS GEMA 
INNER JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID


CREATE INDEX TEMP1 ON #CONTACTS (PMPERMITID);
CREATE INDEX TEMP1 ON #MADDRESS (PMPERMITID);
CREATE INDEX TEMP1 ON #CONTACTADDRESS (GLOBALENTITYID);
CREATE INDEX TEMP2 ON #CONTACTADDRESS (ROWNBR);

/*BEGIN MAIN QUERY*/

SELECT PM.PMPERMITID, PM.PERMITNUMBER, PM.SQUAREFEET, PM.VALUE, PM.[DESCRIPTION], PM.ISSUEDATE, PM."EXPIREDATE", PM.IVRNUMBER PERMIT_IVRNUMBER,
	PMT.NAME AS PMTYPE,
	PMWC.NAME AS PMCLASS,
	PMS.NAME AS PMSTATUS,
	MA.ADDRESS_LINE1 MADDRESS_LINE1, MA.ADDRESS_LINE2 MADDRESS_LINE2,
	CASE WHEN OWN.ISCOMPANY = 1 THEN OWN.COMPANYNAME ELSE OWN.FIRSTNAME + ' ' + OWN.LASTNAME END OWNERNAME,
	OWN.PHONE OWNERPHONE,
	CASE WHEN CON.ISCOMPANY = 1 THEN CON.COMPANYNAME ELSE CON.FIRSTNAME + ' ' + CON.LASTNAME END CONTRACTORNAME,
	CON.PHONE CONTRACTORPHONE, CON.GLOBALENTITYID CONID,
	CONADD.ADDRESS_LINE1, CONADD.ADDRESS_LINE2,
	CASE WHEN EXISTS (SELECT TOP 1 * FROM IVInspectionStaging) 
		THEN 'Y' 
		ELSE 'N'
		END AS IVR_FLAG,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Inspection_Card_Municipality_Name') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Inspection_Card_Municipality_Name') END Municipality_Name,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Inspection_Card_Footer') Inspection_Card_Footer,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Address') Municipality_Address,
	(SELECT  REPLACE(R.REPORTTEXT,CHAR(10),'<BR>') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Inspection_Card_Contact_Info') Inspection_Card_Contact_Info,
	(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Permit_Logo') LOGO,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Permit_Logo') SHOWLOGO,
	@CUSTOMFIELDS CUSTOMFIELDS
FROM PMPERMIT PM
INNER JOIN PMPERMITTYPE PMT ON PM.PMPERMITTYPEID = PMT.PMPERMITTYPEID
INNER JOIN PMPERMITWORKCLASS PMWC ON PM.PMPERMITWORKCLASSID = PMWC.PMPERMITWORKCLASSID
INNER JOIN PMPERMITSTATUS PMS ON PM.PMPERMITSTATUSID = PMS.PMPERMITSTATUSID
LEFT JOIN #MADDRESS MA ON PM.PMPERMITID = MA.PMPERMITID
LEFT JOIN #CONTACTS OWN ON PM.PMPERMITID = OWN.PMPERMITID AND OWN.CONTACTTYPE LIKE '%OWNER%' AND OWN.ROWNBR = 1
LEFT JOIN #CONTACTS CON ON PM.PMPERMITID = CON.PMPERMITID AND CON.CONTACTTYPE LIKE '%CONTRACTOR%'
LEFT JOIN #CONTACTADDRESS CONADD ON CON.GLOBALENTITYID = CONADD.GLOBALENTITYID AND CONADD.ROWNBR = 1

WHERE PM.PMPERMITID = @PMPERMITID

DROP TABLE #CONTACTS;
DROP TABLE #CONTACTADDRESS;
DROP TABLE #MADDRESS;
