
CREATE PROCEDURE rpt_PM_SR_Contractor_Listing
	@STARTDATE AS DATETIME,
	@ENDDATE AS DATETIME,
	@FILTER AS VARCHAR(150)
	AS
Begin
SET @STARTDATE = DATEADD(dd, DATEDIFF(dd, 0, @startdate), 0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))  

SELECT PMC.PMPERMITID, GE.FIRSTNAME, GE.LASTNAME, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME COMPANYNAME,
	LMCT.NAME CONTACTTYPE, PMC.ISBILLING, GE.ISCOMPANY, GE.ISCONTACT, GE.MIDDLENAME, GE.EMAIL,
	ROW_NUMBER() OVER (PARTITION BY PMC.PMPERMITID,LMCT.NAME ORDER BY GE.GLOBALENTITYID) AS ROWNBR,
	CASE	WHEN LEN(LTRIM(GE.BUSINESSPHONE)) > 0 THEN GE.BUSINESSPHONE 
		WHEN LEN(LTRIM(GE.MOBILEPHONE)) > 0 THEN GE.MOBILEPHONE 
		WHEN LEN(LTRIM(GE.HOMEPHONE)) > 0 THEN GE.HOMEPHONE 
		WHEN LEN(LTRIM(GE.OTHERPHONE)) > 0 THEN GE.OTHERPHONE 
		ELSE '' END AS PHONE,
	ISNULL(STUFF((select  ', '+ COLC.LICENSENUMBER + ' - ' +  COLCT.NAME
		FROM COLICENSECERTIFICATION COLC
		INNER JOIN COLICENSECERTIFICATIONTYPE COLCT ON COLCT.COSIMPLELICCERTTYPEID = COLC.COSIMPLELICCERTTYPEID
		WHERE COLC.GLOBALENTITYID = GE.GLOBALENTITYID
		ORDER BY COLC.LICENSENUMBER
		for xml path(''), root('MyString'), type
		).value('/MyString[1]','varchar(max)'),1,2,''),'') AS 'LICENSE'
INTO #CONTACTS
FROM PMPERMITCONTACT PMC
INNER JOIN GLOBALENTITY GE ON PMC.GLOBALENTITYID = GE.GLOBALENTITYID
INNER JOIN LANDMANAGEMENTCONTACTTYPE LMCT ON PMC.LANDMANAGEMENTCONTACTTYPEID = LMCT.LANDMANAGEMENTCONTACTTYPEID
WHERE LMCT.NAME LIKE '%CONTRACTOR%'

SELECT GEMA.GLOBALENTITYID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + MA.POSTALCODE) ADDRESS_LINE2,
	ROW_NUMBER() OVER (PARTITION BY GEMA.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE '%Mailing%' THEN 1 WHEN MA.ADDRESSTYPE LIKE '%Business%' THEN 2 ELSE 3 END ) AS ROWNBR
INTO #ADDRESS
FROM GLOBALENTITYMAILINGADDRESS GEMA 
INNER JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID

SELECT PA.PMPERMITID, PA.MAIN, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + MA.POSTALCODE) ADDRESS_LINE2
INTO #MADDRESS
FROM PMPERMITADDRESS PA
INNER JOIN MAILINGADDRESS MA ON PA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE PA.MAIN = 1

SELECT DISTINCT PMH.PMPERMITID
INTO #HOLDS
FROM PMPERMITHOLD PMH
WHERE PMH.ACTIVE = 1

CREATE INDEX TEMP1 ON #CONTACTS (PMPERMITID);
CREATE INDEX TEMP1 ON #ADDRESS (GLOBALENTITYID);
CREATE INDEX TEMP1 ON #MADDRESS (PMPERMITID);
CREATE INDEX TEMP1 ON #HOLDS (PMPERMITID);

SELECT PMPERMITSTATUS.NAME AS PermitStatus, PMPERMITTYPE.NAME AS PermitType, PMPERMITWORKCLASS.NAME AS PermitClass, 
       PMPERMIT.PERMITNUMBER, PMPERMIT.EXPIREDATE, PMPERMIT.VALUE, PMPERMIT.DESCRIPTION AS PermitDesc,
       PRPROJECT.NAME AS ProjectName, PMPERMIT.SQUAREFEET, DISTRICT.NAME AS District, PARCEL.PARCELNUMBER, 
	   MA.ADDRESS_LINE1,
	   MA.ADDRESS_LINE2,
       PMPERMIT.PMPERMITID, PMPERMIT.APPLYDATE, PMPERMIT.FINALIZEDATE, PMPERMIT.ISSUEDATE, PMPERMITWORKCLASS.NAME WorkClass,
	   U.FNAME + ' ' + U.LNAME ASSIGNEDTO, PMPERMIT.LASTINSPECTIONDATE,
	 --(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer,
	CASE WHEN H.PMPERMITID IS NULL THEN 'N' ELSE 'Y' END AS HOLDFLAG,
	CASE WHEN CON.ISCONTACT = 1 THEN CON.FIRSTNAME + (CASE WHEN ISNULL(CON.MIDDLENAME,'') = '' THEN '' ELSE ' ' + LEFT(CON.MIDDLENAME,1)  END )+ ' ' + CON.LASTNAME ELSE CON.COMPANYNAME END CONTRACTORNAME,
	CON.PHONE,
	CON.LICENSE,
	CON.EMAIL,
	CON.CONTACTTYPE,
	CONADD.ADDRESS_LINE1 CON_ADDRESS_LINE1,
	CONADD.ADDRESS_LINE2 CON_ADDRESS_LINE2
FROM PMPERMIT PMPERMIT
INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID = PMPERMITSTATUS.PMPERMITSTATUSID
INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
INNER JOIN PMPERMITWORKCLASS ON PMPERMIT.PMPERMITWORKCLASSID = PMPERMITWORKCLASS.PMPERMITWORKCLASSID
INNER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID
LEFT JOIN PRPROJECTPERMIT ON PMPERMIT.PMPERMITID = PRPROJECTPERMIT.PMPERMITID
LEFT JOIN PRPROJECT ON PRPROJECTPERMIT.PRPROJECTID = PRPROJECT.PRPROJECTID
LEFT JOIN ( SELECT * FROM PMPERMITPARCEL WHERE PMPERMITPARCEL.MAIN = 1 ) AS PMPERMITPARCEL ON PMPERMIT.PMPERMITID = PMPERMITPARCEL.PMPERMITID
LEFT JOIN PARCEL ON PMPERMITPARCEL.PARCELID = PARCEL.PARCELID
LEFT JOIN #MADDRESS MA ON MA.PMPERMITID = PMPERMIT.PMPERMITID
LEFT JOIN USERS U ON PMPERMIT.ASSIGNEDTO = U.SUSERGUID
LEFT JOIN #CONTACTS CON ON PMPERMIT.PMPERMITID = CON.PMPERMITID
LEFT JOIN #ADDRESS CONADD ON CON.GLOBALENTITYID = CONADD.GLOBALENTITYID AND CONADD.ROWNBR = 1
LEFT JOIN #HOLDS H ON H.PMPERMITID = PMPERMIT.PMPERMITID
WHERE (CASE @FILTER 
	WHEN 'EXPIRATION DATE' THEN PMPERMIT.EXPIREDATE
	WHEN 'APPLIED DATE' THEN PMPERMIT.APPLYDATE
	WHEN 'FINALED DATE' THEN PMPERMIT.FINALIZEDATE
	WHEN 'ISSUED DATE' THEN PMPERMIT.ISSUEDATE
	WHEN 'LAST INSPECTION DATE' THEN PMPERMIT.LASTINSPECTIONDATE END)  BETWEEN @STARTDATE AND @ENDDATE

DROP TABLE #CONTACTS;
DROP TABLE #ADDRESS;
DROP TABLE #MADDRESS;
DROP TABLE #HOLDS;

END
