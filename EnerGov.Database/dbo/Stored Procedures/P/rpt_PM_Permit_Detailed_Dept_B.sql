
-- select * from pmpermit where permitnumber like '%bc%40%'
-- exec rpt_PM_Permit_Detailed_Dept_B '7d2a81d0-40bb-49cd-a431-c2b223fc5299',''
CREATE PROCEDURE rpt_PM_Permit_Detailed_Dept_B
@PMPERMITID varchar(36),
@REPORTID VARCHAR(36)
AS

--DECLARE @PMPERMITID varchar(36) = '7d2a81d0-40bb-49cd-a431-c2b223fc5299'
DECLARE @CUSTOMFIELDS NVARCHAR(MAX) = '';
EXEC [dbo].[GetCustomReportText] @REPORTID, @PMPERMITID, @CUSTOMFIELDS OUTPUT; 

/*GET MAIN ADDRESS*/
SELECT PA.PMPERMITID, PA.MAIN, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') +  
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2
INTO #MADDRESS
FROM PMPERMITADDRESS PA
INNER JOIN MAILINGADDRESS MA ON PA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE PA.PMPERMITID = @PMPERMITID AND PA.MAIN = 1


/*BEGIN MAIN QUERY*/
SELECT PM.PMPERMITID, PM.PERMITNUMBER, PM.ISSUEDATE, PM.EXPIREDATE, PM.VALUE AS VALUATION, 
	PM.SQUAREFEET, PM.DESCRIPTION,
	PTP.NAME AS PERMITTYPE,
	PWC.NAME AS WORKCLASS,
	PS.NAME AS PERMITSTATUS,
	PAR.PARCELNUMBER,
	MA.ADDRESS_LINE1 MADDRESS_LINE1, MA.ADDRESS_LINE2 MADDRESS_LINE2,
	U.FNAME + ' ' + U.LNAME ISSUEDBY,
	PR.NAME PROJECTNAME,
	CASE WHEN EXISTS (SELECT TOP 1 * FROM IVInspectionStaging) 
		THEN 'Y' 
		ELSE 'N'
		END AS IVR_FLAG,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Municipality_Name') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Municipality_Name') END Municipality_Name,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Municipality_Address') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Address')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Municipality_Address') END Municipality_Address,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Notice_Prefix') Permit_Notice_Prefix,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Page_Footer') Permit_Page_Footer,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Signature_1') Permit_Signature_1,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Signature_2') Permit_Signature_2,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Permit_Detailed_Dept_B_Inspection_Phone') Inspection_Phone,
	(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Permit_Detailed_Dept_B_Logo') LOGO,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Permit_Detailed_Dept_B_Logo') SHOWLOGO,
	@CUSTOMFIELDS CUSTOMFIELDS
	

FROM PMPERMIT PM
INNER JOIN PMPERMITTYPE PTP ON PTP.PMPERMITTYPEID = PM.PMPERMITTYPEID
INNER JOIN PMPERMITWORKCLASS PWC ON PWC.PMPERMITWORKCLASSID = PM.PMPERMITWORKCLASSID
INNER JOIN PMPERMITSTATUS PS ON PS.PMPERMITSTATUSID = PM.PMPERMITSTATUSID
LEFT  JOIN PMPERMITPARCEL PPAR ON PPAR.PMPERMITID = PM.PMPERMITID AND PPAR.MAIN = 1
LEFT  JOIN PARCEL PAR ON PPAR.PARCELID = PAR.PARCELID
LEFT  JOIN #MADDRESS MA ON PM.PMPERMITID = MA.PMPERMITID
LEFT  JOIN USERS U ON PM.ASSIGNEDTO = U.SUSERGUID
LEFT  JOIN PRPROJECTPERMIT PRPM ON PM.PMPERMITID = PRPM.PMPERMITID
LEFT  JOIN PRPROJECT PR ON PR.PRPROJECTID = PRPM.PRPROJECTID
WHERE PM.PMPERMITID = @PMPERMITID

DROP TABLE #MADDRESS;

