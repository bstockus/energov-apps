
-- select * from PLPLAN order by APPLICATIONDATE desc where Plannumber like '%bc%40%'
-- exec rpt_PL_Standard_Plan_Detailed '04421b7c-335d-46cf-af35-38fe5c82c3c5',''
CREATE PROCEDURE rpt_PL_Standard_Plan_Detailed
@PLPLANID varchar(36),
@REPORTID VARCHAR(36)
AS

DECLARE @CUSTOMFIELDS NVARCHAR(MAX) = '';
EXEC [dbo].[GetCustomReportText] @REPORTID, @PLPLANID, @CUSTOMFIELDS OUTPUT; 

/*GET MAIN ADDRESS*/
SELECT PA.PLPLANID, PA.MAIN
	 , MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	   LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1
	 , RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') +  
	        (CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		          THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		          ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2
			  
INTO #MADDRESS
FROM PLPLANADDRESS PA
INNER JOIN MAILINGADDRESS MA ON PA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE PA.PLPLANID = @PLPLANID AND PA.MAIN = 1 

SELECT PC.PLANID
	 , C.[NAME] CON_NAME, C.[DESCRIPTION] CON_DESC, C.COMMENTS CON_COMM

INTO #CONDITIONS
FROM PLPLANCONDITION PC
INNER JOIN CONDITION C ON PC.CONDITIONID = C.CONDITIONID
WHERE PC.PLANID = @PLPLANID


/*BEGIN MAIN QUERY*/
SELECT P.PLPLANID, P.PLANNUMBER, P.APPLICATIONDATE, P.EXPIREDATE, P.VALUE AS VALUATION, P.IVRNUMBER, P.SQUAREFEET, P.DESCRIPTION
	 , PT.PLANNAME AS PLANTYPE
	 , PWC.NAME AS WORKCLASS
	 , PS.NAME AS PLANSTATUS
	 , PAR.PARCELNUMBER
	 , MA.ADDRESS_LINE1 MADDRESS_LINE1, MA.ADDRESS_LINE2 MADDRESS_LINE2
	 , U.FNAME + ' ' + U.LNAME ISSUEDBY
	 , PR.NAME PROJECTNAME
	 , C.CON_NAME, C.CON_DESC, C.CON_COMM
	 , CASE WHEN EXISTS (SELECT TOP 1 * FROM IVInspectionStaging) 
		    THEN 'Y' 
		    ELSE 'N'
		    END AS IVR_FLAG
     , CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Municipality_Name') = '' 
		    THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name')
		    ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R	WHERE R.TEXTNAME = 'Plan_Municipality_Name') END Municipality_Name
	 , CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Municipality_Address') = '' 
		    THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R	WHERE R.TEXTNAME = 'Municipality_Address')
		    ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Municipality_Address') END Municipality_Address
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE r.TEXTNAME = 'Plan_Report_Title') Report_Title
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Notice_Prefix') Plan_Notice_Prefix
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Page_Footer') Plan_Page_Footer
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Signature_1') Plan_Signature_1
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Plan_Signature_2') Plan_Signature_2
	 , (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Inspection_Phone') Inspection_Phone
	 , (SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Plan_Logo') LOGO
	 , (SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Plan_Logo') SHOWLOGO
	 , (SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE r.IMAGENAME = 'Standard_Plan_Detailed_Signature_Image') Sig_Image
	 , (SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Standard_Plan_Detailed_Signature_Image') SHOW_SIGIMAGE
	 , @CUSTOMFIELDS CUSTOMFIELDS	

FROM PLPLAN P
INNER JOIN PLPLANTYPE PT ON P.PLPLANTYPEID = PT.PLPLANTYPEID
INNER JOIN PLPLANWORKCLASS PWC ON PWC.PLPLANWORKCLASSID = P.PLPLANWORKCLASSID
INNER JOIN PLPLANSTATUS PS ON PS.PLPLANSTATUSID = P.PLPLANSTATUSID
LEFT JOIN PLPLANPARCEL PPAR ON PPAR.PLPLANID = P.PLPLANID AND PPAR.MAIN = 1
LEFT JOIN PARCEL PAR ON PPAR.PARCELID = PAR.PARCELID
LEFT JOIN #MADDRESS MA ON P.PLPLANID = MA.PLPLANID
LEFT JOIN #CONDITIONS C ON P.PLPLANID = C.PLANID
LEFT JOIN USERS U ON P.ASSIGNEDTO = U.SUSERGUID
LEFT JOIN PRPROJECTPLAN PRP ON P.PLPLANID = PRP.PLPLANID
LEFT JOIN PRPROJECT PR ON PRP.PRPROJECTID = PR.PRPROJECTID
WHERE P.PLPLANID = @PLPLANID

DROP TABLE #MADDRESS;

