
/*
select * from plplan where plannumber like '%4880-2016'
exec rpt_PL_SR_Plan_History_By_Case 'fed91921-87d9-4a43-90f8-34f9db156627'
*/


CREATE PROCEDURE [dbo].[rpt_PL_SR_Plan_History_By_Case]
@PLPLANID  VARCHAR(36)
AS

BEGIN

SELECT HPL.CHANGEDON, HPL.FIELDNAME, Users.FNAME, Users.LNAME, PL.PLANNUMBER, PL.PLPLANID, 
       HPL.OLDVALUE, HPL.NEWVALUE, HPL.ADDITIONALINFO,
	   --(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM HISTORYPLANMANAGEMENT HPL
INNER JOIN PLITEMREVIEW IR ON HPL.ID = IR.PLITEMREVIEWID
INNER JOIN PLPLAN PL ON IR.PLPLANID = PL.PLPLANID
INNER JOIN USERS ON USERS.SUSERGUID = HPL.CHANGEDBY 
WHERE PL.PLPLANID = @PLPLANID 

UNION ALL

SELECT HISTORYPLANMANAGEMENT.CHANGEDON, HISTORYPLANMANAGEMENT.FIELDNAME, USERS.FNAME, USERS.LNAME, PLPLAN.PLANNUMBER, PLPLAN.PLPLANID, 
       HISTORYPLANMANAGEMENT.OLDVALUE, HISTORYPLANMANAGEMENT.NEWVALUE, HISTORYPLANMANAGEMENT.ADDITIONALINFO,
	   --(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
		 
FROM PLPLAN 
INNER JOIN HISTORYPLANMANAGEMENT ON PLPLAN.PLPLANID = HISTORYPLANMANAGEMENT.ID
INNER JOIN USERS ON USERS.SUSERGUID = HISTORYPLANMANAGEMENT.CHANGEDBY 
WHERE PLPLAN.PLPLANID = @PLPLANID 
ORDER BY CHANGEDON

END

