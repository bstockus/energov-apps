

CREATE PROCEDURE [dbo].[rpt_PM_SR_Permit_History_Report]
@PMPERMITID AS VARCHAR(36)
AS
BEGIN
SELECT PMPERMIT.PERMITNUMBER, HISTORYPERMITMANAGEMENT."ROWVERSION", HISTORYPERMITMANAGEMENT.CHANGEDON, 
       HISTORYPERMITMANAGEMENT.FIELDNAME, HISTORYPERMITMANAGEMENT.OLDVALUE, HISTORYPERMITMANAGEMENT.NEWVALUE, HISTORYPERMITMANAGEMENT.ADDITIONALINFO, 
       USERS.FNAME, USERS.LNAME,
	   (SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM PMPERMIT 
INNER JOIN HISTORYPERMITMANAGEMENT ON PMPERMIT.PMPERMITID = HISTORYPERMITMANAGEMENT.ID 
INNER JOIN USERS ON HISTORYPERMITMANAGEMENT.CHANGEDBY = USERS.SUSERGUID
WHERE PMPERMIT.PMPERMITID = @PMPERMITID

UNION ALL

SELECT PMPERMIT.PERMITNUMBER, HISTORYPERMITMANAGEMENT."ROWVERSION", HISTORYPERMITMANAGEMENT.CHANGEDON, 
       HISTORYPERMITMANAGEMENT.FIELDNAME, HISTORYPERMITMANAGEMENT.OLDVALUE, HISTORYPERMITMANAGEMENT.NEWVALUE, HISTORYPERMITMANAGEMENT.ADDITIONALINFO, 
       USERS.FNAME, USERS.LNAME,
	   (SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM HISTORYPERMITMANAGEMENT
INNER JOIN PLITEMREVIEW IR ON HISTORYPERMITMANAGEMENT.ID = IR.PLITEMREVIEWID
INNER JOIN PLSUBMITTAL PLS ON IR.PLSUBMITTALID=PLS.PLSUBMITTALID
INNER JOIN PMPERMITWFACTIONSTEP WFAS ON PLS.PMPERMITWFACTIONSTEPID=WFAS.PMPERMITWFACTIONSTEPID
INNER JOIN PMPERMITWFSTEP WFS ON WFAS.PMPERMITWFSTEPID=WFS.PMPERMITWFSTEPID
INNER JOIN PMPERMIT ON IR.PMPERMITID = PMPERMIT.PMPERMITID
INNER JOIN USERS ON USERS.SUSERGUID = HISTORYPERMITMANAGEMENT.CHANGEDBY 
WHERE PMPERMIT.PMPERMITID =  @PMPERMITID

END
