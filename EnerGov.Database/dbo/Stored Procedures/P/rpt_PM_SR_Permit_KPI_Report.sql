

/****** Object:  StoredProcedure [dbo].[rpt_PM_SR_Permit_KPI_Report] *******/

CREATE PROCEDURE rpt_PM_SR_Permit_KPI_Report 

-- Add the parameters for the stored procedure here

--@MODULEID varchar(36)
@STARTDATE datetime,
@ENDDATE datetime

AS

BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;
SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE=dateadd(ss,-1,datediff(dd,0,@ENDDATE) + 1)

-- Insert statements for procedure here
SELECT	'Applied' as KPIType,
		PMPERMIT.PMPERMITID, PMPERMIT.APPLYDATE, PMPERMIT.EXPIREDATE,
		PMPERMITTYPE.NAME PERMITTYPE,
		PMPERMITWORKCLASS.NAME PERMITCLASS,
		PMPERMITSTATUS.NAME PERMITSTATUS,
		DISTRICT.NAME PERMITDISTRICT,
		0 AS PERMITFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM	PMPERMIT
		INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
		INNER JOIN PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
		INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID  = PMPERMITSTATUS.PMPERMITSTATUSID
		LEFT OUTER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID

WHERE	PMPERMIT.APPLYDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Expired' as KPIType,
		PMPERMIT.PMPERMITID, PMPERMIT.APPLYDATE, PMPERMIT.EXPIREDATE,
		PMPERMITTYPE.NAME PERMITTYPE,
		PMPERMITWORKCLASS.NAME PERMITCLASS,
		PMPERMITSTATUS.NAME PERMITSTATUS,
		DISTRICT.NAME PERMITDISTRICT,
		0 AS PERMITFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM	PMPERMIT
		INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
		INNER JOIN PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
		INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID  = PMPERMITSTATUS.PMPERMITSTATUSID
		LEFT OUTER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID

WHERE	PMPERMIT.EXPIREDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Fees' as KPIType,
		PMPERMIT.PMPERMITID, PMPERMIT.APPLYDATE, PMPERMIT.EXPIREDATE,
		PMPERMITTYPE.NAME PERMITTYPE,
		PMPERMITWORKCLASS.NAME PERMITCLASS,
		PMPERMITSTATUS.NAME PERMITSTATUS,
		DISTRICT.NAME PERMITDISTRICT,
		COALESCE(PERMITFEES.PERMITFEE,0) AS PERMITFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM	PMPERMIT
		INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
		INNER JOIN PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
		INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID  = PMPERMITSTATUS.PMPERMITSTATUSID
		INNER JOIN (
			SELECT	PMPERMITFEE.PMPERMITID, CAINVOICE.INVOICEDATE, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) AS PERMITFEE
			FROM	PMPERMITFEE
					INNER JOIN CACOMPUTEDFEE ON PMPERMITFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
			WHERE	CACOMPUTEDFEE.ISDELETED = 0
					AND NOT CAINVOICE.CASTATUSID IN (5,9,10)	-- Exclude fees from Void, Refunded and Deleted invoices
					AND CAINVOICE.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE
			GROUP BY PMPERMITFEE.PMPERMITID, CAINVOICE.INVOICEDATE
		) AS PERMITFEES ON PMPERMIT.PMPERMITID = PERMITFEES.PMPERMITID
		LEFT OUTER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID

WHERE	PERMITFEES.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'AppliedOnline' as KPIType,
		PMPERMIT.PMPERMITID, PMPERMIT.APPLYDATE, PMPERMIT.EXPIREDATE,
		PMPERMITTYPE.NAME PERMITTYPE,
		PMPERMITWORKCLASS.NAME PERMITCLASS,
		PMPERMITSTATUS.NAME PERMITSTATUS,
		DISTRICT.NAME PERMITDISTRICT,
		0 AS PERMITFEE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R	WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
		(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
		(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM	PMPERMIT
		INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
		INNER JOIN PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
		INNER JOIN PMPERMITSTATUS ON PMPERMIT.PMPERMITSTATUSID  = PMPERMITSTATUS.PMPERMITSTATUSID
		LEFT OUTER JOIN DISTRICT ON PMPERMIT.DISTRICTID = DISTRICT.DISTRICTID

WHERE	PMPERMIT.APPLYDATE BETWEEN @STARTDATE AND @ENDDATE
	AND PMPERMIT.ISAPPLIEDONLINE = 1

END
