
-- EXEC [rpt_PM_SR_Year_Over_Year_Permits_Report] '2017'


CREATE PROCEDURE [dbo].[rpt_PM_SR_Year_Over_Year_Permits_Report]
@YEAR AS INT
AS
BEGIN

DECLARE @STARTDATE DATETIME
DECLARE @ENDDATE DATETIME
SET @STARTDATE = CAST(CAST((@YEAR-6) AS VARCHAR)+ '0101' AS DATETIME)
SET @ENDDATE = CAST(CAST((@YEAR) AS VARCHAR)+ '1231' AS DATETIME)
SET @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(SECOND,-1,DATEDIFF(DAY,0,@ENDDATE) + 1)

SELECT PMPERMIT.PERMITNUMBER AS PermitNumber, PMPERMITTYPE.NAME AS PermitType, PMPERMIT.VALUE AS Valuation, PMPERMIT.APPLYDATE AS ApplyDate, 
       PMPERMIT.ISSUEDATE AS IssueDate, PMPERMIT.SQUAREFEET AS SquareFeet, PMPERMIT.PMPERMITID,
	   --(SELECT R.[IMAGE] FROM RPTIMAGELIB R
	   -- WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM PMPERMIT
INNER JOIN PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
WHERE (PMPERMIT.APPLYDATE BETWEEN @STARTDATE AND @ENDDATE
OR PMPERMIT.ISSUEDATE BETWEEN @STARTDATE AND @ENDDATE)
END
