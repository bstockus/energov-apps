


-- [dbo].[RPT_PL_PLAN_EXPIRED_BY_STATUS] '20110101','20121201'

CREATE PROCEDURE [dbo].[RPT_PL_PLAN_APPLIED_BY_STATUS]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME
AS
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))
--SELECT PLPLAN.PLPLANID, PLPLAN.PLANNUMBER, PLPLAN.EXPIREDATE, DISTRICT.NAME AS DISTRICT, PLPLANWORKCLASS.NAME AS [WORK CLASS], PLPLANSTATUS.NAME AS STATUS, 
--       PLPLANTYPE.PLANNAME AS [PLAN TYPE], PRPROJECT.NAME AS PROJECT
       
SELECT PLPlanType.PLANNAME, PLPlan.PLANNUMBER, PLPLANSTATUS.NAME AS STATUS, 
       PLPlan.APPLICATIONDATE, CONVERT( VARCHAR(10), PLPLAN.APPLICATIONDATE, 101) AS Applied_DTE,  Users.FNAME, Users.LNAME, Parcel.PARCELNUMBER, PLPlanParcel.MAIN
       ,PLPlan.COMPLETEDATE, PLPLANWORKCLASS.NAME AS [WORK CLASS], DISTRICT.NAME AS DISTRICT, PLPlan.PLPLANID, PRPROJECT.NAME AS PROJECT,
       CASE WHEN (Applicant.FIRSTNAME IS NULL) OR ( LEN(Applicant.FIRSTNAME) <= 0) THEN Applicant.GLOBALENTITYNAME ELSE Applicant.FIRSTNAME + ' ' + Applicant.LASTNAME END AS Applicant
       ,MAIN_ADD.ADDRESSLINE1, MAIN_ADD.ADDRESSLINE2, MAIN_ADD.ADDRESSLINE3, MAIN_ADD.CITY, MAIN_ADD.STATE, MAIN_ADD.POSTALCODE, 
       MAIN_ADD.POSTDIRECTION, MAIN_ADD.PREDIRECTION, MAIN_ADD.UNITORSUITE, MAIN_ADD.STREETTYPE
FROM PLPLAN 
INNER JOIN PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID 
INNER JOIN PLPLANWORKCLASS ON PLPLAN.PLPLANWORKCLASSID = PLPLANWORKCLASS.PLPLANWORKCLASSID 
INNER JOIN PLPLANSTATUS ON PLPLAN.PLPLANSTATUSID = PLPLANSTATUS.PLPLANSTATUSID 
INNER JOIN DISTRICT ON PLPLAN.DISTRICTID = DISTRICT.DISTRICTID
LEFT OUTER JOIN USERS ON PLPLAN.ASSIGNEDTO = USERS.SUSERGUID 
LEFT OUTER JOIN PRPROJECTPLAN ON PRPROJECTPLAN.PLPLANID = PLPLAN.PLPLANID
LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTPLAN.PRPROJECTID 
LEFT OUTER JOIN (SELECT * FROM PLPLANPARCEL WHERE MAIN = 1)PLPLANPARCEL ON PLPLAN.PLPLANID = PLPLANPARCEL.PLPLANID 
LEFT OUTER JOIN PARCEL ON PARCEL.PARCELID = PLPLANPARCEL.PARCELID 
LEFT OUTER JOIN (SELECT GLOBALENTITY.FIRSTNAME, GLOBALENTITY.LASTNAME, GLOBALENTITY.GLOBALENTITYNAME, PLPLANCONTACT.PLPLANID  
                  FROM PLPLANCONTACT 
                 INNER JOIN LANDMANAGEMENTCONTACTTYPE ON PLPLANCONTACT.LANDMANAGEMENTCONTACTTYPEID  = LANDMANAGEMENTCONTACTTYPE.LANDMANAGEMENTCONTACTTYPEID
                 INNER JOIN GLOBALENTITY ON PLPLANCONTACT.GLOBALENTITYID = GLOBALENTITY.GLOBALENTITYID
                 WHERE LANDMANAGEMENTCONTACTTYPE.NAME = N'Applicant')
                 Applicant ON PLPLAN.PLPLANID = Applicant.PLPLANID
LEFT OUTER JOIN (SELECT MAILINGADDRESS.ADDRESSLINE1, MAILINGADDRESS.ADDRESSLINE2, MAILINGADDRESS.ADDRESSLINE3, MAILINGADDRESS.CITY, MAILINGADDRESS.STATE, MAILINGADDRESS.POSTALCODE, 
                  MAILINGADDRESS.POSTDIRECTION, MAILINGADDRESS.PREDIRECTION, MAILINGADDRESS.UNITORSUITE, MAILINGADDRESS.STREETTYPE, PLPLANADDRESS.PLPLANID
                 FROM PLPLANADDRESS
                 INNER JOIN MAILINGADDRESS ON PLPLANADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID 
                 WHERE PLPLANADDRESS.MAIN = 1) MAIN_ADD ON PLPLAN.PLPLANID = MAIN_ADD.PLPLANID
WHERE PLPlan.APPLICATIONDATE BETWEEN @STARTDATE AND @ENDDATE
AND PLPlan.APPLICATIONDATE IS NOT NULL
ORDER BY PLPlan.APPLICATIONDATE


