
CREATE PROCEDURE rpt_PL_SR_Plan_Listing
	@STARTDATE AS DATETIME,
	@ENDDATE AS DATETIME,
	@FILTER AS VARCHAR(150),
	@CASEORIGIN AS VARCHAR(50)
AS
BEGIN
SET @STARTDATE = DATEADD(dd, DATEDIFF(dd, 0, @startdate), 0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))  

SELECT PF.PLPLANID, SUM(C.COMPUTEDAMOUNT) FEETOTAL
INTO #FEES
FROM PLPLANFEE PF
INNER JOIN CACOMPUTEDFEE C ON C.CACOMPUTEDFEEID = PF.CACOMPUTEDFEEID
WHERE C.CASTATUSID NOT IN (5,10) --VOID, DELETED
GROUP BY PF.PLPLANID


CREATE INDEX TEMP1 ON #FEES (PLPLANID);

SELECT PLPLANSTATUS.NAME AS PlanStatus, PLPLANTYPE.PLANNAME AS PlanType, PLPLANWORKCLASS.NAME AS PlanClass, 
       PLPLAN.PLANNUMBER, PLPLAN.EXPIREDATE, PLPLAN.VALUE, PLPLAN.DESCRIPTION AS PlanDesc,
	   CASE WHEN PLPLAN.ISAPPLIEDONLINE = 1 THEN 'Yes' ELSE 'No' END APPLIEDONLINE,
       COALESCE(NULLIF(DISTRICT.NAME,''),'Not Assigned') AS DISTRICT, COALESCE(NULLIF(PRPROJECT.NAME,''),'Not Assigned') AS ProjectName, PLPLAN.SQUAREFEET, PARCEL.PARCELNUMBER, 
	   TB_APP.NAME APP_NAME, TB_APP.GLOBALENTITYNAME AS APP_COMP,	   
       TB_ADDR.ADDRESSLINE1, TB_ADDR.ADDRESSLINE2, TB_ADDR.ADDRESSLINE3, TB_ADDR.CITY, TB_ADDR.STATE, 
       TB_ADDR.POSTALCODE, TB_ADDR.POSTDIRECTION, TB_ADDR.PREDIRECTION, TB_ADDR.STREETTYPE, TB_ADDR.UNITORSUITE,
       PLPLAN.PLPLANID, PLPLAN.APPLICATIONDATE, PLPLAN.COMPLETEDATE, PLPLAN.APPROVALEXPIREDATE, PLPLANWORKCLASS.NAME WorkClass,
	   COALESCE(NULLIF(U.FNAME + ' ' + U.LNAME,''),'Not Assigned') ASSIGNEDTO,  
	   F.FEETOTAL,
	   Z.ZONECODE + ' ' + Z.NAME AS ZONE,
	 --   (SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM PLPLAN PLPLAN
INNER JOIN PLPLANSTATUS ON PLPLAN.PLPLANSTATUSID = PLPLANSTATUS.PLPLANSTATUSID
INNER JOIN PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID
INNER JOIN PLPLANWORKCLASS ON PLPLAN.PLPLANWORKCLASSID = PLPLANWORKCLASS.PLPLANWORKCLASSID
INNER JOIN DISTRICT ON PLPLAN.DISTRICTID = DISTRICT.DISTRICTID
LEFT OUTER JOIN PRPROJECTPLAN ON PLPLAN.PLPLANID = PRPROJECTPLAN.PLPLANID
LEFT OUTER JOIN PRPROJECT ON PRPROJECTPLAN.PRPROJECTID = PRPROJECT.PRPROJECTID
LEFT OUTER JOIN ( SELECT * FROM PLPLANPARCEL WHERE PLPLANPARCEL.MAIN = 1 ) AS PLPLANPARCEL ON PLPLAN.PLPLANID = PLPLANPARCEL.PLPLANID
LEFT OUTER JOIN PARCEL ON PLPLANPARCEL.PARCELID = PARCEL.PARCELID
LEFT OUTER JOIN  (SELECT PC.PLPLANID, LMCT.NAME CONTACTTYPE, GE.FIRSTNAME +' '+ GE.LASTNAME NAME, GE.GLOBALENTITYNAME,
		                 ROW_NUMBER() OVER (PARTITION BY PC.PLPLANID ORDER BY LMCT.NAME, GE.GLOBALENTITYID) AS ROW
	              FROM PLPLANCONTACT PC
		          INNER JOIN LANDMANAGEMENTCONTACTTYPE LMCT ON PC.LANDMANAGEMENTCONTACTTYPEID = LMCT.LANDMANAGEMENTCONTACTTYPEID
		          INNER JOIN GLOBALENTITY GE ON PC.GLOBALENTITYID = GE.GLOBALENTITYID
		          WHERE LMCT.NAME = 'APPLICANT'
		        ) AS TB_APP ON PLPLAN.PLPLANID = TB_APP.PLPLANID AND TB_APP.ROW = 1
LEFT OUTER JOIN ( SELECT PLPLANADDRESS.PLPLANID, MAILINGADDRESS.MAILINGADDRESSID, MAILINGADDRESS.ADDRESSTYPE, MAILINGADDRESS.PARCELNUMBER, 
                         MAILINGADDRESS.ADDRESSLINE1, MAILINGADDRESS.ADDRESSLINE2, MAILINGADDRESS.ADDRESSLINE3, MAILINGADDRESS.CITY, MAILINGADDRESS.STATE, 
                         MAILINGADDRESS.POSTALCODE, MAILINGADDRESS.POSTDIRECTION, MAILINGADDRESS.PREDIRECTION, MAILINGADDRESS.STREETTYPE, MAILINGADDRESS.UNITORSUITE
                  FROM PLPLANADDRESS 
                  INNER JOIN MAILINGADDRESS ON PLPLANADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  WHERE PLPLANADDRESS.MAIN = 1
                ) AS TB_ADDR ON PLPLAN.PLPLANID = TB_ADDR.PLPLANID
LEFT JOIN USERS U ON PLPLAN.ASSIGNEDTO = U.SUSERGUID
LEFT JOIN #FEES F ON PLPLAN.PLPLANID = F.PLPLANID
LEFT JOIN PLPLANZONE PZ ON PLPLAN.PLPLANID = PZ.PLPLANID AND PZ.MAIN = 1
LEFT JOIN [ZONE] Z ON Z.ZONEID = PZ.ZONEID
WHERE (CASE @FILTER 
		WHEN 'EXPIRE DATE' THEN PLPLAN.EXPIREDATE
		WHEN 'APPLY DATE' THEN PLPLAN.APPLICATIONDATE
		WHEN 'COMPLETE DATE' THEN PLPLAN.COMPLETEDATE 
		WHEN 'APPROVAL EXPIRE DATE' THEN PLPLAN.APPROVALEXPIREDATE END)
	BETWEEN @STARTDATE AND @ENDDATE
	AND CASE @CASEORIGIN
			WHEN 'Online Only' THEN 1
			WHEN 'Back Office Only' THEN 0
			ELSE PLPLAN.ISAPPLIEDONLINE
	    END = PLPLAN.ISAPPLIEDONLINE

END
