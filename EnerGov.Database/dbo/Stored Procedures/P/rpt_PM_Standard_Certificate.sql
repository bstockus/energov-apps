
/*
exec rpt_PM_Standard_Certificate '5c907492-c614-4696-b828-cd038797c30d', '84CA7B5F-2100-4C21-8B0D-F7B804ACF198'
select * from pmpermit
select * from rptreport r where r.reportname = 'PM_Standard_Certificate.rpt'
*/

CREATE PROCEDURE rpt_PM_Standard_Certificate
@PMPERMITID VARCHAR(36),
@REPORTID VARCHAR(36)
AS

DECLARE @CUSTOMFIELDS NVARCHAR(MAX) = '';
EXEC [dbo].[GetCustomReportText] @REPORTID, @PMPERMITID, @CUSTOMFIELDS OUTPUT; 

SELECT PMC.PMPERMITID, GE.FIRSTNAME, GE.LASTNAME, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME COMPANYNAME,
	LMCT.NAME CONTACTTYPE, PMC.ISBILLING,
	ROW_NUMBER() OVER (PARTITION BY PMC.PMPERMITID, CASE WHEN LMCT.NAME LIKE '%OWNER%' THEN 1 WHEN LMCT.NAME LIKE '%CONTRACTOR%' THEN 2 ELSE 3 END ORDER BY PMC.ISBILLING DESC, GE.GLOBALENTITYID) AS ROWNBR,
	CASE	WHEN LEN(LTRIM(GE.BUSINESSPHONE)) > 0 THEN GE.BUSINESSPHONE 
		WHEN LEN(LTRIM(GE.MOBILEPHONE)) > 0 THEN GE.MOBILEPHONE 
		WHEN LEN(LTRIM(GE.HOMEPHONE)) > 0 THEN GE.HOMEPHONE 
		WHEN LEN(LTRIM(GE.OTHERPHONE)) > 0 THEN GE.OTHERPHONE 
		ELSE '' END AS PHONE
INTO #CONTACTS
FROM PMPERMITCONTACT PMC
INNER JOIN GLOBALENTITY GE ON PMC.GLOBALENTITYID = GE.GLOBALENTITYID
INNER JOIN LANDMANAGEMENTCONTACTTYPE LMCT ON PMC.LANDMANAGEMENTCONTACTTYPEID = LMCT.LANDMANAGEMENTCONTACTTYPEID

SELECT PA.PMPERMITID, PA.MAIN, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2
INTO #MADDRESS
FROM PMPERMITADDRESS PA
INNER JOIN MAILINGADDRESS MA ON PA.MAILINGADDRESSID = MA.MAILINGADDRESSID

SELECT GEMA.GLOBALENTITYID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + 
	(CASE WHEN LEN(REPLACE(ISNULL(MA.POSTALCODE,''),'-','')) > 5 
		THEN SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),1,5) + '-' + SUBSTRING(REPLACE(ISNULL(MA.POSTALCODE,''),'-',''),6,4)
		ELSE REPLACE(ISNULL(MA.POSTALCODE,''),'-','') END)) ADDRESS_LINE2,
	ROW_NUMBER() OVER (PARTITION BY GEMA.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE 'Mailing%' THEN 1 WHEN MA.ADDRESSTYPE LIKE '%Location%' THEN 2 WHEN MA.ADDRESSTYPE LIKE '%Business%' THEN 3 ELSE 4 END ) AS ROWNBR
INTO #CADDRESS
FROM GLOBALENTITYMAILINGADDRESS GEMA 
INNER JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID

CREATE INDEX TEMP1 ON #CONTACTS (PMPERMITID);
CREATE INDEX TEMP1 ON #MADDRESS (PMPERMITID);
CREATE INDEX TEMP1 ON #CADDRESS (GLOBALENTITYID);

SELECT P.PMPERMITID, P.PERMITNUMBER, P.EXPIREDATE, P.ISSUEDATE,
	OWN.FIRSTNAME + ' ' + OWN.LASTNAME OWNER_NAME, OWN.COMPANYNAME OWNER_COMPANYNAME,
	CON.COMPANYNAME CONTRACTOR_COMPANYNAME, CON.FIRSTNAME + ' ' + CON.LASTNAME CONTRACTOR_NAME,
	MA.ADDRESS_LINE1, MA.ADDRESS_LINE2,
	OWNADD.ADDRESS_LINE1 OWNER_ADDRESS1, OWNADD.ADDRESS_LINE2 OWNER_ADDRESS2,
	STUFF((select  ', '+Z.ZONECODE + ' - ' + Z.NAME FROM PMPERMITZONE PZ
			INNER JOIN ZONE Z ON PZ.ZONEID = Z.ZONEID 
			WHERE PZ.PMPERMITID = @PMPERMITID
			for xml path(''), root('MyString'), type
			).value('/MyString[1]','varchar(max)'),1,2,'') AS 'ZONES',
	STUFF((select  '||'+C.COMMENTS FROM PMPERMITCONDITION PC
			INNER JOIN CONDITION C ON PC.CONDITIONID = C.CONDITIONID
			WHERE PC.PMPERMITID = @PMPERMITID
			for xml path(''), root('MyString'), type
			).value('/MyString[1]','varchar(max)'),1,2,'') AS 'CONDITIONS',
	@CUSTOMFIELDS CUSTOMFIELDS,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Of_Occupancy_Note') Certificate_Of_Occupancy_Note,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Temp_Certificate_Of_Occupancy_Note') Temp_Certificate_Of_Occupancy_Note,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Of_Completion_Note') Certificate_Of_Completion_Note,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Signature_Text') Certificate_Signature_Text,
	(SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Signature_Text_2') Certificate_Signature_Text_2,
	CASE WHEN (SELECT ISNULL(R.REPORTTEXT,'') FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Municipality_Name') = '' 
		THEN (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name')
		ELSE (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Certificate_Municipality_Name') END Municipality_Name,
	(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Certificate_Watermark_96DPI') Certificate_Watermark,
	(SELECT R.DIMENSIONS FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Certificate_Watermark_96DPI') Watermark_Dimensions,
	(SELECT CASE WHEN R.[IMAGE] IS NULL  THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Certificate_Watermark_96DPI') Show_Watermark
FROM PMPERMIT P
LEFT JOIN #CONTACTS OWN ON P.PMPERMITID = OWN.PMPERMITID AND OWN.ROWNBR = 1 AND OWN.CONTACTTYPE LIKE '%OWNER%'
LEFT JOIN #CADDRESS OWNADD ON OWN.GLOBALENTITYID = OWNADD.GLOBALENTITYID AND OWNADD.ROWNBR = 1
LEFT JOIN #CONTACTS CON ON P.PMPERMITID = CON.PMPERMITID AND CON.ROWNBR = 1 AND CON.CONTACTTYPE LIKE '%CONTRACTOR%'
LEFT JOIN #MADDRESS MA ON P.PMPERMITID = MA.PMPERMITID AND MA.MAIN = 1
WHERE P.PMPERMITID = @PMPERMITID;

DROP TABLE #CONTACTS;
DROP TABLE #MADDRESS;
DROP TABLE #CADDRESS;
