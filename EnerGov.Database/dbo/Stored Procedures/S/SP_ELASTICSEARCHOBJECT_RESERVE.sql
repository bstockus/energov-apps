CREATE PROCEDURE [dbo].[SP_ELASTICSEARCHOBJECT_RESERVE] (
	@RESERVED_BY CHAR(36)
	,@RESERVED_DATE DATETIME
	,@BATCH_SIZE INT
) AS
BEGIN
	UPDATE [ELASTICSEARCHOBJECT]
	SET [RESERVEDBY] = @RESERVED_BY, [RESERVEDDATE] = @RESERVED_DATE
	WHERE [OBJECTID] IN (
		SELECT [OBJECTID] FROM (
			SELECT DISTINCT TOP (@BATCH_SIZE)
				[OBJECTID]
				,[CREATEDATE]
			FROM [ELASTICSEARCHOBJECT]
			WHERE [RESERVEDBY] = NULL AND [PROCESSEDDATE] = NULL
			ORDER BY [CREATEDATE] -- Reserve oldest first
		) AS [UNIQUE_IDS]
	);
END