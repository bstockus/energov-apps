
CREATE PROCEDURE [dbo].[GETMYINBOXITEMREVIEWLISTWITHLASTNDAYS]
-- Add the parameters for the stored procedure here
@AssignedUserID char(36),
@RoleID char(36),
@LastNDays int	
AS
BEGIN	
	SELECT	DISTINCT PLITEMREVIEW.PLITEMREVIEWID,  
			PLITEMREVIEW.PLPLANID,
			PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
			PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID,
			PLITEMREVIEWSTATUS.NAME AS STATUSNAME,
			PLITEMREVIEWTYPE.NAME AS ITEMREVIEWTYPENAME,
			DEPARTMENT.NAME AS DEPARTMENTNAME,
			PLITEMREVIEW.COMMENTS,
			PLITEMREVIEW.NOTREQUIRED,
			PLITEMREVIEW.COMPLETED,
			PLITEMREVIEW.PASSED,
			PLITEMREVIEW.PRIORITYORDER,
			PLITEMREVIEW.ASSIGNEDDATE,
			PLITEMREVIEW.DUEDATE,
			PLITEMREVIEW.COMPLETEDATE,
			PLITEMREVIEW.ASSIGNEDUSERID,
			USERS.FNAME,
			USERS.LNAME,
			PLITEMREVIEW.HASUNRESOLVEDCORRECTIONS,
			PLITEMREVIEW.LASTCHANGEDBY,
			PLITEMREVIEW.LASTCHANGEDON,
			PLITEMREVIEW.ROWVERSION,
			PLPLANWFACTIONSTEP.NAME AS SUBMITTALNAME,
			PLPLANWFACTIONSTEP.VERSIONNUMBER AS SUBMITTALVERSION
	FROM PLITEMREVIEW	
	INNER JOIN PLITEMREVIEWTYPE ON PLITEMREVIEWTYPE.PLITEMREVIEWTYPEID = PLITEMREVIEW.PLITEMREVIEWTYPEID
	INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLITEMREVIEW.PLPLANID
	INNER JOIN PLPLANTYPE ON PLPLANTYPE.PLPLANTYPEID = PLPLAN.PLPLANTYPEID
	INNER JOIN PLITEMREVIEWSTATUS ON PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID = PLITEMREVIEW.PLITEMREVIEWSTATUSID
	LEFT OUTER JOIN DEPARTMENT ON DEPARTMENT.DEPARTMENTID = PLITEMREVIEWTYPE.DEPARTMENTID
	INNER JOIN PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
	INNER JOIN PLSUBMITTALTYPE ON PLSUBMITTALTYPE.PLSUBMITTALTYPEID = PLSUBMITTAL.PLSUBMITTALTYPEID		
	INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID		
	LEFT OUTER JOIN PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID
	LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PLPLAN.PLPLANTYPEID
	WHERE PLITEMREVIEW.ASSIGNEDUSERID = @AssignedUserID AND ((PLITEMREVIEW.COMPLETED=0) OR (PLITEMREVIEW.COMPLETED =1 AND 
	(PLITEMREVIEW.completedate= NULL OR DATEDIFF(DAY, PLITEMREVIEW.completedate,GETDATE()) <=@LastNDays)))	AND		       
			(@RoleID is null OR @RoleID = '' OR (ROLERECORDTYPEXREF.ROLEID = @RoleID AND ROLERECORDTYPEXREF.VISIBLE = 1))
END
