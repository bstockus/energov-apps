CREATE PROCEDURE [dbo].[GETMYSEARCHITEMREVIEWLIST]
-- Add the parameters for the stored procedure here
@ASSIGNEDUSERGUID char(36),
@ROLEID char(36),
@ITEMREVIEWSTATUSID char(36),
@ITEMREVIEWDUEDATEFROM datetime,
@ITEMREVIEWDUEDATETO datetime,
@CASENUMBER nvarchar(50),
@MODULEID int,
@NOTREQUIRED bit,
@PROJECTNAME nvarchar(50),
@SUBMITTALTYPEID char(36),
@DEPARTMENTID char(36),
@PREDIRECTION nvarchar(30),
@ADDRESSLINE1 nvarchar(200),
@ADDRESSLINE2 nvarchar(200),	
@ADDRESSLINE3 nvarchar(200),
@STREETTYPE nvarchar(50),
@POSTDIRECTION nvarchar(30),
@UNITORSUITE nvarchar(20),
@SUBMITTALNAME nvarchar(50),
@UPLOADFOLDER nvarchar(20)	
AS
BEGIN		
	IF @UPLOADFOLDER IS NOT NULL
	BEGIN
		IF @MODULEID = 1
		BEGIN
			SELECT @CASENUMBER = PLPLAN.PLANNUMBER 
			FROM PLPLAN
			INNER JOIN ERPROJECT ON ERPROJECT.PLPLANID = PLPLAN.PLPLANID
			WHERE ERPROJECT.UPLOADFOLDER = @UPLOADFOLDER
		END
		ELSE IF @MODULEID = 2
		BEGIN
			SELECT @CASENUMBER = PMPERMIT.PERMITNUMBER
			FROM PMPERMIT
			INNER JOIN ERPROJECT ON ERPROJECT.PMPERMITID = PMPERMIT.PMPERMITID
			WHERE ERPROJECT.UPLOADFOLDER = @UPLOADFOLDER
		END
	END
	IF @MODULEID = 1
	BEGIN
		SELECT	DISTINCT PLITEMREVIEW.PLITEMREVIEWID,  
				PLITEMREVIEW.PLPLANID AS CASEID,
				PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
				PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID,
				PLITEMREVIEWSTATUS.NAME AS STATUSNAME,
				PLITEMREVIEWTYPE.NAME AS ITEMREVIEWTYPENAME,
				DEPARTMENT.NAME AS DEPARTMENTNAME,
				PLITEMREVIEW.COMMENTS,
				PLITEMREVIEW.NOTREQUIRED,
				PLITEMREVIEW.COMPLETED,
				PLITEMREVIEW.PASSED,
				PLITEMREVIEW.PRIORITYORDER,
				PLITEMREVIEW.ASSIGNEDDATE,
				PLITEMREVIEW.DUEDATE,
				PLITEMREVIEW.COMPLETEDATE,
				PLITEMREVIEW.ASSIGNEDUSERID,
				USERS.FNAME,
				USERS.LNAME,
				PLITEMREVIEW.HASUNRESOLVEDCORRECTIONS,
				PLITEMREVIEW.LASTCHANGEDBY,
				PLITEMREVIEW.LASTCHANGEDON,
				PLITEMREVIEW.ROWVERSION,
				PLPLANWFACTIONSTEP.NAME AS SUBMITTALNAME,
				PLPLANWFACTIONSTEP.VERSIONNUMBER AS SUBMITTALVERSION,
				1 AS MODULEID,
				'Plan' AS MODULENAME
				FROM PLITEMREVIEW	
				INNER JOIN PLITEMREVIEWTYPE ON PLITEMREVIEWTYPE.PLITEMREVIEWTYPEID = PLITEMREVIEW.PLITEMREVIEWTYPEID
				INNER JOIN PLITEMREVIEWSTATUS ON PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID = PLITEMREVIEW.PLITEMREVIEWSTATUSID
				LEFT OUTER JOIN DEPARTMENT ON DEPARTMENT.DEPARTMENTID = PLITEMREVIEWTYPE.DEPARTMENTID
				INNER JOIN PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
				INNER JOIN PLSUBMITTALTYPE ON PLSUBMITTALTYPE.PLSUBMITTALTYPEID = PLSUBMITTAL.PLSUBMITTALTYPEID	
				INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLITEMREVIEW.PLPLANID
				OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPLAN WHERE PRPROJECTPLAN.PLPLANID = PLPLAN.PLPLANID) A
				LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID	
				INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
				OUTER APPLY (SELECT TOP 1 PLPLANADDRESS.MAILINGADDRESSID FROM PLPLANADDRESS WHERE PLPLANADDRESS.PLPLANID = PLPLAN.PLPLANID AND PLPLANADDRESS.MAIN = 1) B
				LEFT OUTER JOIN MAILINGADDRESS ON MAILINGADDRESS.MAILINGADDRESSID = B.MAILINGADDRESSID 
				LEFT OUTER JOIN PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID
				LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PLPLAN.PLPLANTYPEID
		WHERE (@ASSIGNEDUSERGUID is null OR @ASSIGNEDUSERGUID = '' OR PLITEMREVIEW.ASSIGNEDUSERID = @ASSIGNEDUSERGUID) AND	
				(@ITEMREVIEWSTATUSID is null OR @ITEMREVIEWSTATUSID = '' OR PLITEMREVIEW.PLITEMREVIEWSTATUSID = @ITEMREVIEWSTATUSID) AND	  
				(@DEPARTMENTID is null OR @DEPARTMENTID = '' OR DEPARTMENT.DEPARTMENTID = @DEPARTMENTID) AND
				((@ITEMREVIEWDUEDATEFROM is null AND @ITEMREVIEWDUEDATETO is null) OR 
				(PLITEMREVIEW.DUEDATE >= @ITEMREVIEWDUEDATEFROM AND  PLITEMREVIEW.DUEDATE <= @ITEMREVIEWDUEDATETO)) AND
				(@CASENUMBER is null OR @CASENUMBER = '' OR PLPLAN.PLANNUMBER LIKE ('%' + @CASENUMBER + '%')) AND
				(@PROJECTNAME is null OR @PROJECTNAME = '' OR PRPROJECT.NAME LIKE ('%' + @PROJECTNAME + '%')) AND 		  		  
				(PLITEMREVIEW.NOTREQUIRED = @NOTREQUIRED) AND
				(@SUBMITTALTYPEID is null OR @SUBMITTALTYPEID = '' OR PLSUBMITTALTYPE.PLSUBMITTALTYPEID = @SUBMITTALTYPEID) AND
				(@PREDIRECTION is null OR @PREDIRECTION = '' OR MAILINGADDRESS.PREDIRECTION = @PREDIRECTION) AND
				(@ADDRESSLINE1 is null OR @ADDRESSLINE1 = '' OR MAILINGADDRESS.ADDRESSLINE1 LIKE '%' + @ADDRESSLINE1 + '%') AND
				(@ADDRESSLINE2 is null OR @ADDRESSLINE2 = '' OR MAILINGADDRESS.ADDRESSLINE2 LIKE '%' + @ADDRESSLINE2 + '%') AND
				(@ADDRESSLINE3 is null OR @ADDRESSLINE3 = '' OR MAILINGADDRESS.ADDRESSLINE3 LIKE '%' + @ADDRESSLINE3 + '%') AND
				(@STREETTYPE is null OR @STREETTYPE = '' OR MAILINGADDRESS.STREETTYPE = @STREETTYPE) AND
				(@POSTDIRECTION is null OR @POSTDIRECTION = '' OR MAILINGADDRESS.POSTDIRECTION = @POSTDIRECTION) AND
				(@UNITORSUITE is null OR @UNITORSUITE ='' OR MAILINGADDRESS.UNITORSUITE LIKE '%' + @UNITORSUITE + '%') AND
				(@SUBMITTALNAME is null OR @SUBMITTALNAME = '' OR PLPLANWFACTIONSTEP.NAME LIKE '%' + @SUBMITTALNAME + '%') AND
				(@ROLEID is null OR @ROLEID = '' OR (ROLERECORDTYPEXREF.ROLEID = @ROLEID AND ROLERECORDTYPEXREF.VISIBLE = 1))   
	END   
	ELSE IF @MODULEID = 2
	BEGIN
		SELECT	DISTINCT PLITEMREVIEW.PLITEMREVIEWID,  
				PLITEMREVIEW.PMPERMITID AS CASEID,
				PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
				PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID,
				PLITEMREVIEWSTATUS.NAME AS STATUSNAME,
				PLITEMREVIEWTYPE.NAME AS ITEMREVIEWTYPENAME,
				DEPARTMENT.NAME AS DEPARTMENTNAME,
				PLITEMREVIEW.COMMENTS,
				PLITEMREVIEW.NOTREQUIRED,
				PLITEMREVIEW.COMPLETED,
				PLITEMREVIEW.PASSED,
				PLITEMREVIEW.PRIORITYORDER,
				PLITEMREVIEW.ASSIGNEDDATE,
				PLITEMREVIEW.DUEDATE,
				PLITEMREVIEW.COMPLETEDATE,
				PLITEMREVIEW.ASSIGNEDUSERID,
				USERS.FNAME,
				USERS.LNAME,
				PLITEMREVIEW.HASUNRESOLVEDCORRECTIONS,
				PLITEMREVIEW.LASTCHANGEDBY,
				PLITEMREVIEW.LASTCHANGEDON,
				PLITEMREVIEW.ROWVERSION,
				PMPERMITWFACTIONSTEP.NAME AS SUBMITTALNAME,
				PMPERMITWFACTIONSTEP.VERSIONNUMBER AS SUBMITTALVERSION,
				2 AS MODULEID,
				'Permit' AS MODULENAME
				FROM PLITEMREVIEW	
				INNER JOIN PLITEMREVIEWTYPE ON PLITEMREVIEWTYPE.PLITEMREVIEWTYPEID = PLITEMREVIEW.PLITEMREVIEWTYPEID
				INNER JOIN PLITEMREVIEWSTATUS ON PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID = PLITEMREVIEW.PLITEMREVIEWSTATUSID
				LEFT OUTER JOIN DEPARTMENT ON DEPARTMENT.DEPARTMENTID = PLITEMREVIEWTYPE.DEPARTMENTID
				INNER JOIN PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
				INNER JOIN PLSUBMITTALTYPE ON PLSUBMITTALTYPE.PLSUBMITTALTYPEID = PLSUBMITTAL.PLSUBMITTALTYPEID	
				INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLITEMREVIEW.PMPERMITID
				OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPLAN WHERE PRPROJECTPLAN.PLPLANID = PMPERMIT.PMPERMITID) A
				LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID	
				INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
				OUTER APPLY (SELECT TOP 1 PMPERMITADDRESS.MAILINGADDRESSID FROM PMPERMITADDRESS WHERE PMPERMITADDRESS.PMPERMITID = PMPERMIT.PMPERMITID AND PMPERMITADDRESS.MAIN = 1) B
				LEFT OUTER JOIN MAILINGADDRESS ON MAILINGADDRESS.MAILINGADDRESSID = B.MAILINGADDRESSID 
				LEFT OUTER JOIN PMPERMITWFACTIONSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = PLSUBMITTAL.PMPERMITWFACTIONSTEPID
				LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PMPERMIT.PMPERMITTYPEID
				WHERE (@ASSIGNEDUSERGUID is null OR @ASSIGNEDUSERGUID = '' OR PLITEMREVIEW.ASSIGNEDUSERID = @ASSIGNEDUSERGUID) AND	
				(@ITEMREVIEWSTATUSID is null OR @ITEMREVIEWSTATUSID = '' OR PLITEMREVIEW.PLITEMREVIEWSTATUSID = @ITEMREVIEWSTATUSID) AND	  
				(@DEPARTMENTID is null OR @DEPARTMENTID = '' OR DEPARTMENT.DEPARTMENTID = @DEPARTMENTID) AND
				((@ITEMREVIEWDUEDATEFROM is null AND @ITEMREVIEWDUEDATETO is null) OR 
				(PLITEMREVIEW.DUEDATE >= @ITEMREVIEWDUEDATEFROM AND  PLITEMREVIEW.DUEDATE <= @ITEMREVIEWDUEDATETO)) AND
				(@CASENUMBER is null OR @CASENUMBER = '' OR PMPERMIT.PERMITNUMBER LIKE ('%' + @CASENUMBER + '%')) AND
				(@PROJECTNAME is null OR @PROJECTNAME = '' OR PRPROJECT.NAME LIKE ('%' + @PROJECTNAME + '%')) AND 		  		  
				(PLITEMREVIEW.NOTREQUIRED = @NOTREQUIRED) AND
				(@SUBMITTALTYPEID is null OR @SUBMITTALTYPEID = '' OR PLSUBMITTALTYPE.PLSUBMITTALTYPEID = @SUBMITTALTYPEID) AND
				(@PREDIRECTION is null OR @PREDIRECTION = '' OR MAILINGADDRESS.PREDIRECTION = @PREDIRECTION) AND
				(@ADDRESSLINE1 is null OR @ADDRESSLINE1 = '' OR MAILINGADDRESS.ADDRESSLINE1 LIKE '%' + @ADDRESSLINE1 + '%') AND
				(@ADDRESSLINE2 is null OR @ADDRESSLINE2 = '' OR MAILINGADDRESS.ADDRESSLINE2 LIKE '%' + @ADDRESSLINE2 + '%') AND
				(@ADDRESSLINE3 is null OR @ADDRESSLINE3 = '' OR MAILINGADDRESS.ADDRESSLINE3 LIKE '%' + @ADDRESSLINE3 + '%') AND
				(@STREETTYPE is null OR @STREETTYPE = '' OR MAILINGADDRESS.STREETTYPE = @STREETTYPE) AND
				(@POSTDIRECTION is null OR @POSTDIRECTION = '' OR MAILINGADDRESS.POSTDIRECTION = @POSTDIRECTION) AND
				(@UNITORSUITE is null OR @UNITORSUITE ='' OR MAILINGADDRESS.UNITORSUITE LIKE '%' + @UNITORSUITE + '%') AND
				(@SUBMITTALNAME is null OR @SUBMITTALNAME = '' OR PMPERMITWFACTIONSTEP.NAME LIKE '%' + @SUBMITTALNAME + '%') AND
				(@ROLEID is null OR @ROLEID = '' OR (ROLERECORDTYPEXREF.ROLEID = @ROLEID AND ROLERECORDTYPEXREF.VISIBLE = 1))   
	END
	ELSE IF @MODULEID = 0
	BEGIN
		SELECT	DISTINCT PLITEMREVIEW.PLITEMREVIEWID,  
		PLITEMREVIEW.PLPLANID AS CASEID,
		PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
		PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID,
		PLITEMREVIEWSTATUS.NAME AS STATUSNAME,
		PLITEMREVIEWTYPE.NAME AS ITEMREVIEWTYPENAME,
		DEPARTMENT.NAME AS DEPARTMENTNAME,
		PLITEMREVIEW.COMMENTS,
		PLITEMREVIEW.NOTREQUIRED,
		PLITEMREVIEW.COMPLETED,
		PLITEMREVIEW.PASSED,
		PLITEMREVIEW.PRIORITYORDER,
		PLITEMREVIEW.ASSIGNEDDATE,
		PLITEMREVIEW.DUEDATE,
		PLITEMREVIEW.COMPLETEDATE,
		PLITEMREVIEW.ASSIGNEDUSERID,
		USERS.FNAME,
		USERS.LNAME,
		PLITEMREVIEW.HASUNRESOLVEDCORRECTIONS,
		PLITEMREVIEW.LASTCHANGEDBY,
		PLITEMREVIEW.LASTCHANGEDON,
		PLITEMREVIEW.ROWVERSION,
		PLPLANWFACTIONSTEP.NAME AS SUBMITTALNAME,
		PLPLANWFACTIONSTEP.VERSIONNUMBER AS SUBMITTALVERSION,
		1 AS MODULEID,
		'Plan' AS MODULENAME
		FROM PLITEMREVIEW	
		INNER JOIN PLITEMREVIEWTYPE ON PLITEMREVIEWTYPE.PLITEMREVIEWTYPEID = PLITEMREVIEW.PLITEMREVIEWTYPEID
		INNER JOIN PLITEMREVIEWSTATUS ON PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID = PLITEMREVIEW.PLITEMREVIEWSTATUSID
		LEFT OUTER JOIN DEPARTMENT ON DEPARTMENT.DEPARTMENTID = PLITEMREVIEWTYPE.DEPARTMENTID
		INNER JOIN PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
		INNER JOIN PLSUBMITTALTYPE ON PLSUBMITTALTYPE.PLSUBMITTALTYPEID = PLSUBMITTAL.PLSUBMITTALTYPEID	
		INNER JOIN PLPLAN ON PLPLAN.PLPLANID = PLITEMREVIEW.PLPLANID
		OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPLAN WHERE PRPROJECTPLAN.PLPLANID = PLPLAN.PLPLANID) A
		LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID	
		INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
		OUTER APPLY (SELECT TOP 1 PLPLANADDRESS.MAILINGADDRESSID FROM PLPLANADDRESS WHERE PLPLANADDRESS.PLPLANID = PLPLAN.PLPLANID AND PLPLANADDRESS.MAIN = 1) B
		LEFT OUTER JOIN MAILINGADDRESS ON MAILINGADDRESS.MAILINGADDRESSID = B.MAILINGADDRESSID 
		LEFT OUTER JOIN PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID
		LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PLPLAN.PLPLANTYPEID
		WHERE (@ASSIGNEDUSERGUID is null OR @ASSIGNEDUSERGUID = '' OR PLITEMREVIEW.ASSIGNEDUSERID = @ASSIGNEDUSERGUID) AND	
				(@ITEMREVIEWSTATUSID is null OR @ITEMREVIEWSTATUSID = '' OR PLITEMREVIEW.PLITEMREVIEWSTATUSID = @ITEMREVIEWSTATUSID) AND	  
				(@DEPARTMENTID is null OR @DEPARTMENTID = '' OR DEPARTMENT.DEPARTMENTID = @DEPARTMENTID) AND
				((@ITEMREVIEWDUEDATEFROM is null AND @ITEMREVIEWDUEDATETO is null) OR 
				(PLITEMREVIEW.DUEDATE >= @ITEMREVIEWDUEDATEFROM AND  PLITEMREVIEW.DUEDATE <= @ITEMREVIEWDUEDATETO)) AND
				(@CASENUMBER is null OR @CASENUMBER = '' OR PLPLAN.PLANNUMBER LIKE ('%' + @CASENUMBER + '%')) AND
				(@PROJECTNAME is null OR @PROJECTNAME = '' OR PRPROJECT.NAME LIKE ('%' + @PROJECTNAME + '%')) AND 		  		  
				(PLITEMREVIEW.NOTREQUIRED = @NOTREQUIRED) AND
				(@SUBMITTALTYPEID is null OR @SUBMITTALTYPEID = '' OR PLSUBMITTALTYPE.PLSUBMITTALTYPEID = @SUBMITTALTYPEID) AND
				(@PREDIRECTION is null OR @PREDIRECTION = '' OR MAILINGADDRESS.PREDIRECTION = @PREDIRECTION) AND
				(@ADDRESSLINE1 is null OR @ADDRESSLINE1 = '' OR MAILINGADDRESS.ADDRESSLINE1 LIKE '%' + @ADDRESSLINE1 + '%') AND
				(@ADDRESSLINE2 is null OR @ADDRESSLINE2 = '' OR MAILINGADDRESS.ADDRESSLINE2 LIKE '%' + @ADDRESSLINE2 + '%') AND
				(@ADDRESSLINE3 is null OR @ADDRESSLINE3 = '' OR MAILINGADDRESS.ADDRESSLINE3 LIKE '%' + @ADDRESSLINE3 + '%') AND
				(@STREETTYPE is null OR @STREETTYPE = '' OR MAILINGADDRESS.STREETTYPE = @STREETTYPE) AND
				(@POSTDIRECTION is null OR @POSTDIRECTION = '' OR MAILINGADDRESS.POSTDIRECTION = @POSTDIRECTION) AND
				(@UNITORSUITE is null OR @UNITORSUITE ='' OR MAILINGADDRESS.UNITORSUITE LIKE '%' + @UNITORSUITE + '%') AND
				(@SUBMITTALNAME is null OR @SUBMITTALNAME = '' OR PLPLANWFACTIONSTEP.NAME LIKE '%' + @SUBMITTALNAME + '%') AND
				(@ROLEID is null OR @ROLEID = '' OR (ROLERECORDTYPEXREF.ROLEID = @ROLEID AND ROLERECORDTYPEXREF.VISIBLE = 1))   
		UNION
		SELECT	DISTINCT PLITEMREVIEW.PLITEMREVIEWID,  
				PLITEMREVIEW.PMPERMITID AS CASEID,
				PLSUBMITTALTYPE.TYPENAME AS SUBMITTALTYPENAME,
				PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID,
				PLITEMREVIEWSTATUS.NAME AS STATUSNAME,
				PLITEMREVIEWTYPE.NAME AS ITEMREVIEWTYPENAME,
				DEPARTMENT.NAME AS DEPARTMENTNAME,
				PLITEMREVIEW.COMMENTS,
				PLITEMREVIEW.NOTREQUIRED,
				PLITEMREVIEW.COMPLETED,
				PLITEMREVIEW.PASSED,
				PLITEMREVIEW.PRIORITYORDER,
				PLITEMREVIEW.ASSIGNEDDATE,
				PLITEMREVIEW.DUEDATE,
				PLITEMREVIEW.COMPLETEDATE,
				PLITEMREVIEW.ASSIGNEDUSERID,
				USERS.FNAME,
				USERS.LNAME,
				PLITEMREVIEW.HASUNRESOLVEDCORRECTIONS,
				PLITEMREVIEW.LASTCHANGEDBY,
				PLITEMREVIEW.LASTCHANGEDON,
				PLITEMREVIEW.ROWVERSION,
				PMPERMITWFACTIONSTEP.NAME AS SUBMITTALNAME,
				PMPERMITWFACTIONSTEP.VERSIONNUMBER AS SUBMITTALVERSION,
				2 AS MODULEID,
				'Permit' AS MODULENAME
				FROM PLITEMREVIEW	
				INNER JOIN PLITEMREVIEWTYPE ON PLITEMREVIEWTYPE.PLITEMREVIEWTYPEID = PLITEMREVIEW.PLITEMREVIEWTYPEID
				INNER JOIN PLITEMREVIEWSTATUS ON PLITEMREVIEWSTATUS.PLITEMREVIEWSTATUSID = PLITEMREVIEW.PLITEMREVIEWSTATUSID
				LEFT OUTER JOIN DEPARTMENT ON DEPARTMENT.DEPARTMENTID = PLITEMREVIEWTYPE.DEPARTMENTID
				INNER JOIN PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
				INNER JOIN PLSUBMITTALTYPE ON PLSUBMITTALTYPE.PLSUBMITTALTYPEID = PLSUBMITTAL.PLSUBMITTALTYPEID	
				INNER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PLITEMREVIEW.PMPERMITID
				OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPLAN WHERE PRPROJECTPLAN.PLPLANID = PMPERMIT.PMPERMITID) A
				LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID	
				INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
				OUTER APPLY (SELECT TOP 1 PMPERMITADDRESS.MAILINGADDRESSID FROM PMPERMITADDRESS WHERE PMPERMITADDRESS.PMPERMITID = PMPERMIT.PMPERMITID AND PMPERMITADDRESS.MAIN = 1) B
				LEFT OUTER JOIN MAILINGADDRESS ON MAILINGADDRESS.MAILINGADDRESSID = B.MAILINGADDRESSID 
				LEFT OUTER JOIN PMPERMITWFACTIONSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = PLSUBMITTAL.PMPERMITWFACTIONSTEPID
				LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PMPERMIT.PMPERMITTYPEID
				WHERE (@ASSIGNEDUSERGUID is null OR @ASSIGNEDUSERGUID = '' OR PLITEMREVIEW.ASSIGNEDUSERID = @ASSIGNEDUSERGUID) AND	
				(@ITEMREVIEWSTATUSID is null OR @ITEMREVIEWSTATUSID = '' OR PLITEMREVIEW.PLITEMREVIEWSTATUSID = @ITEMREVIEWSTATUSID) AND	  
				(@DEPARTMENTID is null OR @DEPARTMENTID = '' OR DEPARTMENT.DEPARTMENTID = @DEPARTMENTID) AND
				((@ITEMREVIEWDUEDATEFROM is null AND @ITEMREVIEWDUEDATETO is null) OR 
				(PLITEMREVIEW.DUEDATE >= @ITEMREVIEWDUEDATEFROM AND  PLITEMREVIEW.DUEDATE <= @ITEMREVIEWDUEDATETO)) AND
				(@CASENUMBER is null OR @CASENUMBER = '' OR PMPERMIT.PERMITNUMBER LIKE ('%' + @CASENUMBER + '%')) AND
				(@PROJECTNAME is null OR @PROJECTNAME = '' OR PRPROJECT.NAME LIKE ('%' + @PROJECTNAME + '%')) AND 		  		  
				(PLITEMREVIEW.NOTREQUIRED = @NOTREQUIRED) AND
				(@SUBMITTALTYPEID is null OR @SUBMITTALTYPEID = '' OR PLSUBMITTALTYPE.PLSUBMITTALTYPEID = @SUBMITTALTYPEID) AND
				(@PREDIRECTION is null OR @PREDIRECTION = '' OR MAILINGADDRESS.PREDIRECTION = @PREDIRECTION) AND
				(@ADDRESSLINE1 is null OR @ADDRESSLINE1 = '' OR MAILINGADDRESS.ADDRESSLINE1 LIKE '%' + @ADDRESSLINE1 + '%') AND
				(@ADDRESSLINE2 is null OR @ADDRESSLINE2 = '' OR MAILINGADDRESS.ADDRESSLINE2 LIKE '%' + @ADDRESSLINE2 + '%') AND
				(@ADDRESSLINE3 is null OR @ADDRESSLINE3 = '' OR MAILINGADDRESS.ADDRESSLINE3 LIKE '%' + @ADDRESSLINE3 + '%') AND
				(@STREETTYPE is null OR @STREETTYPE = '' OR MAILINGADDRESS.STREETTYPE = @STREETTYPE) AND
				(@POSTDIRECTION is null OR @POSTDIRECTION = '' OR MAILINGADDRESS.POSTDIRECTION = @POSTDIRECTION) AND
				(@UNITORSUITE is null OR @UNITORSUITE ='' OR MAILINGADDRESS.UNITORSUITE LIKE '%' + @UNITORSUITE + '%') AND
				(@SUBMITTALNAME is null OR @SUBMITTALNAME = '' OR PMPERMITWFACTIONSTEP.NAME LIKE '%' + @SUBMITTALNAME + '%') AND
				(@ROLEID is null OR @ROLEID = '' OR (ROLERECORDTYPEXREF.ROLEID = @ROLEID AND ROLERECORDTYPEXREF.VISIBLE = 1))   
	END
END