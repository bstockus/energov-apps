CREATE PROCEDURE [dbo].[GETMYINBOXCASELIST]
-- Add the parameters for the stored procedure here
@AssignedUserID char(36),
@RoleID char(36)		
AS
BEGIN
    DECLARE @NumOfDaySearch int 
	SET @NumOfDaySearch = NULL
	SELECT @NumOfDaySearch = INTVALUE FROM SETTINGS WHERE NAME = 'ERInboxItemReviewDaySearch'			
	SELECT	DISTINCT PLPLAN.PLPLANID AS CASEID,
			PLPLAN.PLANNUMBER AS CASENUMBER,
			PLPLANTYPE.PLANNAME AS CASETYPENAME,
			PLPLANWORKCLASS.NAME AS CASEWORKCLASSNAME,
			PLPLANSTATUS.NAME AS CASESTATUSNAME,
			PLPLAN.DESCRIPTION AS CASEDESCRIPTION,
			PRPROJECT.NAME AS PROJECTNAME,
			DISTRICT.NAME AS DISTRICTNAME,
			ASSIGNEDUSER.FNAME,
			ASSIGNEDUSER.LNAME,
			PLPLAN.APPLICATIONDATE,
			PLPLAN.COMPLETEDATE,
			PLPLAN.EXPIREDATE,
			NULL AS ISSUEDATE,
			PLPLAN.APPROVALEXPIREDATE,
			PLPLAN.SQUAREFEET,
			PLPLAN.VALUE,
			PRPROJECT.PRPROJECTID,
			1 AS MODULEID
	FROM PLPLAN
	INNER JOIN PLITEMREVIEW	ON PLITEMREVIEW.PLPLANID = PLPLAN.PLPLANID	
	INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
	LEFT OUTER JOIN USERS AS ASSIGNEDUSER ON ASSIGNEDUSER.SUSERGUID = PLPLAN.ASSIGNEDTO
	INNER JOIN PLPLANTYPE ON PLPLANTYPE.PLPLANTYPEID = PLPLAN.PLPLANTYPEID
	LEFT OUTER JOIN PLPLANWORKCLASS ON PLPLANWORKCLASS.PLPLANWORKCLASSID = PLPLAN.PLPLANWORKCLASSID
	INNER JOIN PLPLANSTATUS ON PLPLANSTATUS.PLPLANSTATUSID = PLPLAN.PLPLANSTATUSID
	OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPLAN WHERE PRPROJECTPLAN.PLPLANID = PLPLAN.PLPLANID) A
	LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID
	INNER JOIN DISTRICT ON DISTRICT.DISTRICTID = PLPLAN.DISTRICTID	
	LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PLPLANTYPE.PLPLANTYPEID
	WHERE (PLITEMREVIEW.ASSIGNEDUSERID = @AssignedUserID) AND
	      (@NumOfDaySearch is null OR (PLITEMREVIEW.ASSIGNEDDATE > getdate() - @NumOfDaySearch)) AND       
			(@RoleID is null OR @RoleID = '' OR (ROLERECORDTYPEXREF.ROLEID = @RoleID AND ROLERECORDTYPEXREF.VISIBLE = 1))      
	UNION
	SELECT	DISTINCT PMPERMIT.PMPERMITID AS CASEID,
			PMPERMIT.PERMITNUMBER AS CASENUMBER,
			PMPERMITTYPE.NAME AS CASETYPENAME,
			PMPERMITWORKCLASS.NAME AS CASEWORKCLASSNAME,
			PMPERMITSTATUS.NAME AS CASESTATUSNAME,
			PMPERMIT.DESCRIPTION AS CASEDESCRIPTION,
			PRPROJECT.NAME AS PROJECTNAME,
			DISTRICT.NAME AS DISTRICTNAME,
			ASSIGNEDUSER.FNAME,
			ASSIGNEDUSER.LNAME,
			PMPERMIT.APPLYDATE AS APPLICATIONDATE,
			NULL AS COMPLETEDATE,
			PMPERMIT.EXPIREDATE,
			PMPERMIT.ISSUEDATE,
			NULL AS APPROVALEXPIREDATE,
			PMPERMIT.SQUAREFEET,
			PMPERMIT.VALUE,
			PRPROJECT.PRPROJECTID,
			2 AS MODULEID
	FROM PMPERMIT
	INNER JOIN PLITEMREVIEW	ON PLITEMREVIEW.PMPERMITID = PMPERMIT.PMPERMITID	
	INNER JOIN USERS ON USERS.SUSERGUID = PLITEMREVIEW.ASSIGNEDUSERID
	LEFT OUTER JOIN USERS AS ASSIGNEDUSER ON ASSIGNEDUSER.SUSERGUID = PMPERMIT.ASSIGNEDTO
	INNER JOIN PMPERMITTYPE ON PMPERMITTYPE.PMPERMITTYPEID = PMPERMIT.PMPERMITTYPEID
	LEFT OUTER JOIN PMPERMITWORKCLASS ON PMPERMITWORKCLASS.PMPERMITWORKCLASSID = PMPERMIT.PMPERMITWORKCLASSID
	INNER JOIN PMPERMITSTATUS ON PMPERMITSTATUS.PMPERMITSTATUSID = PMPERMIT.PMPERMITSTATUSID
	OUTER APPLY (SELECT TOP 1 PRPROJECTID FROM PRPROJECTPERMIT WHERE PRPROJECTPERMIT.PMPERMITID = PMPERMIT.PMPERMITID) A
	LEFT OUTER JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = A.PRPROJECTID
	INNER JOIN DISTRICT ON DISTRICT.DISTRICTID = PMPERMIT.DISTRICTID	
	LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = PMPERMITTYPE.PMPERMITTYPEID
	WHERE (PLITEMREVIEW.ASSIGNEDUSERID = @AssignedUserID) AND
	      (@NumOfDaySearch is null OR (PLITEMREVIEW.ASSIGNEDDATE > getdate() - @NumOfDaySearch)) AND       
			(@RoleID is null OR @RoleID = '' OR (ROLERECORDTYPEXREF.ROLEID = @RoleID AND ROLERECORDTYPEXREF.VISIBLE = 1))      
END