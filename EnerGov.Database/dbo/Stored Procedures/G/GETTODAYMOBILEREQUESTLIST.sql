	--SELECT @AssignedUserID='2FB39FA9-DF43-41D7-BB8B-C91836D30987'
	--SELECT @RoleId ='A652344C-FDB0-4116-A63B-126FFCAF2B2D'
CREATE PROCEDURE GETTODAYMOBILEREQUESTLIST
	-- Add the parameters for the stored procedure here
	@AssignedUserID char(36),
	@RoleID char(36)

	AS
	BEGIN
		
		DECLARE @START AS DATETIME
		DECLARE @END AS DATETIME
		SET @START=CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE())) 
		SET @END=CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE()+1))

		SELECT	 
			CITIZENREQUEST.CITIZENREQUESTID, 
			REQUESTNUMBER,
			IDREQUESTNUMBER, 
			CITIZENREQUEST.CITIZENREQUESTTYPEID,
			CITIZENREQUESTTYPE.NAME TYPENAME,
			CITIZENREQUEST.DESCRIPTION,
			DATEFILED,
			CITIZENREQUEST.CITIZENREQUESTSTATUSID,
			CITIZENREQUESTSTATUS.STATUS STATUSNAME,
			CITIZENREQUEST.CITIZENREQUESTPRIORITYID,
			CITIZENREQUESTPRIORITY.NAME PRIORITYNAME,
			ENTEREDBYUSER,
			ASSIGNEDTOUSER,
			USERS.FNAME FIRSTNAME,
			USERS.LNAME LASTNAME,
			COMPDEADLINE,
			COMPCOMPLETE,
			EMERGENCY,
			RESOLVED,
			CITIZENREQUEST.CITIZENREQUESTSOURCEID,
			CITIZENREQUESTSOURCE.NAME SOURCENAME,
			REVIEWED,
			DISTRICT.DISTRICTID,
			DISTRICT.NAME DISTRICTNAME,
			PRPROJECT.NAME PROJECTNAME,
			PRPROJECT.PROJECTNUMBER,
			PRPROJECT.PRPROJECTID	,
			CITIZENREQUEST.ROWVERSION
		 FROM CITIZENREQUEST
		 INNER JOIN USERS ON USERS.SUSERGUID = CITIZENREQUEST.ASSIGNEDTOUSER	
		 INNER JOIN DISTRICT ON DISTRICT.DISTRICTID = CITIZENREQUEST.DISTRICTID
		 INNER JOIN CITIZENREQUESTTYPE ON CITIZENREQUESTTYPE.CITIZENREQUESTTYPEID = CITIZENREQUEST.CITIZENREQUESTTYPEID
		 INNER JOIN CITIZENREQUESTSTATUS ON CITIZENREQUESTSTATUS.CITIZENREQUESTSTATUSID = CITIZENREQUEST.CITIZENREQUESTSTATUSID
		 INNER JOIN CITIZENREQUESTSOURCE ON CITIZENREQUESTSOURCE.CITIZENREQUESTSOURCEID =CITIZENREQUEST.CITIZENREQUESTSOURCEID
		 INNER JOIN CITIZENREQUESTPRIORITY ON CITIZENREQUESTPRIORITY.CITIZENREQUESTPRIORITYID = CITIZENREQUEST.CITIZENREQUESTPRIORITYID
		 --LEFT OUTER JOIN ROLERECORDTYPEXREF ON ROLERECORDTYPEXREF.RECORDTYPEID = CITIZENREQUEST.CITIZENREQUESTTYPEID
		 OUTER APPLY (SELECT TOP 1 ROLEID, VISIBLE FROM ROLERECORDTYPEXREF R 
					WHERE R.RECORDTYPEID = CITIZENREQUEST.CITIZENREQUESTTYPEID AND R.VISIBLE = 1 AND R.ROLEID = @RoleID) ROLERECORDTYPEXREF
		 LEFT JOIN PRPROJECTCITIZENREQUEST ON PRPROJECTCITIZENREQUEST.CITIZENREQUESTID = CITIZENREQUEST.CITIZENREQUESTID
		 LEFT JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTCITIZENREQUEST.PRPROJECTID
		WHERE  EXISTS(
					SELECT * FROM IMINSPECTION
					INNER JOIN IMINSPECTORREF ON IMINSPECTORREF.INSPECTIONID = IMINSPECTION.IMINSPECTIONID
					 WHERE 
						SCHEDULEDSTARTDATE >= @START AND  SCHEDULEDSTARTDATE < @END AND IMINSPECTION.LINKID =  CITIZENREQUEST.CITIZENREQUESTID
						AND IMINSPECTORREF.USERID = @AssignedUserID) AND   
			   (@RoleID is null OR @RoleID = '''' OR (ROLERECORDTYPEXREF.ROLEID = @RoleID AND ROLERECORDTYPEXREF.VISIBLE = 1)) 
		ORDER BY CITIZENREQUEST.REQUESTNUMBER
END