
-- exec rpt_CM_SR_Code_Case_Detailed_Report_Inspection '0395ca50-eb2f-465e-bded-6b1985b5353f'
CREATE PROCEDURE [dbo].[rpt_CM_SR_Code_Case_Detailed_Report_Inspection]
@CMCODECASEID AS VARCHAR(36)
AS

;WITH CTE_CHECKLIST AS
(SELECT I.IMINSPECTIONID, I.INSPECTIONNUMBER, CHKLXREF.COMMENTS
	  , ROW_NUMBER() OVER (PARTITION BY I.INSPECTIONNUMBER ORDER BY CHKLXREF.ORDERNUM) RowNBR
 FROM  IMINSPECTION I
 INNER JOIN IMINSPECTIONCHECKLISTXREF CHKLXREF ON I.IMINSPECTIONID = CHKLXREF.IMINSPECTIONID
 WHERE I.LINKID = @CMCODECASEID AND (CHKLXREF.COMMENTS <> '' OR CHKLXREF.COMMENTS IS NOT NULL)
 )
 
 	
SELECT COALESCE(IMINSPECTION.ACTUALENDDATE, IMINSPECTION.SCHEDULEDENDDATE) AS INSPECTIONDATE, IMINSPECTION.INSPECTIONNUMBER,
	   IMINSPECTIONTYPE.NAME AS INSPECTIONTYPE, IMINSPECTIONSTATUS.STATUSNAME AS INSPECTIONSTATUS
	 , USERS.FNAME + ' ' + USERS.LNAME AS INSPECTOR
	 , STUFF((SELECT ', ' + CC.COMMENTS
              FROM  CTE_CHECKLIST CC
              WHERE CC.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
              FOR XML PATH(''), root('MyString'), type
		      ).value('/MyString[1]','varchar(max)'),1,2,'') ChecklistComments
			  
FROM IMINSPECTION
INNER JOIN IMINSPECTIONTYPE ON IMINSPECTION.IMINSPECTIONTYPEID = IMINSPECTIONTYPE.IMINSPECTIONTYPEID
INNER JOIN IMINSPECTIONSTATUS ON IMINSPECTION.IMINSPECTIONSTATUSID = IMINSPECTIONSTATUS.IMINSPECTIONSTATUSID
LEFT JOIN IMINSPECTORREF ON IMINSPECTION.IMINSPECTIONID = IMINSPECTORREF.INSPECTIONID AND IMINSPECTORREF.BPRIMARY = 1
LEFT JOIN USERS ON IMINSPECTORREF.USERID = USERS.SUSERGUID
WHERE IMINSPECTION.LINKID = @CMCODECASEID

