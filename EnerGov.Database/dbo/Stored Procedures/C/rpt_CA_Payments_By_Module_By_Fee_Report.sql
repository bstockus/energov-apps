



CREATE PROCEDURE [dbo].[rpt_CA_Payments_By_Module_By_Fee_Report]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME
AS
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT CAINVOICE.INVOICENUMBER, COALESCE (PMPERMIT.PERMITNUMBER, PLPLAN.PLANNUMBER, BLLICENSE.LICENSENUMBER, ILLICENSE.LICENSENUMBER, CMCODECASE.CASENUMBER, PRPROJECT.NAME) AS CaseNumber, 
       CATRANSACTIONFEE.PAIDAMOUNT, CACOMPUTEDFEE.COMPUTEDAMOUNT, CATRANSACTIONFEE.REFUNDAMOUNT, 
       CATRANSACTIONPAYMENT.PAYMENTDATE, CAPAYMENTMETHOD.NAME AS PaymentMethod, CATRANSACTIONPAYMENT.SUPPLEMENTALDATA, 
       CACOMPUTEDFEE.FEENAME, CAENTITY.NAME AS Module, CATRANSACTIONTYPE.NAME AS TRANSACTIONTYPE
FROM CATRANSACTIONFEE
INNER JOIN CACOMPUTEDFEE ON CATRANSACTIONFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID 
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID 
INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID 
INNER JOIN CAFEETEMPLATEFEE ON CACOMPUTEDFEE.CAFEETEMPLATEFEEID = CAFEETEMPLATEFEE.CAFEETEMPLATEFEEID 
INNER JOIN CAFEETEMPLATE ON CAFEETEMPLATEFEE.CAFEETEMPLATEID = CAFEETEMPLATE.CAFEETEMPLATEID 
LEFT OUTER JOIN CAENTITY ON CAENTITY.CAENTITYID = CAFEETEMPLATE.CAENTITYID 

LEFT OUTER JOIN PLPLANFEE ON PLPLANFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PLPLAN ON PLPLAN.PLPLANID = PLPLANFEE.PLPLANID 

LEFT OUTER JOIN PRPROJECTFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PRPROJECTFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PRPROJECT ON PRPROJECTFEE.PRPROJECTID = PRPROJECT.PRPROJECTID 

LEFT OUTER JOIN BLLICENSEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN BLLICENSE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID 

LEFT OUTER JOIN ILLICENSEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN ILLICENSE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID 

LEFT OUTER JOIN CMCODECASEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN CMCODECASE ON CMCODECASEFEE.CMCODECASEID = CMCODECASE.CMCODECASEID 

LEFT OUTER JOIN PMPERMITFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
LEFT OUTER JOIN PMPERMIT ON PMPERMIT.PMPERMITID = PMPERMITFEE.PMPERMITID 
WHERE     (CATRANSACTIONPAYMENT.PAYMENTDATE BETWEEN @STARTDATE AND @ENDDATE) AND (CATRANSACTION.CATRANSACTIONTYPEID NOT IN (5, 6)) 
					  AND (CATRANSACTION.CATRANSACTIONSTATUSID NOT IN (2,3)) AND (CAINVOICE.CASTATUSID <> 5) AND 
                      (CATRANSACTIONFEE.CASTATUSID NOT IN (5, 6))
UNION ALL

SELECT CAINVOICE.INVOICENUMBER, 'Misc Fee' AS CaseNumber, 
       CATRANSACTIONMISCFEE.PAIDAMOUNT, CAMISCFEE.AMOUNT AS ComputedAmount, CATRANSACTIONMISCFEE.REFUNDAMOUNT,
       CATRANSACTIONPAYMENT.PAYMENTDATE, CAPAYMENTMETHOD.NAME AS PaymentMethod, CATRANSACTIONPAYMENT.SUPPLEMENTALDATA, 
       CAMISCFEE.FEENAME, 'Cashier' AS Module , CATRANSACTIONTYPE.NAME AS TRANSACTIONTYPE
FROM CAMISCFEE 
INNER JOIN CATRANSACTIONMISCFEE ON CAMISCFEE.CAMISCFEEID = CATRANSACTIONMISCFEE.CAMISCFEEID 
INNER JOIN CATRANSACTION ON CATRANSACTIONMISCFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPaymentMethod ON CATransactionPayment.CAPaymentMethodID = CAPaymentMethod.CAPaymentMethodID 
INNER JOIN CATRANSACTIONMISCFEEPOSTING ON CATRANSACTIONMISCFEE.CATRANSACTIONMISCFEEID = CATRANSACTIONMISCFEEPOSTING.CATRANSACTIONMISCFEEID 
INNER JOIN CATRANSACTIONGLPOSTING ON CATRANSACTIONMISCFEEPOSTING.CATRANSACTIONGLPOSTINGID = CATRANSACTIONGLPOSTING.CATRANSACTIONGLPOSTINGID
INNER JOIN CAINVOICEMISCFEE ON CAMISCFEE.CAMISCFEEID = CAINVOICEMISCFEE.CAMISCFEEID 
INNER JOIN CAINVOICE ON CAINVOICEMISCFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
WHERE     CATransactionPayment.PaymentDate BETWEEN @STARTDATE AND @ENDDATE AND (CATransaction.CATransactionTypeID NOT IN (5, 6)) 
					  AND (CATransaction.CATransactionStatusID NOT IN (2, 3)) AND (CAInvoice.CAStatusID <> 5) AND 
                      (CATransactionMiscFee.CAStatusID NOT IN (5, 6))


