
CREATE PROCEDURE [dbo].[rpt_CR_SR_Citizen_Request_Listing]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME,
@FILTER AS VARCHAR(150)
AS

BEGIN
SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))


; with CTE_adddress as (
SELECT CITIZENREQUESTADDRESS.CITIZENREQUESTID, MAILINGADDRESS.ADDRESSLINE1, MAILINGADDRESS.ADDRESSLINE2, MAILINGADDRESS.ADDRESSLINE3, MAILINGADDRESS.CITY, MAILINGADDRESS.STATE, 
       MAILINGADDRESS.POSTALCODE, MAILINGADDRESS.POSTDIRECTION, MAILINGADDRESS.PREDIRECTION, MAILINGADDRESS.STREETTYPE, MAILINGADDRESS.UNITORSUITE
FROM CITIZENREQUESTADDRESS 
INNER JOIN MAILINGADDRESS ON CITIZENREQUESTADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
WHERE CITIZENREQUESTADDRESS.MAIN = 'TRUE'
)
SELECT CitizenRequest.RequestNumber, CitizenRequest.Description, CitizenRequest.DateFiled, CitizenRequest.CompDeadline AS DeadlineDate, 
       CitizenRequest.CompComplete AS CompleteDate, CitizenRequest.Emergency, CitizenRequestType.Name AS RequestType,
	   COALESCE(NULLIF(DISTRICT.NAME,''),'Not Assigned') AS DISTRICT, 
       CitizenRequestStatus.Status, CitizenRequestSource.Name AS "Source", CitizenRequest.CitizenRequestID
	   ,case when CitizenRequest.Emergency=1 then 'Emergency' else 'Non-Emergency' end as Emergency_string
	   ,CTE_adddress.*
	   ,CITIZENREQUESTPRIORITY.NAME AS [PRIORITY]
	   ,PRPROJECT.NAME AS PROJECT_NAME,
	   CRAC.ATTACHEDCASENUMBER
	   ,LTRIM(RTRIM(USERS.FNAME)) + LTRIM(RTRIM(USERS.LNAME)) AS ASSIGNEDTO_NAME,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		--WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM CitizenRequest 
INNER JOIN CitizenRequestType ON CitizenRequest.CitizenRequestTypeID = CitizenRequestType.CitizenRequestTypeID 
INNER JOIN CitizenRequestStatus ON CitizenRequest.CitizenRequestStatusID = CitizenRequestStatus.CitizenRequestStatusID 
INNER JOIN CitizenRequestSource ON CitizenRequest.CitizenRequestSourceID = CitizenRequestSource.CitizenRequestSourceID 
INNER JOIN District ON CitizenRequest.DistrictID = District.DistrictID
LEFT JOIN PRPROJECTCITIZENREQUEST ON PRPROJECTCITIZENREQUEST.CITIZENREQUESTID = CITIZENREQUEST.CITIZENREQUESTID
LEFT JOIN PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTCITIZENREQUEST.PRPROJECTID
LEFT JOIN CITIZENREQUESTPRIORITY ON CITIZENREQUESTPRIORITY.CITIZENREQUESTPRIORITYID = CITIZENREQUEST.CITIZENREQUESTPRIORITYID
LEFT JOIN USERS ON USERS.SUSERGUID = CITIZENREQUEST.ASSIGNEDTOUSER
left join CTE_adddress on CTE_adddress.CITIZENREQUESTID = CITIZENREQUEST.CITIZENREQUESTID
LEFT JOIN CITIZENREQUESTATTACHEDCASELIST CRAC ON CRAC.CITIZENREQUESTID = CITIZENREQUEST.CITIZENREQUESTID
WHERE (CASE @FILTER
		WHEN 'COMPLETE DATE' THEN CITIZENREQUEST.COMPCOMPLETE
		WHEN 'DATE ENTERED' THEN CITIZENREQUEST.DATEFILED
		WHEN 'DEADLINE DATE' THEN CITIZENREQUEST.COMPDEADLINE
		END)
		BETWEEN @STARTDATE AND @ENDDATE
END
