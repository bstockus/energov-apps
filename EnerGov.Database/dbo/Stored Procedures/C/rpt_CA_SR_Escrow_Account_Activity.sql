
CREATE PROCEDURE rpt_CA_SR_Escrow_Account_Activity
AS
BEGIN

SELECT GE.GLOBALENTITYID 
		, CASE GE.ISCOMPANY 
			WHEN 1 THEN GE.GLOBALENTITYNAME
			ELSE GE.FIRSTNAME + ' ' 
				+ CASE WHEN RTRIM(GE.MIDDLENAME) = '' THEN '' ELSE LEFT(GE.MIDDLENAME,1) + ' ' END 
				+ GE.LASTNAME END CONTACTNAME
		, TA.ENTITYACCOUNTBALANCE
		, TGP.POSTINGAMOUNT
		, AA.NAME ACCOUNTACTION
		, GEA.GLOBALENTITYACCOUNTID, GEA.ACCOUNTNUMBER, GEA.BALANCE, GEA.NAME ACCOUNTNAME
		, GEAT.TYPENAME ACCOUNTTYPE, GEAT.GLOBALENTITYACCOUNTTYPEID
		, T.RECEIPTNUMBER, T.CATRANSACTIONID
		, TP.PAYMENTDATE
		, PM.NAME PAYMENTMETHOD
		, TT.NAME TRANSACTIONTYPE
		, CASE WHEN (SELECT COALESCE(S.BITVALUE,0) FROM SETTINGS S WHERE S.NAME = 'EnableTCIntegration') = 0 THEN
		  (CASE AA.NAME WHEN 'Credit' THEN TGP.CREDITACCOUNTNUMBER ELSE TGP.DEBITACCOUNTNUMBER END) ELSE GEAT.CHARGECODE END AS GLACCOUNT
		,(SELECT COALESCE(S.BITVALUE,0) FROM SETTINGS S WHERE S.NAME = 'EnableTCIntegration') AS TCIntegration
		,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM GLOBALENTITY GE
INNER JOIN GLOBALENTITYACCOUNTENTITY GEAE ON GE.GLOBALENTITYID = GEAE.GLOBALENTITYID
INNER JOIN GLOBALENTITYACCOUNT GEA ON GEAE.GLOBALENTITYACCOUNTID = GEA.GLOBALENTITYACCOUNTID
INNER JOIN GLOBALENTITYACCOUNTTYPE GEAT ON GEA.GLOBALENTITYACCOUNTTYPEID = GEAT.GLOBALENTITYACCOUNTTYPEID
INNER JOIN CATRANSACTIONACCOUNT TA ON GEA.GLOBALENTITYACCOUNTID = TA.ENTITYACCOUNTID
INNER JOIN CAACCOUNTACTION AA ON TA.CAACCOUNTACTIONID = AA.CAACCOUNTACTIONID
INNER JOIN CATRANSACTION T ON TA.CATRANSACTIONID = T.CATRANSACTIONID
INNER JOIN CATRANSACTIONPAYMENT TP ON T.CATRANSACTIONID = TP.CATRANSACTIONID
INNER JOIN CAPAYMENTMETHOD PM ON TP.CAPAYMENTMETHODID = PM.CAPAYMENTMETHODID
INNER JOIN CATRANSACTIONTYPE TT ON T.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
LEFT OUTER JOIN CATRANSACTIONACCOUNTPOSTING TAP ON TA.CATRANSACTIONACCOUNTID = TAP.CATRANSACTIONACCOUNTID
LEFT OUTER JOIN CATRANSACTIONGLPOSTING TGP ON TAP.CATRANSACTIONGLPOSTINGID = TGP.CATRANSACTIONGLPOSTINGID
WHERE GEA.ACTIVE = 1

END
