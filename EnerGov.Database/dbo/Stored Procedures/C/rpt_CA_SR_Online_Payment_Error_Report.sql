
/*
EXEC rpt_CA_SR_Online_Payment_Error_Report '20160912', '20190912'
*/

CREATE PROCEDURE [dbo].rpt_CA_SR_Online_Payment_Error_Report
@STARTDATE		DATETIME,
@ENDDATE		DATETIME
AS

BEGIN
SET NOCOUNT ON
;

SET @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(SECOND,-1,DATEDIFF(DAY,0,@ENDDATE) + 1)


SELECT CA.CAINVOICEID, CA.INVOICENUMBER
	 , CS.[NAME] INV_STATUS
	 , RI.AMOUNT, RI.PROCESSEDDATE, RI.ERRORMESSAGE	
	 , COALESCE((SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo')
		         ,(SELECT TOP 1 IMAGEVALUE FROM SETTINGS WHERE NAME = 'LogoImage')) LOGO
	 ,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
	 ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
	 ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM RECEIPTITEM RI
INNER JOIN CAINVOICE CA ON  RI.ITEMID = CA.CAINVOICEID
INNER JOIN CASTATUS CS ON CA.CASTATUSID = CS.CASTATUSID AND CS.CASTATUSID IN ('1','2','3','6','8')
WHERE RI.PROCESSEDDATE BETWEEN @STARTDATE AND @ENDDATE AND RI.ERRORMESSAGE <> '' 

END
