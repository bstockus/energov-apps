
CREATE PROCEDURE [dbo].[rpt_CM_SR_Code_Case_Listing]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME,
@FILTER AS VARCHAR(150)
AS

SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT CMCODECASEFEE.CMCODECASEID, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) FEETOTAL
INTO #FEES 
FROM CMCODECASE 
INNER JOIN CMCODECASEFEE ON CMCODECASE.CMCODECASEID = CMCODECASEFEE.CMCODECASEID
INNER JOIN CACOMPUTEDFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID
WHERE CACOMPUTEDFEE.CASTATUSID NOT IN (5,10) --VOID, DELETED
AND (CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
	     BETWEEN @STARTDATE AND @ENDDATE
GROUP BY CMCODECASEFEE.CMCODECASEID

SELECT CMVIOLATIONFEE.CMVIOLATIONID, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) FEETOTALVIO
INTO #VIOFEES 
FROM CMCODECASE 
INNER JOIN CMCODEWFSTEP ON CMCODECASE.CMCODECASEID = CMCODEWFSTEP.CMCODECASEID
INNER JOIN CMVIOLATION ON CMCODEWFSTEP.CMCODEWFSTEPID = CMVIOLATION.CMCODEWFSTEPID 
INNER JOIN CMVIOLATIONFEE ON CMVIOLATION.CMVIOLATIONID = CMVIOLATIONFEE.CMVIOLATIONID
INNER JOIN CACOMPUTEDFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CMVIOLATIONFEE.CACOMPUTEDFEEID
WHERE CACOMPUTEDFEE.CASTATUSID NOT IN (5,10) --VOID, DELETED
AND (CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
	     BETWEEN @STARTDATE AND @ENDDATE
GROUP BY CMVIOLATIONFEE.CMVIOLATIONID

SELECT V.CMCODECASEID, V.CMVIOLATIONID, V.CodeNumber, V.CodeDescription, V.CITATIONISSUEDATE, V.COMPLIANCEDATE, V.RESOLVEDDATE, V.ViolationStatus
INTO #VIOLIST
FROM (
SELECT CMCODEWFSTEP.CMCODECASEID, CMVIOLATION.CMVIOLATIONID, CMCODE.CODENUMBER AS CodeNumber, CMCODE.DESCRIPTION AS CodeDescription
		, CMVIOLATION.CITATIONISSUEDATE, CMVIOLATION.COMPLIANCEDATE, CMVIOLATION.RESOLVEDDATE, CMVIOLATIONSTATUS.NAME AS ViolationStatus
FROM CMCODECASE 
INNER JOIN CMCODEWFSTEP ON CMCODECASE.CMCODECASEID = CMCODEWFSTEP.CMCODECASEID
INNER JOIN CMCODEWFACTIONSTEP ON CMCODEWFSTEP.CMCODEWFSTEPID = CMCODEWFACTIONSTEP.CMCODEWFSTEPID 
INNER JOIN CMVIOLATION ON CMCODEWFACTIONSTEP.CMCODEWFACTIONSTEPID = CMVIOLATION.CMCODEWFACTIONID 
INNER JOIN CMVIOLATIONSTATUS ON CMVIOLATIONSTATUS.CMVIOLATIONSTATUSID = CMVIOLATION.CMVIOLATIONSTATUSID
INNER JOIN CMCODE ON CMVIOLATION.CMCODEID = CMCODE.CMCODEID
WHERE	(CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
	     BETWEEN @STARTDATE AND @ENDDATE
UNION
SELECT CMCODEWFSTEP.CMCODECASEID, CMVIOLATION.CMVIOLATIONID, CMCODE.CODENUMBER AS CodeNumber, CMCODE.DESCRIPTION AS CodeDescription
		, CMVIOLATION.CITATIONISSUEDATE, CMVIOLATION.COMPLIANCEDATE, CMVIOLATION.RESOLVEDDATE, CMVIOLATIONSTATUS.NAME AS ViolationStatus
FROM CMCODECASE 
INNER JOIN CMCODEWFSTEP ON CMCODECASE.CMCODECASEID = CMCODEWFSTEP.CMCODECASEID
INNER JOIN CMVIOLATION ON CMCODEWFSTEP.CMCODEWFSTEPID = CMVIOLATION.CMCODEWFSTEPID 
INNER JOIN CMVIOLATIONSTATUS ON CMVIOLATIONSTATUS.CMVIOLATIONSTATUSID = CMVIOLATION.CMVIOLATIONSTATUSID
INNER JOIN CMCODE ON CMVIOLATION.CMCODEID = CMCODE.CMCODEID
WHERE	(CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
	     BETWEEN @STARTDATE AND @ENDDATE
) V

CREATE INDEX TEMP1 ON #FEES (CMCODECASEID);
CREATE INDEX TEMP1 ON #VIOFEES (CMVIOLATIONID);
CREATE INDEX TEMP1 ON #VIOLIST (CMVIOLATIONID);

SELECT	CMCODECASE.CMCODECASEID AS CodeCaseID, CMCODECASE.CASENUMBER AS CaseNumber, CMCODECASE.OPENEDDATE AS OpenedDate, CMCODECASE.CLOSEDDATE AS ClosedDate, CMCODECASE.DESCRIPTION, 
		CMCODECASE.[EMERGENCY],
		CMCASETYPE.NAME AS CaseType, 
		#VIOLIST.CODENUMBER AS CodeNumber, #VIOLIST.CodeDescription, 
		CMCODECASESTATUS.NAME AS CaseStatus,
		#VIOLIST.CITATIONISSUEDATE, #VIOLIST.COMPLIANCEDATE, #VIOLIST.RESOLVEDDATE,
		#VIOLIST.ViolationStatus,
		COALESCE(VIOFEES.FEETOTALVIO, 0) AS FEETOTALVIO,
		COALESCE(NULLIF(DISTRICT.NAME,''),'Not Assigned') AS District,
		PRPROJECT.NAME AS ProjectName,
		PARCEL.PARCELNUMBER,
		MAILINGADDRESS.ADDRESSLINE1 AS AddressLine1, MAILINGADDRESS.ADDRESSLINE2 AS AddressLine2, 
		MAILINGADDRESS.ADDRESSLINE3 AS AddressLine3, MAILINGADDRESS.CITY AS City, MAILINGADDRESS."STATE" AS "State", 
		MAILINGADDRESS.POSTALCODE AS PostalCode, MAILINGADDRESS.UNITORSUITE AS UnitOrSuite, 
		MAILINGADDRESS.POSTDIRECTION AS PostDirection, MAILINGADDRESS.PREDIRECTION AS PreDirection, 
		MAILINGADDRESS.STREETTYPE AS StreetType,
		COALESCE(USERS.FNAME + ' ' + USERS.LNAME,'No User Assigned') AS ASSIGNEDTO,
		COALESCE(FEES.FEETOTAL, 0) AS FEETOTAL, 
		--ZONE.ZONECODE + ' ' + ZONE.NAME AS ZONE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		-- WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	    (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		 WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	    (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		 WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	    (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		 WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer


FROM	CMCODECASE 
		INNER JOIN CMCASETYPE ON CMCODECASE.CMCASETYPEID = CMCASETYPE.CMCASETYPEID 
		INNER JOIN CMCODECASESTATUS ON CMCODECASE.CMCODECASESTATUSID = CMCODECASESTATUS.CMCODECASESTATUSID
		LEFT OUTER JOIN #VIOLIST ON CMCODECASE.CMCODECASEID = #VIOLIST.CMCODECASEID
		LEFT OUTER JOIN #VIOFEES VIOFEES ON #VIOLIST.CMVIOLATIONID = VIOFEES.CMVIOLATIONID
		LEFT OUTER JOIN DISTRICT ON CMCODECASE.DISTRICTID = DISTRICT.DISTRICTID
		LEFT OUTER JOIN PRPROJECTCODECASE ON CMCODECASE.CMCODECASEID = PRPROJECTCODECASE.CMCODECASEID
		LEFT OUTER JOIN PRPROJECT ON PRPROJECTCODECASE.PRPROJECTID = PRPROJECT.PRPROJECTID
		LEFT OUTER JOIN ( SELECT * FROM CMCODECASEPARCEL WHERE CMCODECASEPARCEL.[PRIMARY] = 1 ) AS CMCODECASEPARCEL ON CMCODECASE.CMCODECASEID = CMCODECASEPARCEL.CMCODECASEID
		LEFT OUTER JOIN PARCEL ON CMCODECASEPARCEL.PARCELID = PARCEL.PARCELID
		LEFT OUTER JOIN CMCODECASEADDRESS ON CMCODECASE.CMCODECASEID = CMCODECASEADDRESS.CMCODECASEID AND CMCODECASEADDRESS.MAIN = 1
		LEFT OUTER JOIN MAILINGADDRESS ON CMCODECASEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
		LEFT OUTER JOIN USERS ON CMCODECASE.ASSIGNEDTO = USERS.SUSERGUID
		LEFT OUTER JOIN #FEES FEES ON CMCODECASE.CMCODECASEID = FEES.CMCODECASEID
		--LEFT OUTER JOIN CMCODECASEZONE ON CMCODECASE.CMCODECASEID = CMCODECASEZONE.CMCODECASEID AND CMCODECASEZONE.MAIN = 1
		--LEFT OUTER JOIN ZONE ON ZONE.ZONEID = CMCODECASEZONE.ZONEID

WHERE	(CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
	     BETWEEN @STARTDATE AND @ENDDATE

UNION 

SELECT	CMCODECASE.CMCODECASEID AS CodeCaseID, CMCODECASE.CASENUMBER AS CaseNumber, CMCODECASE.OPENEDDATE AS OpenedDate, CMCODECASE.CLOSEDDATE AS ClosedDate, CMCODECASE.DESCRIPTION,
		CMCODECASE.[EMERGENCY],
		CMCASETYPE.NAME AS CaseType, 
		#VIOLIST.CODENUMBER AS CodeNumber, #VIOLIST.CodeDescription, 
		CMCODECASESTATUS.NAME AS CaseStatus,
		#VIOLIST.CITATIONISSUEDATE, #VIOLIST.COMPLIANCEDATE, #VIOLIST.RESOLVEDDATE,
		#VIOLIST.ViolationStatus,
		COALESCE(VIOFEES.FEETOTALVIO, 0) AS FEETOTALVIO,
		COALESCE(NULLIF(DISTRICT.NAME,''),'Not Assigned') AS District,
		PRPROJECT.NAME AS ProjectName,
		PARCEL.PARCELNUMBER,
		MAILINGADDRESS.ADDRESSLINE1 AS AddressLine1, MAILINGADDRESS.ADDRESSLINE2 AS AddressLine2, 
		MAILINGADDRESS.ADDRESSLINE3 AS AddressLine3, MAILINGADDRESS.CITY AS City, MAILINGADDRESS."STATE" AS "State", 
		MAILINGADDRESS.POSTALCODE AS PostalCode, MAILINGADDRESS.UNITORSUITE AS UnitOrSuite, 
		MAILINGADDRESS.POSTDIRECTION AS PostDirection, MAILINGADDRESS.PREDIRECTION AS PreDirection, 
		MAILINGADDRESS.STREETTYPE AS StreetType,
		COALESCE(USERS.FNAME + ' ' + USERS.LNAME,'No User Assigned') AS ASSIGNEDTO,
		COALESCE(FEES.FEETOTAL, 0) AS FEETOTAL, 
		--ZONE.ZONECODE + ' ' + ZONE.NAME AS ZONE,
		--(SELECT R.[IMAGE] FROM RPTIMAGELIB R
		-- WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	    (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		 WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	    (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		 WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,
	    (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		 WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	CMCODECASE 
		INNER JOIN CMCASETYPE ON CMCODECASE.CMCASETYPEID = CMCASETYPE.CMCASETYPEID 
		INNER JOIN CMCODECASESTATUS ON CMCODECASESTATUS.CMCODECASESTATUSID = CMCODECASE.CMCODECASESTATUSID 
		LEFT OUTER JOIN #VIOLIST ON CMCODECASE.CMCODECASEID = #VIOLIST.CMCODECASEID
		LEFT OUTER JOIN #VIOFEES VIOFEES ON #VIOLIST.CMVIOLATIONID = VIOFEES.CMVIOLATIONID
		LEFT OUTER JOIN DISTRICT ON CMCODECASE.DISTRICTID = DISTRICT.DISTRICTID
		LEFT OUTER JOIN PRPROJECTCODECASE ON CMCODECASE.CMCODECASEID = PRPROJECTCODECASE.CMCODECASEID
		LEFT OUTER JOIN PRPROJECT ON PRPROJECTCODECASE.PRPROJECTID = PRPROJECT.PRPROJECTID
		LEFT OUTER JOIN ( SELECT * FROM CMCODECASEPARCEL WHERE CMCODECASEPARCEL.[PRIMARY] = 1 ) AS CMCODECASEPARCEL ON CMCODECASE.CMCODECASEID = CMCODECASEPARCEL.CMCODECASEID
		LEFT OUTER JOIN PARCEL ON CMCODECASEPARCEL.PARCELID = PARCEL.PARCELID 
		LEFT OUTER JOIN CMCODECASEADDRESS ON CMCODECASE.CMCODECASEID = CMCODECASEADDRESS.CMCODECASEID AND CMCODECASEADDRESS.MAIN = 1
		LEFT OUTER JOIN MAILINGADDRESS ON CMCODECASEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
		LEFT OUTER JOIN USERS ON CMCODECASE.ASSIGNEDTO = USERS.SUSERGUID
		LEFT OUTER JOIN #FEES FEES ON CMCODECASE.CMCODECASEID = FEES.CMCODECASEID
		--LEFT OUTER JOIN CMCODECASEZONE ON CMCODECASE.CMCODECASEID = CMCODECASEZONE.CMCODECASEID AND CMCODECASEZONE.MAIN = 1
		--LEFT OUTER JOIN ZONE ON ZONE.ZONEID = CMCODECASEZONE.ZONEID  

WHERE	(CASE @FILTER 
	     WHEN 'OPENED DATE' THEN CMCODECASE.OPENEDDATE
	     WHEN 'CLOSED DATE' THEN CMCODECASE.CLOSEDDATE END)
		 BETWEEN @STARTDATE AND @ENDDATE
