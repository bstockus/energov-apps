

CREATE PROCEDURE [dbo].[rpt_CA_SR_Daily_Transaction_Listing_Escrow_Deposits]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME
AS
BEGIN
SET @STARTDATE = DATEADD(dd, DATEDIFF(dd, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT TP.PAYMENTAMOUNT - (2 * CASE WHEN TA.CAACCOUNTACTIONID = 1 THEN TP.PAYMENTAMOUNT ELSE 0 END) PAYMENTAMOUNT
	, COALESCE(NULLIF(LTRIM(T.EXTERNALBATCHNBR), ''), 'NONE SPECIFIED') AS EXTERNALBATCHNBR
	, TA.ENTITYACCOUNTBALANCE
	, T.RECEIPTNUMBER
	, T.TRANSACTIONDATE
	, TT.NAME TransactionType
	, TS.NAME TransactionStatus
	, PT.NAME PAYMENTTYPE
	, PM.NAME PAYMENTMETHOD
	, GEA.ACCOUNTNUMBER, GEA.NAME ACCOUNTNAME, GEA.BALANCE
	, COALESCE(U.SUSERGUID, 'NONE') SUSERGUID
	, COALESCE(U.FNAME, 'NO') FNAME, COALESCE(U.LNAME,'USER') LNAME
	--, I.INVOICENUMBER
FROM CATRANSACTIONACCOUNT TA
INNER JOIN GLOBALENTITYACCOUNT GEA ON TA.ENTITYACCOUNTID = GEA.GLOBALENTITYACCOUNTID
INNER JOIN CATRANSACTION T ON TA.CATRANSACTIONID = T.CATRANSACTIONID 
	AND T.CATRANSACTIONTYPEID <> 5 -- NSF
INNER JOIN CATRANSACTIONTYPE TT ON T.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS TS ON T.CATRANSACTIONSTATUSID = TS.CATRANSACTIONSTATUSID 
INNER JOIN USERS U ON T.CREATEDBY = U.SUSERGUID 
INNER JOIN CATRANSACTIONPAYMENT TP ON T.CATRANSACTIONID = TP.CATRANSACTIONID 
	AND TP.CAPAYMENTSTATUSID <> 3 -- NSF
INNER JOIN CAPAYMENTMETHOD PM ON TP.CAPAYMENTMETHODID = PM.CAPAYMENTMETHODID 
INNER JOIN CAPAYMENTTYPE PT ON TP.CAPAYMENTTYPEID = PT.CAPAYMENTTYPEID
WHERE TT.NAME NOT IN ('Void Reversal', 'NSF Reversal') 
	AND TT.NAME NOT LIKE 'Refund%'
	AND TA.CAACCOUNTACTIONID = 2 -- Deposit
	AND TS.NAME NOT IN ('Void', 'NSF')
	AND T.TRANSACTIONDATE BETWEEN @STARTDATE AND @ENDDATE
	
END
