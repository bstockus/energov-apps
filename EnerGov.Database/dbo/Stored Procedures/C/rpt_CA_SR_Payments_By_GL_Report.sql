
CREATE PROCEDURE [dbo].[rpt_CA_SR_Payments_By_GL_Report]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME
AS
BEGIN

SET @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @ENDDATE), 1)

SELECT	 COALESCE(GLACCOUNT.ACCOUNTNUMBER,CAFEE.ARFEECODE) AS GLACCOUNT
		, CACOMPUTEDFEE.FEENAME, CACOMPUTEDFEE.CACOMPUTEDFEEID
		, CATRANSACTIONPAYMENT.PAYMENTDATE, CATRANSACTIONTYPE.[NAME] TRANSACTIONTYPE
		, COALESCE(
			CASE WHEN (CATRANSACTIONFEE.PAIDAMOUNT - 2*CATRANSACTIONFEE.REFUNDAMOUNT) < 0
				THEN 0-CATRANSACTIONGLPOSTING.POSTINGAMOUNT
				ELSE CATRANSACTIONGLPOSTING.POSTINGAMOUNT
			END 
			, (CATRANSACTIONFEE.PAIDAMOUNT - 2*CATRANSACTIONFEE.REFUNDAMOUNT)
		  ) AS TRANSACTIONAMOUNT
		, GE.GLOBALENTITYNAME, GE.FIRSTNAME, GE.LASTNAME
		, CAPAYMENTMETHOD.NAME AS PAYMENTMETHOD
		--,(SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') LOGO
		,(SELECT COALESCE(S.BITVALUE,0) FROM SETTINGS S WHERE S.NAME = 'EnableTCIntegration') AS TCIntegration
	    ,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
	    ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
	    ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM CACOMPUTEDFEE 
INNER JOIN CATRANSACTIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CATRANSACTIONFEE.CACOMPUTEDFEEID 
INNER JOIN CAFEETEMPLATEFEE ON CACOMPUTEDFEE.CAFEETEMPLATEFEEID = CAFEETEMPLATEFEE.CAFEETEMPLATEFEEID
INNER JOIN CAFEE ON CAFEETEMPLATEFEE.CAFEEID = CAFEE.CAFEEID
INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
INNER JOIN GLOBALENTITY GE ON CATRANSACTION.GLOBALENTITYID = GE.GLOBALENTITYID
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPaymentMethod ON CATransactionPayment.CAPaymentMethodID = CAPaymentMethod.CAPaymentMethodID 
LEFT JOIN CATRANSACTIONFEEPOSTING ON CATRANSACTIONFEE.CATRANSACTIONFEEID = CATRANSACTIONFEEPOSTING.CATRANSACTIONFEEID
LEFT JOIN CATRANSACTIONGLPOSTING ON CATRANSACTIONFEEPOSTING.CATRANSACTIONGLPOSTINGID = CATRANSACTIONGLPOSTING.CATRANSACTIONGLPOSTINGID
LEFT JOIN GLACCOUNT ON CATRANSACTIONGLPOSTING.CREDITACCOUNTID = GLACCOUNT.GLACCOUNTID
WHERE CATransactionPayment.PaymentDate >= @STARTDATE AND CATransactionPayment.PaymentDate < @ENDDATE
AND (CATransactionType.CATransactionTypeID NOT IN (6)) --void reversal
AND (CATransactionStatus.CATransactionStatusID NOT IN (2)) --void
AND (CATransactionFee.CAStatusID NOT IN (5, 10)) --void, deleted

UNION ALL

SELECT	COALESCE(GLACCOUNT.ACCOUNTNUMBER,CAFEE.ARFEECODE) AS GLACCOUNT
		, CAMISCFEE.FEENAME, CAMISCFEE.CAMISCFEEID
		, CATRANSACTIONPAYMENT.PAYMENTDATE, CATRANSACTIONTYPE.[NAME] TRANSACTIONTYPE
		, COALESCE(
			CASE WHEN CATRANSACTIONMISCFEE.PAIDAMOUNT - 2*CATRANSACTIONMISCFEE.REFUNDAMOUNT < 0
				THEN 0 - CATRANSACTIONGLPOSTING.POSTINGAMOUNT
				ELSE CATRANSACTIONGLPOSTING.POSTINGAMOUNT
			END
			, CATRANSACTIONMISCFEE.PAIDAMOUNT - 2*CATRANSACTIONMISCFEE.REFUNDAMOUNT
		  ) AS TRANSACTIONAMOUNT
		, GE.GLOBALENTITYNAME, GE.FIRSTNAME, GE.LASTNAME
		, CAPAYMENTMETHOD.NAME AS PAYMENTMETHOD
		--,(SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') LOGO
		,(SELECT COALESCE(S.BITVALUE,0) FROM SETTINGS S WHERE S.NAME = 'EnableTCIntegration') AS TCIntegration
	    ,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
	    ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
	    ,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM CAMISCFEE 
INNER JOIN CAFEE ON CAMISCFEE.CAFEEID = CAFEE.CAFEEID
INNER JOIN CATRANSACTIONMISCFEE ON CAMISCFEE.CAMISCFEEID = CATRANSACTIONMISCFEE.CAMISCFEEID 
INNER JOIN CATRANSACTION ON CATRANSACTIONMISCFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN GLOBALENTITY GE ON CATRANSACTION.GLOBALENTITYID = GE.GLOBALENTITYID
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPaymentMethod ON CATransactionPayment.CAPaymentMethodID = CAPaymentMethod.CAPaymentMethodID 
LEFT JOIN CATRANSACTIONMISCFEEPOSTING ON CATRANSACTIONMISCFEE.CATRANSACTIONMISCFEEID = CATRANSACTIONMISCFEEPOSTING.CATRANSACTIONMISCFEEID 
LEFT JOIN CATRANSACTIONGLPOSTING ON CATRANSACTIONMISCFEEPOSTING.CATRANSACTIONGLPOSTINGID = CATRANSACTIONGLPOSTING.CATRANSACTIONGLPOSTINGID
LEFT JOIN GLACCOUNT ON CATRANSACTIONGLPOSTING.CREDITACCOUNTID = GLACCOUNT.GLACCOUNTID
WHERE CATransactionPayment.PaymentDate >= @STARTDATE AND CATransactionPayment.PaymentDate < @ENDDATE
AND (CATransactionType.CATransactionTypeID NOT IN (6)) --void reversal
AND (CATransactionStatus.CATransactionStatusID NOT IN (2)) --void
AND (CATRANSACTIONMISCFEE.CAStatusID NOT IN (5, 10)) --void, deleted
ORDER BY GLACCOUNT, PAYMENTDATE

END
