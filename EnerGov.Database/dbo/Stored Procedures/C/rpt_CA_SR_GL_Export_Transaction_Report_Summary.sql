

CREATE PROCEDURE rpt_CA_SR_GL_Export_Transaction_Report_Summary

@STARTDATE datetime,
@ENDDATE datetime

AS
BEGIN

SET NOCOUNT ON;

SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE=dateadd(ss,-1,datediff(dd,0,@ENDDATE) + 1)

-- Fee Payment Credits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTF.PAIDAMOUNT)) AS GLAMOUNT
	
	, COALESCE(GL.NAME, F.ARFEECODE) AS GLNAME
	, COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE) AS GLACCOUNT
	, 'CREDIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONFEE CTF ON CT.CATRANSACTIONID = CTF.CATRANSACTIONID
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CACOMPUTEDFEE CF ON CTF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
		INNER JOIN CAFEETEMPLATEFEE FTF ON CF.CAFEETEMPLATEFEEID = FTF.CAFEETEMPLATEFEEID
		INNER JOIN CAFEE F ON FTF.CAFEEID = F.CAFEEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		LEFT JOIN CATRANSACTIONFEEPOSTING CTFAP ON CTF.CATRANSACTIONFEEID = CTFAP.CATRANSACTIONFEEID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON CTFAP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.CREDITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.CREDITACCOUNTNUMBER IS NOT NULL AND CTGP.CREDITACCOUNTNUMBER <> '')
		AND COALESCE(CTGP.POSTINGDATE, TP.PAYMENTDATE) BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] IN ('Fee Payment','Account Deposit','Bond Payment')

GROUP BY COALESCE(GL.NAME, F.ARFEECODE), COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE)

UNION ALL

--Fee payment debits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTF.PAIDAMOUNT)) AS GLAMOUNT
	, COALESCE(GL.NAME, F.ARFEECODE) AS GLNAME
	, COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE) AS GLACCOUNT
	, 'DEBIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONFEE CTF ON CT.CATRANSACTIONID = CTF.CATRANSACTIONID
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CACOMPUTEDFEE CF ON CTF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
		INNER JOIN CAFEETEMPLATEFEE FTF ON CF.CAFEETEMPLATEFEEID = FTF.CAFEETEMPLATEFEEID
		INNER JOIN CAFEE F ON FTF.CAFEEID = F.CAFEEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		LEFT JOIN CATRANSACTIONFEEPOSTING CTFAP ON CTF.CATRANSACTIONFEEID = CTFAP.CATRANSACTIONFEEID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON CTFAP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.DEBITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.DEBITACCOUNTNUMBER IS NOT NULL AND CTGP.DEBITACCOUNTNUMBER <> '')
		AND COALESCE(CTGP.POSTINGDATE, TP.PAYMENTDATE) BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] NOT IN ('Fee Payment','Account Deposit','Bond Payment')
		

GROUP BY COALESCE(GL.NAME, F.ARFEECODE), COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE)


UNION ALL

--Miscellaneous Fee Payments Credits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTMF.PAIDAMOUNT)) AS GLAMOUNT
	, COALESCE(GL.NAME, F.ARFEECODE) AS GLNAME
	, COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE) AS GLACCOUNT
	, 'CREDIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CATRANSACTIONMISCFEE CTMF ON CT.CATRANSACTIONID = CTMF.CATRANSACTIONID
		INNER JOIN CAMISCFEE MF ON CTMF.CAMISCFEEID = MF.CAMISCFEEID
		INNER JOIN CAFEE F ON MF.CAFEEID = F.CAFEEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		LEFT JOIN CATRANSACTIONMISCFEEPOSTING CTMFP ON CTMF.CATRANSACTIONMISCFEEID = CTMFP.CATRANSACTIONMISCFEEID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON CTMFP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.CREDITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.CREDITACCOUNTNUMBER IS NOT NULL AND CTGP.CREDITACCOUNTNUMBER <> '')
		AND COALESCE(CTGP.POSTINGDATE, TP.PAYMENTDATE) BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] IN ('Fee Payment','Account Deposit','Bond Payment')

GROUP BY COALESCE(GL.NAME, F.ARFEECODE), COALESCE(CTGP.CREDITACCOUNTNUMBER, F.ARFEECODE)

UNION ALL

--Miscellaneous Fee Payments Debits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTMF.PAIDAMOUNT)) AS GLAMOUNT
	, COALESCE(GL.NAME, F.ARFEECODE) AS GLNAME
	, COALESCE(CTGP.DEBITACCOUNTNUMBER, F.ARFEECODE) AS GLACCOUNT
	, 'DEBIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CATRANSACTIONMISCFEE CTMF ON CT.CATRANSACTIONID = CTMF.CATRANSACTIONID
		INNER JOIN CAMISCFEE MF ON CTMF.CAMISCFEEID = MF.CAMISCFEEID
		INNER JOIN CAFEE F ON MF.CAFEEID = F.CAFEEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		LEFT JOIN CATRANSACTIONMISCFEEPOSTING CTMFP ON CTMF.CATRANSACTIONMISCFEEID = CTMFP.CATRANSACTIONMISCFEEID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON CTMFP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.DEBITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.DEBITACCOUNTNUMBER IS NOT NULL AND CTGP.DEBITACCOUNTNUMBER <> '')
		AND COALESCE(CTGP.POSTINGDATE, TP.PAYMENTDATE) BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] NOT IN ('Fee Payment','Account Deposit','Bond Payment')

GROUP BY COALESCE(GL.NAME, F.ARFEECODE), COALESCE(CTGP.DEBITACCOUNTNUMBER, F.ARFEECODE)

UNION ALL

--Escrow Account Deposits Credits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTA.AMOUNT)) AS GLAMOUNT
	, COALESCE(GL.NAME, GEAT.CHARGECODE) AS GLNAME
	, COALESCE(CTGP.CREDITACCOUNTNUMBER,GEAT.CHARGECODE) AS GLACCOUNT
	, 'CREDIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		INNER JOIN CATRANSACTIONACCOUNT CTA ON CT.CATRANSACTIONID = CTA.CATRANSACTIONID
		INNER JOIN GLOBALENTITYACCOUNT GEA ON CTA.ENTITYACCOUNTID = GEA.GLOBALENTITYACCOUNTID
		INNER JOIN GLOBALENTITYACCOUNTTYPE GEAT ON GEA.GLOBALENTITYACCOUNTTYPEID = GEAT.GLOBALENTITYACCOUNTTYPEID
		LEFT JOIN CATRANSACTIONACCOUNTPOSTING TAP ON CTA.CATRANSACTIONACCOUNTID = TAP.CATRANSACTIONACCOUNTID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON TAP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.CREDITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.CREDITACCOUNTNUMBER IS NOT NULL AND CTGP.CREDITACCOUNTNUMBER <> '')
		AND COALESCE(CTGP.POSTINGDATE, TP.PAYMENTDATE) BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] IN ('Fee Payment','Account Deposit','Bond Payment')

GROUP BY COALESCE(GL.NAME, GEAT.CHARGECODE), COALESCE(CTGP.CREDITACCOUNTNUMBER,GEAT.CHARGECODE)

UNION ALL

--Escrow Account Deposits Debits

SELECT	SUM(COALESCE(CTGP.POSTINGAMOUNT,CTA.AMOUNT)) AS GLAMOUNT
	, COALESCE(GL.NAME, GEAT.CHARGECODE) AS GLNAME
	, COALESCE(CTGP.DEBITACCOUNTNUMBER,GEAT.CHARGECODE) AS GLACCOUNT
	, 'DEBIT' AS GLTYPE

FROM	CATRANSACTION CT
		INNER JOIN CATRANSACTIONTYPE TT ON CT.CATRANSACTIONTYPEID = TT.CATRANSACTIONTYPEID
		INNER JOIN CATRANSACTIONPAYMENT TP ON CT.CATRANSACTIONID = TP.CATRANSACTIONID
		INNER JOIN CATRANSACTIONACCOUNT CTA ON CT.CATRANSACTIONID = CTA.CATRANSACTIONID
		INNER JOIN GLOBALENTITYACCOUNT GEA ON CTA.ENTITYACCOUNTID = GEA.GLOBALENTITYACCOUNTID
		INNER JOIN GLOBALENTITYACCOUNTTYPE GEAT ON GEA.GLOBALENTITYACCOUNTTYPEID = GEAT.GLOBALENTITYACCOUNTTYPEID
		LEFT JOIN CATRANSACTIONACCOUNTPOSTING TAP ON CTA.CATRANSACTIONACCOUNTID = TAP.CATRANSACTIONACCOUNTID
		LEFT JOIN CATRANSACTIONGLPOSTING CTGP ON TAP.CATRANSACTIONGLPOSTINGID = CTGP.CATRANSACTIONGLPOSTINGID
		LEFT JOIN GLACCOUNT GL ON CTGP.DEBITACCOUNTID = GL.GLACCOUNTID

WHERE	CT.CATRANSACTIONTYPEID <> 6			-- Void Reversal
		AND CT.CATRANSACTIONSTATUSID <> 2	-- Void Transaction
		--AND (CTGP.DEBITACCOUNTNUMBER IS NOT NULL AND CTGP.DEBITACCOUNTNUMBER <> '')
		AND CTGP.POSTINGDATE BETWEEN @STARTDATE AND @ENDDATE
		AND TT.[NAME] NOT IN ('Fee Payment','Account Deposit','Bond Payment')

GROUP BY COALESCE(GL.NAME, GEAT.CHARGECODE), COALESCE(CTGP.DEBITACCOUNTNUMBER,GEAT.CHARGECODE)

END

