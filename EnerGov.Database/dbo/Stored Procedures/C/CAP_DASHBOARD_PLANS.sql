
CREATE PROCEDURE [dbo].[CAP_DASHBOARD_PLANS]
(
	@GLOBAL_ENTITY_ID CHAR(36),
	@APPLY_DATE_CUTOFF DATETIME,
	@USE_WORK_CLASS BIT
)
AS
BEGIN
	SELECT 
    PLPLANTYPE.PLPLANTYPEID TypeId,
    PLPLANTYPE.PLANNAME TypeName,
    PLPLANTYPE.PLANNAME TypeDescription,
    PLPLANWORKCLASS.PLPLANWORKCLASSID WorkClassId,
	PLPLANWORKCLASS.NAME WorkClassName,
    SUM(CASE WHEN PLPLANSTATUS.FAILUREFLAG = 1 OR PLPLANSTATUS.HOLDFLAG = 1 OR dbo.PLAN_HAS_UNPAID_FEES(PLPLAN.PLPLANID) = 1 OR dbo.PLAN_HAS_FAILED_INSPECTIONS(PLPLAN.PLPLANID) = 1 THEN 1 ELSE 0	END) Attention,      
    SUM(CASE WHEN PLPLANSTATUS.SUCCESSFLAG <> 1 AND PLPLANSTATUS.HOLDFLAG <> 1 AND PLPLANSTATUS.FAILUREFLAG <> 1 THEN 1 ELSE 0 END)  Pending,	
    SUM(CASE WHEN PLPLANSTATUS.SUCCESSFLAG = 1 THEN 1 ELSE 0 END)  Approved,  
    SUM(CASE WHEN PLPLANSTATUS.FAILUREFLAG = 1 THEN 1 ELSE 0 END)  Denied,
    SUM(CASE WHEN PLPLAN.APPLICATIONDATE >= @APPLY_DATE_CUTOFF THEN 1 ELSE 0 END) Recent	
  
  FROM PLPLAN
	INNER JOIN PLPLANTYPE ON PLPLANTYPE.PLPLANTYPEID = PLPLAN.PLPLANTYPEID
	INNER JOIN PLPLANSTATUS ON PLPLANSTATUS.PLPLANSTATUSID = PLPLAN.PLPLANSTATUSID
	INNER JOIN PLPLANWORKCLASS ON PLPLANWORKCLASS.PLPLANWORKCLASSID = PLPLAN.PLPLANWORKCLASSID
	WHERE 
		EXISTS(SELECT * FROM PLPLANCONTACT WHERE PLPLANCONTACT.GLOBALENTITYID = @GLOBAL_ENTITY_ID and PLPLANCONTACT.PLPLANID = PLPLAN.PLPLANID)
	GROUP BY 
		PLPLANTYPE.PLPLANTYPEID,
		PLPLANTYPE.PLANNAME,
		PLPLANWORKCLASS.PLPLANWORKCLASSID,
		PLPLANWORKCLASS.NAME
	ORDER BY 
		PLPLANTYPE.PLPLANTYPEID,
		PLPLANTYPE.PLANNAME,
		PLPLANWORKCLASS.PLPLANWORKCLASSID,
		PLPLANWORKCLASS.NAME;

END
