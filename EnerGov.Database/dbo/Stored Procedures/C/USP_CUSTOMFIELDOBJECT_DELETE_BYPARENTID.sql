CREATE PROCEDURE [dbo].[USP_CUSTOMFIELDOBJECT_DELETE_BYPARENTID]
(
	@PARENTID CHAR(36)
)
AS

DECLARE @DELETED_CUSTOM_FIELDS AS RecordIDs

INSERT INTO @DELETED_CUSTOM_FIELDS
SELECT [dbo].[CUSTOMFIELDOBJECT].[GCUSTOMFIELD] 
FROM [dbo].[CUSTOMFIELDOBJECT] WITH (NOLOCK) -- NO LOCK TO AVOID POTENTIAL DEADLOCKS
WHERE
	[FKGCUSTOMFIELDLAYOUT] = @PARENTID

EXEC [dbo].[USP_CUSTOMFIELDPICKLISTITEM_DELETE_BYPARENTID] @DELETED_CUSTOM_FIELDS
EXEC [dbo].[USP_CUSTOMFIELDPICKLIST_DELETE_BYPARENTID] @DELETED_CUSTOM_FIELDS
EXEC [dbo].[USP_CUSTOMFIELDWORKSHEETITEM_DELETE_BYPARENTID] @DELETED_CUSTOM_FIELDS
EXEC [dbo].[USP_CUSTOMFIELDWORKSHEET_DELETE_BYPARENTID] @DELETED_CUSTOM_FIELDS

-- HANDLE THE FACT THAT THE LOGICALLY THE SAME DATA IS SPLIT BETWEEN TWO TABLES
-- DELETE FROM CHILD TABLE FIRST
DELETE FROM [dbo].[CUSTOMFIELDOBJECT]
WHERE
	[FKGCUSTOMFIELDLAYOUT] = @PARENTID

-- DELETE FROM PARENT TABLE
DELETE FROM [dbo].[CUSTOMFIELD]
WHERE
	[GCUSTOMFIELD] IN (SELECT RECORDID FROM @DELETED_CUSTOM_FIELDS)