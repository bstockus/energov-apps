
CREATE PROCEDURE [dbo].[CAP_DASHBOARD_INVOICES]
(
	@GLOBAL_ENTITY_ID CHAR(36),
	@TODAY_DATE DATETIME
)
AS
BEGIN
	SELECT 
		COUNT(CAINVOICE.CAINVOICEID) TotalInvoices,
		CASE 
			WHEN (CAINVOICE.CASTATUSID IN (1,3,6) AND CAINVOICE.INVOICEDUEDATE < @TODAY_DATE) OR CAINVOICE.CASTATUSID in (2,7,8) THEN 1 
			ELSE 0 
		END IsPastDue,
		SUM([dbo].[INVOICE_DUE_AMOUNT](CAINVOICE.CAINVOICEID, CAINVOICE.CASTATUSID, CAINVOICE.INVOICETOTAL)) AS TotalDue
	FROM CAINVOICE 
	INNER JOIN CAINVOICECONTACT ON CAINVOICECONTACT.CAINVOICEID = CAINVOICE.CAINVOICEID
	WHERE CAINVOICECONTACT.GLOBALENTITYID = @GLOBAL_ENTITY_ID  AND CAINVOICE.CASTATUSID NOT IN (4,5,9,10) AND [dbo].[INVOICE_DUE_AMOUNT](CAINVOICE.CAINVOICEID, CAINVOICE.CASTATUSID, CAINVOICE.INVOICETOTAL) > 0 
	GROUP BY 
		CASE 
			WHEN (CAINVOICE.CASTATUSID in (1,3,6) AND CAINVOICE.INVOICEDUEDATE < @TODAY_DATE) OR CAINVOICE.CASTATUSID in (2,7,8) THEN 1 
			ELSE 0 
		END
END
