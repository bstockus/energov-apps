


CREATE PROCEDURE [dbo].[rpt_CA_SR_Daily_Transaction_Listing_Sum]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME,
@FILTER AS VARCHAR(150) = 'USER',
@FILTERID AS VARCHAR(36),
@VOIDS AS VARCHAR(3)
AS
BEGIN
SET @STARTDATE = DATEADD(dd, DATEDIFF(dd, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))
SELECT CASE WHEN @FILTER = 'USER' THEN TB.SUSERGUID ELSE TB.EXTERNALBATCHNBR END AS GROUPING_VALUE
	, COALESCE(LTRIM(RTRIM(TB.FNAME))+' '+LTRIM(RTRIM(TB.LNAME)),'') AS UserName
	, UPPER(TB.PaymentMethod) AS PaymentMethod
	, SUM(ISNULL(TB.PAIDAMOUNT,0)) AS PAIDAMOUNT
FROM (
	SELECT	COALESCE(USERS.SUSERGUID, 'NONE') SUSERGUID
			, COALESCE(USERS.FNAME, 'NO') FNAME, COALESCE(USERS.LNAME,'USER') LNAME
			, CAPAYMENTMETHOD.NAME AS PaymentMethod
			, (CATRANSACTIONFEE.PAIDAMOUNT - 2*CATRANSACTIONFEE.REFUNDAMOUNT) AS PAIDAMOUNT
			, COALESCE(NULLIF(LTRIM(CATRANSACTION.EXTERNALBATCHNBR), ''), 'NONE SPECIFIED') AS EXTERNALBATCHNBR
	FROM CACOMPUTEDFEE
	INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID 
	INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID 
	INNER JOIN CATRANSACTIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CATRANSACTIONFEE.CACOMPUTEDFEEID 
	INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
	INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
	INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
	LEFT JOIN USERS ON CATRANSACTION.CREATEDBY = USERS.SUSERGUID AND @FILTER = 'USER'
	INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
	INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
	WHERE (CATRANSACTION.TRANSACTIONDATE BETWEEN @STARTDATE AND @ENDDATE)
		AND CASE WHEN @VOIDS = 'YES' 
				THEN 1
				ELSE CASE WHEN (CATRANSACTIONTYPE.NAME = 'Void Reversal') OR (CATRANSACTIONSTATUS.NAME = 'Void')
					THEN 0
					ELSE 1
					END
				END = 1
	--AND   (CAInvoice.CAStatusID <> 5)
	AND   (1 = (CASE @FILTER
			WHEN 'BATCH' 
				THEN (CASE WHEN COALESCE(NULLIF(LTRIM(CATRANSACTION.EXTERNALBATCHNBR), ''), 'NONE SPECIFIED') = @FILTERID THEN 1 ELSE 0 END)
			WHEN 'USER'
				THEN (CASE WHEN USERS.SUSERGUID = @FILTERID THEN 1 ELSE 0 END)
			ELSE
				(CASE WHEN USERS.SUSERGUID = @FILTERID THEN 1 ELSE 0 END)
			END))

	UNION ALL

	SELECT	COALESCE(USERS.SUSERGUID, 'NONE') SUSERGUID
			, COALESCE(USERS.FNAME, 'NO') FNAME, COALESCE(USERS.LNAME,'USER') LNAME
			, CAPAYMENTMETHOD.NAME AS PaymentMethod
			, (CATRANSACTIONMISCFEE.PAIDAMOUNT - 2*CATRANSACTIONMISCFEE.REFUNDAMOUNT) AS PAIDAMOUNT
			, COALESCE(NULLIF(LTRIM(CATRANSACTION.EXTERNALBATCHNBR), ''), 'NONE SPECIFIED') AS EXTERNALBATCHNBR
	FROM CAMISCFEE 
	INNER JOIN CAINVOICEMISCFEE ON CAMISCFEE.CAMISCFEEID = CAINVOICEMISCFEE.CAMISCFEEID 
	INNER JOIN CAINVOICE ON CAINVOICEMISCFEE.CAINVOICEID = CAINVOICE.CAINVOICEID 
	INNER JOIN CATRANSACTIONMISCFEE ON CAMISCFEE.CAMISCFEEID = CATRANSACTIONMISCFEE.CAMISCFEEID 
	INNER JOIN CATRANSACTION ON CATRANSACTIONMISCFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
	INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
	INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
	LEFT JOIN USERS ON CATRANSACTION.CREATEDBY = USERS.SUSERGUID
		AND @FILTER = 'USER'
	INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
	INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
	WHERE (CATRANSACTION.TRANSACTIONDATE BETWEEN @STARTDATE AND @ENDDATE)
		AND CASE WHEN @VOIDS = 'YES' 
				THEN 1
				ELSE CASE WHEN (CATRANSACTIONTYPE.NAME = 'Void Reversal') OR (CATRANSACTIONSTATUS.NAME = 'Void')
					THEN 0
					ELSE 1
					END
				END = 1
	--AND   (CAInvoice.CAStatusID <> 5)
	AND   (1 = (CASE @FILTER
			WHEN 'BATCH' 
				THEN (CASE WHEN COALESCE(NULLIF(LTRIM(CATRANSACTION.EXTERNALBATCHNBR), ''), 'NONE SPECIFIED') = @FILTERID THEN 1 ELSE 0 END)
			WHEN 'USER'
				THEN (CASE WHEN USERS.SUSERGUID = @FILTERID THEN 1 ELSE 0 END)
			ELSE
				(CASE WHEN USERS.SUSERGUID = @FILTERID THEN 1 ELSE 0 END)
			END))
) AS TB
GROUP BY CASE WHEN @FILTER = 'USER' THEN TB.SUSERGUID ELSE TB.EXTERNALBATCHNBR END
	, COALESCE(LTRIM(RTRIM(TB.FNAME))+' '+LTRIM(RTRIM(TB.LNAME)),'')
	, TB.PaymentMethod

END
