

CREATE PROCEDURE [dbo].[rpt_CR_SR_Citizen_Request_Detailed_Report]
@REQUESTID AS VARCHAR(36)
AS
-- select * from citizenrequest cr where cr.requestnumber='acc-000005-2016'
-- exec rpt_CR_SR_Citizen_Request_Detailed_Report '7fb3de92-f94c-439c-8a11-6df3e72173e1'
SELECT CR.CITIZENREQUESTID, CR.REQUESTNUMBER AS RequestNumber, CR.EMERGENCY AS Emergency, CR.DESCRIPTION AS Description,
       CR.DATEFILED AS DateEntered, CR.COMPCOMPLETE AS CompleteDate, CR.COMPDEADLINE AS DeadlineDate,
       CRTYPE.NAME AS RequestType, CRSTATUS.STATUS AS Status, CRSOURCE.NAME AS Source, CRPRIORITY.NAME AS Priority,
       USERS.LNAME + ', ' + USERS.FNAME AS AssignedTo, DISTRICT.NAME AS District, PR.NAME AS PROJECTNAME,
	   (SELECT R.[IMAGE] FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') LOGO,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM CITIZENREQUEST AS CR
INNER JOIN CITIZENREQUESTTYPE AS CRTYPE ON CR.CITIZENREQUESTTYPEID = CRTYPE.CITIZENREQUESTTYPEID
INNER JOIN CITIZENREQUESTSTATUS AS CRSTATUS ON CR.CITIZENREQUESTSTATUSID = CRSTATUS.CITIZENREQUESTSTATUSID
INNER JOIN CITIZENREQUESTSOURCE AS CRSOURCE ON CR.CITIZENREQUESTSOURCEID = CRSOURCE.CITIZENREQUESTSOURCEID
LEFT OUTER JOIN DISTRICT ON CR.DISTRICTID = DISTRICT.DISTRICTID
LEFT OUTER JOIN CITIZENREQUESTPRIORITY AS CRPRIORITY ON CR.CITIZENREQUESTPRIORITYID = CRPRIORITY.CITIZENREQUESTPRIORITYID
LEFT OUTER JOIN USERS ON CR.ASSIGNEDTOUSER = USERS.SUSERGUID
LEFT OUTER JOIN PRPROJECTCITIZENREQUEST AS PRCR ON CR.CITIZENREQUESTID = PRCR.CITIZENREQUESTID
LEFT OUTER JOIN PRPROJECT AS PR ON PRCR.PRPROJECTID = PR.PRPROJECTID
WHERE CR.CITIZENREQUESTID = @REQUESTID

