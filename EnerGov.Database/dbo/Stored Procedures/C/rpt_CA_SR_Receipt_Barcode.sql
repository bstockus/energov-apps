
CREATE PROCEDURE rpt_CA_SR_Receipt_Barcode
@CATRANSACTIONID AS VARCHAR(36)
AS

BEGIN

SELECT	CATransaction.CATransactionID, CATransaction.ReceiptNumber
		,CAComputedFee.CAComputedFeeID, CAComputedFee.FeeName
		,CATransactionFee.PaidAmount, CATRANSACTIONFEE.REFUNDAMOUNT
		,CATransactionType.Name AS TransactionType
		,CATRANSACTIONSTATUS.NAME AS TRANSACTIONSTATUS
		,CATransaction.GlobalEntityID
		,COALESCE(BLLICENSE.LICENSENUMBER, CMCODECASE.CASENUMBER, CODEVIO.CASENUMBER, ILLICENSE.LICENSENUMBER, PLAPPLICATION.APPNUMBER, PLPLAN.PLANNUMBER
					, PMPERMIT.PERMITNUMBER, PRPROJECT.PROJECTNUMBER, RPLANDLORDLICENSE.LANDLORDNUMBER, RPPROPERTY.PROPERTYNUMBER
					, TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER, IPCASE.CASENUMBER, IMINSPECTION.INSPECTIONNUMBER)AS CaseNumber
		,COALESCE(BLLICENSE.BLLICENSEID, CMCODECASE.CMCODECASEID, CODEVIO.CMCODECASEID, ILLICENSE.ILLICENSEID, PLAPPLICATION.PLAPPLICATIONID
				, PLPLAN.PLPLANID, PMPERMIT.PMPERMITID, PRPROJECT.PRPROJECTID, RPLANDLORDLICENSE.RPLANDLORDLICENSEID
				, RPPROPERTY.RPPROPERTYID, TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID, IPCASE.IPCASEID
				, IMINSPECTION.IMINSPECTIONID) AS CaseID
		,CATransactionPayment.PaymentDate
		,CAPaymentMethod.Name AS PaymentMethod
		,CATransactionPayment.SupplementalData
		,COALESCE((SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo')
		,(SELECT TOP 1 IMAGEVALUE FROM SETTINGS WHERE NAME = 'LogoImage')) LOGO
		,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM CACOMPUTEDFEE 
INNER JOIN CATRANSACTIONFEE ON CATRANSACTIONFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTIONTYPE.CATRANSACTIONTYPEID = CATRANSACTION.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID  
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID 
LEFT OUTER JOIN BLLICENSEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN BLLICENSE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID 
LEFT OUTER JOIN CMCODECASEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN CMCODECASE ON CMCODECASEFEE.CMCODECASEID = CMCODECASE.CMCODECASEID 
LEFT OUTER JOIN CMVIOLATIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CMVIOLATIONFEE.CACOMPUTEDFEEID
LEFT OUTER JOIN CMVIOLATION ON CMVIOLATIONFEE.CMVIOLATIONID = CMVIOLATION.CMVIOLATIONID
LEFT OUTER JOIN CMCODEWFSTEP ON CMVIOLATION.CMCODEWFSTEPID = CMCODEWFSTEP.CMCODEWFSTEPID
LEFT OUTER JOIN CMCODECASE CODEVIO ON CMCODEWFSTEP.CMCODECASEID = CODEVIO.CMCODECASEID 
LEFT OUTER JOIN ILLICENSEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN ILLICENSE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID 
LEFT OUTER JOIN PLAPPLICATIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PLAPPLICATIONFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PLAPPLICATION ON PLAPPLICATIONFEE.PLAPPLICATIONID = PLAPPLICATION.PLAPPLICATIONID 
LEFT OUTER JOIN PLPLANFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PLPLAN ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID 
LEFT OUTER JOIN PMPERMITFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PMPERMIT ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID 
LEFT OUTER JOIN PRPROJECTFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = PRPROJECTFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN PRPROJECT ON PRPROJECTFEE.PRPROJECTID = PRPROJECT.PRPROJECTID 
LEFT OUTER JOIN RPLANDLORDLICENSEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = RPLANDLORDLICENSEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN RPLANDLORDLICENSE ON RPLANDLORDLICENSEFEE.RPLANDLORDLICENSEID = RPLANDLORDLICENSE.RPLANDLORDLICENSEID 
LEFT OUTER JOIN RPPROPERTYFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = RPPROPERTYFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN RPPROPERTY ON RPPROPERTYFEE.RPPROPERTYID = RPPROPERTY.RPPROPERTYID 
LEFT OUTER JOIN TXREMITTANCEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = TXREMITTANCEFEE.CACOMPUTEDFEEID 
LEFT OUTER JOIN TXREMITTANCE ON TXREMITTANCEFEE.TXREMITTANCEID = TXREMITTANCE.TXREMITTANCEID 
LEFT OUTER JOIN TXREMITTANCEACCOUNT ON TXREMITTANCE.TXREMITTANCEACCOUNTID = TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID
LEFT OUTER JOIN IPCONDITIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = IPCONDITIONFEE.CACOMPUTEDFEEID
LEFT OUTER JOIN IPCONDITION ON IPCONDITIONFEE.IPCONDITIONID = IPCONDITION.IPCONDITIONID
LEFT OUTER JOIN IPCASE ON IPCONDITION.IPCASEID = IPCASE.IPCASEID
LEFT OUTER JOIN IMINSPECTIONFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
LEFT OUTER JOIN IMINSPECTION ON IMINSPECTION.IMINSPECTIONID = IMINSPECTIONFEE.IMINSPECTIONID
WHERE CATransaction.CATransactionID = @CATRANSACTIONID
--AND   (NOT (CATRANSACTIONSTATUS.NAME IN ('Void'))) 
--AND   (NOT (CATRANSACTIONTYPE.NAME IN ('Void Reversal'))) 

UNION ALL

SELECT	CATransaction.CATransactionID, CATransaction.ReceiptNumber
		,CAMiscFee.CAMISCFEEID AS CAComputedFeeID, CAMiscFee.FeeName
		,CATransactionMiscFee.PaidAmount, CATransactionMiscFee.REFUNDAMOUNT
		,CATransactionType.Name AS TransactionType
		,CATRANSACTIONSTATUS.NAME AS TRANSACTIONSTATUS
		,CATransaction.GlobalEntityID
		,'Cashier' AS CaseNumber
		,'Cashier' as CaseID
		,CATransactionPayment.PaymentDate
		,CAPaymentMethod.Name AS PaymentMethod
		,CATransactionPayment.SupplementalData
		,COALESCE((SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo')
		,(SELECT TOP 1 IMAGEVALUE FROM SETTINGS WHERE NAME = 'LogoImage')) LOGO
		,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM CAMISCFEE 
INNER JOIN CATRANSACTIONMISCFEE ON CATRANSACTIONMISCFEE.CAMISCFEEID = CAMISCFEE.CAMISCFEEID 
INNER JOIN CATRANSACTION ON CATRANSACTIONMISCFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID 
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTIONTYPE.CATRANSACTIONTYPEID = CATRANSACTION.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID  
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
WHERE CATransaction.CATransactionID = @CATRANSACTIONID
--AND   (NOT (CATRANSACTIONSTATUS.NAME IN ('Void'))) 
--AND   (NOT (CATRANSACTIONTYPE.NAME IN ('Void Reversal'))) 
                   
UNION ALL

SELECT	CATRANSACTION.CATRANSACTIONID, CATRANSACTION.RECEIPTNUMBER
		,CATRANSACTIONACCOUNT.CATRANSACTIONACCOUNTID
		,'ACCT#  '+GLOBALENTITYACCOUNT.ACCOUNTNUMBER AS FEENAME
		,CATRANSACTIONPAYMENT.PAYMENTAMOUNT
		,0 AS REFUNDAMOUNT
		,CATransactionType.Name AS TransactionType
		,CATRANSACTIONSTATUS.NAME AS TRANSACTIONSTATUS
		,CATransaction.GlobalEntityID
		,'Contacts Account' AS CaseNumber
		,'Contacts Account' AS CaseID
		,CATransactionPayment.PaymentDate
		,CAPaymentMethod.Name AS PaymentMethod
		,CATransactionPayment.SupplementalData
		,COALESCE((SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo')
		,(SELECT TOP 1 IMAGEVALUE FROM SETTINGS WHERE NAME = 'LogoImage')) LOGO
		,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM GLOBALENTITYACCOUNT 
INNER JOIN GLOBALENTITYACCOUNTTYPE ON GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTTYPEID = GLOBALENTITYACCOUNTTYPE.GLOBALENTITYACCOUNTTYPEID
INNER JOIN CATRANSACTIONACCOUNT ON GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTID = CATRANSACTIONACCOUNT.ENTITYACCOUNTID
INNER JOIN CATRANSACTION ON CATRANSACTIONACCOUNT.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTIONTYPE.CATRANSACTIONTYPEID = CATRANSACTION.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
WHERE CATRANSACTION.CATRANSACTIONID = @CATRANSACTIONID
--AND (NOT (CATRANSACTIONTYPE.NAME IN ('Void Reversal'))) AND (NOT (CATRANSACTIONSTATUS.NAME IN ('Void'))) 
AND NOT EXISTS ( SELECT 'X' FROM CATRANSACTIONFEE WHERE CATRANSACTION.CATRANSACTIONID = CATRANSACTIONFEE.CATRANSACTIONID )
AND NOT EXISTS ( SELECT 'X' FROM CATRANSACTIONMISCFEE WHERE CATRANSACTION.CATRANSACTIONID = CATRANSACTIONMISCFEE.CATRANSACTIONID )

UNION ALL

SELECT	CATRANSACTION.CATRANSACTIONID, CATRANSACTION.RECEIPTNUMBER
		,'BONDID' AS CAComputedFeeID, 'Bond# ' + BOND.BONDNUMBER AS FeeName
		,BOND.AMOUNT AS PaidAmount
		,0 AS REFUNDAMOUNT
		,'Bond Transaction' AS TransactionType
		,CATRANSACTIONSTATUS.NAME AS TRANSACTIONSTATUS
		,GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTID AS GlobalEntityID
		,'Cashier' AS CaseNumber
		,'Cashier' AS CaseID
		,CATRANSACTIONPAYMENT.PaymentDate
		,CAPAYMENTMETHOD.NAME AS PaymentMethod
		,CATransactionPayment.SupplementalData
		,COALESCE((SELECT R.[IMAGE] FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo')
		,(SELECT TOP 1 IMAGEVALUE FROM SETTINGS WHERE NAME = 'LogoImage')) LOGO
		,(SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		,(SELECT R.REPORTTEXT FROM RPTTEXTLIB R WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM BOND 
	INNER JOIN CATRANSACTIONBOND ON BOND.BONDID = CATRANSACTIONBOND.BONDID
	INNER JOIN CATRANSACTION ON CATRANSACTIONBOND.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
	INNER JOIN GLOBALENTITY GE ON CATRANSACTION.GLOBALENTITYID = GE.GLOBALENTITYID
	INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
		--AND (CATransactionType.CATransactionTypeID NOT IN (5, 6)) 
	INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID 
		--AND (CATransactionStatus.CATransactionStatusID NOT IN (2, 3))
	INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID 
	INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID 
	INNER JOIN GLOBALENTITYACCOUNT ON CATRANSACTIONBOND.GLOBALENTITYACCOUNTID = GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTID 
	INNER JOIN GLOBALENTITYACCOUNTTYPEGL ON GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTTYPEID = GLOBALENTITYACCOUNTTYPEGL.GLOBALENTITYACCOUNTTYPEID 
		AND GLOBALENTITYACCOUNTTYPEGL.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
	INNER JOIN GLACCOUNT ON GLOBALENTITYACCOUNTTYPEGL.CREDITGLACCOUNTID = GLACCOUNT.GLACCOUNTID
WHERE CATRANSACTION.CATRANSACTIONID = @CATRANSACTIONID
	AND NOT EXISTS ( SELECT 'X' FROM CATRANSACTIONACCOUNT WHERE CATRANSACTION.CATRANSACTIONID = CATRANSACTIONACCOUNT.CATRANSACTIONID ) -- ATC 1/26/18 - DOESN'T SHOW BOND DEPOSIT IF MADE FROM A CONTACT ESCROW ACCOUNT

END
