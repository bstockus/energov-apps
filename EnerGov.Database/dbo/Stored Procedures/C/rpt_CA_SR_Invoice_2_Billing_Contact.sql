
-- rpt_CA_SR_Invoice_Billing_Contact 'ba49fc17-6be3-4080-96b8-1698f0e3b4ad'
CREATE PROCEDURE [dbo].[rpt_CA_SR_Invoice_2_Billing_Contact]
@CAINVOICEID AS VARCHAR(36)
AS
BEGIN

SELECT INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME
INTO #BILLING_CONTACT
FROM CAINVOICE INV
INNER JOIN CAINVOICECONTACT INVC ON INV.CAINVOICEID = INVC.CAINVOICEID
INNER JOIN GLOBALENTITY GE ON INVC.GLOBALENTITYID = GE.GLOBALENTITYID
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN PLPLANFEE PF ON CF.CACOMPUTEDFEEID = PF.CACOMPUTEDFEEID
--INNER JOIN PLPLAN P ON PF.PLPLANID = P.PLPLANID
--INNER JOIN PLPLANCONTACT PC ON P.PLPLANID = PC.PLPLANID
--INNER JOIN GLOBALENTITY GE ON PC.GLOBALENTITYID = GE.GLOBALENTITYID
WHERE INV.CAINVOICEID = @CAINVOICEID --AND PC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN PMPERMITFEE PF ON CF.CACOMPUTEDFEEID = PF.CACOMPUTEDFEEID
--INNER JOIN PMPERMIT P ON PF.PMPERMITID = P.PMPERMITID
--INNER JOIN PMPERMITCONTACT PC ON P.PMPERMITID = PC.PMPERMITID
--INNER JOIN GLOBALENTITY GE ON PC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND PC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN BLLICENSEFEE BLF ON CF.CACOMPUTEDFEEID = BLF.CACOMPUTEDFEEID
--INNER JOIN BLLICENSE BL ON BLF.BLLICENSEID = BL.BLLICENSEID
--INNER JOIN BLLICENSECONTACT BLC ON BL.BLLICENSEID = BLC.BLLICENSEID
--INNER JOIN GLOBALENTITY GE ON BLC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND BLC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN CMCODECASEFEE CCF ON CF.CACOMPUTEDFEEID = CCF.CACOMPUTEDFEEID
--INNER JOIN CMCODECASE CC ON CCF.CMCODECASEID = CC.CMCODECASEID
--INNER JOIN CMCODECASECONTACT BLC ON CC.CMCODECASEID = BLC.CMCODECASEID
--INNER JOIN GLOBALENTITY GE ON BLC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND BLC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN ILLICENSEFEE ILF ON CF.CACOMPUTEDFEEID = ILF.CACOMPUTEDFEEID
--INNER JOIN ILLICENSE IL ON ILF.ILLICENSEID = IL.ILLICENSEID
--INNER JOIN ILLICENSECONTACT ILC ON IL.ILLICENSEID = ILC.ILLICENSEID
--INNER JOIN GLOBALENTITY GE ON ILC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND ILC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN IMINSPECTIONFEE IMF ON CF.CACOMPUTEDFEEID = IMF.CACOMPUTEDFEEID
--INNER JOIN IMINSPECTION I ON IMF.IMINSPECTIONID = I.IMINSPECTIONID
--INNER JOIN IMINSPECTIONCONTACT IC ON I.IMINSPECTIONID = IC.IMINSPECTIONID
--INNER JOIN GLOBALENTITY GE ON IC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND IC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN PRPROJECTFEE PRF ON CF.CACOMPUTEDFEEID = PRF.CACOMPUTEDFEEID
--INNER JOIN PRPROJECT PR ON PRF.PRPROJECTID = PR.PRPROJECTID
--INNER JOIN PRPROJECTCONTACT PRC ON PR.PRPROJECTID = PRC.PRPROJECTID
--INNER JOIN GLOBALENTITY GE ON PRC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND PRC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN IPCONDITIONFEE ICF ON CF.CACOMPUTEDFEEID = ICF.CACOMPUTEDFEEID
--INNER JOIN IPCASE I ON ICF.IPCONDITIONID = I.IPCASEID
--INNER JOIN IPCASECONTACT IC ON I.IPCASEID = IC.IPCASEID
--INNER JOIN GLOBALENTITY GE ON IC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND IC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN TXREMITTANCEFEE TRF ON CF.CACOMPUTEDFEEID = TRF.CACOMPUTEDFEEID
--INNER JOIN TXREMITTANCE TR ON TRF.TXREMITTANCEID = TR.TXREMITTANCEID
--INNER JOIN TXREMACCCONTACT TRC ON TR.TXREMITTANCEACCOUNTID = TRC.TXREMITTANCEACCOUNTID
--INNER JOIN GLOBALENTITY GE ON TRC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND TRC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN RPPROPERTYFEE RPF ON CF.CACOMPUTEDFEEID = RPF.CACOMPUTEDFEEID
--INNER JOIN RPPROPERTY RP ON RPF.RPPROPERTYID = RP.RPPROPERTYID
--INNER JOIN RPPROPERTYCONTACT RPC ON RP.RPPROPERTYID = RPC.RPPROPERTYID
--INNER JOIN GLOBALENTITY GE ON RPC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND RPC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN RPLANDLORDLICENSEFEE LLF ON CF.CACOMPUTEDFEEID = LLF.CACOMPUTEDFEEID
--INNER JOIN RPLANDLORDLICENSE LL ON LLF.RPLANDLORDLICENSEID = LL.RPLANDLORDLICENSEID
--INNER JOIN RPLANDLORDLICENSECONTACT LLC ON LL.RPLANDLORDLICENSEID = LLC.RPLANDLORDLICENSEID
--INNER JOIN GLOBALENTITY GE ON LLC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND LLC.ISBILLING = 1

--UNION ALL

--SELECT /*DISTINCT*/ INV.CAINVOICEID, GE.GLOBALENTITYID, GE.GLOBALENTITYNAME, GE.FIRSTNAME + ' ' + GE.LASTNAME AS GLOBALENTITYFLNAME

--FROM CAINVOICE INV
--INNER JOIN CAINVOICEFEE INVF ON INV.CAINVOICEID = INVF.CAINVOICEID
--INNER JOIN CACOMPUTEDFEE CF ON INVF.CACOMPUTEDFEEID = CF.CACOMPUTEDFEEID
--INNER JOIN PLAPPLICATIONFEE PAF ON CF.CACOMPUTEDFEEID = PAF.CACOMPUTEDFEEID
--INNER JOIN PLAPPLICATION PA ON PAF.PLAPPLICATIONID = PA.PLAPPLICATIONID
--INNER JOIN PLAPPLICATIONCONTACT PAC ON PA.PLAPPLICATIONID = PAC.PLAPPLICATIONID
--INNER JOIN GLOBALENTITY GE ON PAC.GLOBALENTITYID = GE.GLOBALENTITYID
--WHERE INV.CAINVOICEID = @CAINVOICEID AND PAC.ISBILLING = 1
;

CREATE INDEX TEMP1 ON #BILLING_CONTACT(GLOBALENTITYID);

SELECT * FROM (
SELECT BC.CAINVOICEID, BC.GLOBALENTITYID, BC.GLOBALENTITYNAME, BC.GLOBALENTITYFLNAME
     , RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	   LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) GE_ADDRESS_LINE1
	 , RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + MA.POSTALCODE) GE_ADDRESS_LINE2
	 , ROW_NUMBER() OVER (PARTITION BY BC.CAINVOICEID, BC.GLOBALENTITYID ORDER BY CASE WHEN MA.ADDRESSTYPE = 'MAILING' THEN 1 ELSE 2 END) RowNBR

FROM #BILLING_CONTACT BC
LEFT JOIN GLOBALENTITYMAILINGADDRESS GEMA ON BC.GLOBALENTITYID = GEMA.GLOBALENTITYID
LEFT JOIN MAILINGADDRESS MA ON GEMA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE BC.CAINVOICEID = @CAINVOICEID) X WHERE X.RowNBR = 1


END
