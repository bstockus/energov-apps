
CREATE PROCEDURE rpt_CM_SR_Case_Images
@CMCODECASEID AS VARCHAR(36)
AS


--DECLARE @CMCODECASEID VARCHAR(36) = '544782A6-F7D8-407F-A29E-7342C4152560'  -- '0186e358-3120-490c-8d18-965274f3e188'  --
;

/******GET ATTACHMENT IMAGES*******/
SELECT IDENTITY(INT) TABLEID,
	ATT.PARENTID,
	ATT.ATTACHMENTID,
	ATT.FILEPATH ATTACH_PATH,
	ATT.FILENAME ATTACH_NAME,
	('<A HREF="' + (SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%APPLICATIONURL%') + CASE WHEN RIGHT((SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%APPLICATIONURL%'),1) = '/' THEN '' ELSE '/' END + ATT.FILEPATH + ATT.ATTACHMENTID + RIGHT(ATT.FILENAME,4) +'" TARGET="_BLANK"> Added on: '+ CONVERT(CHAR(10),  ATT.ADDEDON, 110) + ' (Direct Link)</A>') AS ATTACH_LINK_HTML
INTO #TEMP_TB
FROM  ATTACHMENT ATT 
WHERE RIGHT(ATT.FILENAME,4) IN ('.PNG', '.JPG', '.GIF')
	/*****************************************************
	UPDATE THE BELOW LINE TO ONLY INCLUDE THE IDS YOU NEED 
	*****************************************************/
	AND ATT.PARENTID IN (SELECT DISTINCT IM.IMINSPECTIONID
							FROM IMINSPECTION IM
							WHERE IM.LINKID  = @CMCODECASEID
							UNION ALL
							SELECT @CMCODECASEID) 
	 


DECLARE @FILEPATH VARCHAR(200),
		@ATTACHPATH NVARCHAR(MAX),
		@ATTACHID CHAR(36),
		@ATTACHNAME NVARCHAR(260),
		@COUNT INT,
		@BLOB_SELECT VARCHAR(MAX);
CREATE TABLE #PHOTOS
   (PHOTOID INT IDENTITY(1,1) NOT NULL,
    PHOTO VARBINARY(MAX) NULL,
	ATTACHMENTID CHAR(36) NULL
	)

DECLARE CUR CURSOR FOR

SELECT (SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%ATTACHMENTSFOLDERPHYSICALPATH%') -- DYNAMIC SELECTION OF FILEPATH FROM SETTINGS
		+ CASE WHEN RIGHT((SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%ATTACHMENTSFOLDERPHYSICALPATH%'),1) = '\' THEN '' ELSE '\' END
		+ LEFT(RIGHT(ATTACH_PATH, 11),10)+'\' 
		+ ATTACHMENTID 
		+ RIGHT(ATTACH_NAME,4),
		ATTACHMENTID 
		
FROM #TEMP_TB  ORDER BY TABLEID

OPEN CUR

FETCH NEXT FROM CUR
INTO @FILEPATH, @ATTACHID
SET @COUNT = 1
WHILE @@FETCH_STATUS = 0

	BEGIN

SET @BLOB_SELECT = 'SELECT * FROM OPENROWSET (BULK '''+ @FILEPATH + ''', SINGLE_BLOB) A'

BEGIN TRY
	INSERT #PHOTOS (PHOTO)
	EXEC  (@BLOB_SELECT)
	UPDATE #PHOTOS
	SET ATTACHMENTID = @ATTACHID
	WHERE PHOTOID = @COUNT
	PRINT @FILEPATH
	PRINT @ATTACHID
	SET @COUNT = @COUNT + 1
END TRY


BEGIN CATCH
	INSERT #PHOTOS (PHOTO, ATTACHMENTID)
	VALUES (NULL, NULL)
	SET @COUNT = @COUNT + 1
END CATCH

	FETCH NEXT FROM CUR
	INTO @FILEPATH, @ATTACHID

	END
CLOSE CUR
DEALLOCATE CUR	

CREATE INDEX TEMP1 ON #PHOTOS (ATTACHMENTID);
CREATE INDEX TEMP1 ON #TEMP_TB (ATTACHMENTID);
CREATE INDEX TEMP2 ON #TEMP_TB (PARENTID);

SELECT T.PARENTID,
	T.ATTACHMENTID,
	T.ATTACH_PATH,
	T.ATTACH_NAME,
	T.ATTACH_LINK_HTML,
	P.PHOTO
INTO #PHOTO_ATTACHMENTS
FROM #TEMP_TB T 
INNER JOIN #PHOTOS P ON P.ATTACHMENTID = T.ATTACHMENTID

DROP TABLE #TEMP_TB
DROP TABLE #PHOTOS

/********ATTACHMENT TABLE END******/

;
WITH ADDRESS_CTE AS

(SELECT CCA.MAIN, CCA.CMCODECASEID, MA.ADDRESSTYPE, RTRIM(MA.ADDRESSLINE1 + ' ' +	LTRIM(MA.PREDIRECTION + ' ') + LTRIM(MA.ADDRESSLINE2 + ' ') + 
	LTRIM(MA.STREETTYPE + ' ') + LTRIM(MA.POSTDIRECTION + ' ') + LTRIM(MA.UNITORSUITE + ' ')  + LTRIM(MA.ADDRESSLINE3)) ADDRESS_LINE1,
	RTRIM(CASE WHEN RTRIM(LTRIM(MA.CITY)) = '' THEN '' ELSE LTRIM(MA.CITY + ', ' ) END + LTRIM(MA.STATE + ' ') + MA.POSTALCODE) ADDRESS_LINE2
FROM CMCODECASEADDRESS CCA
INNER JOIN MAILINGADDRESS MA ON CCA.MAILINGADDRESSID = MA.MAILINGADDRESSID
WHERE CCA.CMCODECASEID = @CMCODECASEID AND CCA.MAIN = 1)


 SELECT CM.CMCODECASEID CASEID,
	CM.CASENUMBER,
	CM.[DESCRIPTION],
	CM.OPENEDDATE,
	CM.CLOSEDDATE,
	'Code Case' AS MODULE,
	CMS.NAME CASESTATUS,
	CMT.NAME CASETYPE,
	MA.ADDRESS_LINE1,
	MA.ADDRESS_LINE2,
	U.FNAME + ' ' + U.LNAME ASSIGNEDTO,
	A.ATTACHMENTID,
	A.ADDEDON,
	A.NOTES ATTACHMENT_NOTES,
	(SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%ApplicationURL%') + CASE WHEN RIGHT((SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%APPLICATIONURL%'),1) = '/' THEN '' ELSE '/' END + A.FILEPATH + A.ATTACHMENTID + RIGHT(A.FILENAME,4) AS ATTACHMENT_URL,
	PA.ATTACH_LINK_HTML AS ATTACHMENT_HTML,
	CM.CASENUMBER MAINCASENUMBER,
	PA.PHOTO
	
 FROM CMCODECASE CM
 LEFT JOIN ATTACHMENT A ON CM.CMCODECASEID = A.PARENTID AND  RIGHT(A.FILENAME,4) IN ('.jpg', '.png', '.bmp')-- AND a.NOTES <>'EnerGov 8.5 Conversion'
 INNER JOIN CMCODECASESTATUS CMS ON CMS.CMCODECASESTATUSID = CM.CMCODECASESTATUSID
 INNER JOIN CMCASETYPE CMT ON CMT.CMCASETYPEID = CM.CMCASETYPEID
 LEFT JOIN ADDRESS_CTE MA ON MA.CMCODECASEID = CM.CMCODECASEID
 LEFT JOIN USERS U ON CM.ASSIGNEDTO = U.SUSERGUID
 LEFT JOIN #PHOTO_ATTACHMENTS PA ON PA.PARENTID = CM.CMCODECASEID AND A.ATTACHMENTID = PA.ATTACHMENTID AND PA.PHOTO IS NOT NULL
 WHERE CM.CMCODECASEID = @CMCODECASEID


 UNION ALL

SELECT IM.IMINSPECTIONID,
	IM.INSPECTIONNUMBER,
	IM.COMMENTS,
	IM.SCHEDULEDSTARTDATE,
	IM.ACTUALSTARTDATE,
	'Inspection(s)' AS MODULE,
	IMS.STATUSNAME,
	IMT.NAME CASETYPE,
	MA.ADDRESS_LINE1,
	MA.ADDRESS_LINE2,
	U.FNAME + ' ' + U.LNAME,
	A.ATTACHMENTID ,
	A.ADDEDON,
	A.NOTES ATTACHMENT_NOTES,
	(SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%ApplicationURL%') + CASE WHEN RIGHT((SELECT STRINGVALUE FROM SETTINGS WHERE NAME LIKE '%APPLICATIONURL%'),1) = '/' THEN '' ELSE '/' END + A.FILEPATH + A.ATTACHMENTID + RIGHT(A.FILENAME,4) AS ATTACHMENT_URL,
	PA.ATTACH_LINK_HTML AS ATTACHMENT_HTML,
	CM.CASENUMBER MAINCASENUMBER,
	PA.PHOTO
FROM IMINSPECTION IM
LEFT JOIN ATTACHMENT A ON IM.IMINSPECTIONID = A.PARENTID AND  RIGHT(A.FILENAME,4) IN ('.jpg', '.png', '.bmp') --AND a.NOTES <>'EnerGov 8.5 Conversion'
INNER JOIN IMINSPECTIONSTATUS IMS ON IMS.IMINSPECTIONSTATUSID = IM.IMINSPECTIONSTATUSID
INNER JOIN IMINSPECTIONTYPE IMT ON IMT.IMINSPECTIONTYPEID = IM.IMINSPECTIONTYPEID
LEFT JOIN ADDRESS_CTE MA ON IM.LINKID = MA.CMCODECASEID
LEFT JOIN IMINSPECTORREF IMIR ON IM.IMINSPECTIONID = IMIR.INSPECTIONID AND IMIR.BPRIMARY = 1
LEFT JOIN USERS U ON IMIR.USERID = U.SUSERGUID
INNER JOIN CMCODECASE CM ON IM.LINKID = CM.CMCODECASEID
LEFT JOIN #PHOTO_ATTACHMENTS PA ON PA.PARENTID = IM.IMINSPECTIONID AND A.ATTACHMENTID = PA.ATTACHMENTID AND PA.PHOTO IS NOT NULL
WHERE IM.LINKID = @CMCODECASEID


