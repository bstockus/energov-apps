
CREATE PROCEDURE [dbo].[CAP_DASHBOPARD_INSPECTIONS]
(
	@GLOBAL_ENTITY_ID CHAR(36),
	@ACTUAL_END_DATE_CUTOFF DATETIME
)
AS
BEGIN
	SELECT 
		CASE 
			WHEN IMINSPECTION.REQUESTEDDATE IS NOT NULL AND IMINSPECTION.SCHEDULEDSTARTDATE IS NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 0 
			WHEN IMINSPECTION.SCHEDULEDSTARTDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 1
			WHEN IMINSPECTION.ACTUALENDDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE >= @ACTUAL_END_DATE_CUTOFF THEN 2
		END GroupTypeId,
		IMINSPECTION.IMINSPECTIONTYPEID TypeId,
		IMINSPECTIONTYPE.NAME TypeName,
		IMINSPECTIONTYPE.DESCRIPTION TypeDescription,
		COUNT(1) AS CountOfInspections
	FROM IMINSPECTION
	INNER JOIN IMINSPECTIONTYPE ON IMINSPECTIONTYPE.IMINSPECTIONTYPEID = IMINSPECTION.IMINSPECTIONTYPEID
	WHERE 
		((IMINSPECTION.REQUESTEDDATE IS NOT NULL AND IMINSPECTION.SCHEDULEDSTARTDATE IS  NULL  AND IMINSPECTION.ACTUALENDDATE IS NULL) OR 
		(IMINSPECTION.SCHEDULEDSTARTDATE IS NOT NULL  AND IMINSPECTION.ACTUALENDDATE IS NULL) OR 
		(IMINSPECTION.ACTUALENDDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE >= @ACTUAL_END_DATE_CUTOFF)) AND 
		(
		EXISTS(
		SELECT * FROM PMPERMITCONTACT WHERE PMPERMITCONTACT.GLOBALENTITYID = @GLOBAL_ENTITY_ID and PMPERMITCONTACT.PMPERMITID = IMINSPECTION.LINKID)
		OR 
		EXISTS(
		SELECT * FROM PLPLANCONTACT WHERE PLPLANCONTACT.GLOBALENTITYID = @GLOBAL_ENTITY_ID and PLPLANCONTACT.PLPLANID = IMINSPECTION.LINKID)
		)
	GROUP BY 
		CASE 
			WHEN IMINSPECTION.REQUESTEDDATE IS NOT NULL AND IMINSPECTION.SCHEDULEDSTARTDATE IS  NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 0 
			WHEN IMINSPECTION.SCHEDULEDSTARTDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 1
			WHEN IMINSPECTION.ACTUALENDDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE >= @ACTUAL_END_DATE_CUTOFF THEN 2
		END,
		IMINSPECTIONTYPE.DESCRIPTION,
		IMINSPECTIONTYPE.NAME,
		IMINSPECTION.IMINSPECTIONTYPEID
		
	ORDER BY 
		CASE 
			WHEN IMINSPECTION.REQUESTEDDATE IS NOT NULL AND IMINSPECTION.SCHEDULEDSTARTDATE IS  NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 0 
			WHEN IMINSPECTION.SCHEDULEDSTARTDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE IS NULL THEN 1
			WHEN IMINSPECTION.ACTUALENDDATE IS NOT NULL AND IMINSPECTION.ACTUALENDDATE >= @ACTUAL_END_DATE_CUTOFF THEN 2
		END,
		COUNT(1) DESC,
		IMINSPECTIONTYPE.DESCRIPTION,
		IMINSPECTIONTYPE.NAME,
		IMINSPECTION.IMINSPECTIONTYPEID

END
