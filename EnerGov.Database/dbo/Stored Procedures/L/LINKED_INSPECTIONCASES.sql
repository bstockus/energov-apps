CREATE PROCEDURE [dbo].[LINKED_INSPECTIONCASES]
@ENTITY_ID char(36),
@FROM INT = 1,
@TO INT,
@PAGE_SIZE INT = 20,
@SORT_FIELD VARCHAR(36),
@IS_ASC BIT = 1,
@USER_ID as char(36)
AS
SET NOCOUNT ON;

BEGIN
with INSPECTIONCASEDETAILS as (
SELECT IMINSPECTIONCASE.IMINSPECTIONCASEID, IMINSPECTIONCASE.CASENO, IMINSPECTIONCASE.STARTDATE, IMINSPECTIONCASE.ENDDATE, IMINSPECTIONCASE.NEXTINSPECTIONDATE, IMINSPECTIONCASETYPE.NAME AS TYPENAME, IMINSPECTIONCASESTATUS.NAME as STATUSNAME
FROM     IMINSPECTIONCASE INNER JOIN 
IMINSPECTIONCASETYPE ON IMINSPECTIONCASE.IMINSPECTIONCASETYPEID = IMINSPECTIONCASETYPE.IMINSPECTIONCASETYPEID INNER JOIN
IMINSPECTIONCASESTATUS ON IMINSPECTIONCASE.IMINSPECTIONCASESTATUSID = IMINSPECTIONCASESTATUS.IMINSPECTIONCASESTATUSID 
INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on IMINSPECTIONCASE.IMINSPECTIONCASETYPEID = u.RECORDTYPEID
WHERE (IMINSPECTIONCASE.LINKID = @ENTITY_ID)),
NUMBEREDDATA as (SELECT IMINSPECTIONCASEID, CASENO, TYPENAME, STATUSNAME, STARTDATE, ENDDATE,NEXTINSPECTIONDATE, ROW_NUMBER() OVER(ORDER BY 
                        case when @is_asc = 1 AND @Sort_Field = 'CASENO' then CASENO END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'CASENO' then CASENO END DESC, 
                        case when @is_asc = 1 AND @Sort_Field = 'TYPENAME' then TYPENAME END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'TYPENAME' then TYPENAME END DESC, 
                        case when @is_asc = 1 AND @Sort_Field = 'STATUSNAME' then STATUSNAME END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'STATUSNAME' then STATUSNAME END DESC, 
                        case when @is_asc = 1 AND @Sort_Field = 'STARTDATE' then STARTDATE END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'STARTDATE' then STARTDATE END DESC, 
                        case when @is_asc = 1 AND @Sort_Field = 'ENDDATE' then ENDDATE END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'ENDDATE' then ENDDATE END DESC, 
                        case when @is_asc = 1 AND @Sort_Field = 'NEXTINSPECTIONDATE' then NEXTINSPECTIONDATE END ASC, 
                        case when @is_asc = 0 AND @Sort_Field = 'NEXTINSPECTIONDATE' then NEXTINSPECTIONDATE END DESC) 
                        AS ROWNUMBER, COUNT(1) OVER() AS TOTAL_ROWS from INSPECTIONCASEDETAILS) 
                        select * from NUMBEREDDATA WHERE ROWNUMBER > @FROM AND ROWNUMBER <= @TO
END