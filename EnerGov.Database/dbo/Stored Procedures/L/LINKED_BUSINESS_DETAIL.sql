CREATE PROCEDURE [dbo].[LINKED_BUSINESS_DETAIL]
	@ENTITY_ID as char(36),
	@MODULE_TYPE as char(36),
	@FROM INT = 1,
	@TO INT,
	@PAGE_SIZE INT = 20,
	@SORT_FIELD char(36),
	@IS_ASC BIT = 1,
	@SUB_MODULE_TYPE INT=1
		
AS
declare @DATA TABLE 
(
	BLGLOBALENTITYEXTENSIONID char(36)
)
declare @UseFreeFormForCompanyName bit

	IF (@MODULE_TYPE = 'ContactManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDBUSSINESSFROMCONTACT(@ENTITY_ID, @SUB_MODULE_TYPE)
	END	
	IF (@MODULE_TYPE = 'BusinessLicenseEntity')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDBUSINESSFROMBUSINESS(@ENTITY_ID, @SUB_MODULE_TYPE)
	END
	IF (@MODULE_TYPE = 'CodeManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDBUSINESSFROMCODECASE(@ENTITY_ID, @SUB_MODULE_TYPE)
	END
	IF (@MODULE_TYPE = 'PropertyManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDBUSINESSFROMPROPERTYMANAGEMENT(@ENTITY_ID, @SUB_MODULE_TYPE)
	END
	IF (@MODULE_TYPE = 'BusinessLicenseManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDBUSINESSFROMBUSINESSLICENSE(@ENTITY_ID, @SUB_MODULE_TYPE)
	END

	select @UseFreeFormForCompanyName =  BITVALUE from SETTINGS where name = 'UseFreeformTextForCompanyName'
	
	IF (@UseFreeFormForCompanyName = 1)
	BEGIN
		with LINKEDBUSINESS AS( select BLGLOBALENTITYEXTENSIONID FROM @DATA), 
		ALLBUSINESS as (SELECT blx.BLGLOBALENTITYEXTENSIONID, blx.COMPANYNAME, blx.REGISTRATIONID as BUSINESSNUMBER, blx.DBA, bcType.NAME as COMPANYTYPE,
		bStatus.NAME as STATUS, blx.EINNUMBER, blx.OPENDATE, blx.CLOSEDATE, blx.ISSUEDDATE
		from BLGLOBALENTITYEXTENSION blx
		INNER JOIN BLEXTCOMPANYTYPE bcType on blx.BLEXTCOMPANYTYPEID = bcType.BLEXTCOMPANYTYPEID  
		INNER JOIN BLEXTSTATUS bStatus on blx.BLEXTSTATUSID = bStatus.BLEXTSTATUSID  
		where blx.BLGLOBALENTITYEXTENSIONID in (SELECT BLGLOBALENTITYEXTENSIONID from LINKEDBUSINESS)),  
		NUMBEREDDATA as (select ALLBUSINESS.BLGLOBALENTITYEXTENSIONID, COMPANYNAME, BUSINESSNUMBER,DBA, COMPANYTYPE, STATUS, EINNUMBER, OPENDATE, CLOSEDATE, ISSUEDDATE,  
		ROW_NUMBER() OVER(ORDER BY  
		case when @is_asc = 1 AND @Sort_Field = 'COMPANYNAME' then COMPANYNAME END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'COMPANYNAME' then COMPANYNAME END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'BUSINESSNUMBER' then BUSINESSNUMBER END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'BUSINESSNUMBER' then BUSINESSNUMBER END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'DBA' then DBA END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'DBA' then DBA END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'COMPANYTYPE' then COMPANYTYPE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'COMPANYTYPE' then COMPANYTYPE END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'STATUS' then STATUS END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'STATUS' then STATUS END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'EINNUMBER' then EINNUMBER END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'EINNUMBER' then EINNUMBER END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'OPENDATE' then OPENDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'OPENDATE' then OPENDATE END DESC,
		case when @is_asc = 1 AND @Sort_Field = 'CLOSEDATE' then CLOSEDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'CLOSEDATE' then CLOSEDATE END DESC,
		case when @is_asc = 1 AND @Sort_Field = 'ISSUEDDATE' then ISSUEDDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'ISSUEDDATE' then ISSUEDDATE END DESC)  
		AS ROWNUMBER, COUNT(1) OVER() AS TOTAL_ROWS from ALLBUSINESS 
        INNER JOIN LINKEDBUSINESS on ALLBUSINESS.BLGLOBALENTITYEXTENSIONID = LINKEDBUSINESS.BLGLOBALENTITYEXTENSIONID)
		select * from NUMBEREDDATA WHERE ROWNUMBER > @From AND ROWNUMBER <= @To 
	END
	ELSE
	BEGIN		
		with LINKEDBUSINESS AS( select BLGLOBALENTITYEXTENSIONID FROM @DATA),   
		ALLBUSINESS as (select blx.BLGLOBALENTITYEXTENSIONID, g.GLOBALENTITYNAME as COMPANYNAME, blx.REGISTRATIONID as BUSINESSNUMBER, blx.DBA, bcType.NAME as COMPANYTYPE,
		bStatus.NAME as STATUS, blx.EINNUMBER, blx.OPENDATE, blx.CLOSEDATE, blx.ISSUEDDATE
		from BLGLOBALENTITYEXTENSION blx
		INNER JOIN BLEXTCOMPANYTYPE bcType on blx.BLEXTCOMPANYTYPEID = bcType.BLEXTCOMPANYTYPEID  
		INNER JOIN BLEXTSTATUS bStatus on blx.BLEXTSTATUSID = bStatus.BLEXTSTATUSID 
		INNER JOIN GLOBALENTITY g on blx.GLOBALENTITYID = g.GLOBALENTITYID
		where blx.BLGLOBALENTITYEXTENSIONID in (SELECT BLGLOBALENTITYEXTENSIONID from LINKEDBUSINESS)),  
		NUMBEREDDATA as (select ALLBUSINESS.BLGLOBALENTITYEXTENSIONID, COMPANYNAME, BUSINESSNUMBER,DBA, COMPANYTYPE, STATUS, EINNUMBER, OPENDATE, CLOSEDATE, ISSUEDDATE, 
		ROW_NUMBER() OVER(ORDER BY  
		case when @is_asc = 1 AND @Sort_Field = 'COMPANYNAME' then COMPANYNAME END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'COMPANYNAME' then COMPANYNAME END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'BUSINESSNUMBER' then BUSINESSNUMBER END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'BUSINESSNUMBER' then BUSINESSNUMBER END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'DBA' then DBA END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'DBA' then DBA END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'COMPANYTYPE' then COMPANYTYPE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'COMPANYTYPE' then COMPANYTYPE END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'STATUS' then STATUS END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'STATUS' then STATUS END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'EINNUMBER' then EINNUMBER END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'EINNUMBER' then EINNUMBER END DESC,  
		case when @is_asc = 1 AND @Sort_Field = 'OPENDATE' then OPENDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'OPENDATE' then OPENDATE END DESC,
		case when @is_asc = 1 AND @Sort_Field = 'CLOSEDATE' then CLOSEDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'CLOSEDATE' then CLOSEDATE END DESC,
		case when @is_asc = 1 AND @Sort_Field = 'ISSUEDDATE' then ISSUEDDATE END ASC,  
		case when @is_asc = 0 AND @Sort_Field = 'ISSUEDDATE' then ISSUEDDATE END DESC)  
		AS ROWNUMBER, COUNT(1) OVER() AS TOTAL_ROWS from ALLBUSINESS
		INNER JOIN LINKEDBUSINESS on ALLBUSINESS.BLGLOBALENTITYEXTENSIONID = LINKEDBUSINESS.BLGLOBALENTITYEXTENSIONID)
		select * from NUMBEREDDATA WHERE ROWNUMBER > @From AND ROWNUMBER <= @To 
	END