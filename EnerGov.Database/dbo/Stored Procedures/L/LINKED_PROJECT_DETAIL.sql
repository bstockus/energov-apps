CREATE PROCEDURE [dbo].LINKED_PROJECT_DETAIL
	@ENTITY_ID AS CHAR(36),
	@MODULE_TYPE as VARCHAR(36),
	@FROM INT = 1,
	@TO INT,
	@PAGE_SIZE INT = 20,
	@SORT_FIELD VARCHAR(36),
	@IS_ASC BIT = 1,
	@USER_ID as CHAR(36)
AS
declare @DATA TABLE 
(
	PRPROJECTID char(36)
)	
	IF (@MODULE_TYPE = 'ContactManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDPROJECTFROMCONTACT(@ENTITY_ID,@USER_ID)
	END
	IF (@MODULE_TYPE = 'PropertyManagement')
	BEGIN
		INSERT INTO @DATA
		SELECT * FROM DBO.LINKEDPROJECTFROMPROPERTYMANAGEMENT(@ENTITY_ID,@USER_ID)
	END
BEGIN
WITH LINKEDPROJECTS AS(select PRPROJECTID FROM @DATA), 
ALLPROJECTSDETAILS AS (
SELECT pr.PRPROJECTID, pr.PROJECTNUMBER, pr.NAME as PROJECTNAME, prtype.NAME as PROJECTTYPE, prst.NAME as STATUS, pr.STARTDATE, pr.EXPECTEDENDDATE, pr.COMPLETEDATE
FROM PRPROJECT pr
INNER JOIN PRPROJECTTYPE prtype ON pr.PRPROJECTTYPEID = prtype.PRPROJECTTYPEID
INNER JOIN PRPROJECTSTATUS prst ON pr.PRPROJECTSTATUSID = prst.PRPROJECTSTATUSID
WHERE pr.PRPROJECTID IN (SELECT PRPROJECTID FROM LINKEDPROJECTS)),
NUMBEREDDATA AS (
SELECT ALLPROJECTSDETAILS.PRPROJECTID, PROJECTNUMBER,PROJECTNAME,PROJECTTYPE,STATUS,STARTDATE,EXPECTEDENDDATE,COMPLETEDATE,
ROW_NUMBER() OVER(
ORDER BY
case when @is_asc = 1 AND @Sort_Field = 'PROJECTNUMBER' then PROJECTNUMBER END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'PROJECTNUMBER' then PROJECTNUMBER END DESC,
case when @is_asc = 1 AND @Sort_Field = 'PROJECTNAME' then PROJECTNAME END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'PROJECTNAME' then PROJECTNAME END DESC, 
case when @is_asc = 1 AND @Sort_Field = 'PROJECTTYPE' then PROJECTTYPE END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'PROJECTTYPE' then PROJECTTYPE END DESC,
case when @is_asc = 1 AND @Sort_Field = 'STATUS' then STATUS END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'STATUS' then STATUS END DESC,
case when @is_asc = 1 AND @Sort_Field = 'STARTDATE' then STARTDATE END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'STARTDATE' then STARTDATE END DESC,
case when @is_asc = 1 AND @Sort_Field = 'EXPECTEDENDDATE' then EXPECTEDENDDATE END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'EXPECTEDENDDATE' then EXPECTEDENDDATE END DESC,
case when @is_asc = 1 AND @Sort_Field = 'COMPLETEDATE' then COMPLETEDATE END ASC, 
case when @is_asc = 0 AND @Sort_Field = 'COMPLETEDATE' then COMPLETEDATE END DESC)
AS ROWNUMBER , COUNT(1) OVER() AS TOTAL_ROWS
from ALLPROJECTSDETAILS INNER JOIN LINKEDPROJECTS on ALLPROJECTSDETAILS.PRPROJECTID = LINKEDPROJECTS.PRPROJECTID)
select * from NUMBEREDDATA WHERE ROWNUMBER > @FROM AND ROWNUMBER <= @TO
END