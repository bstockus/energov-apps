
CREATE PROCEDURE rpt_BL_SR_Business_License_KPI_Report
@STARTDATE datetime,
@ENDDATE datetime

AS

BEGIN
SET NOCOUNT ON;
SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE=dateadd(ss,-1,datediff(dd,0,@ENDDATE) + 1)

-- Insert statements for procedure here
SELECT	'Applied' as KPIType,
		BLLICENSE.BLLICENSEID, BLLICENSE.APPLIEDDATE, BLLICENSE.ISSUEDDATE, BLLICENSE.LASTRENEWALDATE,
		BLLICENSETYPE.NAME LICENSETYPE,
		BLLICENSECLASS.NAME LICENSECLASS,
		BLLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,


	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	BLLICENSE
		INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
		INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
		INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID  = BLLICENSESTATUS.BLLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	BLLICENSE.APPLIEDDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Issued' as KPIType,
		BLLICENSE.BLLICENSEID, BLLICENSE.APPLIEDDATE, BLLICENSE.ISSUEDDATE, BLLICENSE.LASTRENEWALDATE,
		BLLICENSETYPE.NAME LICENSETYPE,
		BLLICENSECLASS.NAME LICENSECLASS,
		BLLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,


	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	BLLICENSE
		INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
		INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
		INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID  = BLLICENSESTATUS.BLLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	BLLICENSE.ISSUEDDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Renewal' as KPIType,
		BLLICENSE.BLLICENSEID, BLLICENSE.APPLIEDDATE, BLLICENSE.ISSUEDDATE, BLLICENSE.LASTRENEWALDATE,
		BLLICENSETYPE.NAME LICENSETYPE,
		BLLICENSECLASS.NAME LICENSECLASS,
		BLLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,


	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	BLLICENSE
		INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
		INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
		INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID  = BLLICENSESTATUS.BLLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	BLLICENSE.LASTRENEWALDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'Fees' as KPIType,
		BLLICENSE.BLLICENSEID, BLLICENSE.APPLIEDDATE, BLLICENSE.ISSUEDDATE, BLLICENSE.LASTRENEWALDATE,
		BLLICENSETYPE.NAME LICENSETYPE,
		BLLICENSECLASS.NAME LICENSECLASS,
		BLLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		COALESCE(LICENSEFEES.LICENSEFEE,0) AS LICENSEFEE,


	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	BLLICENSE
		INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
		INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
		INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID  = BLLICENSESTATUS.BLLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID
		INNER JOIN (
			SELECT	BLLICENSEFEE.BLLICENSEID, CAINVOICE.INVOICEDATE, SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT) AS LICENSEFEE
			FROM	BLLICENSEFEE
					INNER JOIN CACOMPUTEDFEE ON BLLICENSEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
					INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
			WHERE	CACOMPUTEDFEE.ISDELETED = 0
					AND NOT CAINVOICE.CASTATUSID IN (5,9,10)	-- Exclude fees from Void, Refunded and Deleted invoices
					AND CAINVOICE.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE
			GROUP BY BLLICENSEFEE.BLLICENSEID, CAINVOICE.INVOICEDATE
		) AS LICENSEFEES ON BLLICENSE.BLLICENSEID = LICENSEFEES.BLLICENSEID

WHERE	LICENSEFEES.INVOICEDATE BETWEEN @STARTDATE AND @ENDDATE

UNION

SELECT	'AppliedOnline' as KPIType,
		BLLICENSE.BLLICENSEID, BLLICENSE.APPLIEDDATE, BLLICENSE.ISSUEDDATE, BLLICENSE.LASTRENEWALDATE,
		BLLICENSETYPE.NAME LICENSETYPE,
		BLLICENSECLASS.NAME LICENSECLASS,
		BLLICENSESTATUS.NAME LICENSESTATUS,
		DISTRICT.NAME LICENSEDISTRICT,
		0 AS LICENSEFEE,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM	BLLICENSE
		INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
		INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
		INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID  = BLLICENSESTATUS.BLLICENSESTATUSID
		LEFT OUTER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID

WHERE	(BLLICENSE.LASTRENEWALDATE BETWEEN @STARTDATE AND @ENDDATE
	OR BLLICENSE.APPLIEDDATE BETWEEN @STARTDATE AND @ENDDATE)
	AND BLLICENSE.ISAPPLIEDONLINE = 1

END
