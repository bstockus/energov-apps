
CREATE PROCEDURE [dbo].[rpt_BL_SR_Business_Licenses_Not_Renewed_Listing]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME,
@FILTER AS VARCHAR(150)
AS
BEGIN

SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT BLF.BLLICENSEID, SUM(CACF.COMPUTEDAMOUNT) FEETOTAL
INTO #FEES
FROM BLLICENSEFEE BLF
INNER JOIN CACOMPUTEDFEE CACF ON BLF.CACOMPUTEDFEEID = CACF.CACOMPUTEDFEEID 
WHERE CACF.CASTATUSID NOT IN (5,10) --VOID, DELETED
GROUP BY BLF.BLLICENSEID

CREATE INDEX TEMP1 ON #FEES (BLLICENSEID);

SELECT BLLICENSETYPE.[NAME] AS LicenseType,
       BLLICENSECLASS.[NAME] AS Classification, 
	   BLLICENSESTATUS.[NAME] AS LicenseStatus, 
       BLLICENSE.LICENSENUMBER, BLLICENSE.ISSUEDDATE, BLLICENSE.EXPIRATIONDATE, BLLICENSE.APPLIEDDATE, BLLICENSE.TAXYEAR,  BLLICENSE.LASTRENEWALDATE, BLLICENSE.[DESCRIPTION],
	   BLLICENSE.ACCOUNTNUMBER, GLOBALENTITYACCOUNT.BALANCE,
       GLOBALENTITY.GLOBALENTITYNAME AS CompanyName,
	   BLGLOBALENTITYEXTENSION.DBA,
	   PARCEL.PARCELNUMBER,
	   F.FEETOTAL,
	   COALESCE(NULLIF(DISTRICT.[NAME],''),'Not Assigned') AS District,
	   COALESCE(NULLIF(USERS.FNAME + ' ' + USERS.LNAME,''),'Not Assigned') IssuedBy,  
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
FROM BLLICENSE
INNER JOIN BLGLOBALENTITYEXTENSION ON BLLICENSE.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
INNER JOIN GLOBALENTITY ON BLGLOBALENTITYEXTENSION.GLOBALENTITYID = GLOBALENTITY.GLOBALENTITYID 
LEFT OUTER JOIN (SELECT * FROM BLGLOBALENTITYEXTENSIONPARCEL WHERE BLGLOBALENTITYEXTENSIONPARCEL.MAIN = 1) AS BLGLOBALENTITYEXTENSIONPARCEL ON BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSIONPARCEL.BLGLOBALENTITYEXTENSIONID
LEFT OUTER JOIN PARCEL ON BLGLOBALENTITYEXTENSIONPARCEL.PARCELID = PARCEL.PARCELID 
LEFT OUTER JOIN GLOBALENTITYACCOUNT ON BLLICENSE.GLOBALENTITYACCOUNTID = GLOBALENTITYACCOUNT.GLOBALENTITYACCOUNTID
INNER JOIN BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID 
INNER JOIN BLLICENSESTATUS ON BLLICENSE.BLLICENSESTATUSID = BLLICENSESTATUS.BLLICENSESTATUSID 
INNER JOIN BLLICENSECLASS ON BLLICENSE.BLLICENSECLASSID = BLLICENSECLASS.BLLICENSECLASSID
LEFT OUTER JOIN USERS ON BLLICENSE.ISSUEDBY = USERS.SUSERGUID 
INNER JOIN DISTRICT ON BLLICENSE.DISTRICTID = DISTRICT.DISTRICTID
LEFT JOIN #FEES F ON BLLICENSE.BLLICENSEID = F.BLLICENSEID
WHERE (CASE @FILTER 
	     WHEN 'APPLIED DATE' THEN BLLICENSE.APPLIEDDATE
	     WHEN 'ISSUED DATE' THEN BLLICENSE.ISSUEDDATE
		 WHEN 'EXPIRATION DATE' THEN BLLICENSE.EXPIRATIONDATE END)
         BETWEEN @STARTDATE AND @ENDDATE 
AND BLLICENSE.LASTRENEWALDATE IS NULL

END
