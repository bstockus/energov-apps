
CREATE PROCEDURE [dbo].[rpt_BL_SR_Companies_Listing]
@STARTDATE AS DATETIME,
@ENDDATE AS DATETIME,
@FILTER AS VARCHAR(150)
AS

BEGIN

SET @STARTDATE=dateadd(dd,datediff(dd,0,@STARTDATE),0)
SET @ENDDATE = DATEADD(S,-1,DATEADD(D,1,@ENDDATE))

SELECT GLOBALENTITY.GLOBALENTITYNAME AS CompanyName, 
		BLGLOBALENTITYEXTENSION.REGISTRATIONID,
       BLEXTLOCATION.NAME LOCATION,
	   BLEXTSTATUS.NAME AS Status, 
       BLEXTCOMPANYTYPE.NAME AS CompanyType, 
	   BLGLOBALENTITYEXTENSION.DBA, BLGLOBALENTITYEXTENSION.OPENDATE, BLGLOBALENTITYEXTENSION.CLOSEDATE, BLGLOBALENTITYEXTENSION.LASTAUDITDATE, BLGLOBALENTITYEXTENSION.DESCRIPTION,
	   BLGLOBALENTITYEXTENSION.EINNUMBER, BLGLOBALENTITYEXTENSION.STATETAXNUMBER, BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID,
	   PARCEL.PARCELNUMBER, CASE WHEN COALESCE(TB.CODENUMBER,'') = '' THEN 'Records w' ELSE TB.CODENUMBER  + ' - ' + TB.NAME END AS BUSINESSTYPE,
	   CASE WHEN LTRIM(RTRIM(DISTRICT.NAME))='' THEN 'Not Assigned' ELSE DISTRICT.NAME END AS District,
	   MA.ADDRESSLINE1, MA.ADDRESSLINE2, MA.ADDRESSLINE3, MA.PREDIRECTION, MA.POSTDIRECTION, MA.STREETTYPE, MA.UNITORSUITE, MA.POSTALCODE, MA.CITY, MA.STATE,
	   (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
		WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO,
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name,	   
	   (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
		WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer

FROM BLGLOBALENTITYEXTENSION 
INNER JOIN GLOBALENTITY ON BLGLOBALENTITYEXTENSION.GLOBALENTITYID = GLOBALENTITY.GLOBALENTITYID
LEFT OUTER JOIN 
		(SELECT BLGLOBALENTITYEXTENSIONADDRESS.BLGLOBALENTITYEXTENSIONID, MAILINGADDRESS.ADDRESSLINE1, MAILINGADDRESS.ADDRESSLINE2, MAILINGADDRESS.ADDRESSLINE3, MAILINGADDRESS.CITY, MAILINGADDRESS.STATE, 
			    MAILINGADDRESS.POSTALCODE, MAILINGADDRESS.POSTDIRECTION, MAILINGADDRESS.PREDIRECTION, MAILINGADDRESS.STREETTYPE, 
			    MAILINGADDRESS.UNITORSUITE
        FROM BLGLOBALENTITYEXTENSIONADDRESS 
        INNER JOIN MAILINGADDRESS ON BLGLOBALENTITYEXTENSIONADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
        WHERE BLGLOBALENTITYEXTENSIONADDRESS.MAIN = 1) AS MA ON BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID = MA.BLGLOBALENTITYEXTENSIONID
LEFT OUTER JOIN (SELECT * FROM BLGLOBALENTITYEXTENSIONPARCEL WHERE BLGLOBALENTITYEXTENSIONPARCEL.MAIN = 1) AS BLGLOBALENTITYEXTENSIONPARCEL ON BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSIONPARCEL.BLGLOBALENTITYEXTENSIONID
LEFT OUTER JOIN PARCEL ON BLGLOBALENTITYEXTENSIONPARCEL.PARCELID = PARCEL.PARCELID 
INNER JOIN BLEXTSTATUS ON BLGLOBALENTITYEXTENSION.BLEXTSTATUSID = BLEXTSTATUS.BLEXTSTATUSID AND BLEXTSTATUS.BLEXTSTATUSSYSTEMID = 1 /*LIMITING TO ONLY ACTIVE*/
INNER JOIN BLEXTLOCATION ON BLGLOBALENTITYEXTENSION.BLEXTLOCATIONID = BLEXTLOCATION.BLEXTLOCATIONID 
INNER JOIN BLEXTCOMPANYTYPE ON BLGLOBALENTITYEXTENSION.BLEXTCOMPANYTYPEID = BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEID
LEFT OUTER JOIN (SELECT BLGLOBALENTITYEXTBUSTYPE.BLGLOBALENTITYEXTENSIONID, BLEXTBUSINESSTYPE.NAME, BLEXTBUSINESSTYPE.CODENUMBER 
				FROM BLGLOBALENTITYEXTBUSTYPE 
				INNER JOIN BLEXTBUSINESSTYPE ON BLGLOBALENTITYEXTBUSTYPE.BLEXTBUSINESSTYPEID = BLEXTBUSINESSTYPE.BLEXTBUSINESSTYPEID AND BLGLOBALENTITYEXTBUSTYPE.MAIN = 1) 
				TB ON TB.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
LEFT OUTER JOIN DISTRICT ON BLGLOBALENTITYEXTENSION.DISTRICTID = DISTRICT.DISTRICTID 
		WHERE (CASE @FILTER
		       WHEN 'OPENED DATE' THEN BLGLOBALENTITYEXTENSION.OPENDATE
		       WHEN 'CLOSED DATE' THEN BLGLOBALENTITYEXTENSION.CLOSEDATE END)
               BETWEEN @STARTDATE AND @ENDDATE

END
