
--  EXEC [rpt_BL_SR_Avery_5160_Business_License_Company_Labels] '01/01/2016', '06/01/2099', 'Expiration Date'

CREATE PROCEDURE [dbo].[rpt_BL_SR_Avery_5160_Business_License_Company_Labels]
@STARTDATE  DATETIME,
@ENDDATE	DATETIME,
@FILTER VARCHAR(150)
AS

SET @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, 0, @STARTDATE), 0)
SET @ENDDATE = DATEADD(SECOND,-1,DATEDIFF(DAY,0,@ENDDATE) + 1) 

SELECT * FROM (
SELECT GE.GlobalEntityName, GE.FirstName + ' ' + GE.LastName AS NAME, BLT.NAME AS BL_TYPE, BLT.BLLICENSETYPEID,
       MA.AddressLine1, MA.AddressLine2, MA.AddressLine3, MA.City, MA."State",
       MA.PostalCode, MA.PostDirection, MA.PreDirection, MA.StreetType, MA.UnitOrSuite
	   , BL.BLLICENSEID, BL.LICENSENUMBER
	   , ROW_NUMBER()OVER(PARTITION BY BL.BLLICENSEID ORDER BY CASE WHEN MA.ADDRESSTYPE LIKE 'MAILING%' THEN 2 ELSE 4 END) ROWNBR
FROM  BLLicense BL
INNER JOIN BLLICENSETYPE BLT ON BL.BLLICENSETYPEID = BLT.BLLICENSETYPEID
INNER JOIN BLGlobalEntityExtension BLGEE ON BLGEE.BLGlobalEntityExtensionID = BL.BLGlobalEntityExtensionID
INNER JOIN GlobalEntity GE ON BLGEE.GlobalEntityID = GE.GlobalEntityID
LEFT OUTER JOIN BLGlobalEntityExtensionAddress BLGEEA ON BLGEE.BLGlobalEntityExtensionID = BLGEEA.BLGlobalEntityExtensionID
LEFT OUTER JOIN MailingAddress MA ON BLGEEA.MailingAddressID = MA.MailingAddressID
WHERE 
	CASE @FILTER
		WHEN 'APPLIED DATE' THEN BL.APPLIEDDATE
	    WHEN 'ISSUED DATE' THEN BL.ISSUEDDATE
		WHEN 'EXPIRATION DATE' THEN BL.EXPIRATIONDATE
		WHEN 'LAST RENEWAL DATE' THEN BL.LASTRENEWALDATE 
	END BETWEEN @STARTDATE AND @ENDDATE
) X WHERE X.ROWNBR = 1

