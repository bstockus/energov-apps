

-- exec [dbo].[rpt_BL_Tax_TopPayerByDistrict] '20120401','20120630'

CREATE PROCEDURE [dbo].[rpt_BL_Tax_TopPayerByDistrict]
@StartDate AS DATETime,
@EndDate As DATETIME
AS

SET @StartDate = DATEADD(S,+1,DATEADD(D,-1,@StartDate))
SET @EndDate= DATEADD(S,-1,DATEADD(D,1,@EndDate))

;WITH CTE_PAID_AMT AS
(
SELECT          
        SUM(catransactionfee.PAIDAMOUNT) As PaidAMT, CACOMPUTEDFEE.CAComputedFeeID
 
FROM  CACOMPUTEDFEE
INNER JOIN  CATransactionFee ON CAComputedFee.CAComputedFeeID = CATransactionFee.CaComputedFeeID  
INNER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID
INNER JOIN CAInvoiceFee ON CATransactionFee.CAComputedFeeID = CAInvoiceFee.CAComputedFeeID
INNER JOIN CAINVOICE ON   CAInvoiceFee.CAInvoiceID = CAInvoice.CAInvoiceID 
INNER JOIN   CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN   CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID
WHERE   (NOT (CATRANSACTIONTYPE.NAME IN ('Void Reversal','NSF Reversal'))) 
AND     (NOT (CATRANSACTIONSTATUS.NAME IN ('Void','NSF'))) 
AND     (NOT( CAInvoice.CAStatusID IN ('5','10')))
AND CATRANSACTIONPAYMENT.PAYMENTDATE BETWEEN @StartDate AND  @EndDate
GROUP BY  CAComputedFee.CAComputedFeeID

), 
CTE_AMOUNT AS( 
SELECT SUM(PaidAMT) AS PaidAMT , SUM(CaComputedFee.ComputedAmount) AS ComputedAMT
   ,TxRemittanceAccount.RemittanceAccountNumber AS REMAccount, TxRemittanceAccount.TXREMITTANCEACCOUNTID
FROM TxRemittance TX
INNER JOIN TxRemittanceAccount ON Tx.TXREMITTANCEACCOUNTID = TxRemittanceAccount.TXREMITTANCEACCOUNTID
INNER JOIN (SELECT * FROM TxRemitStatus WHERE TxRemitStatusSystemID <> 2 )TxRemitStatus ON TxRemittanceAccount.TxRemittanceStatusID = TxRemitStatus.TxRemitStatusID
INNER JOIN TxRemittanceFee ON Tx.TXREMITTANCEID = TxRemittanceFee.TXREMITTANCEID 
INNER JOIN CAComputedFee ON CAComputedFee.CAComputedFeeID = TxRemittanceFee.CAComputedFeeID 
INNER JOIN CTE_PAID_AMT ON CTE_PAID_AMT.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
GROUP BY TxRemittanceAccount.RemittanceAccountNumber, TxRemittanceAccount.TXREMITTANCEACCOUNTID
)

,CTE_District AS (
SELECT TxRemittanceAccount.TXREMITTANCEACCOUNTID, COALESCE(NULLIF(GlobalEntity.GLOBALENTITYName,''),'N/A') AS BusinessName
, DISTRICT.NAME AS District, DISTRICT.DISTRICTID
FROM  TxRemittanceAccount 
INNER JOIN BLGLOBALENTITYEXTENSION ON TXREMITTANCEACCOUNT.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
INNER JOIN GLOBALENTITY ON GLOBALENTITY.GLOBALENTITYID  = BLGLOBALENTITYEXTENSION.GLOBALENTITYID
INNER JOIN DISTRICT ON TxRemittanceAccount.DISTRICT = DISTRICT.DISTRICTID
)
,CTE_ReportAMT AS (
SELECT  SUM(Tx.AmountReported) AS ReportAMT, TxRemittanceAccount.TXREMITTANCEACCOUNTID
FROM TxRemittance TX
INNER JOIN TxRemittanceAccount ON Tx.TXREMITTANCEACCOUNTID = TxRemittanceAccount.TXREMITTANCEACCOUNTID
INNER JOIN TXBILLPERIOD ON TX.TXBILLPERIODID  = TXBILLPERIOD.BILLPERIODID
WHERE TXBILLPERIOD.DUEDATE BETWEEN  @StartDate AND  @EndDate
GROUP BY  TxRemittanceAccount.RemittanceAccountNumber,TxRemittanceAccount.TXREMITTANCEACCOUNTID
) 
SELECT REMAccount, ReportAMT, ComputedAMT, PaidAMT, (ComputedAMT - PaidAMT) AS Balance, BusinessName, District, DISTRICTID
FROM  CTE_AMOUNT
INNER JOIN CTE_District ON CTE_AMOUNT.TXREMITTANCEACCOUNTID = CTE_District.TXREMITTANCEACCOUNTID
INNER JOIN CTE_ReportAMT ON CTE_AMOUNT.TXREMITTANCEACCOUNTID = CTE_ReportAMT.TXREMITTANCEACCOUNTID


