
-- EXEC [rpt_TX_SR_Tax_Remittance_Report_Account_With_Due_Invoices] '20000701', '20990901'

CREATE PROCEDURE [dbo].[rpt_TX_SR_Tax_Remittance_Report_Account_With_Due_Invoices]
@StartDate AS DATETime,
@EndDate As DATETIME
AS

SET @EndDate= DATEADD(S,-1,DATEADD(D,1,@EndDate))

SELECT *
	, ROW_NUMBER () OVER (
		ORDER BY X.REMAccount, X.GLOBALENTITYName, X.STARTDATE
	  ) SORTORDER
FROM(
	SELECT SUM(CaComputedFee.ComputedAmount) AS ComputedAMT, SUM(CaComputedFee.AMOUNTPAIDTODATE) AS PaidAMT
		, CAINVOICE.INVOICENUMBER
		, TXA.RemittanceAccountNumber AS REMAccount, TXA.TXREMITTANCEACCOUNTID
		, TXB.PERIODNAME, TXB.STARTDATE
		, Tx.AmountReported
		, CASTATUS.NAME AS INVOICESTATUS
		, GlobalEntity.GLOBALENTITYName
		, (SELECT CASE WHEN R.[IMAGE] IS NULL THEN 'N' ELSE 'Y' END FROM RPTIMAGELIB R
			WHERE R.IMAGENAME = 'Municipality_Logo') SHOWLOGO
		, (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Name') Municipality_Name
		, (SELECT R.REPORTTEXT FROM RPTTEXTLIB R
			WHERE R.TEXTNAME = 'Municipality_Page_Footer') Municipality_Page_Footer
	FROM TxRemittanceAccount TXA
	INNER JOIN TxRemittance TX ON Tx.TXREMITTANCEACCOUNTID = TXA.TXREMITTANCEACCOUNTID
	INNER JOIN TXBILLPERIOD TXB ON TX.TXBILLPERIODID = TXB.BILLPERIODID
	INNER JOIN TxRemitStatus ON TXA.TxRemittanceStatusID = TxRemitStatus.TxRemitStatusID and TxRemitStatus.TXREMITSTATUSSYSTEMID <> 2
	INNER JOIN TxRemittanceFee ON Tx.TXREMITTANCEID = TxRemittanceFee.TXREMITTANCEID
	INNER JOIN CACOMPUTEDFEE ON TXREMITTANCEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
	INNER JOIN CAINVOICEFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
	INNER JOIN CAINVOICE ON CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID AND CAINVOICE.CASTATUSID NOT IN (4,5,10) --PAID IN FULL, VOID, DELETED
	INNER JOIN CAStatus ON CAINVOICE.CASTATUSID = CASTATUS.CASTATUSID
	INNER JOIN BLGLOBALENTITYEXTENSION ON TXA.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
	INNER JOIN GLOBALENTITY ON GLOBALENTITY.GLOBALENTITYID  = BLGLOBALENTITYEXTENSION.GLOBALENTITYID
	WHERE CAINVOICE.INVOICEDUEDATE BETWEEN @StartDate AND @EndDate
	GROUP BY TXA.RemittanceAccountNumber, TXA.TXREMITTANCEACCOUNTID, TXB.PERIODNAME, TXB.STARTDATE, Tx.AmountReported, GlobalEntity.GLOBALENTITYName, CAINVOICE.INVOICENUMBER, CASTATUS.NAME--, DISTRICT.NAME, DISTRICT.DISTRICTID
) X
ORDER BY SORTORDER

