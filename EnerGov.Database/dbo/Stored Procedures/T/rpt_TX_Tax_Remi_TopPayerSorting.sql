

-- exec [dbo].[rpt_BL_Tax_TopPayerSorting] '2012-01-01','2012-04-16'
CREATE PROCEDURE [dbo].[rpt_TX_Tax_Remi_TopPayerSorting]
@StartDate AS DATETime,
@EndDate As DATETIME
AS

SET @EndDate= DATEADD(S,-1,DATEADD(D,1,@EndDate))

SELECT  
          TXREMITTANCETYPE.NAME As Account_Type
          ,TxRemittanceAccount.RemittanceAccountNumber AS REMAccount,TXRPTPERIOD.NAME ReportPeriod
          ,COALESCE(NULLIF(GlobalEntity.GLOBALENTITYName,''),'N/A') AS BusinessName
          ,SUM(Tx.AmountReported) As Sum_ReportedAmt
          ,SUM(CaComputedFee.ComputedAmount) AS Sum_CompAmtInComputed, SUM(CaComputedFee.AmountPaidToDate) As Sum_AmtPaidToDateInComputed
          ,SUM(CaTransactionFee.PaidAmount) As Sum_PaidAmtInTransaction, SUM(CaTransactionFee.RefundAmount) As Sum_RefundAmt
          ,SUM(CaTransactionFee.PaidAmount-CaTransactionFee.RefundAmount) As Sum_RealPaidAmt
     



FROM   TXREMITTANCE Tx
INNER JOIN TxRemittanceAccount ON Tx.TXREMITTANCEACCOUNTID = TxRemittanceAccount.TXREMITTANCEACCOUNTID
INNER JOIN DISTRICT ON TXREMITTANCEACCOUNT.DISTRICT = DISTRICT.DISTRICTID
LEFT OUTER JOIN TXRPTPERIOD ON TXREMITTANCEACCOUNT.REPORTPERIODID = TXRPTPERIOD.TXRPTPERIODID
INNER JOIN TXREMITTANCETYPE ON TXREMITTANCEACCOUNT.TXREMITTANCETYPEID = TXREMITTANCETYPE.TXREMITTANCETYPEID
INNER JOIN TXBILLPERIOD On Tx.TXBILLPERIODID = TxBillPeriod.BillPeriodID
INNER JOIN TxRemitStatus ON TxRemittanceAccount.TxRemittanceStatusID = TxRemitStatus.TxRemitStatusID
LEFT OUTER JOIN TxRemittanceFee ON Tx.TXREMITTANCEID = TxRemittanceFee.TXREMITTANCEID
LEFT OUTER JOIN CAComputedFee ON CAComputedFee.CAComputedFeeID = TxRemittanceFee.CAComputedFeeID 
LEFT OUTER JOIN CAFeeTemplateFee ON CAComputedFee.CAFeeTemplateFeeID = CAFeeTemplateFee.CAFeeTemplateFeeID
LEFT OUTER JOIN CATransactionFee ON CAComputedFee.CAComputedFeeID = CATransactionFee.CaComputedFeeID
LEFT OUTER JOIN CATRANSACTION ON CATRANSACTIONFEE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONPAYMENT.CATRANSACTIONID
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID 
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTION.CATRANSACTIONSTATUSID = CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID
INNER JOIN BLGLOBALENTITYEXTENSION ON TXREMITTANCEACCOUNT.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
INNER JOIN GLOBALENTITY ON GLOBALENTITY.GLOBALENTITYID  = BLGLOBALENTITYEXTENSION.GLOBALENTITYID
LEFT OUTER JOIN CATRANSACTIONINVOICE ON CATRANSACTION.CATRANSACTIONID = CATRANSACTIONINVOICE.CATRANSACTIONID 
LEFT OUTER JOIN CAINVOICE ON CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID
LEFT OUTER JOIN CAStatus ON CAINVOICE.CASTATUSID = CASTATUS.CASTATUSID
WHERE TxRemitStatus.TxRemitStatusSystemID <> 2 
AND  ( CATRANSACTIONTYPE.NAME <> 'Void Reversal' OR   CATRANSACTIONSTATUS.NAME <>'Void')
AND CASTATUS.NAME <> 'Void'
AND (CATransactionPayment.PaymentDATE BETWEEN @STARTDATE AND @ENDDATE)
--AND TxRemittanceAccount.RemittanceAccountNumber =  'TDF070382'
GROUP BY  
           TxRemittanceAccount.RemittanceAccountNumber
           ,COALESCE(NULLIF(GlobalEntity.GLOBALENTITYName,''),'N/A')
            ,TXREMITTANCETYPE.NAME
           ,TXRPTPERIOD.NAME
           ,TXREMITTANCEACCOUNT.REPORTPERIODID
           
          

