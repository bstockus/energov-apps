CREATE PROCEDURE [dbo].[USP_QUERYACTIONMAILMERGETMPL_DELETE_BYPARENTID]
(
	@QUERYACTIONID CHAR(36),
	@QUERYID CHAR(36)
)
AS
	DECLARE @MAILMERGETEMPLATEIDS RECORDIDS
	INSERT INTO @MAILMERGETEMPLATEIDS
	SELECT MAILMERGETEMPLATEID from [dbo].[QUERYACTIONMAILMERGETMPL]
	INNER JOIN [dbo].[QUERYACTION] on [dbo].[QUERYACTIONMAILMERGETMPL].[QUERYACTIONID] = [dbo].[QUERYACTION].[QUERYACTIONID]
	WHERE
		(@QUERYACTIONID IS NULL OR [dbo].[QUERYACTION].[QUERYACTIONID] = @QUERYACTIONID) AND
		(@QUERYID IS NULL OR [dbo].[QUERYACTION].[QUERYID] = @QUERYID)
	
	DELETE [dbo].[QUERYACTIONMAILMERGETMPL] FROM [dbo].[QUERYACTIONMAILMERGETMPL]
	INNER JOIN [dbo].[QUERYACTION] on [dbo].[QUERYACTIONMAILMERGETMPL].[QUERYACTIONID] = [dbo].[QUERYACTION].[QUERYACTIONID]
	WHERE
		(@QUERYACTIONID IS NULL OR [dbo].[QUERYACTION].[QUERYACTIONID] = @QUERYACTIONID) AND
		(@QUERYID IS NULL OR [dbo].[QUERYACTION].[QUERYID] = @QUERYID)
	
	EXEC [dbo].[USP_MAILMERGETEMPLATE_DELETE_BYIDS] @MAILMERGETEMPLATEIDS