CREATE TABLE [dbo].[EXAMREQUEST] (
    [EXAMREQUESTID]    CHAR (36)      NOT NULL,
    [REQUESTDATE]      DATETIME       NOT NULL,
    [EXAMTYPEID]       CHAR (36)      NOT NULL,
    [EXAMLOCATIONID]   CHAR (36)      NOT NULL,
    [EXAMLINKID]       INT            NULL,
    [LINKID]           CHAR (36)      NULL,
    [LINKNUMBER]       NVARCHAR (50)  NULL,
    [LASTCHANGEDON]    DATETIME       NULL,
    [LASTCHANGEDBY]    CHAR (36)      NULL,
    [ROWVERSION]       INT            NOT NULL,
    [EXAMFORMATID]     INT            NOT NULL,
    [SPECIALSITTING]   BIT            NOT NULL,
    [LOCATIONDETAILS]  NVARCHAR (MAX) NULL,
    [EXAMTIMESLOTID]   CHAR (36)      NOT NULL,
    [REQUESTNUMBER]    NVARCHAR (50)  NOT NULL,
    [EXAMFORMATTYPEID] INT            NULL,
    CONSTRAINT [PK_EXAMREQUEST] PRIMARY KEY NONCLUSTERED ([EXAMREQUESTID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_EXAMREQUEST_EXAMLINK] FOREIGN KEY ([EXAMLINKID]) REFERENCES [dbo].[EXAMLINK] ([EXAMLINKID]),
    CONSTRAINT [FK_EXAMREQUEST_FORMAT] FOREIGN KEY ([EXAMFORMATID]) REFERENCES [dbo].[EXAMFORMAT] ([EXAMFORMATID]),
    CONSTRAINT [FK_EXAMREQUEST_FORMATTYPE] FOREIGN KEY ([EXAMFORMATTYPEID]) REFERENCES [dbo].[EXAMFORMATTYPE] ([EXAMFORMATTYPEID]),
    CONSTRAINT [FK_EXAMREQUEST_LOCATION] FOREIGN KEY ([EXAMLOCATIONID]) REFERENCES [dbo].[EXAMLOCATION] ([EXAMLOCATIONID]),
    CONSTRAINT [FK_EXAMREQUEST_TIMESLOT] FOREIGN KEY ([EXAMTIMESLOTID]) REFERENCES [dbo].[EXAMTIMESLOT] ([EXAMTIMESLOTID]),
    CONSTRAINT [FK_EXAMREQUEST_TYPE] FOREIGN KEY ([EXAMTYPEID]) REFERENCES [dbo].[EXAMTYPE] ([EXAMTYPEID]),
    CONSTRAINT [FK_EXAMREQUEST_USERS] FOREIGN KEY ([LASTCHANGEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO
CREATE NONCLUSTERED INDEX [IX_EXAMREQUEST_LASTCHANGEDON]
    ON [dbo].[EXAMREQUEST]([LASTCHANGEDON] ASC)
    INCLUDE([EXAMREQUESTID]);


GO

CREATE TRIGGER [TG_EXAMREQUEST_INSERT_ELASTIC] ON  EXAMREQUEST
   AFTER INSERT
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[EXAMREQUESTID] ,
        'EnerGovBusiness.SystemSetup.ExamRequest' ,
        [Inserted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        1 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];

END
GO

CREATE TRIGGER [TG_EXAMREQUEST_DELETE_ELASTIC] ON  EXAMREQUEST
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Deleted].[EXAMREQUESTID] ,
        'EnerGovBusiness.SystemSetup.ExamRequest' ,
        [Deleted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        3 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted];

END
GO

CREATE TRIGGER [TG_EXAMREQUEST_UPDATE_ELASTIC] ON  EXAMREQUEST
   AFTER UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[EXAMREQUESTID] ,
        'EnerGovBusiness.SystemSetup.ExamRequest' ,
        [Inserted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];

END