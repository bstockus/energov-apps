CREATE TABLE [dbo].[EXAMTYPEVERSION] (
    [EXAMTYPEVERSIONID] CHAR (36) NOT NULL,
    [EXAMTYPEID]        CHAR (36) NOT NULL,
    [EXAMVERSIONID]     CHAR (36) NOT NULL,
    [ISDEFAULT]         BIT       NOT NULL,
    [ACTIVE]            BIT       NOT NULL,
    CONSTRAINT [PK_EXAMTYPEVERSION] PRIMARY KEY NONCLUSTERED ([EXAMTYPEVERSIONID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_EXAMTYPEVERSION_TYPE] FOREIGN KEY ([EXAMTYPEID]) REFERENCES [dbo].[EXAMTYPE] ([EXAMTYPEID]),
    CONSTRAINT [FK_EXAMTYPEVERSION_VERSION] FOREIGN KEY ([EXAMVERSIONID]) REFERENCES [dbo].[EXAMVERSION] ([EXAMVERSIONID])
);


GO
CREATE NONCLUSTERED INDEX [EXAMTYPEVERSION_IX_EXAMTYPEID]
    ON [dbo].[EXAMTYPEVERSION]([EXAMTYPEID] ASC);


GO

CREATE TRIGGER [TG_EXAMTYPEVERSION_DELETE] ON [EXAMTYPEVERSION]
	AFTER DELETE
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO [HISTORYSYSTEMSETUP]
	(
		[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
	)
	SELECT
			[EXAMTYPE].[EXAMTYPEID],
			[EXAMTYPE].[ROWVERSION],
			GETUTCDATE(),
			(SELECT dbo.UFN_GET_USERID_FROM_CONTEXT_INFO()),
			'Exam Type Exam Version Deleted',
			'',
			'',
			'Exam Type (' + [EXAMTYPE].[NAME] + '), Exam Version ('+ [EXAMVERSION].[NAME] + ')',
			'B4DF1B5F-9A50-4053-8695-EE3A78674DCF',
			3,
			0,
			[EXAMVERSION].[NAME]
	FROM	[deleted]	
	INNER JOIN [EXAMTYPE] ON [deleted].[EXAMTYPEID] = [EXAMTYPE].[EXAMTYPEID]
	INNER JOIN [EXAMVERSION] ON [deleted].[EXAMVERSIONID] = [EXAMVERSION].[EXAMVERSIONID]
END
GO

CREATE TRIGGER [TG_EXAMTYPEVERSION_INSERT] ON [EXAMTYPEVERSION]
	AFTER INSERT
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO [HISTORYSYSTEMSETUP]
	(
		[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
	)
	SELECT 
			[EXAMTYPE].[EXAMTYPEID],
			[EXAMTYPE].[ROWVERSION],
			GETUTCDATE(),
			[EXAMTYPE].[LASTCHANGEDBY],
			'Exam Type Exam Version Added',
			'',
			'',
			'Exam Type (' + [EXAMTYPE].[NAME] + '), Exam Version ('+ [EXAMVERSION].[NAME] + ')',
			'B4DF1B5F-9A50-4053-8695-EE3A78674DCF',
			1,
			0,
			[EXAMVERSION].[NAME]
	FROM	[inserted]
	INNER JOIN [EXAMTYPE] ON [inserted].[EXAMTYPEID] = [EXAMTYPE].[EXAMTYPEID]
	INNER JOIN [EXAMVERSION] ON [inserted].[EXAMVERSIONID] = [EXAMVERSION].[EXAMVERSIONID]
END
GO

CREATE TRIGGER [TG_EXAMTYPEVERSION_UPDATE] ON [EXAMTYPEVERSION]
	AFTER UPDATE
AS
BEGIN
 INSERT INTO [HISTORYSYSTEMSETUP]
    (	[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
    )
	SELECT
			[EXAMTYPE].[EXAMTYPEID],
			[EXAMTYPE].[ROWVERSION],
			GETUTCDATE(),
			[EXAMTYPE].[LASTCHANGEDBY],
			'Active Flag',
			CASE [deleted].[ACTIVE] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' END,
			CASE [inserted].[ACTIVE] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' END,
			'Exam Type (' + [EXAMTYPE].[NAME] + '), Exam Version ('+ [EXAMVERSION].[NAME] + ')',
			'B4DF1B5F-9A50-4053-8695-EE3A78674DCF',
			2,
			0,
			[EXAMVERSION].[NAME]
	FROM	[deleted]
			JOIN [inserted] ON [deleted].[EXAMTYPEID] = [inserted].[EXAMTYPEID]
			INNER JOIN [EXAMTYPE] ON [inserted].[EXAMTYPEID] = [EXAMTYPE].[EXAMTYPEID]
			INNER JOIN [EXAMVERSION] ON [inserted].[EXAMVERSIONID] = [EXAMVERSION].[EXAMVERSIONID]
	WHERE	[deleted].[ACTIVE] <> [inserted].[ACTIVE]
	UNION ALL

	SELECT
			[EXAMTYPE].[EXAMTYPEID],
			[EXAMTYPE].[ROWVERSION],
			GETUTCDATE(),
			[EXAMTYPE].[LASTCHANGEDBY],
			'Default Flag',
			CASE [deleted].[ISDEFAULT] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' END,
			CASE [inserted].[ISDEFAULT] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' END,
			'Exam Type (' + [EXAMTYPE].[NAME] + '), Exam Version ('+ [EXAMVERSION].[NAME] + ')',
			'B4DF1B5F-9A50-4053-8695-EE3A78674DCF',
			2,
			0,
			[EXAMVERSION].[NAME]
	FROM	[deleted]
			JOIN [inserted] ON [deleted].[EXAMTYPEID] = [inserted].[EXAMTYPEID]
			INNER JOIN [EXAMTYPE] ON [inserted].[EXAMTYPEID] = [EXAMTYPE].[EXAMTYPEID]
			INNER JOIN [EXAMVERSION] ON [inserted].[EXAMVERSIONID] = [EXAMVERSION].[EXAMVERSIONID]
	WHERE	[deleted].[ISDEFAULT] <> [inserted].[ISDEFAULT]
END