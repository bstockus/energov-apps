CREATE TABLE [dbo].[IMINSPECTIONCASE] (
    [IMINSPECTIONCASEID]       CHAR (36)      NOT NULL,
    [IMINSPECTIONCASETYPEID]   CHAR (36)      NOT NULL,
    [CASENO]                   NVARCHAR (50)  NOT NULL,
    [STARTDATE]                DATETIME       NULL,
    [ENDDATE]                  DATETIME       NULL,
    [LASTINSPECTIONDATE]       DATETIME       NULL,
    [NEXTINSPECTIONDATE]       DATETIME       NULL,
    [DESCRIPTION]              NVARCHAR (MAX) NULL,
    [CREATEDATE]               DATETIME       NOT NULL,
    [DISTRICTID]               CHAR (36)      NOT NULL,
    [IMINSPECTIONCASESTATUSID] CHAR (36)      NOT NULL,
    [ROWVERSION]               INT            NOT NULL,
    [LASTCHANGEDON]            DATETIME       NULL,
    [LASTCHANGEDBY]            CHAR (36)      NULL,
    [LINKNUMBER]               NVARCHAR (50)  NULL,
    [LINKID]                   CHAR (36)      NULL,
    [IMINSPECTIONLINKID]       INT            NULL,
    [RECURRENCEID]             CHAR (36)      NULL,
    [PRPROJECTID]              CHAR (36)      NULL,
    CONSTRAINT [PK_IMInspectionCase] PRIMARY KEY CLUSTERED ([IMINSPECTIONCASEID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_IMINSPECTIONCASE_DT] FOREIGN KEY ([DISTRICTID]) REFERENCES [dbo].[DISTRICT] ([DISTRICTID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_LINK] FOREIGN KEY ([IMINSPECTIONLINKID]) REFERENCES [dbo].[IMINSPECTIONLINK] ([IMINSPECTIONLINKID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_PR] FOREIGN KEY ([PRPROJECTID]) REFERENCES [dbo].[PRPROJECT] ([PRPROJECTID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_REC] FOREIGN KEY ([RECURRENCEID]) REFERENCES [dbo].[RECURRENCE] ([RECURRENCEID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_ST] FOREIGN KEY ([IMINSPECTIONCASESTATUSID]) REFERENCES [dbo].[IMINSPECTIONCASESTATUS] ([IMINSPECTIONCASESTATUSID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_TYPE] FOREIGN KEY ([IMINSPECTIONCASETYPEID]) REFERENCES [dbo].[IMINSPECTIONCASETYPE] ([IMINSPECTIONCASETYPEID]),
    CONSTRAINT [FK_IMINSPECTIONCASE_USERS] FOREIGN KEY ([LASTCHANGEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO

CREATE TRIGGER [TG_INSPECTIONCASE_UPDATE_ELASTIC] ON IMINSPECTIONCASE
	AFTER UPDATE
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID(),
		[Inserted].[IMINSPECTIONCASEID],
		'EnerGovBusiness.Inspections.InspectionCase',
		[Inserted].[ROWVERSION],
		GETDATE(),
		NULL,
		2,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];
END
GO

CREATE TRIGGER [TG_INSPECTIONCASE_DELETE_ELASTIC] ON IMINSPECTIONCASE
	AFTER DELETE
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID(),
		[Deleted].[IMINSPECTIONCASEID],
		'EnerGovBusiness.Inspections.InspectionCase',
		[Deleted].[ROWVERSION],
		GETDATE(),
		NULL,
		3,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted];
END
GO

CREATE TRIGGER [TG_INSPECTIONCASE_INSERT_ELASTIC] ON IMINSPECTIONCASE
	AFTER INSERT
AS
BEGIN
	SET NOCOUNT ON;
	
	INSERT INTO [ELASTICSEARCHOBJECT]
	 ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT 
		NEWID(),
		[Inserted].[IMINSPECTIONCASEID],
		'EnerGovBusiness.Inspections.InspectionCase',
		[Inserted].[ROWVERSION],
		GETDATE(),
		NULL,
		1,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];
END