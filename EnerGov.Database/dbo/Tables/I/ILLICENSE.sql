CREATE TABLE [dbo].[ILLICENSE] (
    [ILLICENSEID]                 CHAR (36)      NOT NULL,
    [LICENSENUMBER]               NVARCHAR (50)  NOT NULL,
    [ISSUEDBY]                    CHAR (36)      NULL,
    [ILLICENSETYPEID]             CHAR (36)      NOT NULL,
    [ILLICENSESTATUSID]           CHAR (36)      NOT NULL,
    [ISSUEDATE]                   DATETIME       NULL,
    [EXPIRATIONDATE]              DATETIME       NULL,
    [LASTCHANGEDON]               DATETIME       NULL,
    [LASTCHANGEDBY]               CHAR (36)      NULL,
    [ROWVERSION]                  INT            NOT NULL,
    [GLOBALENTITYID]              CHAR (36)      NOT NULL,
    [ILLICENSEPARENTID]           CHAR (36)      NULL,
    [DISTRICTID]                  CHAR (36)      NOT NULL,
    [ILLICENSECLASSIFICATIONID]   CHAR (36)      NOT NULL,
    [APPLIEDDATE]                 DATETIME       NOT NULL,
    [LASTRENEWALDATE]             DATETIME       NULL,
    [LICENSEYEAR]                 INT            NULL,
    [ILLICENSEGROUPID]            CHAR (36)      NULL,
    [DESCRIPTION]                 NVARCHAR (MAX) NULL,
    [GLOBALENTITYACCOUNTID]       CHAR (36)      NULL,
    [CALENDARDUEDATE]             DATETIME       NULL,
    [ISAPPLIEDONLINE]             BIT            NOT NULL,
    [IMPORTEDCUSTOMFIELDLAYOUTID] CHAR (36)      NULL,
    CONSTRAINT [PK_ILLicense] PRIMARY KEY CLUSTERED ([ILLICENSEID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_ILLICENSE_CUSTOMFIELDLAYOUT] FOREIGN KEY ([IMPORTEDCUSTOMFIELDLAYOUTID]) REFERENCES [dbo].[CUSTOMFIELDLAYOUT] ([GCUSTOMFIELDLAYOUTS]),
    CONSTRAINT [FK_ILLICENSE_DISTRICT] FOREIGN KEY ([DISTRICTID]) REFERENCES [dbo].[DISTRICT] ([DISTRICTID]),
    CONSTRAINT [FK_ILLICENSE_GLOBALENTACCT] FOREIGN KEY ([GLOBALENTITYACCOUNTID]) REFERENCES [dbo].[GLOBALENTITYACCOUNT] ([GLOBALENTITYACCOUNTID]),
    CONSTRAINT [FK_ILLICENSE_GLOBALENTITY] FOREIGN KEY ([GLOBALENTITYID]) REFERENCES [dbo].[GLOBALENTITY] ([GLOBALENTITYID]),
    CONSTRAINT [FK_ILLICENSE_ILLICENSE] FOREIGN KEY ([ILLICENSEPARENTID]) REFERENCES [dbo].[ILLICENSE] ([ILLICENSEID]),
    CONSTRAINT [FK_ILLICENSE_ILLICENSECLASS] FOREIGN KEY ([ILLICENSECLASSIFICATIONID]) REFERENCES [dbo].[ILLICENSECLASSIFICATION] ([ILLICENSECLASSIFICATIONID]),
    CONSTRAINT [FK_ILLICENSE_ILLICENSEGROUP] FOREIGN KEY ([ILLICENSEGROUPID]) REFERENCES [dbo].[ILLICENSEGROUP] ([ILLICENSEGROUPID]),
    CONSTRAINT [FK_ILLicense_ILLicenseType] FOREIGN KEY ([ILLICENSETYPEID]) REFERENCES [dbo].[ILLICENSETYPE] ([ILLICENSETYPEID]),
    CONSTRAINT [FK_ILLicense_Status] FOREIGN KEY ([ILLICENSESTATUSID]) REFERENCES [dbo].[ILLICENSESTATUS] ([ILLICENSESTATUSID]),
    CONSTRAINT [FK_ILLicense_Users] FOREIGN KEY ([ISSUEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID]),
    CONSTRAINT [FK_ILLICENSE_USERS1] FOREIGN KEY ([LASTCHANGEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO
CREATE NONCLUSTERED INDEX [IX_ILLICENSE_RECENT_LIC]
    ON [dbo].[ILLICENSE]([GLOBALENTITYID] ASC, [ILLICENSETYPEID] ASC, [LICENSEYEAR] ASC, [ILLICENSEID] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [IMPORT1]
    ON [dbo].[ILLICENSE]([LICENSENUMBER] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [NCIDX_ILLICENSE_ILLICENSEPARENTID]
    ON [dbo].[ILLICENSE]([ILLICENSEPARENTID] ASC) WITH (FILLFACTOR = 90, PAD_INDEX = ON);


GO
CREATE NONCLUSTERED INDEX [IX_ILLICENSE_LASTCHANGEDON]
    ON [dbo].[ILLICENSE]([LASTCHANGEDON] ASC)
    INCLUDE([ILLICENSEID]);


GO

CREATE TRIGGER [TG_ILLICENSE_UPDATE_ELASTIC] ON  ILLICENSE
   AFTER UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[ILLICENSEID] ,
        'EnerGovBusiness.IndividualLicense.License' ,
        [Inserted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];

END
GO

CREATE TRIGGER [TG_ILLICENSE_INSERT_ELASTIC] ON  ILLICENSE
   AFTER INSERT
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[ILLICENSEID] ,
        'EnerGovBusiness.IndividualLicense.License' ,
        [Inserted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        1 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];

END
GO

CREATE TRIGGER [TG_ILLICENSE_DELETE_ELASTIC] ON  ILLICENSE
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Deleted].[ILLICENSEID] ,
        'EnerGovBusiness.IndividualLicense.License' ,
        [Deleted].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        3 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted];

END