CREATE TABLE [dbo].[QUERYACTIONATTACHDOC] (
    [QUERYACTIONATTACHDOCID] CHAR (36)      NOT NULL,
    [QUERYACTIONID]          CHAR (36)      NOT NULL,
    [ATTACHMENTGROUPID]      CHAR (36)      NULL,
    [NOTES]                  NVARCHAR (MAX) NOT NULL,
    [RPTREPORTID]            CHAR (36)      NOT NULL,
    CONSTRAINT [PK_QUERYACTIONATTACHDOC] PRIMARY KEY CLUSTERED ([QUERYACTIONATTACHDOCID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_QUERYACTIONATTACHDOC_AG] FOREIGN KEY ([ATTACHMENTGROUPID]) REFERENCES [dbo].[ATTACHMENTGROUP] ([ATTACHMENTGROUPID]),
    CONSTRAINT [FK_QUERYACTIONATTACHDOC_QA] FOREIGN KEY ([QUERYACTIONID]) REFERENCES [dbo].[QUERYACTION] ([QUERYACTIONID]),
    CONSTRAINT [FK_QUERYACTIONATTACHDOC_RP] FOREIGN KEY ([RPTREPORTID]) REFERENCES [dbo].[RPTREPORT] ([RPTREPORTID])
);


GO
CREATE NONCLUSTERED INDEX [QUERYACTIONATTACHDOC_ATTACHMENTGROUPID]
    ON [dbo].[QUERYACTIONATTACHDOC]([ATTACHMENTGROUPID] ASC);


GO
CREATE NONCLUSTERED INDEX [QUERYACTIONATTACHDOC_QUERYACTIONID]
    ON [dbo].[QUERYACTIONATTACHDOC]([QUERYACTIONID] ASC);


GO
CREATE NONCLUSTERED INDEX [QUERYACTIONATTACHDOC_RPTREPORTID]
    ON [dbo].[QUERYACTIONATTACHDOC]([RPTREPORTID] ASC);


GO


CREATE TRIGGER [dbo].[TG_QUERYACTIONATTACHDOC_UPDATE]
   ON  [dbo].[QUERYACTIONATTACHDOC]
   AFTER UPDATE
AS 
BEGIN	
	SET NOCOUNT ON;
	INSERT INTO [HISTORYSYSTEMSETUP]
    (	[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
    )	
	SELECT
			[QUERY].[QUERYID], 
			[QUERY].[ROWVERSION],
			GETUTCDATE(),
			[QUERY].[LASTCHANGEDBY],
			'Attachment Group',
			ISNULL(DELETEATTACHMENTGROUP.[NAME],'[none]'),
			ISNULL(INSERTATTACHMENTGROUP.[NAME],'[none]'),
			'Intelligent Query Action (' + [QUERY].[NAME] + '), Action (' + [QUERYACTION].[ACTIONNAME] +'), Action Type (' + [QUERYACTIONTYPE].[NAME] + ')',
			'C08776DA-046E-4E9B-9DE4-4CC2005A98CD',
			2,
			0,
			[QUERYACTION].[ACTIONNAME]
	FROM	[deleted]
			JOIN [inserted] ON [deleted].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERYACTION] ON [QUERYACTION].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERY] ON [QUERY].[QUERYID] = [QUERYACTION].[QUERYID]
			INNER JOIN [QUERYACTIONTYPE] WITH (NOLOCK) ON [QUERYACTIONTYPE].[QUERYACTIONTYPEID] = [QUERYACTION].[QUERYACTIONTYPEID]
			LEFT JOIN [ATTACHMENTGROUP] AS DELETEATTACHMENTGROUP WITH (NOLOCK) ON DELETEATTACHMENTGROUP.[ATTACHMENTGROUPID] = [deleted].[ATTACHMENTGROUPID]
			LEFT JOIN [ATTACHMENTGROUP] AS INSERTATTACHMENTGROUP WITH (NOLOCK) ON INSERTATTACHMENTGROUP.[ATTACHMENTGROUPID] = [inserted].[ATTACHMENTGROUPID]
	WHERE	ISNULL([deleted].[ATTACHMENTGROUPID],'') <> ISNULL([inserted].[ATTACHMENTGROUPID],'')

	UNION ALL
	SELECT
			[QUERY].[QUERYID], 
			[QUERY].[ROWVERSION],
			GETUTCDATE(),
			[QUERY].[LASTCHANGEDBY],
			'Notes',
			[deleted].[NOTES],
			[inserted].[NOTES],
			'Intelligent Query Action (' + [QUERY].[NAME] + '), Action (' + [QUERYACTION].[ACTIONNAME] +'), Action Type (' + [QUERYACTIONTYPE].[NAME] + ')',
			'C08776DA-046E-4E9B-9DE4-4CC2005A98CD',
			2,
			0,
			[QUERYACTION].[ACTIONNAME]
	FROM	[deleted]
			JOIN [inserted] ON [deleted].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERYACTION] ON [QUERYACTION].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERY] ON [QUERY].[QUERYID] = [QUERYACTION].[QUERYID]
			INNER JOIN [QUERYACTIONTYPE] WITH (NOLOCK) ON [QUERYACTIONTYPE].[QUERYACTIONTYPEID] = [QUERYACTION].[QUERYACTIONTYPEID]
	WHERE	[deleted].[ATTACHMENTGROUPID] <> [inserted].[ATTACHMENTGROUPID]

	UNION ALL
	SELECT
			[QUERY].[QUERYID], 
			[QUERY].[ROWVERSION],
			GETUTCDATE(),
			[QUERY].[LASTCHANGEDBY],
			'Attachment',
			ISNULL(DELETERPTREPORT.[FRIENDLYNAME],'[none]'),
			ISNULL(INSERTRPTREPORT.[FRIENDLYNAME],'[none]'),
			'Intelligent Query Action (' + [QUERY].[NAME] + '), Action (' + [QUERYACTION].[ACTIONNAME] +'), Action Type (' + [QUERYACTIONTYPE].[NAME] + ')',
			'C08776DA-046E-4E9B-9DE4-4CC2005A98CD',
			2,
			0,
			[QUERYACTION].[ACTIONNAME]
	FROM	[deleted]
			JOIN [inserted] ON [deleted].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERYACTION] ON [QUERYACTION].[QUERYACTIONID] = [inserted].[QUERYACTIONID]
			INNER JOIN [QUERY] ON [QUERY].[QUERYID] = [QUERYACTION].[QUERYID]
			INNER JOIN [QUERYACTIONTYPE] WITH (NOLOCK) ON [QUERYACTIONTYPE].[QUERYACTIONTYPEID] = [QUERYACTION].[QUERYACTIONTYPEID]
			INNER JOIN [RPTREPORT] AS DELETERPTREPORT WITH (NOLOCK) ON DELETERPTREPORT.[RPTREPORTID] = [deleted].[RPTREPORTID]
			INNER JOIN [RPTREPORT] AS INSERTRPTREPORT WITH (NOLOCK) ON INSERTRPTREPORT.[RPTREPORTID] = [inserted].[RPTREPORTID]
	WHERE	[deleted].[RPTREPORTID] <> [inserted].[RPTREPORTID]

END