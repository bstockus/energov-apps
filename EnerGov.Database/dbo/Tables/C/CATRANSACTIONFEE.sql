CREATE TABLE [dbo].[CATRANSACTIONFEE] (
    [CATRANSACTIONFEEID] CHAR (36) NOT NULL,
    [CATRANSACTIONID]    CHAR (36) NOT NULL,
    [CACOMPUTEDFEEID]    CHAR (36) NOT NULL,
    [PAIDAMOUNT]         MONEY     NOT NULL,
    [CASTATUSID]         INT       CONSTRAINT [DEF_CATransactionFee_Status] DEFAULT ((1)) NOT NULL,
    [ROWVERSION]         INT       CONSTRAINT [DF_CATransactionFee_RowVersion] DEFAULT ((1)) NOT NULL,
    [LASTCHANGEDON]      DATETIME  CONSTRAINT [DF_CATransactionFee_LastChangedOn] DEFAULT (getdate()) NOT NULL,
    [LASTCHANGEDBY]      CHAR (36) NOT NULL,
    [REFUNDAMOUNT]       MONEY     CONSTRAINT [DF_CATransFee_RefundAmount] DEFAULT ((0)) NOT NULL,
    CONSTRAINT [PK_CATransactionFee] PRIMARY KEY NONCLUSTERED ([CATRANSACTIONFEEID] ASC) WITH (FILLFACTOR = 80),
    CONSTRAINT [FK_CATransactionFee_Status] FOREIGN KEY ([CASTATUSID]) REFERENCES [dbo].[CASTATUS] ([CASTATUSID]),
    CONSTRAINT [FK_CATransactionFee_Users] FOREIGN KEY ([LASTCHANGEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID]),
    CONSTRAINT [FK_CATransFee_Fee] FOREIGN KEY ([CACOMPUTEDFEEID]) REFERENCES [dbo].[CACOMPUTEDFEE] ([CACOMPUTEDFEEID]),
    CONSTRAINT [FK_CATransFee_Trans] FOREIGN KEY ([CATRANSACTIONID]) REFERENCES [dbo].[CATRANSACTION] ([CATRANSACTIONID])
);


GO
CREATE NONCLUSTERED INDEX [IMPORT1]
    ON [dbo].[CATRANSACTIONFEE]([CACOMPUTEDFEEID] ASC) WITH (FILLFACTOR = 80);


GO
CREATE NONCLUSTERED INDEX [IMPORT2]
    ON [dbo].[CATRANSACTIONFEE]([CATRANSACTIONID] ASC) WITH (FILLFACTOR = 80);


GO
CREATE NONCLUSTERED INDEX [IX_CATRANSACTIONFEE_CATRANSACTIONID]
    ON [dbo].[CATRANSACTIONFEE]([CATRANSACTIONID] ASC);


GO
CREATE NONCLUSTERED INDEX [NCIDX_CATRANSACTIONFEE_PAYMENTDETAIL_INCL]
    ON [dbo].[CATRANSACTIONFEE]([CACOMPUTEDFEEID] ASC)
    INCLUDE([CATRANSACTIONFEEID], [CATRANSACTIONID], [PAIDAMOUNT], [REFUNDAMOUNT]);


GO

CREATE TRIGGER [TG_CATRANSACTIONFEE_UPDATE_ELASTIC_FEE] ON  CATRANSACTIONFEE
   AFTER UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[CACOMPUTEDFEEID] ,
        'EnerGovBusiness.Cashier.Fee' ,
        [CACOMPUTEDFEE].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted] INNER JOIN [CACOMPUTEDFEE] 
	on [inserted].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID];

END
GO

CREATE TRIGGER [TG_CATRANSACTIONFEE_INSERT_ELASTIC_FEE] ON  CATRANSACTIONFEE
   AFTER INSERT
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Inserted].[CACOMPUTEDFEEID] ,
        'EnerGovBusiness.Cashier.Fee' ,
        [CACOMPUTEDFEE].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        1 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted] INNER JOIN [CACOMPUTEDFEE] 
	on [inserted].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID];

END
GO

CREATE TRIGGER [TG_CATRANSACTIONFEE_DELETE_ELASTIC_FEE] ON  CATRANSACTIONFEE
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Deleted].[CATRANSACTIONFEEID] ,
        'EnerGovBusiness.Cashier.Fee' ,
        [CACOMPUTEDFEE].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        3 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted] INNER JOIN [CACOMPUTEDFEE] 
	on [Deleted].[CACOMPUTEDFEEID] = [CACOMPUTEDFEE].[CACOMPUTEDFEEID];

END