CREATE TABLE [dbo].[CUSTOMSAVERCODEMANAGEMENTMS] (
    [ID]                        CHAR (36) NOT NULL,
    [CUSTOMFIELDID]             CHAR (36) NOT NULL,
    [CUSTOMFIELDPICKLISTITEMID] CHAR (36) NOT NULL,
    CONSTRAINT [PK_CodeManagementMS] PRIMARY KEY NONCLUSTERED ([ID] ASC, [CUSTOMFIELDID] ASC, [CUSTOMFIELDPICKLISTITEMID] ASC) WITH (FILLFACTOR = 80),
    CONSTRAINT [CodeManagementMS_CodeManagemen] FOREIGN KEY ([ID]) REFERENCES [dbo].[CUSTOMSAVERCODEMANAGEMENT] ([ID]),
    CONSTRAINT [CodeManagementMS_CustomField] FOREIGN KEY ([CUSTOMFIELDID]) REFERENCES [dbo].[CUSTOMFIELD] ([GCUSTOMFIELD]),
    CONSTRAINT [CodeManagementMS_CustomFieldPi] FOREIGN KEY ([CUSTOMFIELDPICKLISTITEMID]) REFERENCES [dbo].[CUSTOMFIELDPICKLISTITEM] ([GCUSTOMFIELDPICKLISTITEM])
);


GO
CREATE NONCLUSTERED INDEX [CodeManagementMS_ID]
    ON [dbo].[CUSTOMSAVERCODEMANAGEMENTMS]([ID] ASC) WITH (FILLFACTOR = 80);


GO

CREATE TRIGGER [TG_CUSTOMSAVERCODEMANAGEMENTMS_UPDATE_ELASTIC_VIO] ON  CUSTOMSAVERCODEMANAGEMENTMS
   AFTER UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[C].[CMCODECASEID] ,
        'EnerGovBusiness.CodeEnforcement.CodeCase' ,
        [C].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted]
	JOIN [CMVIOLATION] AS [V] WITH (NOLOCK) ON [V].[CMVIOLATIONID] = [Inserted].[ID]
	JOIN [CMCODEWFACTIONSTEP] AS [A] WITH (NOLOCK) ON [A].[CMCODEWFACTIONSTEPID] = [V].[CMCODEWFACTIONID]
	JOIN [CMCODEWFSTEP] AS [S] WITH (NOLOCK) ON [S].[CMCODEWFSTEPID] = [A].[CMCODEWFSTEPID]
	JOIN [CMCODECASE] AS [C] WITH (NOLOCK) ON [C].[CMCODECASEID] = [Inserted].[ID];

END
GO

CREATE TRIGGER [TG_CUSTOMSAVERCODEMANAGEMENTMS_UPDATE_ELASTIC] ON  CUSTOMSAVERCODEMANAGEMENTMS
   AFTER UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[C].[CMCODECASEID] ,
        'EnerGovBusiness.CodeEnforcement.CodeCase' ,
        [C].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted]
	JOIN [CMCODECASE] AS [C] WITH (NOLOCK) ON [C].[CMCODECASEID] = [Inserted].[ID];

END