CREATE TABLE [dbo].[GISZONETOINSPECTORDESIG] (
    [GISZONETOINSPECTORDESIGID] CHAR (36) NOT NULL,
    [GISZONEEXTERNALVALUEID]    CHAR (36) NOT NULL,
    [USERID]                    CHAR (36) NOT NULL,
    CONSTRAINT [PK_GISZoneToInspectorDesig] PRIMARY KEY CLUSTERED ([GISZONETOINSPECTORDESIGID] ASC) WITH (FILLFACTOR = 80),
    CONSTRAINT [FK_GISZoneToInspDesig_GISZoneExternalValue] FOREIGN KEY ([GISZONEEXTERNALVALUEID]) REFERENCES [dbo].[GISZONEEXTERNALVALUE] ([GISZONEEXTERNALVALUEID]),
    CONSTRAINT [FK_GISZoneToInspDesig_Users] FOREIGN KEY ([USERID]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO
CREATE NONCLUSTERED INDEX [GISZONETOINSPECTORDESIG_IX_GISZONEEXTERNALVALUEID]
    ON [dbo].[GISZONETOINSPECTORDESIG]([GISZONEEXTERNALVALUEID] ASC);


GO

CREATE TRIGGER [dbo].[TG_GISZONETOINSPECTORDESIG_DELETE] ON [dbo].[GISZONETOINSPECTORDESIG]
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [HISTORYSYSTEMSETUP]
    (	[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
    )

	SELECT
			[GISZONEMAPPING].[GISZONEMAPPINGID],
			[GISZONEMAPPING].[ROWVERSION],
			GETUTCDATE(),
			(SELECT dbo.UFN_GET_USERID_FROM_CONTEXT_INFO()),
			'Zone Inspector Mapping Zone Inspector Deleted',
			'',
			'',
			'Zone Inspector Mapping (' + [GISZONEMAPPING].[SOURCENAME] + '),  Zone Inspector (' + [USERS].[LNAME] + COALESCE(', ' + [USERS].[FNAME],'') + ')',			
			'D2A6823F-93FB-45DF-8F63-BE59E04D0E23',
			3,
			0,
			[USERS].[LNAME] + COALESCE(', ' + [USERS].[FNAME],'')
	FROM	[deleted]
	JOIN [GISZONEEXTERNALVALUE] ON [deleted].[GISZONEEXTERNALVALUEID] = GISZONEEXTERNALVALUE.GISZONEEXTERNALVALUEID
	JOIN [GISZONEMAPPING] ON [GISZONEEXTERNALVALUE].[GISZONEMAPPINGID] = GISZONEMAPPING.GISZONEMAPPINGID
	JOIN [USERS] WITH (NOLOCK) ON [deleted].[USERID] = USERS.SUSERGUID
END
GO

CREATE TRIGGER [TG_GISZONETOINSPECTORDESIG_INSERT] ON GISZONETOINSPECTORDESIG
	AFTER INSERT
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO [HISTORYSYSTEMSETUP]
	(
		[ID],
		[ROWVERSION],
		[CHANGEDON],
		[CHANGEDBY],
		[FIELDNAME],
		[OLDVALUE],
		[NEWVALUE],
		[ADDITIONALINFO],
		[FORMID],
		[ACTION],
		[ISROOT],
		[RECORDNAME]
	)
	SELECT 
			[GISZONEMAPPING].[GISZONEMAPPINGID],
			[GISZONEMAPPING].[ROWVERSION],
			GETUTCDATE(),
			[GISZONEMAPPING].[LASTCHANGEDBY],
			'Zone Inspector Mapping Zone Inspector Added',
			'',
			'',
			'Zone Inspector Mapping (' + [GISZONEMAPPING].[SOURCENAME] + '),  Zone Inspector (' + [USERS].[LNAME] + COALESCE(', ' + [USERS].[FNAME],'') + ')',			
			'D2A6823F-93FB-45DF-8F63-BE59E04D0E23',
			1,
			0,
			[USERS].[LNAME] + COALESCE(', ' + [USERS].[FNAME],'')
	FROM	[inserted]
	JOIN [GISZONEEXTERNALVALUE] ON [inserted].[GISZONEEXTERNALVALUEID] = GISZONEEXTERNALVALUE.GISZONEEXTERNALVALUEID
	JOIN [GISZONEMAPPING] ON [GISZONEEXTERNALVALUE].[GISZONEMAPPINGID] = GISZONEMAPPING.GISZONEMAPPINGID
	JOIN [USERS] WITH (NOLOCK) ON [inserted].[USERID] = USERS.SUSERGUID	
END