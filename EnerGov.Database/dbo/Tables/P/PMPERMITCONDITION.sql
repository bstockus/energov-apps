CREATE TABLE [dbo].[PMPERMITCONDITION] (
    [PMPERMITCONDITIONID] CHAR (36)   NOT NULL,
    [CONDITIONID]         CHAR (36)   NOT NULL,
    [PMPERMITID]          CHAR (36)   NOT NULL,
    [ISSATISFIED]         BIT         NOT NULL,
    [SCOPE]               INT         NOT NULL,
    [CREATEDON]           DATETIME    NULL,
    [ORDER]               VARCHAR (5) NULL,
    [CREATEDBY]           CHAR (36)   NULL,
    CONSTRAINT [PK_PermitCond] PRIMARY KEY CLUSTERED ([PMPERMITCONDITIONID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_PMPermitCond_conCond] FOREIGN KEY ([CONDITIONID]) REFERENCES [dbo].[CONDITION] ([CONDITIONID]),
    CONSTRAINT [FK_PMPermitCond_CondScope] FOREIGN KEY ([SCOPE]) REFERENCES [dbo].[CONDITIONSCOPE] ([CONDITIONSCOPEID]),
    CONSTRAINT [FK_PMPermitCond_PMPermit] FOREIGN KEY ([PMPERMITID]) REFERENCES [dbo].[PMPERMIT] ([PMPERMITID]),
    CONSTRAINT [FK_PMPERMITCONDITION_USERS] FOREIGN KEY ([CREATEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO
CREATE NONCLUSTERED INDEX [IX_PMPERMITCOND_PMPERMITID]
    ON [dbo].[PMPERMITCONDITION]([PMPERMITID] ASC) WITH (FILLFACTOR = 90);


GO


CREATE TRIGGER [TG_PMPERMITCONDITION_DELETE_ELASTIC_EREVIEW] ON  PMPERMITCONDITION
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[E].[ERPROJECTID] ,
        'EnerGovBusiness.PlanManagement.EProject' ,
        [E].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted]
	JOIN [PMPERMIT] AS [P] WITH (NOLOCK) ON [P].[PMPERMITID] = [Deleted].[PMPERMITID]
	JOIN [ERPROJECT] AS [E] WITH (NOLOCK) ON [E].[PMPERMITID] = [P].[PMPERMITID];

END
GO

CREATE TRIGGER [TG_PMPERMITCONDITION_INSERTUPDATE_ELASTIC_EREVIEW] ON  PMPERMITCONDITION
   AFTER INSERT, UPDATE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[E].[ERPROJECTID] ,
        'EnerGovBusiness.PlanManagement.EProject' ,
        [E].[ROWVERSION] ,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted]
	JOIN [PMPERMIT] AS [P] WITH (NOLOCK) ON [P].[PMPERMITID] = [Inserted].[PMPERMITID]
	JOIN [ERPROJECT] AS [E] WITH (NOLOCK) ON [E].[PMPERMITID] = [P].[PMPERMITID];

END