CREATE TABLE [dbo].[PLAPPLICATION] (
    [PLAPPLICATIONID]           CHAR (36)     NOT NULL,
    [APPNUMBER]                 NVARCHAR (50) NULL,
    [PLAPPLICATIONTYPEID]       CHAR (36)     NULL,
    [PLAPPLICATIONSTATUSID]     CHAR (36)     NULL,
    [APPLICATIONDATE]           DATETIME      NULL,
    [ROWVERSION]                INT           NOT NULL,
    [ASSIGNEDTO]                CHAR (36)     NULL,
    [DISTRICTID]                CHAR (36)     NULL,
    [LASTCHANGEDBY]             CHAR (36)     NULL,
    [LASTCHANGEDON]             DATETIME      NULL,
    [APPLICATIONPLPLANID]       CHAR (36)     NULL,
    [ASSETGEOMETRYCOLLECTIONID] CHAR (36)     NULL,
    [DESCRIPTION]               VARCHAR (MAX) NULL,
    [IMPORTCUSTOMFIELDLAYOUTID] CHAR (36)     NULL,
    [COMPLETEDATE]              DATETIME      NULL,
    CONSTRAINT [PK_PLApplication] PRIMARY KEY CLUSTERED ([PLAPPLICATIONID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_PLApp_AssetGeometryCollection] FOREIGN KEY ([ASSETGEOMETRYCOLLECTIONID]) REFERENCES [dbo].[ASSETGEOMETRYCOLLECTION] ([ASSETGEOMETRYCOLLECTIONID]),
    CONSTRAINT [FK_PLApplication_CustomField] FOREIGN KEY ([IMPORTCUSTOMFIELDLAYOUTID]) REFERENCES [dbo].[CUSTOMFIELDLAYOUT] ([GCUSTOMFIELDLAYOUTS]),
    CONSTRAINT [FK_PLApplication_District] FOREIGN KEY ([DISTRICTID]) REFERENCES [dbo].[DISTRICT] ([DISTRICTID]),
    CONSTRAINT [FK_PLApplication_PLApplicationStatus] FOREIGN KEY ([PLAPPLICATIONSTATUSID]) REFERENCES [dbo].[PLAPPLICATIONSTATUS] ([PLAPPLICATIONSTATUSID]),
    CONSTRAINT [FK_PLApplication_PLApplicationType] FOREIGN KEY ([PLAPPLICATIONTYPEID]) REFERENCES [dbo].[PLAPPLICATIONTYPE] ([PLAPPLICATIONTYPEID]),
    CONSTRAINT [FK_PLApplication_PLPlan] FOREIGN KEY ([APPLICATIONPLPLANID]) REFERENCES [dbo].[PLPLAN] ([PLPLANID]),
    CONSTRAINT [FK_PLApplication_Users] FOREIGN KEY ([ASSIGNEDTO]) REFERENCES [dbo].[USERS] ([SUSERGUID]),
    CONSTRAINT [FK_PLApplication_Users1] FOREIGN KEY ([LASTCHANGEDBY]) REFERENCES [dbo].[USERS] ([SUSERGUID])
);


GO

CREATE TRIGGER [TG_APPLICATION_UPDATE_ELASTIC] ON PLAPPLICATION
	AFTER UPDATE
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID(),
		[Inserted].[PLAPPLICATIONID],
		'EnerGovBusiness.PlanManagement.Application',
		[Inserted].[ROWVERSION],
		GETDATE(),
		NULL,
		2,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];
END
GO

CREATE TRIGGER [TG_APPLICATION_INSERT_ELASTIC] ON PLAPPLICATION
	AFTER INSERT
AS
BEGIN
	SET NOCOUNT ON;
	
	INSERT INTO [ELASTICSEARCHOBJECT]
	 ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT 
		NEWID(),
		[Inserted].[PLAPPLICATIONID],
		'EnerGovBusiness.PlanManagement.Application',
		[Inserted].[ROWVERSION],
		GETDATE(),
		NULL,
		1,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Inserted];
END
GO

CREATE TRIGGER [TG_APPLICATION_DELETE_ELASTIC] ON PLAPPLICATION
	AFTER DELETE
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID(),
		[Deleted].[PLAPPLICATIONID],
		'EnerGovBusiness.PlanManagement.Application',
		[Deleted].[ROWVERSION],
		GETDATE(),
		NULL,
		3,
		(SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted];
END