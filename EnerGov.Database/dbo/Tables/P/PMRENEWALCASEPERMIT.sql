CREATE TABLE [dbo].[PMRENEWALCASEPERMIT] (
    [PMRENEWALCASEID] CHAR (36) NOT NULL,
    [PMPERMITID]      CHAR (36) NOT NULL,
    CONSTRAINT [PK_PMRENEWALCASEPERMIT] PRIMARY KEY CLUSTERED ([PMRENEWALCASEID] ASC, [PMPERMITID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_PMRENEWAL_PERMIT] FOREIGN KEY ([PMPERMITID]) REFERENCES [dbo].[PMPERMIT] ([PMPERMITID]),
    CONSTRAINT [FK_PMRENEWALCASE] FOREIGN KEY ([PMRENEWALCASEID]) REFERENCES [dbo].[PMRENEWALCASE] ([PMRENEWALCASEID])
);


GO
CREATE NONCLUSTERED INDEX [IX_PMRENEWALCASEPERMIT_ATTACHEDCASEENTITY]
    ON [dbo].[PMRENEWALCASEPERMIT]([PMPERMITID] ASC);


GO
CREATE TRIGGER [TG_PMRENEWALCASEPERMIT_DELETE_ELASTIC] ON  PMRENEWALCASEPERMIT
   AFTER DELETE
AS 
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ELASTICSEARCHOBJECT]
    ( [ELASTICSEARCHOBJECTID] ,
        [OBJECTID] ,
        [OBJECTCLASSNAME] ,
        [ROWVERSION] ,
        [CREATEDATE] ,
        [PROCESSEDDATE] ,
        [OBJECTACTION] ,
        [INDEXNAME]
    )
	SELECT
		NEWID() ,
		[Deleted].[PMPERMITID] ,
        'EnerGovBusiness.PermitManagement.Permit' ,
       (SElECT TOP 1 ROWVERSION FROM PMPERMIT WITH (NOLOCK) WHERE PMPERMIT.PMPERMITID = [deleted].PMPERMITID) AS ROWVERSION,
        GETDATE() ,
        NULL ,
        2 ,
        (SELECT STRINGVALUE FROM SETTINGS WITH (NOLOCK) WHERE NAME = 'ServiceBusTenant')
	FROM [Deleted];

END