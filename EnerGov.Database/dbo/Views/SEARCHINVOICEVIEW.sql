
CREATE VIEW [dbo].[SEARCHINVOICEVIEW]
AS

SELECT TOP 100 PERCENT
      CAINVOICE.CAINVOICEID,
      CAINVOICE.INVOICENUMBER,
      CAINVOICE.INVOICEDESCRIPTION,
      CAINVOICE.INVOICEDATE,
      CAINVOICE.INVOICEDUEDATE,
      CAINVOICE.CASTATUSID,
      (SELECT NAME FROM CASTATUS WHERE CASTATUSID = CAINVOICE.CASTATUSID) AS 'STATUSNAME',
      GLOBALENTITY.FIRSTNAME,
      GLOBALENTITY.LASTNAME,
      GLOBALENTITY.GLOBALENTITYNAME,
      GLOBALENTITY.GLOBALENTITYID,
      COALESCE(
            (SELECT TOP 1 PLPLAN.PLANNUMBER AS NUMBER
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
            (SELECT TOP 1 PMPERMIT.PERMITNUMBER AS NUMBER
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            (SELECT TOP 1 PLAPPLICATION.APPNUMBER AS NUMBER
                  FROM PLAPPLICATION
                  INNER JOIN PLAPPLICATIONFEE ON PLAPPLICATIONFEE.PLAPPLICATIONID = PLAPPLICATION.PLAPPLICATIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLAPPLICATIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            (SELECT TOP 1 PRPROJECT.PROJECTNUMBER AS NUMBER
                  FROM PRPROJECT
                  INNER JOIN PRPROJECTFEE ON PRPROJECTFEE.PRPROJECTID = PRPROJECT.PRPROJECTID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PRPROJECTFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			(SELECT TOP 1 BLLICENSE.LICENSENUMBER AS NUMBER
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
             (SELECT TOP 1 BLGLOBALENTITYEXTENSION.REGISTRATIONID AS NUMBER
                  FROM BLGLOBALENTITYEXTENSION
                  INNER JOIN BLGLOBALENTITYEXTENSIONFEE ON BLGLOBALENTITYEXTENSIONFEE.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLGLOBALENTITYEXTENSIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			(SELECT TOP 1 ILLICENSE.LICENSENUMBER AS NUMBER
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			(SELECT TOP 1 IMINSPECTION.INSPECTIONNUMBER AS NUMBER
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            (SELECT TOP 1 CMCODECASE.CASENUMBER AS NUMBER
                  FROM CMCODECASE
                  INNER JOIN CMCODECASEFEE ON CMCODECASEFEE.CMCODECASEID = CMCODECASE.CMCODECASEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            (SELECT TOP 1 CMCODECASE.CASENUMBER AS NUMBER
                  FROM CMCODECASE
                  INNER JOIN CMCODEWFSTEP ON CMCODEWFSTEP.CMCODECASEID = CMCODECASE.CMCODECASEID
                  INNER JOIN CMVIOLATION ON CMVIOLATION.CMCODEWFSTEPID = CMCODEWFSTEP.CMCODEWFSTEPID
                  INNER JOIN CMVIOLATIONFEE ON CMVIOLATION.CMVIOLATIONID = CMVIOLATION.CMVIOLATIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CMVIOLATIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			-- Rental Property Additions TS1025
			(SELECT TOP 1 RPPROPERTY.PROPERTYNUMBER AS NUMBER
                  FROM RPPROPERTY
                  INNER JOIN RPPROPERTYFEE ON RPPROPERTYFEE.RPPROPERTYID = RPPROPERTY.RPPROPERTYID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = RPPROPERTYFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			(SELECT TOP 1 RPLANDLORDLICENSE.LANDLORDNUMBER AS NUMBER
                  FROM RPLANDLORDLICENSE
                  INNER JOIN RPLANDLORDLICENSEFEE ON RPLANDLORDLICENSEFEE.RPLANDLORDLICENSEID = RPLANDLORDLICENSE.RPLANDLORDLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = RPLANDLORDLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
			 (SELECT TOP 1 TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER AS "NUMBER"
                  FROM TXREMITTANCEACCOUNT, TXREMITTANCE, CAINVOICEFEE, TXREMITTANCEFEE 
                  WHERE TXREMITTANCEFEE.TXREMITTANCEID = TXREMITTANCE.TXREMITTANCEID
				  AND TXREMITTANCE.TXREMITTANCEACCOUNTID = TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID
                  AND CAINVOICEFEE.CACOMPUTEDFEEID = TXREMITTANCEFEE.CACOMPUTEDFEEID
                  AND CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID
                  ),
			(SELECT TOP 1 IPCONDITION.CONDITIONNUMBER AS NUMBER
                  FROM IPCONDITION
                  INNER JOIN IPCONDITIONFEE ON IPCONDITIONFEE.IPCONDITIONID = IPCONDITION.IPCONDITIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IPCONDITIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 			
            ''
      ) AS ENTITYNUMBER
FROM CAINVOICE
INNER JOIN GLOBALENTITY ON GLOBALENTITY.GLOBALENTITYID = CAINVOICE.GLOBALENTITYID
UNION
SELECT     TOP (100) PERCENT dbo.CAINVOICE.CAINVOICEID, dbo.CAINVOICE.INVOICENUMBER, dbo.CAINVOICE.INVOICEDESCRIPTION, dbo.CAINVOICE.INVOICEDATE, 
                      dbo.CAINVOICE.INVOICEDUEDATE, dbo.CAINVOICE.CASTATUSID,
                          (SELECT     NAME
                            FROM          dbo.CASTATUS
                            WHERE      (CASTATUSID = dbo.CAINVOICE.CASTATUSID)) AS STATUSNAME, dbo.GLOBALENTITY.FIRSTNAME, dbo.GLOBALENTITY.LASTNAME, 
                      dbo.GLOBALENTITY.GLOBALENTITYNAME, dbo.GLOBALENTITY.GLOBALENTITYID, COALESCE
                          ((SELECT     TOP (1) dbo.PLPLAN.PLANNUMBER AS NUMBER
                              FROM         dbo.PLPLAN INNER JOIN
                                                    dbo.PLPLANFEE ON dbo.PLPLANFEE.PLPLANID = dbo.PLPLAN.PLPLANID INNER JOIN
                                                    dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.PLPLANFEE.CACOMPUTEDFEEID
                              WHERE     (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.PMPERMIT.PERMITNUMBER AS NUMBER
                            FROM          dbo.PMPERMIT INNER JOIN
                                                   dbo.PMPERMITFEE ON dbo.PMPERMITFEE.PMPERMITID = dbo.PMPERMIT.PMPERMITID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.PMPERMITFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.PLAPPLICATION.APPNUMBER AS NUMBER
                            FROM          dbo.PLAPPLICATION INNER JOIN
                                                   dbo.PLAPPLICATIONFEE ON dbo.PLAPPLICATIONFEE.PLAPPLICATIONID = dbo.PLAPPLICATION.PLAPPLICATIONID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.PLAPPLICATIONFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.PRPROJECT.PROJECTNUMBER AS NUMBER
                            FROM          dbo.PRPROJECT INNER JOIN
                                                   dbo.PRPROJECTFEE ON dbo.PRPROJECTFEE.PRPROJECTID = dbo.PRPROJECT.PRPROJECTID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.PRPROJECTFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.BLLICENSE.LICENSENUMBER AS NUMBER
                            FROM          dbo.BLLICENSE INNER JOIN
                                                   dbo.BLLICENSEFEE ON dbo.BLLICENSEFEE.BLLICENSEID = dbo.BLLICENSE.BLLICENSEID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.BLLICENSEFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                            (SELECT     TOP (1) dbo.BLGLOBALENTITYEXTENSION.REGISTRATIONID AS NUMBER
                            FROM          dbo.BLGLOBALENTITYEXTENSION INNER JOIN
                                                   dbo.BLGLOBALENTITYEXTENSIONFEE ON dbo.BLGLOBALENTITYEXTENSIONFEE.BLGLOBALENTITYEXTENSIONID = dbo.BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.BLGLOBALENTITYEXTENSIONFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.ILLICENSE.LICENSENUMBER AS NUMBER
                            FROM          dbo.ILLICENSE INNER JOIN
                                                   dbo.ILLICENSEFEE ON dbo.ILLICENSEFEE.ILLICENSEID = dbo.ILLICENSE.ILLICENSEID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.ILLICENSEFEE.CACOMPUTEDFEEID
							WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
						  (SELECT     TOP (1) dbo.IMINSPECTION.INSPECTIONNUMBER AS NUMBER
                            FROM          dbo.IMINSPECTION INNER JOIN
                                                   dbo.IMINSPECTIONFEE ON dbo.IMINSPECTIONFEE.IMINSPECTIONID = dbo.IMINSPECTION.IMINSPECTIONID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.IMINSPECTIONFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.CMCODECASE.CASENUMBER AS NUMBER
                            FROM          dbo.CMCODECASE INNER JOIN
                                                   dbo.CMCODECASEFEE ON dbo.CMCODECASEFEE.CMCODECASEID = dbo.CMCODECASE.CMCODECASEID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.CMCODECASEFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.CMCODECASE.CASENUMBER AS NUMBER
                            FROM          dbo.CMCODECASE INNER JOIN
                                                   dbo.CMCODEWFSTEP ON dbo.CMCODEWFSTEP.CMCODECASEID = dbo.CMCODECASE.CMCODECASEID INNER JOIN
                                                   dbo.CMVIOLATION ON dbo.CMVIOLATION.CMCODEWFSTEPID = dbo.CMCODEWFSTEP.CMCODEWFSTEPID INNER JOIN
                                                   dbo.CMVIOLATIONFEE ON dbo.CMVIOLATION.CMVIOLATIONID = dbo.CMVIOLATION.CMVIOLATIONID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.CMVIOLATIONFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.RPPROPERTY.PROPERTYNUMBER AS NUMBER
                            FROM          dbo.RPPROPERTY INNER JOIN
                                                   dbo.RPPROPERTYFEE ON dbo.RPPROPERTYFEE.RPPROPERTYID = dbo.RPPROPERTY.RPPROPERTYID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.RPPROPERTYFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
						  (SELECT     TOP (1) dbo.IPCONDITION.CONDITIONNUMBER AS NUMBER
                            FROM          dbo.IPCONDITION INNER JOIN
                                                   dbo.IPCONDITIONFEE ON dbo.IPCONDITIONFEE.IPCONDITIONID = dbo.IPCONDITION.IPCONDITIONID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.IPCONDITIONFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.RPLANDLORDLICENSE.LANDLORDNUMBER AS NUMBER
                            FROM          dbo.RPLANDLORDLICENSE INNER JOIN
                                                   dbo.RPLANDLORDLICENSEFEE ON 
                                                   dbo.RPLANDLORDLICENSEFEE.RPLANDLORDLICENSEID = dbo.RPLANDLORDLICENSE.RPLANDLORDLICENSEID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.CAINVOICEFEE.CACOMPUTEDFEEID = dbo.RPLANDLORDLICENSEFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)),
                          (SELECT     TOP (1) dbo.TXREMITTANCEACCOUNT.REMITTANCEACCOUNTNUMBER AS NUMBER
                            FROM          dbo.TXREMITTANCEFEE INNER JOIN
                                                   dbo.TXREMITTANCE ON dbo.TXREMITTANCEFEE.TXREMITTANCEID = dbo.TXREMITTANCE.TXREMITTANCEID INNER JOIN
                                                   dbo.TXREMITTANCEACCOUNT ON 
                                                   dbo.TXREMITTANCE.TXREMITTANCEACCOUNTID = dbo.TXREMITTANCEACCOUNT.TXREMITTANCEACCOUNTID INNER JOIN
                                                   dbo.CAINVOICEFEE ON dbo.TXREMITTANCEFEE.CACOMPUTEDFEEID = dbo.CAINVOICEFEE.CACOMPUTEDFEEID
                            WHERE      (dbo.CAINVOICEFEE.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID)), '') AS ENTITYNUMBER
FROM         dbo.CAINVOICE 
INNER JOIN dbo.CAINVOICECONTACT ON dbo.CAINVOICECONTACT.CAINVOICEID = dbo.CAINVOICE.CAINVOICEID
INNER JOIN dbo.GLOBALENTITY ON dbo.GLOBALENTITY.GLOBALENTITYID = dbo.CAINVOICECONTACT.GLOBALENTITYID
-- WHERE CAINVOICE.CASTATUSID <> 5 -- VOID  remove the exclusion of the VOID status INVOICE
ORDER BY CAINVOICE.INVOICENUMBER