



CREATE VIEW [dbo].[PORTALINVOICEFEETEST]
AS
SELECT CAINVOICEFEEID,
	   CAINVOICEID,
	   FEENAME,
	   FEETOTAL,
	   AMOUNTDUE,
	   NOTES,	   
	    COALESCE(
            (SELECT TOP 1 PLPLAN.PLANNUMBER AS "REFERENCEENTITY"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID), 
            (SELECT TOP 1 PMPERMIT.PERMITNUMBER AS "REFERENCEENTITY"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                       
            (SELECT TOP 1 BLLICENSE.LICENSENUMBER AS "REFERENCEENTITY"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),           
            (SELECT TOP 1 IMINSPECTION.INSPECTIONNUMBER AS "REFERENCEENTITY"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                            
              NULL                
        ) AS REFERENCEENTITY,
		 COALESCE(
            (SELECT TOP 1 'Plan' AS "ENTITY"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                   
            (SELECT TOP 1 'Permit' AS "ENTITY"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                                       
            (SELECT TOP 1 'Business License' AS "ENTITY"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                   
            (SELECT TOP 1 'Inspection' AS "ENTITY"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                                              
              NULL                
        ) AS ENTITY
 FROM (
SELECT TOP 100 PERCENT  CAINVOICEFEE.CAINVOICEFEEID,
          CAINVOICEFEE.CAINVOICEID,
          CACOMPUTEDFEE.FEENAME,
          CACOMPUTEDFEE.COMPUTEDAMOUNT AS FEETOTAL,
          (CACOMPUTEDFEE.COMPUTEDAMOUNT - CACOMPUTEDFEE.AMOUNTPAIDTODATE) AS AMOUNTDUE,          
          CACOMPUTEDFEE.NOTES                    
FROM CAINVOICEFEE
INNER JOIN CACOMPUTEDFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID) 
INVOICEFEE