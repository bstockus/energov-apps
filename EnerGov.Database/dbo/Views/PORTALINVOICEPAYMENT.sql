
CREATE VIEW [dbo].[PORTALINVOICEPAYMENT]
AS
SELECT  CAINVOICEID,
        RECEIPTNUMBER,
        STATUS,
        CATRANSACTIONTYPEID,
        TRANSACTIONTYPE,
        PAYMENTTYPE,
        (CASE WHEN CATRANSACTIONTYPEID = 4 OR CATRANSACTIONTYPEID = 5 OR CATRANSACTIONTYPEID = 6 THEN 0 ELSE PAYMENTAMOUNT END) AS PAYMENTAMOUNT,
        PAYMENTDATE
FROM        
(SELECT  CATRANSACTIONINVOICE.CAINVOICEID,
        CATRANSACTION.RECEIPTNUMBER,
        CATRANSACTIONSTATUS.NAME AS STATUS,
        CATRANSACTION.CATRANSACTIONTYPEID,
        CATRANSACTIONTYPE.NAME AS TRANSACTIONTYPE,
        CAPAYMENTMETHOD.NAME AS PAYMENTTYPE,
        CATRANSACTIONPAYMENT.PAYMENTAMOUNT,
        CATRANSACTIONPAYMENT.PAYMENTDATE
FROM    CATRANSACTION
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID = CATRANSACTION.CATRANSACTIONSTATUSID
INNER JOIN CATRANSACTIONINVOICE ON CATRANSACTIONINVOICE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTIONPAYMENT.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
INNER JOIN CATRANSACTIONTYPE ON CATRANSACTION.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID
UNION
SELECT  CATRANSACTIONINVOICE.CAINVOICEID,
        C2.RECEIPTNUMBER,
        CATRANSACTIONSTATUS.NAME AS STATUS,
        C2.CATRANSACTIONTYPEID,
        CATRANSACTIONTYPE.NAME AS TRANSACTIONTYPE,
        CAPAYMENTMETHOD.NAME AS PAYMENTTYPE,
        CATRANSACTIONPAYMENT.PAYMENTAMOUNT,
        CATRANSACTIONPAYMENT.PAYMENTDATE
FROM CATRANSACTION C2
INNER JOIN CATRANSACTIONINVOICE ON CATRANSACTIONINVOICE.CATRANSACTIONID = C2.CATRANSACTIONID
INNER JOIN CATRANSACTION C1 ON C1.PARENTTRANSACTIONID = C2.CATRANSACTIONID
INNER JOIN CATRANSACTIONSTATUS ON CATRANSACTIONSTATUS.CATRANSACTIONSTATUSID = C2.CATRANSACTIONSTATUSID
INNER JOIN CATRANSACTIONPAYMENT ON CATRANSACTIONPAYMENT.CATRANSACTIONID = C2.CATRANSACTIONID
INNER JOIN CAPAYMENTMETHOD ON CATRANSACTIONPAYMENT.CAPAYMENTMETHODID = CAPAYMENTMETHOD.CAPAYMENTMETHODID
INNER JOIN CATRANSACTIONTYPE ON C2.CATRANSACTIONTYPEID = CATRANSACTIONTYPE.CATRANSACTIONTYPEID) INVOICEPAYMENT

