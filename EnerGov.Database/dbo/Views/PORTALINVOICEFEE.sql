
CREATE VIEW [dbo].[PORTALINVOICEFEE]
AS
SELECT CAINVOICEFEEID,
	   CAINVOICEID,
	   FEENAME,
	   FEETOTAL,
	   AMOUNTDUE,
	   NOTES,	   
	    COALESCE(
            (SELECT TOP 1 PLPLAN.PLANNUMBER AS "REFERENCEENTITY"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID), 
            (SELECT TOP 1 PMPERMIT.PERMITNUMBER AS "REFERENCEENTITY"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                       
            (SELECT TOP 1 BLLICENSE.LICENSENUMBER AS "REFERENCEENTITY"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
            (SELECT TOP 1 BLGLOBALENTITYEXTENSION.REGISTRATIONID AS "REFERENCEENTITY"
                  FROM BLGLOBALENTITYEXTENSION
                  INNER JOIN BLGLOBALENTITYEXTENSIONFEE ON BLGLOBALENTITYEXTENSIONFEE.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLGLOBALENTITYEXTENSIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
		    (SELECT TOP 1 ILLICENSE.LICENSENUMBER AS "REFERENCEENTITY"
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),          
            (SELECT TOP 1 IMINSPECTION.INSPECTIONNUMBER AS "REFERENCEENTITY"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
            (SELECT TOP 1 PLAPPLICATION.APPNUMBER AS "REFERENCEENTITY"
                  FROM PLAPPLICATION
                  INNER JOIN PLAPPLICATIONFEE ON PLAPPLICATIONFEE.PLAPPLICATIONID = PLAPPLICATION.PLAPPLICATIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLAPPLICATIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
		    (SELECT TOP 1 CMCODECASE.CASENUMBER AS "REFERENCEENTITY"
                  FROM CMCODECASE
                  INNER JOIN CMCODECASEFEE ON CMCODECASEFEE.CMCODECASEID = CMCODECASE.CMCODECASEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),  
		    (SELECT TOP 1 CM.CASENUMBER AS "REFERENCEENTITY"
                  FROM CMCODECASE CM
                  INNER JOIN CMCODEWFSTEP CWFS ON CM.CMCODECASEID = CWFS.CMCODECASEID 
				  INNER JOIN CMVIOLATION CMV ON CWFS.CMCODEWFSTEPID = CMV.CMCODEWFSTEPID 
				  INNER JOIN CMVIOLATIONFEE CMVF ON CMV.CMVIOLATIONID = CMVF.CMVIOLATIONID 
				  INNER JOIN CACOMPUTEDFEE CACOMPUTEDFEE ON CMVF.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
				  INNER JOIN  CAINVOICEFEE AS CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
				  INNER JOIN  CAINVOICE AS CAINVOICE ON CAINVOICE.CAINVOICEID = CAINVOICEFEE.CAINVOICEID 
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                            
              NULL                
        ) AS REFERENCEENTITY,
		 COALESCE(
            (SELECT TOP 1 'Plan' AS "ENTITY"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                   
            (SELECT TOP 1 'Permit' AS "ENTITY"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                                       
            (SELECT TOP 1 'Business License' AS "ENTITY"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
             (SELECT TOP 1 'Business' AS "ENTITY"
                  FROM BLGLOBALENTITYEXTENSION
                  INNER JOIN BLGLOBALENTITYEXTENSIONFEE ON BLGLOBALENTITYEXTENSIONFEE.BLGLOBALENTITYEXTENSIONID = BLGLOBALENTITYEXTENSION.BLGLOBALENTITYEXTENSIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLGLOBALENTITYEXTENSIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
		    (SELECT TOP 1 'Professional License' AS "ENTITY"
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                
            (SELECT TOP 1 'Inspection' AS "ENTITY"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
            (SELECT TOP 1 'Application' AS "ENTITY"
                  FROM PLAPPLICATION
                  INNER JOIN PLAPPLICATIONFEE ON PLAPPLICATIONFEE.PLAPPLICATIONID = PLAPPLICATION.PLAPPLICATIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLAPPLICATIONFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),
		    (SELECT TOP 1 'Code Case' AS "ENTITY"
                  FROM CMCODECASE
                  INNER JOIN CMCODECASEFEE ON CMCODECASEFEE.CMCODECASEID = CMCODECASE.CMCODECASEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CMCODECASEFEE.CACOMPUTEDFEEID
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),   
		    (SELECT TOP 1 'Code Case' AS "ENTITY"
                  FROM CMCODECASE CM
                  INNER JOIN CMCODEWFSTEP CWFS ON CM.CMCODECASEID = CWFS.CMCODECASEID 
				  INNER JOIN CMVIOLATION CMV ON CWFS.CMCODEWFSTEPID = CMV.CMCODEWFSTEPID 
				  INNER JOIN CMVIOLATIONFEE CMVF ON CMV.CMVIOLATIONID = CMVF.CMVIOLATIONID 
				  INNER JOIN CACOMPUTEDFEE CACOMPUTEDFEE ON CMVF.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID
				  INNER JOIN  CAINVOICEFEE AS CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID 
				  INNER JOIN  CAINVOICE AS CAINVOICE ON CAINVOICE.CAINVOICEID = CAINVOICEFEE.CAINVOICEID 
				  WHERE CAINVOICEFEE.CAINVOICEFEEID = INVOICEFEE.CAINVOICEFEEID),                                                             
              NULL                
        ) AS ENTITY
 FROM (
SELECT TOP 100 PERCENT  CAINVOICEFEE.CAINVOICEFEEID,
          CAINVOICEFEE.CAINVOICEID,
          CACOMPUTEDFEE.FEENAME,
          CACOMPUTEDFEE.COMPUTEDAMOUNT AS FEETOTAL,
          (CACOMPUTEDFEE.COMPUTEDAMOUNT - CAINVOICEFEE.PAIDAMOUNT) AS AMOUNTDUE,          
          CACOMPUTEDFEE.NOTES                    
FROM CAINVOICEFEE
INNER JOIN CACOMPUTEDFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = CACOMPUTEDFEE.CACOMPUTEDFEEID) 
INVOICEFEE