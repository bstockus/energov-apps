

CREATE VIEW dbo.CSSINVOICEVIEW
AS
SELECT      CAINVOICEID,
            INVOICENUMBER,
            INVOICEDESCRIPTION,
            INVOICEDATE,
            INVOICEDUEDATE,
            CASTATUSID,
            STATUSNAME,
            INVOICETOTAL,
            (CASE WHEN PAIDTODATE IS NULL THEN 0 ELSE PAIDTODATE END) AS PAIDTODATE,
            (CASE WHEN TOTALDUE IS NULL THEN INVOICETOTAL ELSE TOTALDUE END) AS TOTALDUE,
            LASTPAIDDATE,
            GLOBALENTITYID,
			ENTITYTYPE,
            ENTITYNUMBER,
            FULLADDRESS
FROM 
(SELECT TOP 100 PERCENT
      CAINVOICE.CAINVOICEID,
      CAINVOICE.INVOICENUMBER,
      CAINVOICE.INVOICEDESCRIPTION,
      CAINVOICE.INVOICEDATE,
      CAINVOICE.INVOICEDUEDATE,
      CAINVOICE.CASTATUSID,
      (SELECT NAME FROM CASTATUS WHERE CASTATUSID = CAINVOICE.CASTATUSID) AS 'STATUSNAME',
        CAINVOICE.INVOICETOTAL,
        (SELECT SUM(CATRANSACTIONINVOICE.PAIDAMOUNT) FROM CATRANSACTIONINVOICE WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS PAIDTODATE,
        (SELECT CAINVOICE.INVOICETOTAL - SUM(CATRANSACTIONINVOICE.PAIDAMOUNT) FROM CATRANSACTIONINVOICE WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS TOTALDUE, 
        (SELECT MAX(CATRANSACTION.TRANSACTIONDATE) FROM CATRANSACTION
      LEFT OUTER JOIN CATRANSACTIONINVOICE ON CATRANSACTIONINVOICE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS LASTPAIDDATE,      
      GLOBALENTITY.GLOBALENTITYID,
	  COALESCE(
            (SELECT TOP 1 2 AS "ENTITYTYPE"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
            (SELECT TOP 1 3 AS "ENTITYTYPE"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),             
                  (SELECT TOP 1 5 AS "ENTITYTYPE"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),   
				  (SELECT TOP 1 11 AS "ENTITYTYPE"
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),              
                  (SELECT TOP 1 4 AS "ENTITYTYPE"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),                                                                
            1
      ) AS ENTITYTYPE,
        COALESCE(
            (SELECT TOP 1 PLPLAN.PLANNUMBER AS NUMBER
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
            (SELECT TOP 1 PMPERMIT.PERMITNUMBER AS NUMBER
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 BLLICENSE.LICENSENUMBER AS NUMBER
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
				   (SELECT TOP 1 ILLICENSE.LICENSENUMBER AS NUMBER
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
                  (SELECT TOP 1 IMINSPECTION.INSPECTIONNUMBER AS NUMBER
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),    
            ''
      ) AS ENTITYNUMBER,
        COALESCE(
            (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "FULLADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN PMPERMITADDRESS on PMPERMITADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMITADDRESS.PMPERMITID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN PLPLANADDRESS on PLPLANADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLANADDRESS.PLPLANID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN BLLICENSEADDRESS on BLLICENSEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSEADDRESS.BLLICENSEID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
				 (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN ILLICENSEADDRESS on ILLICENSEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSEADDRESS.ILLICENSEID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN IMINSPECTIONADDRESS on IMINSPECTIONADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTIONADDRESS.IMINSPECTIONID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            ''
      ) AS FULLADDRESS
FROM CAINVOICE

INNER JOIN GLOBALENTITY ON GLOBALENTITY.GLOBALENTITYID = CAINVOICE.GLOBALENTITYID
LEFT JOIN CAINVOICECONTACT ON CAINVOICECONTACT.CAINVOICEID = CAINVOICE.CAINVOICEID WHERE CAINVOICECONTACT.GLOBALENTITYID IS NULL

UNION ALL
SELECT  TOP (100) PERCENT 
            CAINVOICE.CAINVOICEID, 
            CAINVOICE.INVOICENUMBER, 
            CAINVOICE.INVOICEDESCRIPTION, 
            CAINVOICE.INVOICEDATE,                       
            CAINVOICE.INVOICEDUEDATE, 
            CAINVOICE.CASTATUSID,
            (SELECT NAME FROM CASTATUS WHERE CASTATUSID = CAINVOICE.CASTATUSID) AS 'STATUSNAME',
        CAINVOICE.INVOICETOTAL,
            (SELECT SUM(CATRANSACTIONINVOICE.PAIDAMOUNT) FROM CATRANSACTIONINVOICE WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS PAIDTODATE,
            (SELECT CAINVOICE.INVOICETOTAL - SUM(CATRANSACTIONINVOICE.PAIDAMOUNT) FROM CATRANSACTIONINVOICE WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS TOTALDUE, 
            (SELECT MAX(CATRANSACTION.TRANSACTIONDATE) FROM CATRANSACTION
        LEFT OUTER JOIN CATRANSACTIONINVOICE ON CATRANSACTIONINVOICE.CATRANSACTIONID = CATRANSACTION.CATRANSACTIONID WHERE CATRANSACTIONINVOICE.CAINVOICEID = CAINVOICE.CAINVOICEID) AS LASTPAIDDATE,      
        CAINVOICECONTACT.GLOBALENTITYID, 
		COALESCE(
            (SELECT TOP 1 2 AS "ENTITYTYPE"
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
            (SELECT TOP 1 3 AS "ENTITYTYPE"
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),             
                  (SELECT TOP 1 5 AS "ENTITYTYPE"
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),  
				  (SELECT TOP 1 11 AS "ENTITYTYPE"
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),                 
                  (SELECT TOP 1 4 AS "ENTITYTYPE"
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),                                                                
            1
      ) AS ENTITYTYPE,
         COALESCE(
            (SELECT TOP 1 PLPLAN.PLANNUMBER AS NUMBER
                  FROM PLPLAN
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLAN.PLPLANID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
            (SELECT TOP 1 PMPERMIT.PERMITNUMBER AS NUMBER
                  FROM PMPERMIT
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMIT.PMPERMITID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 BLLICENSE.LICENSENUMBER AS NUMBER
                  FROM BLLICENSE
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSE.BLLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
				  (SELECT TOP 1 ILLICENSE.LICENSENUMBER AS NUMBER
                  FROM ILLICENSE
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSE.ILLICENSEID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID), 
                  (SELECT TOP 1 IMINSPECTION.INSPECTIONNUMBER AS NUMBER
                  FROM IMINSPECTION
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTION.IMINSPECTIONID
                  INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),    
            ''
      ) AS ENTITYNUMBER,
        COALESCE(
            (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN PMPERMITADDRESS on PMPERMITADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN PMPERMITFEE ON PMPERMITFEE.PMPERMITID = PMPERMITADDRESS.PMPERMITID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PMPERMITFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN PLPLANADDRESS on PLPLANADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN PLPLANFEE ON PLPLANFEE.PLPLANID = PLPLANADDRESS.PLPLANID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = PLPLANFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN BLLICENSEADDRESS on BLLICENSEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN BLLICENSEFEE ON BLLICENSEFEE.BLLICENSEID = BLLICENSEADDRESS.BLLICENSEID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = BLLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),

		(SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN ILLICENSEADDRESS on ILLICENSEADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN ILLICENSEFEE ON ILLICENSEFEE.ILLICENSEID = ILLICENSEADDRESS.ILLICENSEID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = ILLICENSEFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
                  (SELECT TOP 1 RTRIM(
                        CASE WHEN LEN(ADDRESSLINE1) > 0 THEN ADDRESSLINE1 + ' ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE <> 1 AND LEN(PREDIRECTION) > 0 THEN PREDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE2) > 0 THEN ADDRESSLINE2 + ' ' ELSE '' END + 
                        CASE WHEN LEN(STREETTYPE) > 0 THEN STREETTYPE + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTDIRECTION) > 0 THEN POSTDIRECTION + ' ' ELSE '' END + 
                        CASE WHEN LEN(UNITORSUITE) > 0 THEN UNITORSUITE + ' ' ELSE '' END + 
                        CASE WHEN LEN(ADDRESSLINE3) > 0 THEN ADDRESSLINE3 + ' ' ELSE '' END + 
                        CASE WHEN LEN(CITY) > 0 THEN CITY + ', ' ELSE '' END + 
                        CASE WHEN COUNTRYTYPE = 1 AND LEN(PROVINCE) > 0 THEN PROVINCE + ' ' WHEN COUNTRYTYPE <> 1 AND LEN([STATE]) > 0 THEN [STATE] + ' ' ELSE '' END + 
                        CASE WHEN LEN(POSTALCODE) > 0 THEN POSTALCODE ELSE '' END
                        ) AS "ADDRESS"
                  FROM MAILINGADDRESS
                  INNER JOIN IMINSPECTIONADDRESS on IMINSPECTIONADDRESS.MAILINGADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
                  INNER JOIN IMINSPECTIONFEE ON IMINSPECTIONFEE.IMINSPECTIONID = IMINSPECTIONADDRESS.IMINSPECTIONID
                          INNER JOIN CAINVOICEFEE ON CAINVOICEFEE.CACOMPUTEDFEEID = IMINSPECTIONFEE.CACOMPUTEDFEEID
                  WHERE CAINVOICEFEE.CAINVOICEID = CAINVOICE.CAINVOICEID),
            ''
      ) AS FULLADDRESS
FROM   CAINVOICE 
INNER JOIN CAINVOICECONTACT ON CAINVOICECONTACT.CAINVOICEID = CAINVOICE.CAINVOICEID
) INVOICEVIEW
