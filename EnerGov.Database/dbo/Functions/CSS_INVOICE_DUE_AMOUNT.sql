

CREATE FUNCTION [dbo].[CSS_INVOICE_DUE_AMOUNT]
(
	@INVOICE_ID CHAR(36),
	@CA_STATUS INT,
	@INVOICE_TOTAL MONEY
)
RETURNS MONEY
AS
BEGIN
	DECLARE @RESULT AS MONEY
	DECLARE @TEMP AS MONEY
	IF(@CA_STATUS NOT IN (3,8))
	BEGIN
		SET @RESULT = @INVOICE_TOTAL
	END
	ELSE
	BEGIN
		SELECT @TEMP = SUM(CAMISCFEE.AMOUNT - CAMISCFEE.PAIDAMOUNT)
			FROM CAMISCFEE
			INNER JOIN CAINVOICEMISCFEE ON CAINVOICEMISCFEE.CAMISCFEEID = CAMISCFEE.CAMISCFEEID
			WHERE CAINVOICEMISCFEE.CAINVOICEID = @INVOICE_ID
		IF @TEMP IS NULL 
		SET @TEMP = 0
		SET @RESULT = @TEMP

		SELECT @TEMP = SUM(CACOMPUTEDFEE.COMPUTEDAMOUNT - CACOMPUTEDFEE.AMOUNTPAIDTODATE)
			FROM CAINVOICEFEE
			INNER JOIN CACOMPUTEDFEE ON CACOMPUTEDFEE.CACOMPUTEDFEEID = CAINVOICEFEE.CACOMPUTEDFEEID
			WHERE CAINVOICEFEE.CAINVOICEID = @INVOICE_ID
		
		IF @TEMP IS NULL 
		SET @TEMP = 0
		SET @RESULT = @RESULT + @TEMP
	END
	
	RETURN @RESULT
END