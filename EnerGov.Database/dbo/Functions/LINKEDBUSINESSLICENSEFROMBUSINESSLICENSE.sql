CREATE FUNCTION DBO.LINKEDBUSINESSLICENSEFROMBUSINESSLICENSE
(	
	@ENTITY_ID char(36),
	@USER_ID char(36),
	@BLLICENSETYPEMODULE_ID INT
)
RETURNS TABLE 
AS
RETURN 
(    
	SELECT BLLICENSE.BLLICENSEID FROM BLLICENSEWFSTEP 
	INNER JOIN BLLICENSEWFACTIONSTEP ON BLLICENSEWFSTEP.BLLICENSEWFSTEPID = BLLICENSEWFACTIONSTEP.BLLICENSEWFSTEPID 
	INNER JOIN BLLICENSEACTIONREF ON BLLICENSEWFACTIONSTEP.BLLICENSEWFACTIONSTEPID = BLLICENSEACTIONREF.OBJECTID 
	INNER JOIN BLLICENSE ON BLLICENSEACTIONREF.BLLICENSEID = BLLICENSE.BLLICENSEID 
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on BLLICENSE.BLLICENSETYPEID = u.RECORDTYPEID
	INNER JOIN BLLICENSETYPE ON BLLICENSETYPE.BLLICENSETYPEID= BLLICENSE.BLLICENSETYPEID
	
	WHERE(BLLICENSEWFSTEP.BLLICENSEID = @ENTITY_ID AND BLLICENSETYPE.BLLICENSETYPEMODULEID=@BLLICENSETYPEMODULE_ID)
		UNION ALL 
	SELECT BLLICENSE.BLLICENSEID FROM BLLICENSEACTIONREF 
	INNER JOIN BLLICENSEWFACTIONSTEP ON BLLICENSEACTIONREF.OBJECTID = BLLICENSEWFACTIONSTEP.BLLICENSEWFACTIONSTEPID 
	INNER JOIN BLLICENSEWFSTEP ON BLLICENSEWFACTIONSTEP.BLLICENSEWFSTEPID = BLLICENSEWFSTEP.BLLICENSEWFSTEPID
	INNER JOIN BLLICENSE ON BLLICENSEWFSTEP.BLLICENSEID = BLLICENSE.BLLICENSEID 
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on BLLICENSE.BLLICENSETYPEID = u.RECORDTYPEID
	INNER JOIN BLLICENSETYPE ON BLLICENSETYPE.BLLICENSETYPEID= BLLICENSE.BLLICENSETYPEID
	WHERE(BLLICENSEACTIONREF.BLLICENSEID = @ENTITY_ID AND BLLICENSETYPE.BLLICENSETYPEMODULEID=@BLLICENSETYPEMODULE_ID)
)