CREATE FUNCTION DBO.LINKEDBUSSINESSFROMCONTACT
(	
	@ENTITY_ID char(36),
	@BLEXTCOMPANYTYPEMODULE_ID INT
)
RETURNS TABLE 
AS
RETURN 
(
	select blx.BLGLOBALENTITYEXTENSIONID
		from BLGLOBALENTITYEXTENSION blx
		INNER JOIN BLEXTCOMPANYTYPE ON BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEID = blx.BLEXTCOMPANYTYPEID
		where blx.GLOBALENTITYID = @ENTITY_ID AND BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEMODULEID= @BLEXTCOMPANYTYPEMODULE_ID	
		UNION 
		select blx.BLGLOBALENTITYEXTENSIONID from BLGLOBALENTITYEXTENSION blx INNER JOIN
		BLGLOBALENTITYEXTENSIONCONTACT blxc on blx.BLGLOBALENTITYEXTENSIONID = blxc.BLGLOBALENTITYEXTENSIONID 
		INNER JOIN BLEXTCOMPANYTYPE ON BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEID = blx.BLEXTCOMPANYTYPEID
		where blxc.GLOBALENTITYID = @ENTITY_ID  AND 
		(blx.GLOBALENTITYID !=  @ENTITY_ID  OR blx.GLOBALENTITYID is NULL)
		AND BLEXTCOMPANYTYPE.BLEXTCOMPANYTYPEMODULEID= @BLEXTCOMPANYTYPEMODULE_ID
)