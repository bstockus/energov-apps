CREATE FUNCTION [dbo].[UFN_GET_PARENT_CHILD_PERMITS_FROM_CHILD_PERMIT]
    ( @paramPermitId CHAR(36) )
RETURNS @returnTable TABLE ( PermitId CHAR(36) )
AS
BEGIN

	INSERT INTO @returnTable
	SELECT ParentPM.PMPERMITID
	FROM PMPERMIT PM
	INNER JOIN PMPERMITACTIONREF PMAR ON PM.PMPERMITID = PMAR.PMPERMITID
	INNER JOIN PMPERMITWFACTIONSTEP PMWFSA ON PMAR.OBJECTID = PMWFSA.PMPERMITWFACTIONSTEPID
	INNER JOIN PMPERMITWFSTEP PMWFS ON PMWFSA.PMPERMITWFSTEPID = PMWFS.PMPERMITWFSTEPID
	INNER JOIN PMPERMIT ParentPM ON PMWFS.PMPERMITID = ParentPM.PMPERMITID
	WHERE PM.PMPERMITID = @paramPermitId
	UNION ALL
	SELECT ChildPM.PMPERMITID
	FROM PMPERMIT PM
	INNER JOIN PMPERMITWFSTEP PMWFS ON PM.PMPERMITID = PMWFS.PMPERMITID
	INNER JOIN PMPERMITWFACTIONSTEP PMWFSA ON PMWFS.PMPERMITWFSTEPID = PMWFSA.PMPERMITWFSTEPID
	INNER JOIN PMPERMITACTIONREF PMAR ON PMWFSA.PMPERMITWFACTIONSTEPID = PMAR.OBJECTID
	INNER JOIN PMPERMIT ChildPM ON PMAR.PMPERMITID = ChildPM.PMPERMITID
	WHERE PM.PMPERMITID = @paramPermitId

	RETURN;	
END;