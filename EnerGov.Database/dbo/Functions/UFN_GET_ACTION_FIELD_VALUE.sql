CREATE FUNCTION [dbo].[UFN_GET_ACTION_FIELD_VALUE]
    (@SETVALUEFIELDVALUE NVARCHAR(MAX),@SETVALUEFIELD NVARCHAR(MAX))
RETURNS NVARCHAR(MAX)
AS
BEGIN
	DECLARE @RETURNVALUE NVARCHAR(MAX);
	DECLARE @TYPEFULLNAME VARCHAR(500);
	DECLARE @NAME VARCHAR(500);
	DECLARE @LOOKUPTABLENAME NVARCHAR(500);
	DECLARE @PROPERTYNAME NVARCHAR(100);
	

	SET  @TYPEFULLNAME = REVERSE(SUBSTRING(LTRIM(RTRIM(REVERSE(SUBSTRING(@SETVALUEFIELD,CHARINDEX('(',@SETVALUEFIELD)+1,(CHARINDEX(')',@SETVALUEFIELD)-CHARINDEX('(',@SETVALUEFIELD))-1)))),
	CHARINDEX('.',LTRIM(RTRIM(REVERSE(SUBSTRING(@SETVALUEFIELD,CHARINDEX('(',@SETVALUEFIELD)+1,(CHARINDEX(')',@SETVALUEFIELD)-CHARINDEX('(',@SETVALUEFIELD))))))),
	LEN(@SETVALUEFIELD)));

	SET @NAME = REVERSE(SUBSTRING(LTRIM(RTRIM(REVERSE(SUBSTRING(@SETVALUEFIELD,CHARINDEX('(',@SETVALUEFIELD)+1,(CHARINDEX(')',@SETVALUEFIELD)-CHARINDEX('(',@SETVALUEFIELD))-1)))),0,
	CHARINDEX('.',LTRIM(RTRIM(REVERSE(SUBSTRING(@SETVALUEFIELD,CHARINDEX('(',@SETVALUEFIELD)+1,(CHARINDEX(')',@SETVALUEFIELD)-CHARINDEX('(',@SETVALUEFIELD))-1)))))));
	

	SELECT @LOOKUPTABLENAME= LOOKUPTABLENAME , @PROPERTYNAME= PROPERTYNAME 
	FROM METADATACLASSPROPERTY p
	JOIN METADATACLASS c ON p.PARENTID = c.ID
	WHERE c.TYPEFULLNAME = @TYPEFULLNAME AND p.NAME = @NAME	AND p.CONTROLTYPEID=1
	
	IF(@LOOKUPTABLENAME IS NOT NULL)
	BEGIN
		SET @RETURNVALUE = 
		(SELECT ISNULL(STRINGVALUE,'') from LOOKUPVIEW where TABLENAME = @LOOKUPTABLENAME and UNIQUEID = CONVERT(CHAR(36),LTRIM(RTRIM(@SETVALUEFIELDVALUE)))
		 UNION ALL
		 SELECT ISNULL(STRINGVALUE,'') from LOOKUPVIEWFORINTEGERS where TABLENAME = @LOOKUPTABLENAME and CONVERT(VARCHAR,UNIQUEID) = @SETVALUEFIELDVALUE
		 )
	END
	ELSE
	BEGIN
		SET @RETURNVALUE = 
			(SELECT  ISNULL(SVALUE,'') from CUSTOMFIELDPICKLISTITEM where GCUSTOMFIELDPICKLISTITEM =CONVERT(CHAR(36),LTRIM(RTRIM(@SETVALUEFIELDVALUE))))
	END 

	IF (@RETURNVALUE IS NULL)
	BEGIN
		SET @RETURNVALUE = ISNULL(@SETVALUEFIELDVALUE,'')
	END 

	RETURN @RETURNVALUE
	
END;