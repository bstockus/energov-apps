CREATE FUNCTION DBO.LINKEDCODECASEFROMBUSINESSLICENSE
(	
	@ENTITY_ID char(36),
	@USER_ID char(36)
)
RETURNS TABLE 
AS
RETURN 
(
	SELECT CMCODECASE.CMCODECASEID,1 AS ISCHILD, 0 AS ISPARENT 	FROM BLLICENSE 
	INNER JOIN BLLICENSEWFSTEP ON BLLICENSE.BLLICENSEID = BLLICENSEWFSTEP.BLLICENSEID
	INNER JOIN BLLICENSEWFACTIONSTEP ON BLLICENSEWFSTEP.BLLICENSEWFSTEPID = BLLICENSEWFACTIONSTEP.BLLICENSEWFSTEPID
	INNER JOIN CMCODECASEACTIONREF ON 	BLLICENSEWFACTIONSTEP.BLLICENSEWFACTIONSTEPID = CMCODECASEACTIONREF.CMCODECASEACTIONREFID
	INNER JOIN CMCODECASE ON CMCODECASEACTIONREF.CMCODECASEID = CMCODECASE.CMCODECASEID 
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on CMCODECASE.CMCASETYPEID = u.RECORDTYPEID
	WHERE (BLLICENSE.BLLICENSEID = @ENTITY_ID)
	UNION ALL 
	SELECT CMCODECASE.CMCODECASEID,0 AS ISCHILD, 1 AS ISPARENT FROM BLLICENSEACTIONREF 
	INNER JOIN CMCODEWFACTIONSTEP ON BLLICENSEACTIONREF.OBJECTID = CMCODEWFACTIONSTEP.CMCODEWFACTIONSTEPID
	INNER JOIN CMCODEWFSTEP ON CMCODEWFACTIONSTEP.CMCODEWFSTEPID = CMCODEWFSTEP.CMCODEWFSTEPID
	INNER JOIN CMCODECASE ON CMCODEWFSTEP.CMCODECASEID = CMCODECASE.CMCODECASEID
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on CMCODECASE.CMCASETYPEID = u.RECORDTYPEID
	WHERE (BLLICENSEACTIONREF.BLLICENSEID = @ENTITY_ID)
)