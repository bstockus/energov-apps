CREATE FUNCTION DBO.LINKEDCODECASEFROMPERMIT
(	
	@ENTITY_ID char(36),
	@USER_ID char(36)
)
RETURNS TABLE 
AS
RETURN 
(
	SELECT CMCODECASE.CMCODECASEID,1 AS ISCHILD, 0 AS ISPARENT 	FROM PMPERMIT 
	INNER JOIN PMPERMITWFSTEP ON PMPERMIT.PMPERMITID = PMPERMITWFSTEP.PMPERMITID
	INNER JOIN PMPERMITWFACTIONSTEP ON PMPERMITWFSTEP.PMPERMITWFSTEPID = PMPERMITWFACTIONSTEP.PMPERMITWFSTEPID
	INNER JOIN CMCODECASEACTIONREF ON 	PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = CMCODECASEACTIONREF.CMCODECASEACTIONREFID
	INNER JOIN CMCODECASE ON CMCODECASEACTIONREF.CMCODECASEID = CMCODECASE.CMCODECASEID 
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on CMCODECASE.CMCASETYPEID = u.RECORDTYPEID
	WHERE (PMPERMIT.PMPERMITID = @ENTITY_ID)
	UNION ALL 
	SELECT CMCODECASE.CMCODECASEID,0 AS ISCHILD, 1 AS ISPARENT FROM PMPERMITACTIONREF 
	INNER JOIN CMCODEWFACTIONSTEP ON PMPERMITACTIONREF.OBJECTID = CMCODEWFACTIONSTEP.CMCODEWFACTIONSTEPID
	INNER JOIN CMCODEWFSTEP ON CMCODEWFACTIONSTEP.CMCODEWFSTEPID = CMCODEWFSTEP.CMCODEWFSTEPID
	INNER JOIN CMCODECASE ON CMCODEWFSTEP.CMCODECASEID = CMCODECASE.CMCODECASEID
	INNER JOIN GETUSERVISIBLERECORDTYPES(@USER_ID) u on CMCODECASE.CMCASETYPEID = u.RECORDTYPEID
	WHERE (PMPERMITACTIONREF.PMPERMITID = @ENTITY_ID)
)