CREATE PROCEDURE [managebusinesslicense].[USP_BLLICENSERENEWDETAIL_GETBYIDS]
(
	@BLLICENSEIDS  RECORDIDS READONLY,
	@VALIDATEHOLDS BIT = NULL
)
AS
BEGIN
SELECT DISTINCT
		[BLLICENSE].BLLICENSEID,
        [BLLICENSE].ROWVERSION,
        [BLLICENSETYPE].BLLICENSETYPEID,
        [BLLICENSETYPE].ISRECEIPTSTYPE,
        [BLLICENSETYPE].ISRENEWABLE,
        [BLLICENSETYPECLASS].RENEWALDAYSPRIORTOEXPIRE,
		(SELECT CAST ((CASE WHEN  COUNT(1)>0 THEN 1 ELSE 0 END) AS BIT) FROM [BLLICENSE] CHILD WHERE [BLLICENSE].BLLICENSEID = [CHILD].BLLICENSEPARENTID) AS [ALREADYRENEWED],
		CAST ((CASE WHEN [BLLICENSECONTACT].[BLLICENSEID] IS NULL THEN 0 ELSE 1 END) AS BIT) BLLICENSECONTACTISBILLING,
        [BLLICENSE].EXPIRATIONDATE,
		(SELECT CAST ((CASE WHEN  COUNT(1)>0 THEN 1 ELSE 0 END) AS BIT) FROM [BLBATCHRENEWALBLLICENSE] WHERE [BLBATCHRENEWALBLLICENSE].BLLICENSEID = [BLLICENSE].BLLICENSEID AND [BLBATCHRENEWALBLLICENSE].PROCESSEDDATE IS NULL) AS ISINEXISTINGBATCH,
        [BLLICENSETYPE].ACTIVE,
		[BLLICENSETYPE].BLLICENSETYPEMODULEID
FROM [dbo].[BLLICENSE]
			INNER JOIN [dbo].[BLLICENSETYPE] ON [BLLICENSE].BLLICENSETYPEID = [BLLICENSETYPE].BLLICENSETYPEID
			INNER JOIN [dbo].[BLLICENSETYPECLASS] ON [BLLICENSETYPE].BLLICENSETYPEID = [BLLICENSETYPECLASS].BLLICENSETYPEID
			AND [BLLICENSE].BLLICENSECLASSID = [BLLICENSETYPECLASS].BLLICENSECLASSID			
			LEFT OUTER JOIN [BLLICENSECONTACT] ON BLLICENSE.BLLICENSEID = [BLLICENSECONTACT].[BLLICENSEID] AND ISBILLING=1
			WHERE BLLICENSE.BLLICENSEID IN (SELECT RECORDID FROM @BLLICENSEIDS)

	IF(@VALIDATEHOLDS=1)
	 BEGIN
		EXEC [managebusinesslicense].[USP_HOLDS_GETBY_BLLICENSEIDS] @BLLICENSEIDS
	 END
END