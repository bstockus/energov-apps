CREATE PROCEDURE [managebusinesslicense].[USP_RECENTLICENSES_GETBY_USERIDS]
(
	@RECENTHISTORYBUSINESSLICENSELIST RecordIDs READONLY,
	@USERID AS CHAR(36) = NULL
)
AS
BEGIN
	SELECT  [BLLICENSE].[APPLIEDDATE] ,		
			[BLLICENSECLASS].[NAME] AS [BLLICENSECLASSNAME],
			[BLGLOBALENTITYEXTENSION].[COMPANYNAME],
			[BLGLOBALENTITYEXTENSION].[DBA] ,
			[BLLICENSE].[ISSUEDBY],
			[BLLICENSE].[DESCRIPTION] ,
			[BLLICENSE].[EXPIRATIONDATE] ,
			[BLLICENSE].[REPORTEDRECEIPTS],
			[BLLICENSE].[ALLOWEDDEDUCTIONAMOUNT],
			[BLLICENSE].[LASTRENEWALDATE] ,
			[BLLICENSE].[BLLICENSEID],
			[BLLICENSE].[LICENSENUMBER],
			[BLLICENSESTATUS].[NAME] AS [BLLICENSESTATUSNAME],			
			[BLLICENSETYPE].[NAME] AS [BLLICENSETYPENAME],		
			[RECENTHISTORYBUSINESSLICENSE].[LOGGEDDATETIME] ,
			[RECENTHISTORYBUSINESSLICENSE].[RECENTHISTORYBUSINESSLICENSEID],
			[RECENTHISTORYBUSINESSLICENSE].[USERID] AS [USERID] ,
			[RECENTHISTORYBUSINESSLICENSE_USERS].[FNAME] AS [USERFIRSTNAME],
			[RECENTHISTORYBUSINESSLICENSE_USERS].[LNAME] AS [USERLASTNAME] ,
			[USERS].[FNAME] AS [ISSUEDBYFNAME],
			[USERS].[LNAME] AS [ISSUEDBYLNAME],
			[BLLICENSE].[TAXYEAR],
			[BLLICENSE].[NUMBEROFUNITS],
			[BLLICENSE].[PROPERTYNAME]
	FROM [dbo].[BLLICENSE]
		INNER JOIN [dbo].[BLGLOBALENTITYEXTENSION] ON [BLLICENSE].[BLGLOBALENTITYEXTENSIONID] = [BLGLOBALENTITYEXTENSION].[BLGLOBALENTITYEXTENSIONID]
		INNER JOIN [dbo].[BLLICENSECLASS] ON [BLLICENSE].[BLLICENSECLASSID] = [BLLICENSECLASS].BLLICENSECLASSID 
		INNER JOIN [dbo].[BLLICENSETYPE] ON [BLLICENSE].[BLLICENSETYPEID] = [BLLICENSETYPE].[BLLICENSETYPEID]
		INNER JOIN [dbo].[BLLICENSESTATUS] ON [BLLICENSE].[BLLICENSESTATUSID] = [BLLICENSESTATUS].[BLLICENSESTATUSID]
		LEFT OUTER JOIN  [dbo].[USERS](NOLOCK) ON [BLLICENSE].[ISSUEDBY] = [USERS].[SUSERGUID]
		INNER JOIN [dbo].[RECENTHISTORYBUSINESSLICENSE] ON  [BLLICENSE].[BLLICENSEID] = [RECENTHISTORYBUSINESSLICENSE].[LICENSEID] 		
		LEFT OUTER JOIN  [dbo].[USERS](NOLOCK) AS [RECENTHISTORYBUSINESSLICENSE_USERS] ON [RECENTHISTORYBUSINESSLICENSE].[USERID] = [RECENTHISTORYBUSINESSLICENSE_USERS].[SUSERGUID]
		INNER JOIN @RECENTHISTORYBUSINESSLICENSELIST AS RECENTHISTORYBUSINESSLICENSELIST ON [BLLICENSE].BLLICENSEID = RECENTHISTORYBUSINESSLICENSELIST.RECORDID
	WHERE [RECENTHISTORYBUSINESSLICENSE].[USERID]=@USERID 
		 ORDER BY [RECENTHISTORYBUSINESSLICENSE].[LOGGEDDATETIME] DESC		

	EXEC [managebusinesslicense].[USP_BLLICENSEADDRESS_GETBYIDS] @RECENTHISTORYBUSINESSLICENSELIST
	EXEC [managebusinesslicense].[USP_BLLICENSECONTACT_GETBYIDS] @RECENTHISTORYBUSINESSLICENSELIST
	EXEC [managebusinesslicense].[USP_BLEXTBUSINESSTYPE_GETBY_BLLICENSEID] @RECENTHISTORYBUSINESSLICENSELIST
END