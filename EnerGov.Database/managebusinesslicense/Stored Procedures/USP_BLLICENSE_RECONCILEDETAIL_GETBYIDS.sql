CREATE PROCEDURE [managebusinesslicense].[USP_BLLICENSE_RECONCILEDETAIL_GETBYIDS]
	@BLLICENSEIDS  RECORDIDS READONLY
AS
BEGIN
	;WITH CTE_PARENTLICENCES (BLLICENSEPARENTID) AS (
				SELECT	BLLICENSE.BLLICENSEPARENTID
				FROM	BLLICENSE
				JOIN	BLLICENSETYPE ON BLLICENSETYPE.BLLICENSETYPEID = BLLICENSE.BLLICENSETYPEID
				WHERE	BLLICENSETYPE.ISRECEIPTSTYPE=1 AND BLLICENSETYPE.ISRENEWABLE=1
					AND	BLLICENSE.LASTRENEWALDATE IS NULL AND BLLICENSE.BLLICENSEPARENTID IS NOT NULL
	)

	SELECT	BLLICENSE.BLLICENSEID,
			BLLICENSE.LASTRENEWALDATE,
			BLLICENSE.BLLICENSEPARENTID,
			BLLICENSETYPE.ISRENEWABLE,
			BLLICENSETYPE.ISRECEIPTSTYPE,
			CAST ((CASE WHEN CTE_PARENTLICENCES.BLLICENSEPARENTID IS NOT NULL THEN 1 ELSE 0 END) AS BIT) AS  CANRECONCILE,
			CAST ((CASE WHEN [BLLICENSECONTACT].[BLLICENSEID] IS NULL THEN 0 ELSE 1 END) AS BIT) BLLICENSECONTACTISBILLING
	FROM BLLICENSE
	LEFT JOIN CTE_PARENTLICENCES ON BLLICENSE.BLLICENSEID = CTE_PARENTLICENCES.BLLICENSEPARENTID
	JOIN BLLICENSETYPE ON BLLICENSETYPE.BLLICENSETYPEID = BLLICENSE.BLLICENSETYPEID
	LEFT OUTER JOIN [BLLICENSECONTACT] ON BLLICENSE.BLLICENSEID = [BLLICENSECONTACT].[BLLICENSEID] AND ISBILLING=1
	WHERE BLLICENSE.BLLICENSEID IN (SELECT RECORDID FROM @BLLICENSEIDS)
END