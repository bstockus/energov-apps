CREATE PROCEDURE [managemyreview].[USP_PLITEMREVIEW_GETBYASSIGNEDUSERS_FACETS_PROJECT]
(
	@ITEMREVIEWLIST RecordIDs READONLY
)
AS
BEGIN
SET NOCOUNT ON;		

SELECT			PRPROJECT.PRPROJECTID AS ID
				, PRPROJECT.NAME
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PMPERMIT ON PLSUBMITTAL.PMPERMITID = PMPERMIT.PMPERMITID
INNER JOIN		PRPROJECTPERMIT ON PMPERMIT.PMPERMITID =  PRPROJECTPERMIT.PMPERMITID
INNER JOIN		PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTPERMIT.PRPROJECTID
GROUP BY		PRPROJECT.PRPROJECTID, PRPROJECT.NAME
UNION ALL
SELECT			PRPROJECT.PRPROJECTID AS ID
				, PRPROJECT.NAME
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PLPLAN ON PLSUBMITTAL.PLPLANID = PLPLAN.PLPLANID
INNER JOIN		PRPROJECTPLAN ON  PLPLAN.PLPLANID = PRPROJECTPLAN.PLPLANID
INNER JOIN		PRPROJECT ON PRPROJECT.PRPROJECTID = PRPROJECTPLAN.PRPROJECTID
GROUP BY		PRPROJECT.PRPROJECTID, PRPROJECT.NAME
UNION ALL
SELECT			'' AS PROJECTID
				, '' AS PROJECTNAME
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
WHERE			(PLSUBMITTAL.PLPLANID IS NULL AND PLSUBMITTAL.PMPERMITID IS NULL AND PLSUBMITTAL.BLLICENSEID IS NULL AND  PLSUBMITTAL.ILLICENSEID IS NULL)
OR				(PLSUBMITTAL.PLPLANID IS NOT NULL AND NOT EXISTS(SELECT * FROM PRPROJECTPLAN WHERE PLPLANID = PLSUBMITTAL.PLPLANID))
OR				(PLSUBMITTAL.PMPERMITID IS NOT NULL AND NOT EXISTS(SELECT * FROM PRPROJECTPERMIT WHERE PMPERMITID = PLSUBMITTAL.PMPERMITID))
ORDER BY COUNT(*) DESC, ID, NAME

END