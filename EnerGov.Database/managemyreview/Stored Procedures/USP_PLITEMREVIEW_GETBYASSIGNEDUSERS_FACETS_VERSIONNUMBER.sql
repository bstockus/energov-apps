CREATE PROCEDURE [managemyreview].[USP_PLITEMREVIEW_GETBYASSIGNEDUSERS_FACETS_VERSIONNUMBER]
(
	@ITEMREVIEWLIST RecordIDs READONLY
)
AS
BEGIN
SET NOCOUNT ON;

WITH CTE_VERSIONNUMBER AS (
SELECT			PLITEMREVIEW.PLITEMREVIEWID 
				, BLLICENSEWFACTIONSTEP.VERSIONNUMBER AS VERSIONNUMBER
FROM			PLITEMREVIEW
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		BLLICENSEWFACTIONSTEP ON BLLICENSEWFACTIONSTEP.BLLICENSEWFACTIONSTEPID = PLSUBMITTAL.BLLICENSEWFACTIONSTEPID
UNION ALL
SELECT			PLITEMREVIEW.PLITEMREVIEWID		
				, ILLICENSEWFACTIONSTEP.VERSIONNUMBER AS VERSIONNUMBER								
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		ILLICENSEWFACTIONSTEP ON ILLICENSEWFACTIONSTEP.ILLICENSEWFACTIONSTEPID = PLSUBMITTAL.ILLICENSEWFACTIONSTEPID
UNION ALL
SELECT			PLITEMREVIEW.PLITEMREVIEWID		
				, PMPERMITWFACTIONSTEP.VERSIONNUMBER AS VERSIONNUMBER							
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PMPERMITWFACTIONSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = PLSUBMITTAL.PMPERMITWFACTIONSTEPID
UNION ALL
SELECT			PLITEMREVIEW.PLITEMREVIEWID		
				, PLPLANWFACTIONSTEP.VERSIONNUMBER AS VERSIONNUMBER		
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID
)
SELECT		CAST(VERSIONNUMBER AS VARCHAR(3)) AS ID,
			CAST(VERSIONNUMBER AS VARCHAR(3)) AS NAME
			, COUNT(*) COUNT
FROM		CTE_VERSIONNUMBER
GROUP BY	VERSIONNUMBER
ORDER BY VERSIONNUMBER

END