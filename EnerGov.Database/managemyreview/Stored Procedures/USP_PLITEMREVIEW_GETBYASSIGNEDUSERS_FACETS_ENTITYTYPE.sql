CREATE PROCEDURE [managemyreview].[USP_PLITEMREVIEW_GETBYASSIGNEDUSERS_FACETS_ENTITYTYPE]
(
	@ITEMREVIEWLIST RecordIDs READONLY
)
AS
BEGIN
SET NOCOUNT ON;
SELECT			BLLICENSETYPE.BLLICENSETYPEID AS ID
				, BLLICENSETYPE.NAME
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		BLLICENSE ON BLLICENSE.BLLICENSEID = PLSUBMITTAL.BLLICENSEID
INNER JOIN		BLLICENSETYPE ON BLLICENSE.BLLICENSETYPEID = BLLICENSETYPE.BLLICENSETYPEID
GROUP BY		BLLICENSETYPE.BLLICENSETYPEID, BLLICENSETYPE.NAME
UNION ALL
SELECT			ILLICENSETYPE.ILLICENSETYPEID AS ID
				, ILLICENSETYPE.NAME 
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		ILLICENSE ON ILLICENSE.ILLICENSEID = PLSUBMITTAL.ILLICENSEID
INNER JOIN		ILLICENSETYPE ON ILLICENSE.ILLICENSETYPEID = ILLICENSETYPE.ILLICENSETYPEID
GROUP BY		ILLICENSETYPE.ILLICENSETYPEID, ILLICENSETYPE.NAME
UNION ALL
SELECT			PMPERMITTYPE.PMPERMITTYPEID AS ID
				, PMPERMITTYPE.NAME 
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PMPERMIT ON PMPERMIT.PMPERMITID = PLSUBMITTAL.PMPERMITID
INNER JOIN		PMPERMITTYPE ON PMPERMIT.PMPERMITTYPEID = PMPERMITTYPE.PMPERMITTYPEID
GROUP BY		PMPERMITTYPE.PMPERMITTYPEID, PMPERMITTYPE.NAME
UNION ALL
SELECT			PLPLANTYPE.PLPLANTYPEID AS ID
				, PLPLANTYPE.PLANNAME AS NAME
				, COUNT(*) COUNT
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
INNER JOIN		PLPLAN ON PLPLAN.PLPLANID = PLSUBMITTAL.PLPLANID
INNER JOIN		PLPLANTYPE ON PLPLAN.PLPLANTYPEID = PLPLANTYPE.PLPLANTYPEID
GROUP BY		PLPLANTYPE.PLPLANTYPEID, PLPLANTYPE.PLANNAME
ORDER BY COUNT(*) DESC, ID, NAME

END