CREATE PROCEDURE [managemyreview].[USP_PLITEMREVIEW_GETPREVIOUSRESPONSES]
(
	 @PLITEMREVIEWID	CHAR(36)
)
AS
BEGIN
SET NOCOUNT ON
DECLARE @VERSIONNUMBER INT, @PARENTWFACTIONID CHAR(36), @PARENTSUBMITTAL CHAR(36), @PARENTSESSIONID VARCHAR(36)

SELECT		@VERSIONNUMBER = VERSIONNUMBER
			, @PARENTWFACTIONID = PARENTWFACTIONSTEPID
			, @PARENTSUBMITTAL = PLSUBMITTALPARENTID
			, @PARENTSESSIONID = ERENTITYSESSIONID
FROM		(
SELECT		PMPERMITWFACTIONSTEP.VERSIONNUMBER
			, PMPERMITWFACTIONSTEP.PMPERMITWFPARENTACTIONSTEPID AS PARENTWFACTIONSTEPID
			, PLSUBMITTAL.PLSUBMITTALPARENTID
			, ERENTITYSESSION.ERENTITYSESSIONID
FROM		PLITEMREVIEW
JOIN		PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = PLITEMREVIEW.PLSUBMITTALID
JOIN		PMPERMITWFACTIONSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = PLSUBMITTAL.PMPERMITWFACTIONSTEPID
LEFT JOIN	ERENTITYSESSION ON ERENTITYSESSION.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALPARENTID
WHERE		PLITEMREVIEW.PLITEMREVIEWID = @PLITEMREVIEWID
UNION ALL
SELECT		PLPLANWFACTIONSTEP.VERSIONNUMBER
			, PLPLANWFACTIONSTEP.PLPLANWFPARENTACTIONSTEPID AS PARENTWFACTIONSTEPID
			, PLSUBMITTAL.PLSUBMITTALPARENTID
			, ERENTITYSESSION.ERENTITYSESSIONID
FROM		PLITEMREVIEW
JOIN		PLSUBMITTAL ON PLSUBMITTAL.PLSUBMITTALID = PLITEMREVIEW.PLSUBMITTALID
JOIN		PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID
LEFT JOIN	ERENTITYSESSION ON ERENTITYSESSION.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALPARENTID
WHERE		PLITEMREVIEW.PLITEMREVIEWID = @PLITEMREVIEWID
) AS TBLTEMP

SELECT		@VERSIONNUMBER - 1 AS VERSIONNUMBER
			, @PARENTSESSIONID AS ENTITYSESSIONID

IF @VERSIONNUMBER > 1
BEGIN
	WITH ItemReviewData AS (
	SELECT		PLSUBMITTAL.PLSUBMITTALID
	FROM		PLSUBMITTAL 
	JOIN		PMPERMITWFACTIONSTEP ON PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = PLSUBMITTAL.PMPERMITWFACTIONSTEPID 
	WHERE		PMPERMITWFACTIONSTEP.VERSIONNUMBER = @VERSIONNUMBER - 1 AND PMPERMITWFACTIONSTEP.PMPERMITWFACTIONSTEPID = @PARENTWFACTIONID
	UNION ALL
	SELECT		PLSUBMITTAL.PLSUBMITTALID
	FROM		PLSUBMITTAL
	JOIN		PLPLANWFACTIONSTEP ON PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = PLSUBMITTAL.PLPLANWFACTIONSTEPID 
	WHERE		PLPLANWFACTIONSTEP.VERSIONNUMBER = @VERSIONNUMBER - 1 AND PLPLANWFACTIONSTEP.PLPLANWFACTIONSTEPID = @PARENTWFACTIONID)
	SELECT		USERS.EMAIL,
                PLPLANCORRECTION.COMMENTS,
                RESPONSE.RESPONSEID,
                RESPONSE.RESPONSEENTITYID,
                RESPONSE.RESPONSETYPEID,
                RESPONSETYPE.NAME AS RESPONSETYPENAME,
                RESPONSE.RESPONSE,
                RESPONSE.CREATEDATE,
                RESPONSE.LASTCHANGEDBY,
                RESPONSE.CREATEDBY,
                USERS_CREATEDBY.FNAME AS CREATEDBYFNAME,
                USERS_CREATEDBY.LNAME AS CREATEDBYLNAME,
				RESPONSE.LASTCHANGEDON
	FROM		ItemReviewData
	JOIN		PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = ItemReviewData.PLSUBMITTALID
	JOIN		PLPLANCORRECTION ON PLPLANCORRECTION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
	JOIN		RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANCORRECTION.PLPLANCORRECTIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
	JOIN		RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
	JOIN		USERS ON USERS.SUSERGUID = PLPLANCORRECTION.ADDEDBYUSERID
	JOIN		USERS AS USERS_CREATEDBY ON USERS_CREATEDBY.SUSERGUID = RESPONSE.CREATEDBY
	UNION ALL
	SELECT		USERS.EMAIL,
                PLPLANRECOMMENDATION.RECOMMENDATION AS COMMENTS,
                RESPONSE.RESPONSEID,
                RESPONSE.RESPONSEENTITYID,
                RESPONSE.RESPONSETYPEID,
                RESPONSETYPE.NAME AS RESPONSETYPENAME,
                RESPONSE.RESPONSE,
                RESPONSE.CREATEDATE,
                RESPONSE.LASTCHANGEDBY,
                RESPONSE.CREATEDBY,
                USERS_CREATEDBY.FNAME AS CREATEDBYFNAME,
                USERS_CREATEDBY.LNAME AS CREATEDBYLNAME,
				RESPONSE.LASTCHANGEDON
	FROM		ItemReviewData
	JOIN		PLITEMREVIEW ON PLITEMREVIEW.PLSUBMITTALID = ItemReviewData.PLSUBMITTALID
	JOIN		PLPLANRECOMMENDATION ON PLPLANRECOMMENDATION.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
	JOIN		RESPONSE ON RESPONSE.RESPONSEENTITYID = PLPLANRECOMMENDATION.PLPLANRECOMENDATIONID AND LEN(RESPONSE.RESPONSE) > 0 AND RESPONSE.ISDELETED = 0
	JOIN		RESPONSETYPE ON RESPONSE.RESPONSETYPEID = RESPONSETYPE.RESPONSETYPEID
	JOIN		USERS ON USERS.SUSERGUID = PLPLANRECOMMENDATION.ADDEDBYUSERID
	JOIN		USERS AS USERS_CREATEDBY ON USERS_CREATEDBY.SUSERGUID = RESPONSE.CREATEDBY
                    
	SELECT	ERPROJECTFILEVERSIONID
	FROM	PLSUBMITTALFILEVERSION
	WHERE	PLSUBMITTALID = @PARENTSUBMITTAL   
END

END