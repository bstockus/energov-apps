CREATE PROCEDURE [managemyreview].[USP_PLITEMREVIEW_GETBYASSIGNEDUSERS_FACETS_ADDRESS]
(
	@ITEMREVIEWLIST RecordIDs READONLY
)
AS
BEGIN
SET NOCOUNT ON;

WITH CTE_ADDRESS AS (
SELECT			PLITEMREVIEW.PLITEMREVIEWID	
				, COALESCE(BLLICENSEADDRESS.MAILINGADDRESSID, ILLICENSEADDRESS.MAILINGADDRESSID, PMPERMITADDRESS.MAILINGADDRESSID, PLPLANADDRESS.MAILINGADDRESSID) AS MAINADDRESSID
				, COALESCE(BLLICENSEADDRESS.BLLICENSEADDRESSID, ILLICENSEADDRESS.ILLICENSEADDRESSID, PMPERMITADDRESS.PMPERMITADDRESSID, PLPLANADDRESS.PLPLANADDRESSID) AS PARENTADDRESSID
FROM			PLITEMREVIEW 
INNER JOIN		@ITEMREVIEWLIST ON PLITEMREVIEW.PLITEMREVIEWID = RECORDID
INNER JOIN		PLSUBMITTAL ON PLITEMREVIEW.PLSUBMITTALID = PLSUBMITTAL.PLSUBMITTALID
LEFT OUTER JOIN	BLLICENSEADDRESS ON PLSUBMITTAL.BLLICENSEID = BLLICENSEADDRESS.BLLICENSEID AND BLLICENSEADDRESS.MAIN = 1
LEFT OUTER JOIN	ILLICENSEADDRESS ON PLSUBMITTAL.ILLICENSEID = ILLICENSEADDRESS.ILLICENSEID AND ILLICENSEADDRESS.MAIN = 1
LEFT OUTER JOIN	PMPERMITADDRESS ON PLSUBMITTAL.PMPERMITID = PMPERMITADDRESS.PMPERMITID AND PMPERMITADDRESS.MAIN = 1
LEFT OUTER JOIN	PLPLANADDRESS ON PLSUBMITTAL.PLPLANID = PLPLANADDRESS.PLPLANID AND PLPLANADDRESS.MAIN = 1
)
SELECT  PLITEMREVIEW.PLITEMREVIEWID AS PARENTID,
		COALESCE(CTE_ADDRESS.PARENTADDRESSID, '') AS ENTITYID,
		COALESCE(MAILINGADDRESS.ADDRESSLINE1, '') AS ADDRESSLINE1,
		COALESCE(MAILINGADDRESS.ADDRESSLINE2, '') AS ADDRESSLINE2,
		COALESCE(MAILINGADDRESS.ADDRESSLINE3, '') AS ADDRESSLINE3,
		COALESCE(MAILINGADDRESS.ADDRESSTYPE, '') AS ADDRESSTYPE,
		COALESCE(MAILINGADDRESS.ATTN, '') AS ATTN,
		COALESCE(MAILINGADDRESS.CITY, '') AS CITY,
		COALESCE(MAILINGADDRESS.COMPSITE, '') AS COMPSITE,
		COALESCE(MAILINGADDRESS.COUNTRY, '') AS COUNTRY,
		COALESCE(MAILINGADDRESSCOUNTRYTYPE.MAILINGADDRESSCOUNTRYTYPEID, '') AS MAILINGADDRESSCOUNTRYTYPEID,
		COALESCE(MAILINGADDRESSCOUNTRYTYPE.MAILINGADDRESSCOUNTRYTYPENAME, '') AS MAILINGADDRESSCOUNTRYTYPENAME,
		CAST(1 AS BIT) AS ISMAIN,
		COALESCE(MAILINGADDRESS.POBOX, '') AS POBOX,
		COALESCE(MAILINGADDRESS.POSTALCODE, '') AS POSTALCODE,
		COALESCE(MAILINGADDRESS.POSTDIRECTION, '') AS POSTDIRECTION,
		COALESCE(MAILINGADDRESS.PREDIRECTION, '') AS PREDIRECTION,
		COALESCE(MAILINGADDRESS.PROVINCE, '') AS PROVINCE,
		COALESCE(MAILINGADDRESS.RURALROUTE, '') AS RURALROUTE,
		COALESCE(MAILINGADDRESS.STATE, '') AS STATE,
		COALESCE(MAILINGADDRESS.STATION, '') AS STATION,
		COALESCE(MAILINGADDRESS.STREETTYPE, '') AS STREETTYPE,
		COALESCE(MAILINGADDRESS.UNITORSUITE, '') AS UNITORSUITE,
		COALESCE(MAILINGADDRESS.ADDRESSID, '') AS ADDRESSID
	FROM PLITEMREVIEW
	INNER JOIN	CTE_ADDRESS ON CTE_ADDRESS.PLITEMREVIEWID = PLITEMREVIEW.PLITEMREVIEWID
	LEFT JOIN	MAILINGADDRESS ON CTE_ADDRESS.MAINADDRESSID = MAILINGADDRESS.MAILINGADDRESSID
	LEFT JOIN	MAILINGADDRESSCOUNTRYTYPE ON MAILINGADDRESS.COUNTRYTYPE = MAILINGADDRESSCOUNTRYTYPE.MAILINGADDRESSCOUNTRYTYPEID

END